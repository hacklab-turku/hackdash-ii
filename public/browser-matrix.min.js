!function e(t,r,n){function o(s,a){if(!r[s]){if(!t[s]){var u="function"==typeof require&&require;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=r[s]={exports:{}};t[s][0].call(l.exports,(function(e){return o(t[s][1][e]||e)}),l,l.exports,e,t,r,n)}return r[s].exports}for(var i="function"==typeof require&&require,s=0;s<n.length;s++)o(n[s]);return o}({1:[function(e,t,r){(function(r){var n=e("./lib/matrix");const o=e("browser-request"),i=e("qs");var s;n.request((function(e,t){return e.qs=i.stringify(e.qs||{},e.qsStringifyOptions),o(e,t)}));try{s=r.indexedDB}catch(e){}s&&n.setCryptoStoreFactory((function(){return new n.IndexedDBCryptoStore(s,"matrix-js-sdk:crypto")})),t.exports=n,r.matrixcs=n}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./lib/matrix":38,"browser-request":104,qs:263}],2:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=s(e("babel-runtime/core-js/get-iterator")),o=s(e("babel-runtime/helpers/classCallCheck")),i=s(e("babel-runtime/helpers/createClass"));function s(e){return e&&e.__esModule?e:{default:e}}var a=function(){function e(t){(0,o.default)(this,e),this.target=t,this.boundHandlers={}}return(0,i.default)(e,[{key:"_handleEvent",value:function(e){for(var t,r=arguments.length,n=Array(r>1?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];(t=this.target).emit.apply(t,[e].concat(n))}},{key:"reEmit",value:function(e,t){var r=function(t){for(var r=arguments.length,n=Array(r>1?r-1:0),o=1;o<r;o++)n[o-1]=arguments[o];t.apply(void 0,n.concat([e]))},o=!0,i=!1,s=void 0;try{for(var a,u=(0,n.default)(t);!(o=(a=u.next()).done);o=!0){var c=a.value;void 0===this.boundHandlers[c]&&(this.boundHandlers[c]=this._handleEvent.bind(this,c));var l=r.bind(this,this.boundHandlers[c]);e.on(c,l)}}catch(e){i=!0,s=e}finally{try{!o&&u.return&&u.return()}finally{if(i)throw s}}}}]),e}();r.default=a},{"babel-runtime/core-js/get-iterator":69,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93}],3:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.AutoDiscovery=void 0;var n=e("bluebird"),o=f(n),i=f(e("babel-runtime/regenerator")),s=f(e("babel-runtime/core-js/get-iterator")),a=f(e("babel-runtime/core-js/object/keys")),u=f(e("babel-runtime/helpers/createClass")),c=f(e("babel-runtime/helpers/classCallCheck")),l=f(e("./logger")),d=e("url");function f(e){return e&&e.__esModule?e:{default:e}}r.AutoDiscovery=function(){function t(){(0,c.default)(this,t)}var r,f,p,h;return(0,u.default)(t,null,[{key:"fromDiscoveryConfig",value:(h=(0,n.coroutine)(i.default.mark((function e(r){var u,c,d,f,p,h;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(u={"m.homeserver":{state:t.FAIL_ERROR,error:t.ERROR_INVALID,base_url:null},"m.identity_server":{state:t.PROMPT,error:null,base_url:null}},r&&r["m.homeserver"]){e.next=6;break}return l.default.error("No m.homeserver key in config"),u["m.homeserver"].state=t.FAIL_PROMPT,u["m.homeserver"].error=t.ERROR_INVALID,e.abrupt("return",o.default.resolve(u));case 6:if(r["m.homeserver"].base_url){e.next=11;break}return l.default.error("No m.homeserver base_url in config"),u["m.homeserver"].state=t.FAIL_PROMPT,u["m.homeserver"].error=t.ERROR_INVALID_HS_BASE_URL,e.abrupt("return",o.default.resolve(u));case 11:if(c=this._sanitizeWellKnownUrl(r["m.homeserver"].base_url)){e.next=16;break}return l.default.error("Invalid base_url for m.homeserver"),u["m.homeserver"].error=t.ERROR_INVALID_HS_BASE_URL,e.abrupt("return",o.default.resolve(u));case 16:return e.next=18,(0,n.resolve)(this._fetchWellKnownObject(c+"/_matrix/client/versions"));case 18:if((d=e.sent)&&d.raw.versions){e.next=24;break}return l.default.error("Invalid /versions response"),u["m.homeserver"].error=t.ERROR_INVALID_HOMESERVER,u["m.homeserver"].base_url=c,e.abrupt("return",o.default.resolve(u));case 24:if(u["m.homeserver"]={state:t.SUCCESS,error:null,base_url:c},f="",!r["m.identity_server"]){e.next=41;break}if(p={"m.homeserver":{state:t.FAIL_ERROR,error:t.ERROR_INVALID_IS,base_url:u["m.homeserver"].base_url},"m.identity_server":{state:t.FAIL_ERROR,error:t.ERROR_INVALID_IS,base_url:null}},f=this._sanitizeWellKnownUrl(r["m.identity_server"].base_url)){e.next=33;break}return l.default.error("Invalid base_url for m.identity_server"),p["m.identity_server"].error=t.ERROR_INVALID_IS_BASE_URL,e.abrupt("return",o.default.resolve(p));case 33:return e.next=35,(0,n.resolve)(this._fetchWellKnownObject(f+"/_matrix/identity/api/v1"));case 35:if((h=e.sent)&&h.raw&&"SUCCESS"===h.action){e.next=41;break}return l.default.error("Invalid /api/v1 response"),p["m.identity_server"].error=t.ERROR_INVALID_IDENTITY_SERVER,p["m.identity_server"].base_url=f,e.abrupt("return",o.default.resolve(p));case 41:return f&&f.length>0&&(u["m.identity_server"]={state:t.SUCCESS,error:null,base_url:f}),(0,a.default)(r).map((function(e){if("m.homeserver"===e||"m.identity_server"===e){var t=["error","state","base_url"],n=!0,o=!1,i=void 0;try{for(var c,l=(0,s.default)((0,a.default)(r[e]));!(n=(c=l.next()).done);n=!0){var d=c.value;t.includes(d)||(u[e][d]=r[e][d])}}catch(e){o=!0,i=e}finally{try{!n&&l.return&&l.return()}finally{if(o)throw i}}}else u[e]=r[e]})),e.abrupt("return",o.default.resolve(u));case 44:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"findClientConfig",value:(p=(0,n.coroutine)(i.default.mark((function e(r){var s,a;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r&&"string"==typeof r&&0!==r.length){e.next=2;break}throw new Error("'domain' must be a string of non-zero length");case 2:return s={"m.homeserver":{state:t.FAIL_ERROR,error:t.ERROR_INVALID,base_url:null},"m.identity_server":{state:t.PROMPT,error:null,base_url:null}},e.next=5,(0,n.resolve)(this._fetchWellKnownObject("https://"+r+"/.well-known/matrix/client"));case 5:if((a=e.sent)&&"SUCCESS"===a.action){e.next=11;break}return l.default.error("No response or error when parsing .well-known"),a.reason&&l.default.error(a.reason),"IGNORE"===a.action?s["m.homeserver"]={state:t.PROMPT,error:null,base_url:null}:(s["m.homeserver"].state=t.FAIL_PROMPT,s["m.homeserver"].error=t.ERROR_INVALID),e.abrupt("return",o.default.resolve(s));case 11:return e.abrupt("return",t.fromDiscoveryConfig(a.raw));case 12:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"getRawClientConfig",value:(f=(0,n.coroutine)(i.default.mark((function e(t){var r;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t&&"string"==typeof t&&0!==t.length){e.next=2;break}throw new Error("'domain' must be a string of non-zero length");case 2:return e.next=4,(0,n.resolve)(this._fetchWellKnownObject("https://"+t+"/.well-known/matrix/client"));case 4:if(r=e.sent){e.next=7;break}return e.abrupt("return",{});case 7:return e.abrupt("return",r.raw||{});case 8:case"end":return e.stop()}}),e,this)}))),function(e){return f.apply(this,arguments)})},{key:"_sanitizeWellKnownUrl",value:function(e){if(!e)return!1;try{var t=null;try{t=d.URL?new d.URL(e):new URL(e)}catch(r){t=new URL(e)}if(!t||!t.hostname)return!1;if("http:"!==t.protocol&&"https:"!==t.protocol)return!1;var r=t.port?":"+t.port:"",n=t.pathname?t.pathname:"",o=t.protocol+"//"+t.hostname+r+n;return o.endsWith("/")&&(o=o.substring(0,o.length-1)),o}catch(e){return l.default.error(e),!1}}},{key:"_fetchWellKnownObject",value:(r=(0,n.method)((function(r){return new o.default((function(n,o){var i=e("./matrix").getRequest();if(!i)throw new Error("No request library available");i({method:"GET",uri:r,timeout:5e3},(function(e,r,o){if(e||r.statusCode<200||r.statusCode>=300){var i="FAIL_PROMPT",s=(e?e.message:null)||"General failure";return 404===r.statusCode&&(i="IGNORE",s=t.ERROR_MISSING_WELLKNOWN),void n({raw:{},action:i,reason:s,error:e})}try{n({raw:JSON.parse(o),action:"SUCCESS"})}catch(e){var a=t.ERROR_INVALID;"SyntaxError"===e.name&&(a=t.ERROR_INVALID_JSON),n({raw:{},action:"FAIL_PROMPT",reason:a,error:e})}}))}))})),function(e){return r.apply(this,arguments)})},{key:"ERROR_INVALID",get:function(){return"Invalid homeserver discovery response"}},{key:"ERROR_GENERIC_FAILURE",get:function(){return"Failed to get autodiscovery configuration from server"}},{key:"ERROR_INVALID_HS_BASE_URL",get:function(){return"Invalid base_url for m.homeserver"}},{key:"ERROR_INVALID_HOMESERVER",get:function(){return"Homeserver URL does not appear to be a valid Matrix homeserver"}},{key:"ERROR_INVALID_IS_BASE_URL",get:function(){return"Invalid base_url for m.identity_server"}},{key:"ERROR_INVALID_IDENTITY_SERVER",get:function(){return"Identity server URL does not appear to be a valid identity server"}},{key:"ERROR_INVALID_IS",get:function(){return"Invalid identity server discovery response"}},{key:"ERROR_MISSING_WELLKNOWN",get:function(){return"No .well-known JSON file found"}},{key:"ERROR_INVALID_JSON",get:function(){return"Invalid JSON"}},{key:"ALL_ERRORS",get:function(){return[t.ERROR_INVALID,t.ERROR_GENERIC_FAILURE,t.ERROR_INVALID_HS_BASE_URL,t.ERROR_INVALID_HOMESERVER,t.ERROR_INVALID_IS_BASE_URL,t.ERROR_INVALID_IDENTITY_SERVER,t.ERROR_INVALID_IS,t.ERROR_MISSING_WELLKNOWN,t.ERROR_INVALID_JSON]}},{key:"FAIL_ERROR",get:function(){return"FAIL_ERROR"}},{key:"FAIL_PROMPT",get:function(){return"FAIL_PROMPT"}},{key:"PROMPT",get:function(){return"PROMPT"}},{key:"SUCCESS",get:function(){return"SUCCESS"}}]),t}()},{"./logger":37,"./matrix":38,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/object/keys":82,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,"babel-runtime/regenerator":100,bluebird:103,url:276}],4:[function(e,t,r){(function(r){"use strict";var n=d(e("babel-runtime/helpers/typeof")),o=d(e("babel-runtime/core-js/get-iterator")),i=d(e("babel-runtime/core-js/object/assign")),s=d(e("babel-runtime/core-js/object/keys")),a=d(e("babel-runtime/regenerator")),u=e("bluebird"),c=e("./service-types"),l=d(e("./logger"));function d(e){return e&&e.__esModule?e:{default:e}}var f,p,h,v,m,y,_,g,b,k,w=e("./http-api"),E=e("./utils"),S=e("./pushprocessor");function x(e,t){switch(e){case c.SERVICE_TYPES.IS:return t+w.PREFIX_IDENTITY_V2+"/terms";case c.SERVICE_TYPES.IM:return t+"/_matrix/integrations/v1/terms";default:throw new Error("Unsupported service type")}}function R(e){E.checkObjectHasKeys(e,["baseUrl","request"]),this.baseUrl=e.baseUrl,this.idBaseUrl=e.idBaseUrl,this.identityServer=e.identityServer;var t={baseUrl:e.baseUrl,idBaseUrl:e.idBaseUrl,accessToken:e.accessToken,request:e.request,prefix:w.PREFIX_R0,onlyData:!0,extraParams:e.queryParams,localTimeoutMs:e.localTimeoutMs,useAuthorizationHeader:e.useAuthorizationHeader};this._http=new w.MatrixHttpApi(this,t),this._txnCtr=0}R.prototype.getHomeserverUrl=function(){return this.baseUrl},R.prototype.getIdentityServerUrl=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return e&&(this.idBaseUrl.startsWith("http://")||this.idBaseUrl.startsWith("https://"))?this.idBaseUrl.split("://")[1]:this.idBaseUrl},R.prototype.setIdentityServerUrl=function(e){this.idBaseUrl=E.ensureNoTrailingSlash(e),this._http.setIdBaseUrl(this.idBaseUrl)},R.prototype.getAccessToken=function(){return this._http.opts.accessToken||null},R.prototype.isLoggedIn=function(){return void 0!==this._http.opts.accessToken},R.prototype.makeTxnId=function(){return"m"+(new Date).getTime()+"."+this._txnCtr++},R.prototype.isUsernameAvailable=function(e){return this._http.authedRequest(void 0,"GET","/register/available",{username:e}).then((function(e){return e.available}))},R.prototype.register=function(e,t,r,n,o,i,s,a){!0===o?o={email:!0}:null==o&&(o={}),"function"==typeof s&&(a=s,s=void 0),null==n&&(n={}),r&&(n.session=r);var u={auth:n};return null!=e&&(u.username=e),null!=t&&(u.password=t),o.email&&(u.bind_email=!0),o.msisdn&&(u.bind_msisdn=!0),null!=i&&(u.guest_access_token=i),null!=s&&(u.inhibit_login=s),null!=t&&(u.x_show_msisdn=!0),this.registerRequest(u,void 0,a)},R.prototype.registerGuest=function(e,t){return(e=e||{}).body=e.body||{},this.registerRequest(e.body,"guest",t)},R.prototype.registerRequest=function(e,t,r){var n={};return t&&(n.kind=t),this._http.request(r,"POST","/register",n,e)},R.prototype.loginFlows=function(e){return this._http.request(e,"GET","/login")},R.prototype.login=function(e,t,r){var n=this,o={type:e};return E.extend(o,t),this._http.authedRequest((function(e,t){t&&t.access_token&&t.user_id&&(n._http.opts.accessToken=t.access_token,n.credentials={userId:t.user_id}),r&&r(e,t)}),"POST","/login",void 0,o)},R.prototype.loginWithPassword=function(e,t,r){return this.login("m.login.password",{user:e,password:t},r)},R.prototype.loginWithSAML2=function(e,t){return this.login("m.login.saml2",{relay_state:e},t)},R.prototype.getCasLoginUrl=function(e){return this.getSsoLoginUrl(e,"cas")},R.prototype.getSsoLoginUrl=function(e,t){return void 0===t&&(t="sso"),this._http.getUrl("/login/"+t+"/redirect",{redirectUrl:e},w.PREFIX_R0)},R.prototype.loginWithToken=function(e,t){return this.login("m.login.token",{token:e},t)},R.prototype.logout=function(e){return this._http.authedRequest(e,"POST","/logout")},R.prototype.deactivateAccount=function(e,t){if("function"==typeof t)throw new Error("deactivateAccount no longer accepts a callback parameter");var r={};return e&&(r.auth=e),void 0!==t&&(r.erase=t),this._http.authedRequest(void 0,"POST","/account/deactivate",void 0,r)},R.prototype.getFallbackAuthUrl=function(e,t){var r=E.encodeUri("/auth/$loginType/fallback/web",{$loginType:e});return this._http.getUrl(r,{session:t},w.PREFIX_R0)},R.prototype.createRoom=function(e,t){return this._http.authedRequest(t,"POST","/createRoom",void 0,e)},R.prototype.fetchRelations=(f=(0,u.coroutine)(a.default.mark((function e(t,r,n,o,i){var s,c,l,d;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s={},i.from&&(s.from=i.from),c=E.encodeParams(s),l=E.encodeUri("/rooms/$roomId/relations/$eventId/$relationType/$eventType?"+c,{$roomId:t,$eventId:r,$relationType:n,$eventType:o}),e.next=6,(0,u.resolve)(this._http.authedRequest(void 0,"GET",l,null,null,{prefix:w.PREFIX_UNSTABLE}));case 6:return d=e.sent,e.abrupt("return",d);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,o){return f.apply(this,arguments)}),R.prototype.roomState=function(e,t){var r=E.encodeUri("/rooms/$roomId/state",{$roomId:e});return this._http.authedRequest(t,"GET",r)},R.prototype.fetchRoomEvent=function(e,t,r){var n=E.encodeUri("/rooms/$roomId/event/$eventId",{$roomId:e,$eventId:t});return this._http.authedRequest(r,"GET",n)},R.prototype.members=function(e,t,r,n,o){var i={};t&&(i.membership=t),r&&(i.not_membership=r),n&&(i.at=n);var s=E.encodeParams(i),a=E.encodeUri("/rooms/$roomId/members?"+s,{$roomId:e});return this._http.authedRequest(o,"GET",a)},R.prototype.upgradeRoom=function(e,t){var r=E.encodeUri("/rooms/$roomId/upgrade",{$roomId:e});return this._http.authedRequest(void 0,"POST",r,void 0,{new_version:t})},R.prototype.getGroupSummary=function(e){var t=E.encodeUri("/groups/$groupId/summary",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},R.prototype.getGroupProfile=function(e){var t=E.encodeUri("/groups/$groupId/profile",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},R.prototype.setGroupProfile=function(e,t){var r=E.encodeUri("/groups/$groupId/profile",{$groupId:e});return this._http.authedRequest(void 0,"POST",r,void 0,t)},R.prototype.setGroupJoinPolicy=function(e,t){var r=E.encodeUri("/groups/$groupId/settings/m.join_policy",{$groupId:e});return this._http.authedRequest(void 0,"PUT",r,void 0,{"m.join_policy":t})},R.prototype.getGroupUsers=function(e){var t=E.encodeUri("/groups/$groupId/users",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},R.prototype.getGroupInvitedUsers=function(e){var t=E.encodeUri("/groups/$groupId/invited_users",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},R.prototype.getGroupRooms=function(e){var t=E.encodeUri("/groups/$groupId/rooms",{$groupId:e});return this._http.authedRequest(void 0,"GET",t)},R.prototype.inviteUserToGroup=function(e,t){var r=E.encodeUri("/groups/$groupId/admin/users/invite/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"PUT",r,void 0,{})},R.prototype.removeUserFromGroup=function(e,t){var r=E.encodeUri("/groups/$groupId/admin/users/remove/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"PUT",r,void 0,{})},R.prototype.addUserToGroupSummary=function(e,t,r){var n=E.encodeUri(r?"/groups/$groupId/summary/$roleId/users/$userId":"/groups/$groupId/summary/users/$userId",{$groupId:e,$roleId:r,$userId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{})},R.prototype.removeUserFromGroupSummary=function(e,t){var r=E.encodeUri("/groups/$groupId/summary/users/$userId",{$groupId:e,$userId:t});return this._http.authedRequest(void 0,"DELETE",r,void 0,{})},R.prototype.addRoomToGroupSummary=function(e,t,r){var n=E.encodeUri(r?"/groups/$groupId/summary/$categoryId/rooms/$roomId":"/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$categoryId:r,$roomId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{})},R.prototype.removeRoomFromGroupSummary=function(e,t){var r=E.encodeUri("/groups/$groupId/summary/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"DELETE",r,void 0,{})},R.prototype.addRoomToGroup=function(e,t,r){void 0===r&&(r=!0);var n=E.encodeUri("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{"m.visibility":{type:r?"public":"private"}})},R.prototype.updateGroupRoomVisibility=function(e,t,r){var n=E.encodeUri("/groups/$groupId/admin/rooms/$roomId/config/m.visibility",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"PUT",n,void 0,{type:r?"public":"private"})},R.prototype.removeRoomFromGroup=function(e,t){var r=E.encodeUri("/groups/$groupId/admin/rooms/$roomId",{$groupId:e,$roomId:t});return this._http.authedRequest(void 0,"DELETE",r,void 0,{})},R.prototype.acceptGroupInvite=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=E.encodeUri("/groups/$groupId/self/accept_invite",{$groupId:e});return this._http.authedRequest(void 0,"PUT",r,void 0,t||{})},R.prototype.joinGroup=function(e){var t=E.encodeUri("/groups/$groupId/self/join",{$groupId:e});return this._http.authedRequest(void 0,"PUT",t,void 0,{})},R.prototype.leaveGroup=function(e){var t=E.encodeUri("/groups/$groupId/self/leave",{$groupId:e});return this._http.authedRequest(void 0,"PUT",t,void 0,{})},R.prototype.getJoinedGroups=function(){var e=E.encodeUri("/joined_groups");return this._http.authedRequest(void 0,"GET",e)},R.prototype.createGroup=function(e){var t=E.encodeUri("/create_group");return this._http.authedRequest(void 0,"POST",t,void 0,e)},R.prototype.getPublicisedGroups=function(e){var t=E.encodeUri("/publicised_groups");return this._http.authedRequest(void 0,"POST",t,void 0,{user_ids:e})},R.prototype.setGroupPublicity=function(e,t){var r=E.encodeUri("/groups/$groupId/self/update_publicity",{$groupId:e});return this._http.authedRequest(void 0,"PUT",r,void 0,{publicise:t})},R.prototype.getStateEvent=function(e,t,r,n){var o={$roomId:e,$eventType:t,$stateKey:r},i=E.encodeUri("/rooms/$roomId/state/$eventType",o);return void 0!==r&&(i=E.encodeUri(i+"/$stateKey",o)),this._http.authedRequest(n,"GET",i)},R.prototype.sendStateEvent=function(e,t,r,n,o){var i={$roomId:e,$eventType:t,$stateKey:n},s=E.encodeUri("/rooms/$roomId/state/$eventType",i);return void 0!==n&&(s=E.encodeUri(s+"/$stateKey",i)),this._http.authedRequest(o,"PUT",s,void 0,r)},R.prototype.roomInitialSync=function(e,t,r){E.isFunction(t)&&(r=t,t=void 0);var n=E.encodeUri("/rooms/$roomId/initialSync",{$roomId:e});return t||(t=30),this._http.authedRequest(r,"GET",n,{limit:t})},R.prototype.setRoomReadMarkersHttpRequest=function(e,t,r,n){var o=E.encodeUri("/rooms/$roomId/read_markers",{$roomId:e}),i={"m.fully_read":t,"m.read":r,"m.hidden":Boolean(!!n&&n.hidden)};return this._http.authedRequest(void 0,"POST",o,void 0,i)},R.prototype.getJoinedRooms=function(){var e=E.encodeUri("/joined_rooms");return this._http.authedRequest(void 0,"GET",e)},R.prototype.getJoinedRoomMembers=function(e){var t=E.encodeUri("/rooms/$roomId/joined_members",{$roomId:e});return this._http.authedRequest(void 0,"GET",t)},R.prototype.publicRooms=function(e,t){"function"==typeof e&&(t=e,e={}),void 0===e&&(e={});var r={};return e.server&&(r.server=e.server,delete e.server),0===(0,s.default)(e).length&&0===(0,s.default)(r).length?this._http.authedRequest(t,"GET","/publicRooms"):this._http.authedRequest(t,"POST","/publicRooms",r,e)},R.prototype.createAlias=function(e,t,r){var n=E.encodeUri("/directory/room/$alias",{$alias:e}),o={room_id:t};return this._http.authedRequest(r,"PUT",n,void 0,o)},R.prototype.deleteAlias=function(e,t){var r=E.encodeUri("/directory/room/$alias",{$alias:e});return this._http.authedRequest(t,"DELETE",r,void 0,void 0)},R.prototype.getRoomIdForAlias=function(e,t){var r=E.encodeUri("/directory/room/$alias",{$alias:e});return this._http.authedRequest(t,"GET",r)},R.prototype.resolveRoomAlias=function(e,t){var r=E.encodeUri("/directory/room/$alias",{$alias:e});return this._http.request(t,"GET",r)},R.prototype.getRoomDirectoryVisibility=function(e,t){var r=E.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this._http.authedRequest(t,"GET",r)},R.prototype.setRoomDirectoryVisibility=function(e,t,r){var n=E.encodeUri("/directory/list/room/$roomId",{$roomId:e});return this._http.authedRequest(r,"PUT",n,void 0,{visibility:t})},R.prototype.setRoomDirectoryVisibilityAppService=function(e,t,r,n){var o=E.encodeUri("/directory/list/appservice/$networkId/$roomId",{$networkId:e,$roomId:t});return this._http.authedRequest(n,"PUT",o,void 0,{visibility:r})},R.prototype.searchUserDirectory=function(e){var t={search_term:e.term};return void 0!==e.limit&&(t.limit=e.limit),this._http.authedRequest(void 0,"POST","/user_directory/search",void 0,t)},R.prototype.uploadContent=function(e,t){return this._http.uploadContent(e,t)},R.prototype.cancelUpload=function(e){return this._http.cancelUpload(e)},R.prototype.getCurrentUploads=function(){return this._http.getCurrentUploads()},R.prototype.getProfileInfo=function(e,t,r){E.isFunction(t)&&(r=t,t=void 0);var n=t?E.encodeUri("/profile/$userId/$info",{$userId:e,$info:t}):E.encodeUri("/profile/$userId",{$userId:e});return this._http.authedRequest(r,"GET",n)},R.prototype.getThreePids=function(e){return this._http.authedRequest(e,"GET","/account/3pid",void 0,void 0)},R.prototype.addThreePid=function(e,t,r){var n={threePidCreds:e,bind:t};return this._http.authedRequest(r,"POST","/account/3pid",null,n)},R.prototype.addThreePidOnly=(p=(0,u.coroutine)(a.default.mark((function e(t){var r,n;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r="/account/3pid/add",e.next=3,(0,u.resolve)(this.isVersionSupported("r0.6.0"));case 3:if(!e.sent){e.next=7;break}e.t0=w.PREFIX_R0,e.next=8;break;case 7:e.t0=w.PREFIX_UNSTABLE;case 8:return n=e.t0,e.abrupt("return",this._http.authedRequest(void 0,"POST",r,null,t,{prefix:n}));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)}),R.prototype.bindThreePid=(h=(0,u.coroutine)(a.default.mark((function e(t){var r,n;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r="/account/3pid/bind",e.next=3,(0,u.resolve)(this.isVersionSupported("r0.6.0"));case 3:if(!e.sent){e.next=7;break}e.t0=w.PREFIX_R0,e.next=8;break;case 7:e.t0=w.PREFIX_UNSTABLE;case 8:return n=e.t0,e.abrupt("return",this._http.authedRequest(void 0,"POST",r,null,t,{prefix:n}));case 10:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)}),R.prototype.unbindThreePid=(v=(0,u.coroutine)(a.default.mark((function e(t,r){var n,o,i;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n="/account/3pid/unbind",o={medium:t,address:r,id_server:this.getIdentityServerUrl(!0)},e.next=4,(0,u.resolve)(this.isVersionSupported("r0.6.0"));case 4:if(!e.sent){e.next=8;break}e.t0=w.PREFIX_R0,e.next=9;break;case 8:e.t0=w.PREFIX_UNSTABLE;case 9:return i=e.t0,e.abrupt("return",this._http.authedRequest(void 0,"POST",n,null,o,{prefix:i}));case 11:case"end":return e.stop()}}),e,this)}))),function(e,t){return v.apply(this,arguments)}),R.prototype.deleteThreePid=function(e,t){var r={medium:e,address:t};return this._http.authedRequest(void 0,"POST","/account/3pid/delete",null,r)},R.prototype.setPassword=function(e,t,r){var n={auth:e,new_password:t};return this._http.authedRequest(r,"POST","/account/password",null,n)},R.prototype.getDevices=function(){return this._http.authedRequest(void 0,"GET","/devices",void 0,void 0)},R.prototype.setDeviceDetails=function(e,t){var r=E.encodeUri("/devices/$device_id",{$device_id:e});return this._http.authedRequest(void 0,"PUT",r,void 0,t)},R.prototype.deleteDevice=function(e,t){var r=E.encodeUri("/devices/$device_id",{$device_id:e}),n={};return t&&(n.auth=t),this._http.authedRequest(void 0,"DELETE",r,void 0,n)},R.prototype.deleteMultipleDevices=function(e,t){var r={devices:e};t&&(r.auth=t);return this._http.authedRequest(void 0,"POST","/delete_devices",void 0,r)},R.prototype.getPushers=function(e){return this._http.authedRequest(e,"GET","/pushers",void 0,void 0)},R.prototype.setPusher=function(e,t){return this._http.authedRequest(t,"POST","/pushers/set",null,e)},R.prototype.getPushRules=function(e){return this._http.authedRequest(e,"GET","/pushrules/").then((function(e){return S.rewriteDefaultRules(e)}))},R.prototype.addPushRule=function(e,t,r,n,o){var i=E.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this._http.authedRequest(o,"PUT",i,void 0,n)},R.prototype.deletePushRule=function(e,t,r,n){var o=E.encodeUri("/pushrules/"+e+"/$kind/$ruleId",{$kind:t,$ruleId:r});return this._http.authedRequest(n,"DELETE",o)},R.prototype.setPushRuleEnabled=function(e,t,r,n,o){var i=E.encodeUri("/pushrules/"+e+"/$kind/$ruleId/enabled",{$kind:t,$ruleId:r});return this._http.authedRequest(o,"PUT",i,void 0,{enabled:n})},R.prototype.setPushRuleActions=function(e,t,r,n,o){var i=E.encodeUri("/pushrules/"+e+"/$kind/$ruleId/actions",{$kind:t,$ruleId:r});return this._http.authedRequest(o,"PUT",i,void 0,{actions:n})},R.prototype.search=function(e,t){var r={};return e.next_batch&&(r.next_batch=e.next_batch),this._http.authedRequest(t,"POST","/search",r,e.body)},R.prototype.uploadKeysRequest=function(e,t,r){var n=(t=t||{}).device_id,o=void 0;return o=n?E.encodeUri("/keys/upload/$deviceId",{$deviceId:n}):"/keys/upload",this._http.authedRequest(r,"POST",o,void 0,e)},R.prototype.uploadKeySignatures=function(e){return this._http.authedRequest(void 0,"POST","/keys/signatures/upload",void 0,e,{prefix:w.PREFIX_UNSTABLE})},R.prototype.downloadKeysForUsers=function(e,t){if(E.isFunction(t))throw new Error("downloadKeysForUsers no longer accepts a callback parameter");var r={device_keys:{}};return"token"in(t=t||{})&&(r.token=t.token),e.forEach((function(e){r.device_keys[e]={}})),this._http.authedRequest(void 0,"POST","/keys/query",void 0,r)},R.prototype.claimOneTimeKeys=function(e,t){var r={};void 0===t&&(t="signed_curve25519");for(var n=0;n<e.length;++n){var o=e[n][0],i=e[n][1],s=r[o]||{};r[o]=s,s[i]=t}var a={one_time_keys:r};return this._http.authedRequest(void 0,"POST","/keys/claim",void 0,a)},R.prototype.getKeyChanges=function(e,t){var r={from:e,to:t};return this._http.authedRequest(void 0,"GET","/keys/changes",r,void 0)},R.prototype.uploadDeviceSigningKeys=function(e,t){var r=(0,i.default)({},t,{auth:e});return this._http.authedRequest(void 0,"POST","/keys/device_signing/upload",void 0,r,{prefix:w.PREFIX_UNSTABLE})},R.prototype.registerWithIdentityServer=function(e){if(!this.idBaseUrl)throw new Error("No Identity Server base URL set");var t=this.idBaseUrl+w.PREFIX_IDENTITY_V2+"/account/register";return this._http.requestOtherUrl(void 0,"POST",t,null,e)},R.prototype.requestEmailToken=(m=(0,u.coroutine)(a.default.mark((function e(t,r,n,o,i,s){var c,d;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c={client_secret:r,email:t,send_attempt:n,next_link:o},e.prev=1,e.next=4,(0,u.resolve)(this._http.idServerRequest(void 0,"POST","/validate/email/requestToken",c,w.PREFIX_IDENTITY_V2,s));case 4:return d=e.sent,i&&i(null,d),e.abrupt("return",d);case 9:if(e.prev=9,e.t0=e.catch(1),"rejected"!==e.t0.cors&&404!==e.t0.httpStatus){e.next=16;break}return l.default.warn("IS doesn't support v2, falling back to deprecated v1"),e.next=15,(0,u.resolve)(this._http.idServerRequest(i,"POST","/validate/email/requestToken",c,w.PREFIX_IDENTITY_V1));case 15:return e.abrupt("return",e.sent);case 16:throw i&&i(e.t0),e.t0;case 18:case"end":return e.stop()}}),e,this,[[1,9]])}))),function(e,t,r,n,o,i){return m.apply(this,arguments)}),R.prototype.requestMsisdnToken=(y=(0,u.coroutine)(a.default.mark((function e(t,r,n,o,i,s,c){var d,f;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d={client_secret:n,country:t,phone_number:r,send_attempt:o,next_link:i},e.prev=1,e.next=4,(0,u.resolve)(this._http.idServerRequest(void 0,"POST","/validate/msisdn/requestToken",d,w.PREFIX_IDENTITY_V2,c));case 4:return f=e.sent,s&&s(null,f),e.abrupt("return",f);case 9:if(e.prev=9,e.t0=e.catch(1),"rejected"!==e.t0.cors&&404!==e.t0.httpStatus){e.next=16;break}return l.default.warn("IS doesn't support v2, falling back to deprecated v1"),e.next=15,(0,u.resolve)(this._http.idServerRequest(s,"POST","/validate/msisdn/requestToken",d,w.PREFIX_IDENTITY_V1));case 15:return e.abrupt("return",e.sent);case 16:throw s&&s(e.t0),e.t0;case 18:case"end":return e.stop()}}),e,this,[[1,9]])}))),function(e,t,r,n,o,i,s){return y.apply(this,arguments)}),R.prototype.submitMsisdnToken=(_=(0,u.coroutine)(a.default.mark((function e(t,r,n,o){var i;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i={sid:t,client_secret:r,token:n},e.prev=1,e.next=4,(0,u.resolve)(this._http.idServerRequest(void 0,"POST","/validate/msisdn/submitToken",i,w.PREFIX_IDENTITY_V2,o));case 4:return e.abrupt("return",e.sent);case 7:if(e.prev=7,e.t0=e.catch(1),"rejected"!==e.t0.cors&&404!==e.t0.httpStatus){e.next=14;break}return l.default.warn("IS doesn't support v2, falling back to deprecated v1"),e.next=13,(0,u.resolve)(this._http.idServerRequest(void 0,"POST","/validate/msisdn/submitToken",i,w.PREFIX_IDENTITY_V1));case 13:return e.abrupt("return",e.sent);case 14:throw e.t0;case 15:case"end":return e.stop()}}),e,this,[[1,7]])}))),function(e,t,r,n){return _.apply(this,arguments)}),R.prototype.submitMsisdnTokenOtherUrl=function(e,t,r,n){var o={sid:t,client_secret:r,token:n};return this._http.requestOtherUrl(void 0,"POST",e,void 0,o)},R.prototype.getIdentityHashDetails=function(e){return this._http.idServerRequest(void 0,"GET","/hash_details",null,w.PREFIX_IDENTITY_V2,e)},R.prototype.identityHashedLookup=(g=(0,u.coroutine)(a.default.mark((function e(t,n){var i,c,l,d,f,p,h,v,m,y,_,g,b,k;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i={},e.next=3,(0,u.resolve)(this.getIdentityHashDetails(n));case 3:if((c=e.sent)&&c.lookup_pepper&&c.algorithms){e.next=6;break}throw new Error("Unsupported identity server: bad response");case 6:if(i.pepper=c.lookup_pepper,l={},!c.algorithms.includes("sha256")){e.next=14;break}d=new r.Olm.Utility,i.addresses=t.map((function(e){var t=e[0].toLowerCase(),r=e[1].toLowerCase(),n=d.sha256(t+" "+r+" "+i.pepper).replace(/\+/g,"-").replace(/\//g,"_");return l[n]=e[0],n})),i.algorithm="sha256",e.next=20;break;case 14:if(!c.algorithms.includes("none")){e.next=19;break}i.addresses=t.map((function(e){var t=e[0].toLowerCase()+" "+e[1].toLowerCase();return l[t]=e[0],t})),i.algorithm="none",e.next=20;break;case 19:throw new Error("Unsupported identity server: unknown hash algorithm");case 20:return e.next=22,(0,u.resolve)(this._http.idServerRequest(void 0,"POST","/lookup",i,w.PREFIX_IDENTITY_V2,n));case 22:if((f=e.sent)&&f.mappings){e.next=25;break}return e.abrupt("return",[]);case 25:p=[],h=!0,v=!1,m=void 0,e.prev=29,y=(0,o.default)((0,s.default)(f.mappings));case 31:if(h=(_=y.next()).done){e.next=41;break}if(g=_.value,b=f.mappings[g],k=l[g]){e.next=37;break}throw new Error("Identity server returned more results than expected");case 37:p.push({address:k,mxid:b});case 38:h=!0,e.next=31;break;case 41:e.next=47;break;case 43:e.prev=43,e.t0=e.catch(29),v=!0,m=e.t0;case 47:e.prev=47,e.prev=48,!h&&y.return&&y.return();case 50:if(e.prev=50,!v){e.next=53;break}throw m;case 53:return e.finish(50);case 54:return e.finish(47);case 55:return e.abrupt("return",p);case 56:case"end":return e.stop()}}),e,this,[[29,43,47,55],[48,,50,54]])}))),function(e,t){return g.apply(this,arguments)}),R.prototype.lookupThreePid=(b=(0,u.coroutine)(a.default.mark((function e(t,r,n,o){var i,s,c,d;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,u.resolve)(this.identityHashedLookup([[r,t]],o));case 3:if(i=e.sent,s=i.find((function(e){return e.address===r}))){e.next=8;break}return n&&n(null,{}),e.abrupt("return",{});case 8:return c={address:r,medium:t,mxid:s.mxid},n&&n(null,c),e.abrupt("return",c);case 13:if(e.prev=13,e.t0=e.catch(0),"rejected"!==e.t0.cors&&404!==e.t0.httpStatus){e.next=21;break}return d={medium:t,address:r},l.default.warn("IS doesn't support v2, falling back to deprecated v1"),e.next=20,(0,u.resolve)(this._http.idServerRequest(n,"GET","/lookup",d,w.PREFIX_IDENTITY_V1));case 20:return e.abrupt("return",e.sent);case 21:throw n&&n(e.t0,void 0),e.t0;case 23:case"end":return e.stop()}}),e,this,[[0,13]])}))),function(e,t,r,n){return b.apply(this,arguments)}),R.prototype.bulkLookupThreePids=(k=(0,u.coroutine)(a.default.mark((function e(t,r){var n,i,s,c,d,f,p,h,v;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,u.resolve)(this.identityHashedLookup(t.map((function(e){return[e[1],e[0]]})),r));case 3:for(n=e.sent,i=[],s=!0,c=!1,d=void 0,e.prev=8,f=function(){var e=h.value,r=t.find((function(t){return t[1]===e.address}));if(!r)throw new Error("Identity sever returned unexpected results");i.push([r[0],e.address,e.mxid])},p=(0,o.default)(n);!(s=(h=p.next()).done);s=!0)f();e.next=17;break;case 13:e.prev=13,e.t0=e.catch(8),c=!0,d=e.t0;case 17:e.prev=17,e.prev=18,!s&&p.return&&p.return();case 20:if(e.prev=20,!c){e.next=23;break}throw d;case 23:return e.finish(20);case 24:return e.finish(17);case 25:return e.abrupt("return",{threepids:i});case 28:if(e.prev=28,e.t1=e.catch(0),"rejected"!==e.t1.cors&&404!==e.t1.httpStatus){e.next=36;break}return v={threepids:t},l.default.warn("IS doesn't support v2, falling back to deprecated v1"),e.next=35,(0,u.resolve)(this._http.idServerRequest(void 0,"POST","/bulk_lookup",v,w.PREFIX_IDENTITY_V1,r));case 35:return e.abrupt("return",e.sent);case 36:throw e.t1;case 37:case"end":return e.stop()}}),e,this,[[0,28],[8,13,17,25],[18,,20,24]])}))),function(e,t){return k.apply(this,arguments)}),R.prototype.getIdentityAccount=function(e){return this._http.idServerRequest(void 0,"GET","/account",void 0,w.PREFIX_IDENTITY_V2,e)},R.prototype.sendToDevice=function(e,t,r){var n=E.encodeUri("/sendToDevice/$eventType/$txnId",{$eventType:e,$txnId:r||this.makeTxnId()}),o={messages:t};return this._http.authedRequest(void 0,"PUT",n,void 0,o)},R.prototype.getThirdpartyProtocols=function(){return this._http.authedRequest(void 0,"GET","/thirdparty/protocols",void 0,void 0).then((function(e){if(!e||"object"!==(void 0===e?"undefined":(0,n.default)(e)))throw new Error("/thirdparty/protocols did not return an object: "+e);return e}))},R.prototype.getThirdpartyLocation=function(e,t){var r=E.encodeUri("/thirdparty/location/$protocol",{$protocol:e});return this._http.authedRequest(void 0,"GET",r,t,void 0)},R.prototype.getThirdpartyUser=function(e,t){var r=E.encodeUri("/thirdparty/user/$protocol",{$protocol:e});return this._http.authedRequest(void 0,"GET",r,t,void 0)},R.prototype.getTerms=function(e,t){var r=x(e,t);return this._http.requestOtherUrl(void 0,"GET",r)},R.prototype.agreeToTerms=function(e,t,r,n){var o=x(e,t),i={Authorization:"Bearer "+r};return this._http.requestOtherUrl(void 0,"POST",o,null,{user_accepts:n},{headers:i})},R.prototype.reportEvent=function(e,t,r,n){var o=E.encodeUri("/rooms/$roomId/report/$eventId",{$roomId:e,$eventId:t});return this._http.authedRequest(void 0,"POST",o,null,{score:r,reason:n})},t.exports=R}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./http-api":34,"./logger":37,"./pushprocessor":51,"./service-types":55,"./utils":65,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/object/assign":76,"babel-runtime/core-js/object/keys":82,"babel-runtime/helpers/typeof":99,"babel-runtime/regenerator":100,bluebird:103}],5:[function(e,t,r){(function(r){"use strict";var n,o=S(e("babel-runtime/core-js/json/stringify")),i=S(e("babel-runtime/core-js/object/assign")),s=S(e("babel-runtime/core-js/set")),a=S(e("babel-runtime/helpers/typeof")),u=e("bluebird"),c=S(u),l=S(e("babel-runtime/regenerator")),d=S(e("babel-runtime/core-js/object/keys")),f=S(e("babel-runtime/helpers/slicedToArray")),p=S(e("babel-runtime/core-js/object/entries")),h=S(e("babel-runtime/core-js/get-iterator")),v=(n=(0,u.coroutine)(l.default.mark((function e(t,r,n,o,i,s){return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t._crypto){e.next=2;break}throw new Error("End-to-End encryption disabled");case 2:return e.next=4,(0,u.resolve)(t._crypto.setDeviceVerification(r,n,o,i,s));case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,r,o,i,s){return n.apply(this,arguments)}),m=S(e("./ReEmitter")),y=S(e("./crypto/RoomList")),_=S(e("./logger")),g=e("./crypto"),b=S(g),k=e("./crypto/recoverykey"),w=e("./crypto/key_passphrase"),E=e("./randomstring");function S(e){return e&&e.__esModule?e:{default:e}}var x=e("./pushprocessor"),R=e("events").EventEmitter,T=e("url"),I=e("./http-api"),C=e("./models/event").MatrixEvent,O=e("./models/event").EventStatus,j=e("./models/event-timeline"),A=e("./models/search-result"),D=e("./store/stub"),M=e("./webrtc/call"),P=e("./utils"),U=e("./content-repo"),L=e("./filter"),F=e("./sync"),N=e("./base-apis"),K=I.MatrixError,q=e("./content-helpers"),B=e("./crypto/olmlib");c.default.config({warnings:!1});var G,V,$,W,H,z,Y,Q,X,J,Z,ee,te,re,ne,oe=(0,g.isCryptoAvailable)();function ie(e,t,r){var n=[],o=!0,i=!1,s=void 0;try{for(var a,u=(0,h.default)((0,p.default)(e));!(o=(a=u.next()).done);o=!0){var c=(0,f.default)(a.value,2),l=c[0],d=c[1];try{var v=se(d,t);v.session_id=l,v.room_id=r,n.push(v)}catch(e){_.default.log("Failed to decrypt session from backup")}}}catch(e){i=!0,s=e}finally{try{!o&&u.return&&u.return()}finally{if(i)throw s}}return n}function se(e,t){return JSON.parse(t.decrypt(e.session_data.ephemeral,e.session_data.mac,e.session_data.ciphertext))}function ae(e){var t=this;e.baseUrl=P.ensureNoTrailingSlash(e.baseUrl),e.idBaseUrl=P.ensureNoTrailingSlash(e.idBaseUrl),N.call(this,e),this.olmVersion=null,this.reEmitter=new m.default(this),this.store=e.store||new D,this.deviceId=e.deviceId||null;var r=e.userId||null;if(this.credentials={userId:r},this.scheduler=e.scheduler,this.scheduler){var n=this;this.scheduler.setProcessFunction((function(e){var t=n.getRoom(e.getRoomId());return e.status!==O.SENDING&&de(t,e,O.SENDING),fe(n,e)}))}this.clientRunning=!1,this.callList={};var o=M.createNewMatrixCall(this);this._supportsVoip=!1,o&&(!function(e){var t={},r=[],n=!1;function o(r){var n=r.getContent(),o=n.call_id?e.callList[n.call_id]:void 0,i=void 0;if("m.call.invite"===r.getType()){if(r.getSender()===e.credentials.userId)return;if(r.getAge()>n.lifetime)return;if(o&&"ended"===o.state)return;if(o&&_.default.log("WARN: Already have a MatrixCall with id %s but got an invite. Clobbering.",n.call_id),!(o=M.createNewMatrixCall(e,r.getRoomId(),{forceTURN:e._forceTURN})))return void _.default.log("Incoming call ID "+n.call_id+" but this client doesn't support WebRTC");if(o.callId=n.call_id,o._initWithInvite(r),e.callList[o.callId]=o,t[o.callId])for(i=0;i<t[o.callId].length;i++)o._gotRemoteIceCandidate(t[o.callId][i]);var s=void 0,a=P.values(e.callList);for(i=0;i<a.length;++i){var u=a[i];if(o.roomId===u.roomId&&"outbound"===u.direction&&-1!==["wait_local_media","create_offer","invite_sent"].indexOf(u.state)){s=u;break}}s?"wait_local_media"===s.state||"create_offer"===s.state||s.callId>o.callId?(_.default.log("Glare detected: answering incoming call "+o.callId+" and canceling outgoing call "+s.callId),s._replacedBy(o),o.answer()):(_.default.log("Glare detected: rejecting incoming call "+o.callId+" and keeping outgoing call "+s.callId),o.hangup()):e.emit("Call.incoming",o)}else if("m.call.answer"===r.getType()){if(!o)return;r.getSender()===e.credentials.userId?"ringing"===o.state&&o._onAnsweredElsewhere(n):o._receivedAnswer(n)}else if("m.call.candidates"===r.getType()){if(r.getSender()===e.credentials.userId)return;if(o)for(i=0;i<n.candidates.length;i++)o._gotRemoteIceCandidate(n.candidates[i]);else t[n.call_id]||(t[n.call_id]=[]),t[n.call_id]=t[n.call_id].concat(n.candidates)}else"m.call.hangup"===r.getType()&&(o?"ended"!==o.state&&(o._onHangupReceived(n),delete e.callList[n.call_id]):(o=M.createNewMatrixCall(e,r.getRoomId()))&&(o.callId=n.call_id,o._initWithHangup(r),e.callList[n.call_id]=o))}e.on("sync",(function(e){if("PREPARED"===e){n=!0;for(var t={},i=r.length-1;i>=0;i--){var s=r[i];"m.call.answer"!==s.getType()&&"m.call.hangup"!==s.getType()||(t[s.getContent().call_id]="yep")}r.forEach((function(e){t[e.getContent().call_id]||o(e)})),r=[]}})),e.on("event",(function e(t){0===t.getType().indexOf("m.call.")?n?o(t):r.push(t):(t.isBeingDecrypted()||t.isDecryptionFailure())&&t.once("Event.decrypted",e)}))}(this),this._supportsVoip=!0),this._syncingRetry=null,this._syncApi=null,this._peekSync=null,this._isGuest=!1,this._ongoingScrollbacks={},this.timelineSupport=Boolean(e.timelineSupport),this.urlPreviewCache={},this._notifTimelineSet=null,this.unstableClientRelationAggregation=!!e.unstableClientRelationAggregation,this._crypto=null,this._cryptoStore=e.cryptoStore,this._sessionStore=e.sessionStore,this._verificationMethods=e.verificationMethods,this._cryptoCallbacks=e.cryptoCallbacks,this._forceTURN=e.forceTURN||!1,this._fallbackICEServerAllowed=e.fallbackICEServerAllowed||!1,this._roomList=new y.default(this._cryptoStore),this._pushProcessor=new x(this),this._serverVersionsCache=null,this._cachedCapabilities=null,this.on("Event.decrypted",(function(e){var r=e.getPushActions(),n=t._pushProcessor.actionsForEvent(e);e.setPushActions(n);var o=t.getRoom(e.getRoomId());if(o){var i=o.getUnreadNotificationCount("highlight"),s=!(!r||!r.tweaks)&&!!r.tweaks.highlight,a=!(!n||!n.tweaks)&&!!n.tweaks.highlight;if((s!==a||i>0)&&!o.hasUserReadEvent(t.getUserId(),e.getId())){var u=i;a&&!s&&u++,!a&&s&&u--,o.setUnreadNotificationCount("highlight",u),o.getUnreadNotificationCount("total")<u&&o.setUnreadNotificationCount("total",u)}}})),this.on("Room.receipt",(function(e,r){if(r&&t.isRoomEncrypted(r.roomId)){var n=e.getContent();if(!((0,d.default)(n).filter((function(e){return(0,d.default)(n[e]["m.read"]).includes(t.getUserId())})).length>0))return;for(var o=r.getLiveTimeline().getEvents(),i=0,s=o.length-1;s>=0;s--){if(s===o.length-20)return;var a=o[s];if(r.hasUserReadEvent(t.getUserId(),a.getId()))break;i+=t.getPushActionsForEvent(a).tweaks.highlight?1:0}r.setUnreadNotificationCount("highlight",i)}}))}function ue(e,t){var r=!0,n=!1,o=void 0;try{for(var i,s=function(){var t=i.value;e.prototype[t]=function(){var e;if(!this._crypto)throw new Error("End-to-end encryption disabled");return(e=this._crypto)[t].apply(e,arguments)}},a=(0,h.default)(t);!(r=(i=a.next()).done);r=!0)s()}catch(e){n=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(n)throw o}}}function ce(e,t,r,n){return c.default.resolve().then((function(){var n=function(e,t,r){if(t.isEncrypted())return null;if(!e.isRoomEncrypted(t.getRoomId()))return null;if("m.reaction"===t.getType())return null;if(!e._crypto)throw new Error("This room is configured to use encryption, but your client does not support encryption.");return e._crypto.encryptEvent(t,r)}(e,r,t);return n?(de(t,r,O.ENCRYPTING),n.then((function(){de(t,r,O.SENDING)}))):null})).then((function(){var n=void 0;return e.scheduler&&(n=e.scheduler.queueEvent(r))&&e.scheduler.getQueueForEvent(r).length>1&&de(t,r,O.QUEUED),n||(n=fe(e,r)),n})).then((function(e){return t&&t.updatePendingEvent(r,O.SENT,e.event_id),n&&n(null,e),e}),(function(e){_.default.error("Error sending event",e.stack||e);try{r.error=e,de(t,r,O.NOT_SENT),e.event=r,n&&n(e)}catch(t){_.default.error("Exception in error handler!",t.stack||e)}throw e}))}function le(e,t,r){return"m.reaction"===r?r:e.isRoomEncrypted(t)?"m.room.encrypted":r}function de(e,t,r){e?e.updatePendingEvent(t,r):t.setStatus(r)}function fe(e,t){var r=t._txnId?t._txnId:e.makeTxnId(),n={$roomId:t.getRoomId(),$eventType:t.getWireType(),$stateKey:t.getStateKey(),$txnId:r},o=void 0;if(t.isState()){var s="/rooms/$roomId/state/$eventType";t.getStateKey()&&t.getStateKey().length>0&&(s="/rooms/$roomId/state/$eventType/$stateKey"),o=P.encodeUri(s,n)}else if(t.isRedaction()){o=P.encodeUri("/rooms/$roomId/redact/$redactsEventId/$txnId",(0,i.default)({$redactsEventId:t.event.redacts},n))}else o=P.encodeUri("/rooms/$roomId/send/$eventType/$txnId",n);return e._http.authedRequest(void 0,"PUT",o,void 0,t.getWireContent()).then((function(e){return _.default.log("Event sent to "+t.getRoomId()+" with event id "+e.event_id),e}))}function pe(e,t,r,n,o,i){P.isFunction(o)&&(i=o,o=void 0);var s=P.encodeUri("/rooms/$room_id/$membership",{$room_id:t,$membership:n});return e._http.authedRequest(i,"POST",s,void 0,{user_id:r,reason:o})}function he(e,t,r,n){var o=P.encodeUri("/presence/list/$userId",{$userId:t.credentials.userId});return t._http.authedRequest(e,n,o,void 0,r)}function ve(e,t,r){e&&e(r),t.reject(r)}function me(e,t,r){e&&e(null,r),t.resolve(r)}function ye(e){return function(t){var r=new C(t);r.isEncrypted()&&(e.reEmitter.reEmit(r,["Event.decrypted"]),r.attemptDecryption(e._crypto));var n=e.getRoom(r.getRoomId());return n&&n.reEmitter.reEmit(r,["Event.replaced"]),r}}P.inherits(ae,R),P.extend(ae.prototype,N.prototype),ae.prototype.clearStores=function(){if(this._clientRunning)throw new Error("Cannot clear stores while client is running");var e=[];return e.push(this.store.deleteAllData()),this._cryptoStore&&e.push(this._cryptoStore.deleteAllData()),c.default.all(e)},ae.prototype.getUserId=function(){return this.credentials&&this.credentials.userId?this.credentials.userId:null},ae.prototype.getDomain=function(){return this.credentials&&this.credentials.userId?this.credentials.userId.replace(/^.*?:/,""):null},ae.prototype.getUserIdLocalpart=function(){return this.credentials&&this.credentials.userId?this.credentials.userId.split(":")[0].substring(1):null},ae.prototype.getDeviceId=function(){return this.deviceId},ae.prototype.supportsVoip=function(){return this._supportsVoip},ae.prototype.setForceTURN=function(e){this._forceTURN=e},ae.prototype.getSyncState=function(){return this._syncApi?this._syncApi.getSyncState():null},ae.prototype.getSyncStateData=function(){return this._syncApi?this._syncApi.getSyncStateData():null},ae.prototype.isGuest=function(){return this._isGuest},ae.prototype.getScheduler=function(){return this.scheduler},ae.prototype.setGuest=function(e){this._isGuest=e},ae.prototype.retryImmediately=function(){return this._syncApi.retryImmediately()},ae.prototype.getNotifTimelineSet=function(){return this._notifTimelineSet},ae.prototype.setNotifTimelineSet=function(e){this._notifTimelineSet=e},ae.prototype.getCapabilities=function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],r=(new Date).getTime();return this._cachedCapabilities&&!t&&r<this._cachedCapabilities.expiration?(_.default.log("Returning cached capabilities"),c.default.resolve(this._cachedCapabilities.capabilities)):this._http.authedRequest(void 0,"GET","/capabilities").catch((function(e){return _.default.error(e),null})).then((function(t){t||(t={});var n=t.capabilities||{},o=(0,d.default)(n).length?216e5:6e4+5e3*Math.random();return e._cachedCapabilities={capabilities:n,expiration:r+o},_.default.log("Caching capabilities: ",n),n}))},ae.prototype.initCrypto=(0,u.coroutine)(l.default.mark((function e(){var t,r;return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((0,g.isCryptoAvailable)()){e.next=2;break}throw new Error("End-to-end encryption not supported in this js-sdk build: did you remember to load the olm library?");case 2:if(!this._crypto){e.next=5;break}return _.default.warn("Attempt to re-initialise e2e encryption on MatrixClient"),e.abrupt("return");case 5:if(this._sessionStore){e.next=7;break}throw new Error("Cannot enable encryption: no sessionStore provided");case 7:if(this._cryptoStore){e.next=9;break}throw new Error("Cannot enable encryption: no cryptoStore provided");case 9:return _.default.log("Crypto: initialising roomlist..."),e.next=12,(0,u.resolve)(this._roomList.init());case 12:if(null!==(t=this.getUserId())){e.next=15;break}throw new Error("Cannot enable encryption on MatrixClient with unknown userId: ensure userId is passed in createClient().");case 15:if(null!==this.deviceId){e.next=17;break}throw new Error("Cannot enable encryption on MatrixClient with unknown deviceId: ensure deviceId is passed in createClient().");case 17:return r=new b.default(this,this._sessionStore,t,this.deviceId,this.store,this._cryptoStore,this._roomList,this._verificationMethods),this.reEmitter.reEmit(r,["crypto.keyBackupFailed","crypto.keyBackupSessionsRemaining","crypto.roomKeyRequest","crypto.roomKeyRequestCancellation","crypto.warning","crypto.devicesUpdated","deviceVerificationChanged","userVerificationChanged","crossSigning.keysChanged"]),_.default.log("Crypto: initialising crypto object..."),e.next=22,(0,u.resolve)(r.init());case 22:this.olmVersion=b.default.getOlmVersion(),r.registerEventHandlers(this),this._crypto=r;case 25:case"end":return e.stop()}}),e,this)}))),ae.prototype.isCryptoEnabled=function(){return null!==this._crypto},ae.prototype.getDeviceEd25519Key=function(){return this._crypto?this._crypto.getDeviceEd25519Key():null},ae.prototype.uploadKeys=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.uploadDeviceKeys()},ae.prototype.downloadKeys=function(e,t){return null===this._crypto?c.default.reject(new Error("End-to-end encryption disabled")):this._crypto.downloadKeys(e,t)},ae.prototype.getStoredDevicesForUser=(G=(0,u.method)((function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getStoredDevicesForUser(e)||[]})),function(e){return G.apply(this,arguments)}),ae.prototype.getStoredDevice=(V=(0,u.method)((function(e,t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getStoredDevice(e,t)||null})),function(e,t){return V.apply(this,arguments)}),ae.prototype.setDeviceVerified=function(e,t,r){void 0===r&&(r=!0);var n=v(this,e,t,r,null);return e==this.credentials.userId&&this._crypto.checkKeyBackup(),n},ae.prototype.setDeviceBlocked=function(e,t,r){return void 0===r&&(r=!0),v(this,e,t,null,r)},ae.prototype.setDeviceKnown=function(e,t,r){return void 0===r&&(r=!0),v(this,e,t,null,null,r)},ae.prototype.requestVerificationDM=function(e,t,r){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.requestVerificationDM(e,t,r)},ae.prototype.acceptVerificationDM=function(e,t){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.acceptVerificationDM(e,t)},ae.prototype.requestVerification=function(e,t,r){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.requestVerification(e,t,r)},ae.prototype.beginKeyVerification=function(e,t,r){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.beginKeyVerification(e,t,r)},ae.prototype.setGlobalBlacklistUnverifiedDevices=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.setGlobalBlacklistUnverifiedDevices(e)},ae.prototype.getGlobalBlacklistUnverifiedDevices=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.getGlobalBlacklistUnverifiedDevices()},ue(ae,["doesCrossSigningHaveKeys","resetCrossSigningKeys","getCrossSigningId","getStoredCrossSigningForUser","checkUserTrust","checkDeviceTrust","checkOwnCrossSigningTrust","checkPrivateKey"]),ae.prototype.checkEventSenderTrust=($=(0,u.coroutine)(l.default.mark((function e(t){var r;return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.resolve)(this.getEventSenderDeviceInfo(t));case 2:if(r=e.sent){e.next=5;break}return e.abrupt("return",0);case 5:return e.next=7,(0,u.resolve)(this._crypto.checkDeviceTrust(t.getSender(),r.deviceId));case 7:return e.abrupt("return",e.sent);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return $.apply(this,arguments)}),ue(ae,["addSecretKey","storeSecret","getSecret","isSecretStored","requestSecret","getDefaultSecretStorageKeyId","setDefaultSecretStorageKeyId"]),ae.prototype.getEventSenderDeviceInfo=(W=(0,u.method)((function(e){return this._crypto?this._crypto.getEventSenderDeviceInfo(e):null})),function(e){return W.apply(this,arguments)}),ae.prototype.isEventSenderVerified=(H=(0,u.coroutine)(l.default.mark((function e(t){var r;return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.resolve)(this.getEventSenderDeviceInfo(t));case 2:if(r=e.sent){e.next=5;break}return e.abrupt("return",!1);case 5:return e.abrupt("return",r.isVerified());case 6:case"end":return e.stop()}}),e,this)}))),function(e){return H.apply(this,arguments)}),ae.prototype.cancelAndResendEventRoomKeyRequest=function(e){return e.cancelAndResendKeyRequest(this._crypto,this.getUserId())},ae.prototype.setRoomEncryption=function(e,t){if(!this._crypto)throw new Error("End-to-End encryption disabled");return this._crypto.setRoomEncryption(e,t)},ae.prototype.isRoomEncrypted=function(e){var t=this.getRoom(e);return!!t&&(!!t.currentState.getStateEvents("m.room.encryption","")||this._roomList.isRoomEncrypted(e))},ae.prototype.forceDiscardSession=function(e){if(!this._crypto)throw new Error("End-to-End encryption disabled");this._crypto.forceDiscardSession(e)},ae.prototype.exportRoomKeys=function(){return this._crypto?this._crypto.exportRoomKeys():c.default.reject(new Error("End-to-end encryption disabled"))},ae.prototype.importRoomKeys=function(e){if(!this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.importRoomKeys(e)},ae.prototype.checkKeyBackup=function(){return this._crypto.checkKeyBackup()},ae.prototype.getKeyBackupVersion=function(){return this._http.authedRequest(void 0,"GET","/room_keys/version",void 0,void 0,{prefix:I.PREFIX_UNSTABLE}).then((function(e){if(e.algorithm!==B.MEGOLM_BACKUP_ALGORITHM){var t="Unknown backup algorithm: "+e.algorithm;return c.default.reject(t)}if("object"===(0,a.default)(e.auth_data)&&e.auth_data.public_key)return e;return c.default.reject("Invalid backup data returned")})).catch((function(e){if("M_NOT_FOUND"===e.errcode)return null;throw e}))},ae.prototype.isKeyBackupTrusted=function(e){return this._crypto.isKeyBackupTrusted(e)},ae.prototype.getKeyBackupEnabled=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return Boolean(this._crypto.backupKey)},ae.prototype.enableKeyBackup=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo=e,this._crypto.backupKey&&this._crypto.backupKey.free(),this._crypto.backupKey=new r.Olm.PkEncryption,this._crypto.backupKey.set_recipient_key(e.auth_data.public_key),this.emit("crypto.keyBackupStatus",!0),this._crypto.scheduleKeyBackupSend()},ae.prototype.disableKeyBackup=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo=null,this._crypto.backupKey&&this._crypto.backupKey.free(),this._crypto.backupKey=null,this.emit("crypto.keyBackupStatus",!1)},ae.prototype.prepareKeyBackupVersion=(z=(0,u.coroutine)(l.default.mark((function e(t){var n,o,i,s;return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==this._crypto){e.next=2;break}throw new Error("End-to-end encryption disabled");case 2:if(n=new r.Olm.PkDecryption,e.prev=3,o=void 0,i={},!t){e.next=15;break}return e.next=9,(0,u.resolve)((0,w.keyFromPassphrase)(t));case 9:s=e.sent,o=n.init_with_private_key(s.key),i.private_key_salt=s.salt,i.private_key_iterations=s.iterations,e.next=16;break;case 15:o=n.generate_key();case 16:return i.public_key=o,e.abrupt("return",{algorithm:B.MEGOLM_BACKUP_ALGORITHM,auth_data:i,recovery_key:(0,k.encodeRecoveryKey)(n.get_private_key())});case 18:return e.prev=18,n.free(),e.finish(18);case 21:case"end":return e.stop()}}),e,this,[[3,,18,21]])}))),function(e){return z.apply(this,arguments)}),ae.prototype.createKeyBackupVersion=(Y=(0,u.coroutine)(l.default.mark((function e(t){var r,n;return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==this._crypto){e.next=2;break}throw new Error("End-to-end encryption disabled");case 2:return r={algorithm:t.algorithm,auth_data:t.auth_data},e.next=5,(0,u.resolve)(this._crypto._signObject(r.auth_data));case 5:if(!this._crypto._crossSigningInfo.getId()){e.next=8;break}return e.next=8,(0,u.resolve)(this._crypto._crossSigningInfo.signObject(r.auth_data,"master"));case 8:return e.next=10,(0,u.resolve)(this._http.authedRequest(void 0,"POST","/room_keys/version",void 0,r,{prefix:I.PREFIX_UNSTABLE}));case 10:return n=e.sent,this.enableKeyBackup({algorithm:t.algorithm,auth_data:t.auth_data,version:n.version}),e.abrupt("return",n);case 13:case"end":return e.stop()}}),e,this)}))),function(e){return Y.apply(this,arguments)}),ae.prototype.deleteKeyBackupVersion=function(e){if(null===this._crypto)throw new Error("End-to-end encryption disabled");this._crypto.backupInfo&&this._crypto.backupInfo.version===e&&this.disableKeyBackup();var t=P.encodeUri("/room_keys/version/$version",{$version:e});return this._http.authedRequest(void 0,"DELETE",t,void 0,void 0,{prefix:I.PREFIX_UNSTABLE})},ae.prototype._makeKeyBackupPath=function(e,t,r){return{path:void 0!==t?P.encodeUri("/room_keys/keys/$roomId/$sessionId",{$roomId:e,$sessionId:t}):void 0!==e?P.encodeUri("/room_keys/keys/$roomId",{$roomId:e}):"/room_keys/keys",queryData:void 0===r?void 0:{version:r}}},ae.prototype.sendKeyBackup=function(e,t,r,n){if(null===this._crypto)throw new Error("End-to-end encryption disabled");var o=this._makeKeyBackupPath(e,t,r);return this._http.authedRequest(void 0,"PUT",o.path,o.queryData,n,{prefix:I.PREFIX_UNSTABLE})},ae.prototype.scheduleAllGroupSessionsForBackup=(0,u.coroutine)(l.default.mark((function e(){return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==this._crypto){e.next=2;break}throw new Error("End-to-end encryption disabled");case 2:return e.next=4,(0,u.resolve)(this._crypto.scheduleAllGroupSessionsForBackup());case 4:case"end":return e.stop()}}),e,this)}))),ae.prototype.flagAllGroupSessionsForBackup=function(){if(null===this._crypto)throw new Error("End-to-end encryption disabled");return this._crypto.flagAllGroupSessionsForBackup()},ae.prototype.isValidRecoveryKey=function(e){try{return(0,k.decodeRecoveryKey)(e),!0}catch(e){return!1}},ae.RESTORE_BACKUP_ERROR_BAD_KEY="RESTORE_BACKUP_ERROR_BAD_KEY",ae.prototype.restoreKeyBackupWithPassword=(Q=(0,u.coroutine)(l.default.mark((function e(t,r,n,o){var i;return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.resolve)((0,w.keyFromAuthData)(o.auth_data,t));case 2:return i=e.sent,e.abrupt("return",this._restoreKeyBackup(i,r,n,o));case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return Q.apply(this,arguments)}),ae.prototype.restoreKeyBackupWithRecoveryKey=function(e,t,r,n){var o=(0,k.decodeRecoveryKey)(e);return this._restoreKeyBackup(o,t,r,n)},ae.prototype._restoreKeyBackup=function(e,t,n,o){var i=this;if(null===this._crypto)throw new Error("End-to-end encryption disabled");var s=0,a=[],u=this._makeKeyBackupPath(t,n,o.version),l=new r.Olm.PkDecryption,v=void 0;try{v=l.init_with_private_key(e)}catch(e){throw l.free(),e}return v!==o.auth_data.public_key?c.default.reject({errcode:ae.RESTORE_BACKUP_ERROR_BAD_KEY}):this._http.authedRequest(void 0,"GET",u.path,u.queryData,void 0,{prefix:I.PREFIX_UNSTABLE}).then((function(e){if(e.rooms){var r=!0,o=!1,u=void 0;try{for(var c,v=(0,h.default)((0,p.default)(e.rooms));!(r=(c=v.next()).done);r=!0){var m=(0,f.default)(c.value,2),y=m[0],g=m[1];if(g.sessions){s+=(0,d.default)(g.sessions).length;var b=ie(g.sessions,l,y),k=!0,w=!1,E=void 0;try{for(var S,x=(0,h.default)(b);!(k=(S=x.next()).done);k=!0){var R=S.value;R.room_id=y,a.push(R)}}catch(e){w=!0,E=e}finally{try{!k&&x.return&&x.return()}finally{if(w)throw E}}}}}catch(e){o=!0,u=e}finally{try{!r&&v.return&&v.return()}finally{if(o)throw u}}}else if(e.sessions)s=(0,d.default)(e.sessions).length,a=ie(e.sessions,l,t);else{s=1;try{var T=se(e,l);T.room_id=t,T.session_id=n,a.push(T)}catch(e){_.default.log("Failed to decrypt session from backup")}}return i.importRoomKeys(a)})).then((function(){return i._crypto.setTrustedBackupPubKey(v)})).then((function(){return{total:s,imported:a.length}})).finally((function(){l.free()}))},ae.prototype.deleteKeysFromBackup=function(e,t,r){if(null===this._crypto)throw new Error("End-to-end encryption disabled");var n=this._makeKeyBackupPath(e,t,r);return this._http.authedRequest(void 0,"DELETE",n.path,n.queryData,void 0,{prefix:I.PREFIX_UNSTABLE})},ae.prototype.getGroup=function(e){return this.store.getGroup(e)},ae.prototype.getGroups=function(){return this.store.getGroups()},ae.prototype.getMediaConfig=function(e){return this._http.authedRequest(e,"GET","/config",void 0,void 0,{prefix:I.PREFIX_MEDIA_R0})},ae.prototype.getRoom=function(e){return this.store.getRoom(e)},ae.prototype.getRooms=function(){return this.store.getRooms()},ae.prototype.getVisibleRooms=function(){var e=this.store.getRooms(),t=new s.default,r=!0,n=!1,o=void 0;try{for(var i,a=(0,h.default)(e);!(r=(i=a.next()).done);r=!0){var u=i.value.currentState.getStateEvents("m.room.create","");if(u){var c=u.getContent().predecessor;c&&c.room_id&&t.add(c.room_id)}}}catch(e){n=!0,o=e}finally{try{!r&&a.return&&a.return()}finally{if(n)throw o}}return e.filter((function(e){return!e.currentState.getStateEvents("m.room.tombstone","")||!t.has(e.roomId)}))},ae.prototype.getUser=function(e){return this.store.getUser(e)},ae.prototype.getUsers=function(){return this.store.getUsers()},ae.prototype.setAccountData=function(e,t,r){var n=P.encodeUri("/user/$userId/account_data/$type",{$userId:this.credentials.userId,$type:e});return this._http.authedRequest(r,"PUT",n,void 0,t)},ae.prototype.getAccountData=function(e){return this.store.getAccountData(e)},ae.prototype.getIgnoredUsers=function(){var e=this.getAccountData("m.ignored_user_list");return e&&e.getContent()&&e.getContent().ignored_users?(0,d.default)(e.getContent().ignored_users):[]},ae.prototype.setIgnoredUsers=function(e,t){var r={ignored_users:{}};return e.map((function(e){return r.ignored_users[e]={}})),this.setAccountData("m.ignored_user_list",r,t)},ae.prototype.isUserIgnored=function(e){return-1!==this.getIgnoredUsers().indexOf(e)},ae.prototype.joinRoom=function(e,t,r){if(P.isFunction(t))throw new Error("Expected 'opts' object, got function.");void 0===(t=t||{}).syncRoom&&(t.syncRoom=!0);var n=this.getRoom(e);if(n&&n.hasMembershipState(this.credentials.userId,"join"))return c.default.resolve(n);var o=c.default.resolve();t.inviteSignUrl&&(o=this._http.requestOtherUrl(void 0,"POST",t.inviteSignUrl,{mxid:this.credentials.userId}));var i={};t.viaServers&&(i.server_name=t.viaServers);var s={qsStringifyOptions:{arrayFormat:"repeat"}},a=c.default.defer(),u=this;return o.then((function(t){var r={};t&&(r.third_party_signed=t);var n=P.encodeUri("/join/$roomid",{$roomid:e});return u._http.authedRequest(void 0,"POST",n,i,r,s)})).then((function(e){var r=e.room_id,n=new F(u,u._clientOpts).createRoom(r);return t.syncRoom,c.default.resolve(n)})).done((function(e){me(r,a,e)}),(function(e){ve(r,a,e)})),a.promise},ae.prototype.resendEvent=function(e,t){return de(t,e,O.SENDING),ce(this,t,e)},ae.prototype.cancelPendingEvent=function(e){if([O.QUEUED,O.NOT_SENT].indexOf(e.status)<0)throw new Error("cannot cancel an event with status "+e.status);this.scheduler&&this.scheduler.removeEventFromQueue(e),de(this.getRoom(e.getRoomId()),e,O.CANCELLED)},ae.prototype.setRoomName=function(e,t,r){return this.sendStateEvent(e,"m.room.name",{name:t},void 0,r)},ae.prototype.setRoomTopic=function(e,t,r){return this.sendStateEvent(e,"m.room.topic",{topic:t},void 0,r)},ae.prototype.getRoomTags=function(e,t){var r=P.encodeUri("/user/$userId/rooms/$roomId/tags/",{$userId:this.credentials.userId,$roomId:e});return this._http.authedRequest(t,"GET",r,void 0)},ae.prototype.setRoomTag=function(e,t,r,n){var o=P.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this._http.authedRequest(n,"PUT",o,void 0,r)},ae.prototype.deleteRoomTag=function(e,t,r){var n=P.encodeUri("/user/$userId/rooms/$roomId/tags/$tag",{$userId:this.credentials.userId,$roomId:e,$tag:t});return this._http.authedRequest(r,"DELETE",n,void 0,void 0)},ae.prototype.setRoomAccountData=function(e,t,r,n){var o=P.encodeUri("/user/$userId/rooms/$roomId/account_data/$type",{$userId:this.credentials.userId,$roomId:e,$type:t});return this._http.authedRequest(n,"PUT",o,void 0,r)},ae.prototype.setPowerLevel=function(e,t,r,n,o){var i={users:{}};n&&"m.room.power_levels"===n.getType()&&(i=P.deepCopy(n.getContent())),i.users[t]=r;var s=P.encodeUri("/rooms/$roomId/state/m.room.power_levels",{$roomId:e});return this._http.authedRequest(o,"PUT",s,void 0,i)},ae.prototype.sendEvent=function(e,t,r,n,o){return this._sendCompleteEvent(e,{type:t,content:r},n,o)},ae.prototype._sendCompleteEvent=function(e,t,r,n){P.isFunction(r)&&(n=r,r=void 0),r||(r=this.makeTxnId());var o=new C((0,i.default)(t,{event_id:"~"+e+":"+r,user_id:this.credentials.userId,room_id:e,origin_server_ts:(new Date).getTime()})),s=this.getRoom(e),a=o.getAssociatedId();if(a&&a.startsWith("~")){var u=s.getPendingEvents().find((function(e){return e.getId()===a}));u.once("Event.localEventIdReplaced",(function(){o.updateAssociatedId(u.getId())}))}var l=o.getType();return _.default.log("sendEvent of type "+l+" in "+e+" with txnId "+r),o._txnId=r,o.setStatus(O.SENDING),s&&s.addPendingEvent(o,r),o.status===O.NOT_SENT?c.default.reject(new Error("Event blocked by other events not yet sent")):ce(this,s,o,n)},ae.prototype.redactEvent=function(e,t,r,n){return this._sendCompleteEvent(e,{type:"m.room.redaction",content:{},redacts:t},r,n)},ae.prototype.sendMessage=function(e,t,r,n){return P.isFunction(r)&&(n=r,r=void 0),this.sendEvent(e,"m.room.message",t,r,n)},ae.prototype.sendTextMessage=function(e,t,r,n){var o=q.makeTextMessage(t);return this.sendMessage(e,o,r,n)},ae.prototype.sendNotice=function(e,t,r,n){var o=q.makeNotice(t);return this.sendMessage(e,o,r,n)},ae.prototype.sendEmoteMessage=function(e,t,r,n){var o=q.makeEmoteMessage(t);return this.sendMessage(e,o,r,n)},ae.prototype.sendImageMessage=function(e,t,r,n,o){P.isFunction(n)&&(o=n,n=void 0),n||(n="Image");var i={msgtype:"m.image",url:t,info:r,body:n};return this.sendMessage(e,i,o)},ae.prototype.sendStickerMessage=function(e,t,r,n,o){P.isFunction(n)&&(o=n,n=void 0),n||(n="Sticker");var i={url:t,info:r,body:n};return this.sendEvent(e,"m.sticker",i,o,void 0)},ae.prototype.sendHtmlMessage=function(e,t,r,n){var o=q.makeHtmlMessage(t,r);return this.sendMessage(e,o,n)},ae.prototype.sendHtmlNotice=function(e,t,r,n){var o=q.makeHtmlNotice(t,r);return this.sendMessage(e,o,n)},ae.prototype.sendHtmlEmote=function(e,t,r,n){var o=q.makeHtmlEmote(t,r);return this.sendMessage(e,o,n)},ae.prototype.sendReceipt=function(e,t,r,n){if("function"==typeof r&&(n=r,r={}),this.isGuest())return c.default.resolve({});var o=P.encodeUri("/rooms/$roomId/receipt/$receiptType/$eventId",{$roomId:e.getRoomId(),$receiptType:t,$eventId:e.getId()}),i=this._http.authedRequest(n,"POST",o,void 0,r||{}),s=this.getRoom(e.getRoomId());return s&&s._addLocalEchoReceipt(this.credentials.userId,e,t),i},ae.prototype.sendReadReceipt=(X=(0,u.method)((function(e,t,r){"function"==typeof t&&(r=t,t={}),t||(t={});var n=e.getId(),o=this.getRoom(e.getRoomId());if(o&&o.hasPendingEvent(n))throw new Error("Cannot set read receipt to a pending event ("+n+")");var i={"m.hidden":Boolean(t.hidden)};return this.sendReceipt(e,"m.read",i,r)})),function(e,t,r){return X.apply(this,arguments)}),ae.prototype.setRoomReadMarkers=(J=(0,u.method)((function(e,t,r,n){var o=this.getRoom(e);if(o&&o.hasPendingEvent(t))throw new Error("Cannot set read marker to a pending event ("+t+")");var i=void 0;if(r){if(i=r.getId(),o&&o.hasPendingEvent(i))throw new Error("Cannot set read receipt to a pending event ("+i+")");o&&o._addLocalEchoReceipt(this.credentials.userId,r,"m.read")}return this.setRoomReadMarkersHttpRequest(e,t,i,n)})),function(e,t,r,n){return J.apply(this,arguments)}),ae.prototype.getUrlPreview=function(e,t,r){var n=t+"_"+e,o=this.urlPreviewCache[n];if(o)return c.default.resolve(o);var i=this;return this._http.authedRequest(r,"GET","/preview_url",{url:e,ts:t},void 0,{prefix:I.PREFIX_MEDIA_R0}).then((function(e){return i.urlPreviewCache[n]=e,e}))},ae.prototype.sendTyping=function(e,t,r,n){if(this.isGuest())return c.default.resolve({});var o=P.encodeUri("/rooms/$roomId/typing/$userId",{$roomId:e,$userId:this.credentials.userId}),i={typing:t};return t&&(i.timeout=r||2e4),this._http.authedRequest(n,"PUT",o,void 0,i)},ae.prototype.getRoomUpgradeHistory=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=this.getRoom(e);if(!r)return[];for(var n=[r],o=r.currentState.getStateEvents("m.room.create","");o;){_.default.log("Looking at "+o.getId());var i=o.getContent().predecessor;if(!i||!i.room_id)break;_.default.log("Looking at predecessor "+i.room_id);var a=this.getRoom(i.room_id);if(!a)break;if(t){var u=a.currentState.getStateEvents("m.room.tombstone","");if(!u||u.getContent().replacement_room!==a.roomId)break}n.splice(0,0,a),o=a.currentState.getStateEvents("m.room.create","")}for(var c=r.currentState.getStateEvents("m.room.tombstone","");c;){var l=this.getRoom(c.getContent().replacement_room);if(!l)break;if(l.roomId===r.roomId)break;if(t){if(!(o=l.currentState.getStateEvents("m.room.create",""))||!o.getContent().predecessor)break;var d=o.getContent().predecessor;if(d.room_id!==r.roomId)break}n.push(l);var f=new s.default(n.map((function(e){return e.roomId})));if(f.size<n.length)return n.slice(0,n.length-1);c=(r=l).currentState.getStateEvents("m.room.tombstone","")}return n},ae.prototype.invite=function(e,t,r){return pe(this,e,t,"invite",void 0,r)},ae.prototype.inviteByEmail=function(e,t,r){return this.inviteByThreePid(e,"email",t,r)},ae.prototype.inviteByThreePid=(Z=(0,u.coroutine)(l.default.mark((function e(t,r,n,o){var i,s,a,d;return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=P.encodeUri("/rooms/$roomId/invite",{$roomId:t}),s=this.getIdentityServerUrl(!0)){e.next=4;break}return e.abrupt("return",c.default.reject(new K({error:"No supplied identity server URL",errcode:"ORG.MATRIX.JSSDK_MISSING_PARAM"})));case 4:if(a={id_server:s,medium:r,address:n},e.t0=this.identityServer&&this.identityServer.getAccessToken,!e.t0){e.next=10;break}return e.next=9,(0,u.resolve)(this.doesServerAcceptIdentityAccessToken());case 9:e.t0=e.sent;case 10:if(!e.t0){e.next=15;break}return e.next=13,(0,u.resolve)(this.identityServer.getAccessToken());case 13:(d=e.sent)&&(a.id_access_token=d);case 15:return e.abrupt("return",this._http.authedRequest(o,"POST",i,void 0,a));case 16:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return Z.apply(this,arguments)}),ae.prototype.leave=function(e,t){return pe(this,e,void 0,"leave",void 0,t)},ae.prototype.leaveRoomChain=function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n=this.getRoomUpgradeHistory(e),o=n;if(!r){o=[];var i=!0,s=!1,a=void 0;try{for(var u,l=(0,h.default)(n);!(i=(u=l.next()).done);i=!0){var d=u.value;if(o.push(d),d.roomId===e)break}}catch(e){s=!0,a=e}finally{try{!i&&l.return&&l.return()}finally{if(s)throw a}}}var f={},p=[],v=function(e){return t.leave(e).then((function(){f[e]=null})).catch((function(t){return f[e]=t,null}))},m=!0,y=!1,_=void 0;try{for(var g,b=(0,h.default)(o);!(m=(g=b.next()).done);m=!0){var k=g.value;p.push(v(k.roomId))}}catch(e){y=!0,_=e}finally{try{!m&&b.return&&b.return()}finally{if(y)throw _}}return c.default.all(p).then((function(){return f}))},ae.prototype.ban=function(e,t,r,n){return pe(this,e,t,"ban",r,n)},ae.prototype.forget=function(e,t,r){void 0===t&&(t=!0);var n=pe(this,e,void 0,"forget",void 0,r);if(!t)return n;var o=this;return n.then((function(t){return o.store.removeRoom(e),o.emit("deleteRoom",e),t}))},ae.prototype.unban=function(e,t,r){var n=P.encodeUri("/rooms/$roomId/unban",{$roomId:e}),o={user_id:t};return this._http.authedRequest(r,"POST",n,void 0,o)},ae.prototype.kick=function(e,t,r,n){return function(e,t,r,n,o,i){P.isFunction(o)&&(i=o,o=void 0);var s=P.encodeUri("/rooms/$roomId/state/m.room.member/$userId",{$roomId:t,$userId:r});return e._http.authedRequest(i,"PUT",s,void 0,{membership:n,reason:o})}(this,e,t,"leave",r,n)},ae.prototype.getPushActionsForEvent=function(e){return e.getPushActions()||e.setPushActions(this._pushProcessor.actionsForEvent(e)),e.getPushActions()},ae.prototype.setProfileInfo=function(e,t,r){var n=P.encodeUri("/profile/$userId/$info",{$userId:this.credentials.userId,$info:e});return this._http.authedRequest(r,"PUT",n,void 0,t)},ae.prototype.setDisplayName=function(e,t){return this.setProfileInfo("displayname",{displayname:e},t)},ae.prototype.setAvatarUrl=function(e,t){return this.setProfileInfo("avatar_url",{avatar_url:e},t)},ae.prototype.mxcUrlToHttp=function(e,t,r,n,o){return U.getHttpUriForMxc(this.baseUrl,e,t,r,n,o)},ae.prototype._unstable_setStatusMessage=function(e){var t=this,r="im.vector.user_status";return c.default.all(this.getRooms().map((function(n){var o="join"===n.getMyMembership(),i=2===n.getInvitedAndJoinedMemberCount();return o&&i&&n.currentState.mayClientSendStateEvent(r,t)?t.sendStateEvent(n.roomId,r,{status:e},t.getUserId()):c.default.resolve()})))},ae.prototype.setPresence=function(e,t){var r=P.encodeUri("/presence/$userId/status",{$userId:this.credentials.userId});"string"==typeof e&&(e={presence:e});if(-1==["offline","online","unavailable"].indexOf(e.presence))throw new Error("Bad presence value: "+e.presence);return this._http.authedRequest(t,"PUT",r,void 0,e)},ae.prototype.getPresenceList=function(e){return he(e,this,void 0,"GET")},ae.prototype.inviteToPresenceList=function(e,t){return he(e,this,{invite:t},"POST")},ae.prototype.dropFromPresenceList=function(e,t){return he(e,this,{drop:t},"POST")},ae.prototype.scrollback=function(e,t,r){P.isFunction(t)&&(r=t,t=void 0),t=t||30;var n=0,o=this._ongoingScrollbacks[e.roomId]||{};if(o.promise)return o.promise;if(o.errorTs){var i=Date.now()-o.errorTs;n=Math.max(3e3-i,0)}if(null===e.oldState.paginationToken)return c.default.resolve(e);var s=this.store.scrollback(e,t).length;if(s===t)return c.default.resolve(e);t-=s;var a=c.default.defer();o={promise:a.promise,errorTs:null};var u=this;return c.default.delay(n).then((function(){return u._createMessagesRequest(e.roomId,e.oldState.paginationToken,t,"b")})).done((function(t){var n=P.map(t.chunk,ye(u));if(t.state){var o=P.map(t.state,ye(u));e.currentState.setUnknownStateEvents(o)}e.addEventsToTimeline(n,!0,e.getLiveTimeline()),e.oldState.paginationToken=t.end,0===t.chunk.length&&(e.oldState.paginationToken=null),u.store.storeEvents(e,n,t.end,!0),u._ongoingScrollbacks[e.roomId]=null,me(r,a,e)}),(function(t){u._ongoingScrollbacks[e.roomId]={errorTs:Date.now()},ve(r,a,t)})),this._ongoingScrollbacks[e.roomId]=o,a.promise},ae.prototype.getEventTimeline=function(e,t){if(!this.timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");if(e.getTimelineForEvent(t))return c.default.resolve(e.getTimelineForEvent(t));var r=P.encodeUri("/rooms/$roomId/context/$eventId",{$roomId:e.room.roomId,$eventId:t}),n=void 0;this._clientOpts.lazyLoadMembers&&(n={filter:(0,o.default)(L.LAZY_LOADING_MESSAGES_FILTER)});var i=this;return i._http.authedRequest(void 0,"GET",r,n).then((function(r){if(!r.event)throw new Error("'event' not in '/context' result - homeserver too old?");if(e.getTimelineForEvent(t))return e.getTimelineForEvent(t);r.events_after.reverse();var n=r.events_after.concat([r.event]).concat(r.events_before),o=P.map(n,i.getEventMapper()),s=e.getTimelineForEvent(o[0].getId());if(s){var a=P.map(r.state,i.getEventMapper());s.getState(j.BACKWARDS).setUnknownStateEvents(a)}else(s=e.addTimeline()).initialiseState(P.map(r.state,i.getEventMapper())),s.getState(j.FORWARDS).paginationToken=r.end;return e.addEventsToTimeline(o,!0,s,r.start),e.getTimelineForEvent(t)||s}))},ae.prototype._createMessagesRequest=function(e,t,r,n){var s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:void 0,a=P.encodeUri("/rooms/$roomId/messages",{$roomId:e});void 0===r&&(r=30);var u={from:t,limit:r,dir:n},c=null;return this._clientOpts.lazyLoadMembers&&(c=(0,i.default)({},L.LAZY_LOADING_MESSAGES_FILTER)),s&&(c=c||{},(0,i.default)(c,s.getRoomTimelineFilterComponent())),c&&(u.filter=(0,o.default)(c)),this._http.authedRequest(void 0,"GET",a,u)},ae.prototype.paginateEventTimeline=function(e,t){var r=e.getTimelineSet()===this._notifTimelineSet,n=(t=t||{}).backwards||!1;if(r&&!n)throw new Error("paginateNotifTimeline can only paginate backwards");var o=n?j.BACKWARDS:j.FORWARDS,i=e.getPaginationToken(o);if(!i)return c.default.resolve(!1);var s=e._paginationRequests[o];if(s)return s;var a=void 0,u=void 0,l=void 0,d=this;if(r)a="/notifications",u={limit:"limit"in t?t.limit:30,only:"highlight"},i&&"end"!==i&&(u.from=i),l=this._http.authedRequest(void 0,"GET",a,u,void 0).then((function(t){for(var r=t.next_token,i=[],s=0;s<t.notifications.length;s++){var a=t.notifications[s],u=d.getEventMapper()(a.event);u.setPushActions(x.actionListToActionsObject(a.actions)),u.event.room_id=a.room_id,i[s]=u}return e.getTimelineSet().addEventsToTimeline(i,n,e,r),n&&!t.next_token&&e.setPaginationToken(null,o),!!t.next_token})).finally((function(){e._paginationRequests[o]=null})),e._paginationRequests[o]=l;else{if(!this.getRoom(e.getRoomId()))throw new Error("Unknown room "+e.getRoomId());(l=this._createMessagesRequest(e.getRoomId(),i,t.limit,o,e.getFilter())).then((function(t){if(t.state){var r=e.getState(o),i=P.map(t.state,d.getEventMapper());r.setUnknownStateEvents(i)}var s=t.end,a=P.map(t.chunk,d.getEventMapper());return e.getTimelineSet().addEventsToTimeline(a,n,e,s),n&&t.end==t.start&&e.setPaginationToken(null,o),t.end!=t.start})).finally((function(){e._paginationRequests[o]=null})),e._paginationRequests[o]=l}return l},ae.prototype.resetNotifTimelineSet=function(){this._notifTimelineSet&&this._notifTimelineSet.resetLiveTimeline("end",null)},ae.prototype.peekInRoom=function(e){return this._peekSync&&this._peekSync.stopPeeking(),this._peekSync=new F(this,this._clientOpts),this._peekSync.peek(e)},ae.prototype.stopPeeking=function(){this._peekSync&&(this._peekSync.stopPeeking(),this._peekSync=null)},ae.prototype.setGuestAccess=function(e,t){var r=this.sendStateEvent(e,"m.room.guest_access",{guest_access:t.allowJoin?"can_join":"forbidden"}),n=c.default.resolve();return t.allowRead&&(n=this.sendStateEvent(e,"m.room.history_visibility",{history_visibility:"world_readable"})),c.default.all([n,r])},ae.prototype.requestRegisterEmailToken=function(e,t,r,n){return this._requestTokenFromEndpoint("/register/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})},ae.prototype.requestRegisterMsisdnToken=function(e,t,r,n,o){return this._requestTokenFromEndpoint("/register/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:o})},ae.prototype.requestAdd3pidEmailToken=function(e,t,r,n){return this._requestTokenFromEndpoint("/account/3pid/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})},ae.prototype.requestAdd3pidMsisdnToken=function(e,t,r,n,o){return this._requestTokenFromEndpoint("/account/3pid/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:o})},ae.prototype.requestPasswordEmailToken=function(e,t,r,n){return this._requestTokenFromEndpoint("/account/password/email/requestToken",{email:e,client_secret:t,send_attempt:r,next_link:n})},ae.prototype.requestPasswordMsisdnToken=function(e,t,r,n,o){return this._requestTokenFromEndpoint("/account/password/msisdn/requestToken",{country:e,phone_number:t,client_secret:r,send_attempt:n,next_link:o})},ae.prototype._requestTokenFromEndpoint=(ee=(0,u.coroutine)(l.default.mark((function e(t,r){var n,o,s;return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,i.default)({},r),e.next=3,(0,u.resolve)(this.doesServerSupportSeparateAddAndBind());case 3:if(e.t0=!e.sent,!e.t0){e.next=6;break}e.t0=this.idBaseUrl;case 6:if(!e.t0){e.next=21;break}if((o=T.parse(this.idBaseUrl)).host){e.next=10;break}throw new Error("Invalid ID server URL: "+this.idBaseUrl);case 10:if(n.id_server=o.host,e.t1=this.identityServer&&this.identityServer.getAccessToken,!e.t1){e.next=16;break}return e.next=15,(0,u.resolve)(this.doesServerAcceptIdentityAccessToken());case 15:e.t1=e.sent;case 16:if(!e.t1){e.next=21;break}return e.next=19,(0,u.resolve)(this.identityServer.getAccessToken());case 19:(s=e.sent)&&(n.id_access_token=s);case 21:return e.abrupt("return",this._http.request(void 0,"POST",t,void 0,n));case 22:case"end":return e.stop()}}),e,this)}))),function(e,t){return ee.apply(this,arguments)}),ae.prototype.getRoomPushRule=function(e,t){if(!this.pushRules)throw new Error("SyncApi.sync() must be done before accessing to push rules.");for(var r=0;r<this.pushRules[e].room.length;r++){var n=this.pushRules[e].room[r];if(n.rule_id===t)return n}},ae.prototype.setRoomMutePushRule=function(e,t,r){var n=this,o=void 0,i=void 0,s=this.getRoomPushRule(e,t);if(s&&0<=s.actions.indexOf("dont_notify")&&(i=!0),r?s?i||(o=c.default.defer(),this.deletePushRule(e,"room",s.rule_id).done((function(){n.addPushRule(e,"room",t,{actions:["dont_notify"]}).done((function(){o.resolve()}),(function(e){o.reject(e)}))}),(function(e){o.reject(e)})),o=o.promise):o=this.addPushRule(e,"room",t,{actions:["dont_notify"]}):i&&(o=this.deletePushRule(e,"room",s.rule_id)),o){var a=c.default.defer();return o.done((function(){n.getPushRules().done((function(e){n.pushRules=e,a.resolve()}),(function(e){a.reject(e)}))}),(function(e){n.getPushRules().done((function(t){n.pushRules=t,a.reject(e)}),(function(t){a.reject(e)}))})),a.promise}},ae.prototype.searchMessageText=function(e,t){var r={search_term:e.query};return"keys"in e&&(r.keys=e.keys),this.search({body:{search_categories:{room_events:r}}},t)},ae.prototype.searchRoomEvents=function(e){var t={search_categories:{room_events:{search_term:e.term,filter:e.filter,order_by:"recent",event_context:{before_limit:1,after_limit:1,include_profile:!0}}}},r={_query:t,results:[],highlights:[]};return this.search({body:t}).then(this._processRoomEventsSearch.bind(this,r))},ae.prototype.backPaginateRoomEventsSearch=function(e){if(!e.next_batch)return c.default.reject(new Error("Cannot backpaginate event search any further"));if(e.pendingRequest)return e.pendingRequest;var t={body:e._query,next_batch:e.next_batch},r=this.search(t).then(this._processRoomEventsSearch.bind(this,e)).finally((function(){e.pendingRequest=null}));return e.pendingRequest=r,r},ae.prototype._processRoomEventsSearch=function(e,t){var r=t.search_categories.room_events;e.count=r.count,e.next_batch=r.next_batch;var n={};r.highlights.forEach((function(e){n[e]=1})),e.highlights.forEach((function(e){n[e]=1})),e.highlights=(0,d.default)(n);for(var o=0;o<r.results.length;o++){var i=A.fromJson(r.results[o],this.getEventMapper());e.results.push(i)}return e},ae.prototype.syncLeftRooms=function(){if(this._syncedLeftRooms)return c.default.resolve([]);if(this._syncLeftRoomsPromise)return this._syncLeftRoomsPromise;var e=this,t=new F(this,this._clientOpts);return this._syncLeftRoomsPromise=t.syncLeftRooms(),this._syncLeftRoomsPromise.then((function(t){_.default.log("Marking success of sync left room request"),e._syncedLeftRooms=!0})).finally((function(){e._syncLeftRoomsPromise=null})),this._syncLeftRoomsPromise},ae.prototype.createFilter=function(e){var t=this,r=P.encodeUri("/user/$userId/filter",{$userId:this.credentials.userId});return this._http.authedRequest(void 0,"POST",r,void 0,e).then((function(r){var n=L.fromJson(t.credentials.userId,r.filter_id,e);return t.store.storeFilter(n),n}))},ae.prototype.getFilter=function(e,t,r){if(r){var n=this.store.getFilter(e,t);if(n)return c.default.resolve(n)}var o=this,i=P.encodeUri("/user/$userId/filter/$filterId",{$userId:e,$filterId:t});return this._http.authedRequest(void 0,"GET",i,void 0,void 0).then((function(r){var n=L.fromJson(e,t,r);return o.store.storeFilter(n),n}))},ae.prototype.getOrCreateFilter=function(e,t){var r=this.store.getFilterIdByName(e),n=c.default.resolve(),o=this;return r&&(n=o.getFilter(o.credentials.userId,r,!0).then((function(n){var i=n.getDefinition(),s=t.getDefinition();if(P.deepCompare(i,s))return c.default.resolve(r);o.store.setFilterIdByName(e,void 0)}),(function(t){if(404!==t.httpStatus||"M_UNKNOWN"!==t.errcode&&"M_NOT_FOUND"!==t.errcode)throw t;o.store.setFilterIdByName(e,void 0)}))),n.then((function(r){return r||o.createFilter(t.getDefinition()).then((function(t){return o.store.setFilterIdByName(e,t.filterId),t.filterId}))}))},ae.prototype.getOpenIdToken=function(){var e=P.encodeUri("/user/$userId/openid/request_token",{$userId:this.credentials.userId});return this._http.authedRequest(void 0,"POST",e,void 0,{})},ae.prototype.turnServer=function(e){return this._http.authedRequest(e,"GET","/voip/turnServer")},ae.prototype.getTurnServers=function(){return this._turnServers||[]},ae.prototype.setFallbackICEServerAllowed=function(e){this._fallbackICEServerAllowed=e},ae.prototype.isFallbackICEServerAllowed=function(){return this._fallbackICEServerAllowed},ae.prototype.isSynapseAdministrator=function(){var e=P.encodeUri("/_synapse/admin/v1/users/$userId/admin",{$userId:this.getUserId()});return this._http.authedRequest(void 0,"GET",e,void 0,void 0,{prefix:""}).then((function(e){return e.admin}))},ae.prototype.whoisSynapseUser=function(e){var t=P.encodeUri("/_synapse/admin/v1/whois/$userId",{$userId:e});return this._http.authedRequest(void 0,"GET",t,void 0,void 0,{prefix:""})},ae.prototype.deactivateSynapseUser=function(e){var t=P.encodeUri("/_synapse/admin/v1/deactivate/$userId",{$userId:e});return this._http.authedRequest(void 0,"POST",t,void 0,void 0,{prefix:""})},ae.prototype.startClient=(te=(0,u.method)((function(e){var t=this;this.clientRunning||(this.clientRunning=!0,"number"==typeof e&&(e={initialSyncLimit:e}),this._crypto&&(this._crypto.uploadDeviceKeys().done(),this._crypto.start()),function e(t){t._supportsVoip&&(t.isGuest()||t.turnServer().done((function(r){if(r.uris){_.default.log("Got TURN URIs: "+r.uris+" refresh in "+r.ttl+" secs");var n={urls:r.uris,username:r.username,credential:r.password};t._turnServers=[n],t._checkTurnServersTimeoutID=setTimeout((function(){e(t)}),1e3*(r.ttl||3600)*.9)}}),(function(r){_.default.error("Failed to get TURN URIs"),t._checkTurnServersTimeoutID=setTimeout((function(){e(t)}),6e4)})))}(this),this._syncApi&&(_.default.error("Still have sync object whilst not running: stopping old one"),this._syncApi.stop()),(e=(0,i.default)({},e)).crypto=this._crypto,e.canResetEntireTimeline=function(e){return!!t._canResetTimelineCallback&&t._canResetTimelineCallback(e)},this._clientOpts=e,this._syncApi=new F(this,e),this._syncApi.sync())})),function(e){return te.apply(this,arguments)}),ae.prototype._storeClientOptions=function(){var e=["boolean","string","number"],t=(0,p.default)(this._clientOpts).filter((function(t){var r=(0,f.default)(t,2),n=(r[0],r[1]);return e.includes(void 0===n?"undefined":(0,a.default)(n))})).reduce((function(e,t){var r=(0,f.default)(t,2),n=r[0],o=r[1];return e[n]=o,e}),{});return this.store.storeClientOptions(t)},ae.prototype.stopClient=function(){_.default.log("stopping MatrixClient"),this.clientRunning=!1,this._syncApi&&(this._syncApi.stop(),this._syncApi=null),this._crypto&&this._crypto.stop(),this._peekSync&&this._peekSync.stopPeeking(),r.clearTimeout(this._checkTurnServersTimeoutID)},ae.prototype.getVersions=(0,u.coroutine)(l.default.mark((function e(){return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!==this._serverVersionsCache){e.next=4;break}return e.next=3,(0,u.resolve)(this._http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:""}));case 3:this._serverVersionsCache=e.sent;case 4:return e.abrupt("return",this._serverVersionsCache);case 5:case"end":return e.stop()}}),e,this)}))),ae.prototype.isVersionSupported=(re=(0,u.coroutine)(l.default.mark((function e(t){var r,n;return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.resolve)(this.getVersions());case 2:return r=e.sent,n=r.versions,e.abrupt("return",n&&n.includes(t));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return re.apply(this,arguments)}),ae.prototype.doesServerSupportLazyLoading=(0,u.coroutine)(l.default.mark((function e(){var t,r,n;return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.resolve)(this.getVersions());case 2:return t=e.sent,r=t.versions,n=t.unstable_features,e.abrupt("return",r&&r.includes("r0.5.0")||n&&n["m.lazy_load_members"]);case 6:case"end":return e.stop()}}),e,this)}))),ae.prototype.doesServerRequireIdServerParam=(0,u.coroutine)(l.default.mark((function e(){var t,r,n;return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.resolve)(this.getVersions());case 2:if(t=e.sent,!(r=t.versions)||!r.includes("r0.6.0")){e.next=6;break}return e.abrupt("return",!1);case 6:if(void 0!==(n=t.unstable_features)["m.require_identity_server"]){e.next=11;break}return e.abrupt("return",!0);case 11:return e.abrupt("return",n["m.require_identity_server"]);case 12:case"end":return e.stop()}}),e,this)}))),ae.prototype.doesServerAcceptIdentityAccessToken=(0,u.coroutine)(l.default.mark((function e(){var t,r,n;return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.resolve)(this.getVersions());case 2:return t=e.sent,r=t.versions,n=t.unstable_features,e.abrupt("return",r&&r.includes("r0.6.0")||n&&n["m.id_access_token"]);case 6:case"end":return e.stop()}}),e,this)}))),ae.prototype.doesServerSupportSeparateAddAndBind=(0,u.coroutine)(l.default.mark((function e(){var t,r,n;return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.resolve)(this.getVersions());case 2:return t=e.sent,r=t.versions,n=t.unstable_features,e.abrupt("return",r&&r.includes("r0.6.0")||n&&n["m.separate_add_and_bind"]);case 6:case"end":return e.stop()}}),e,this)}))),ae.prototype.hasLazyLoadMembersEnabled=function(){return!!this._clientOpts.lazyLoadMembers},ae.prototype.setCanResetTimelineCallback=function(e){this._canResetTimelineCallback=e},ae.prototype.getCanResetTimelineCallback=function(){return this._canResetTimelineCallback},ae.prototype.relations=(ne=(0,u.coroutine)(l.default.mark((function e(t,r,n,o){var i,s,a,d,f,p,h=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};return l.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=le(this,t,o),e.next=3,(0,u.resolve)(this.fetchRelations(t,r,n,i,h));case 3:if(s=e.sent,a=this.getEventMapper(),d=void 0,s.original_event&&(d=a(s.original_event)),f=s.chunk.map(a),"m.room.encrypted"!==i){e.next=13;break}return p=d?f.concat(d):f,e.next=12,(0,u.resolve)(c.default.all(p.map((function(e){return new c.default((function(t){return e.once("Event.decrypted",t)}))}))));case 12:f=f.filter((function(e){return e.getType()===o}));case 13:return e.abrupt("return",{originalEvent:d,events:f,nextBatch:s.next_batch});case 14:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,o){return ne.apply(this,arguments)}),ae.prototype.getEventMapper=function(){return ye(this)},ae.prototype.generateClientSecret=function(){return(0,E.randomString)(32)},t.exports.MatrixClient=ae,t.exports.CRYPTO_ENABLED=oe}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./ReEmitter":2,"./base-apis":4,"./content-helpers":6,"./content-repo":7,"./crypto":19,"./crypto/RoomList":12,"./crypto/key_passphrase":20,"./crypto/olmlib":21,"./crypto/recoverykey":22,"./filter":33,"./http-api":34,"./logger":37,"./models/event":42,"./models/event-timeline":41,"./models/search-result":49,"./pushprocessor":51,"./randomstring":52,"./store/stub":61,"./sync":63,"./utils":65,"./webrtc/call":66,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/json/stringify":71,"babel-runtime/core-js/object/assign":76,"babel-runtime/core-js/object/entries":79,"babel-runtime/core-js/object/keys":82,"babel-runtime/core-js/set":89,"babel-runtime/helpers/slicedToArray":97,"babel-runtime/helpers/typeof":99,"babel-runtime/regenerator":100,bluebird:103,events:257,url:276}],6:[function(e,t,r){"use strict";t.exports={makeHtmlMessage:function(e,t){return{msgtype:"m.text",format:"org.matrix.custom.html",body:e,formatted_body:t}},makeHtmlNotice:function(e,t){return{msgtype:"m.notice",format:"org.matrix.custom.html",body:e,formatted_body:t}},makeHtmlEmote:function(e,t){return{msgtype:"m.emote",format:"org.matrix.custom.html",body:e,formatted_body:t}},makeTextMessage:function(e){return{msgtype:"m.text",body:e}},makeNotice:function(e){return{msgtype:"m.notice",body:e}},makeEmoteMessage:function(e){return{msgtype:"m.emote",body:e}}}},{}],7:[function(e,t,r){"use strict";var n=e("./utils");t.exports={getHttpUriForMxc:function(e,t,r,o,i,s){if("string"!=typeof t||!t)return"";if(0!==t.indexOf("mxc://"))return s?t:"";var a=t.slice(6),u="/_matrix/media/r0/download/",c={};r&&(c.width=Math.round(r)),o&&(c.height=Math.round(o)),i&&(c.method=i),n.keys(c).length>0&&(u="/_matrix/media/r0/thumbnail/");var l=a.indexOf("#"),d="";return l>=0&&(d=a.substr(l),a=a.substr(0,l)),e+u+a+(0===n.keys(c).length?"":"?"+n.encodeParams(c))+d},getIdenticonUri:function(e,t,r,o){if(!t)return null;r||(r=96),o||(o=96);var i={width:r,height:o};return e+n.encodeUri("/_matrix/media/unstable/identicon/$ident",{$ident:t})+(0===n.keys(i).length?"":"?"+n.encodeParams(i))}}},{"./utils":65}],8:[function(e,t,r){(function(t){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.DeviceTrustLevel=r.UserTrustLevel=r.CrossSigningLevel=r.CrossSigningInfo=void 0;var n=e("bluebird"),o=_(e("babel-runtime/core-js/object/assign")),i=_(e("babel-runtime/helpers/slicedToArray")),s=_(e("babel-runtime/helpers/defineProperty")),a=_(e("babel-runtime/core-js/object/keys")),u=_(e("babel-runtime/regenerator")),c=_(e("babel-runtime/core-js/object/get-prototype-of")),l=_(e("babel-runtime/helpers/classCallCheck")),d=_(e("babel-runtime/helpers/createClass")),f=_(e("babel-runtime/helpers/possibleConstructorReturn")),p=_(e("babel-runtime/helpers/inherits")),h=_(e("babel-runtime/core-js/object/entries")),v=e("./olmlib"),m=e("events"),y=_(e("../logger"));function _(e){return e&&e.__esModule?e:{default:e}}function g(e){return(0,h.default)(e.keys)[0]}r.CrossSigningInfo=function(e){function r(e,t){(0,l.default)(this,r);var n=(0,f.default)(this,(r.__proto__||(0,c.default)(r)).call(this));return Object.defineProperty(n,"userId",{enumerable:!0,value:e}),n._callbacks=t||{},n.keys={},n.firstUse=!0,n}var h,m,_,E,S;return(0,p.default)(r,e),(0,d.default)(r,[{key:"getCrossSigningKey",value:(S=(0,n.coroutine)(u.default.mark((function e(r,o){var i,s,a;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._callbacks.getCrossSigningKey){e.next=2;break}throw new Error("No getCrossSigningKey callback supplied");case 2:return void 0===o&&(o=this.getId(r)),e.next=5,(0,n.resolve)(this._callbacks.getCrossSigningKey(r,o));case 5:if(i=e.sent){e.next=8;break}throw new Error("getCrossSigningKey callback for  "+r+" returned falsey");case 8:if(s=new t.Olm.PkSigning,(a=s.init_with_seed(i))===o){e.next=15;break}throw s.free(),new Error("Key type "+r+" from getCrossSigningKey callback did not match");case 15:return e.abrupt("return",[a,s]);case 16:case"end":return e.stop()}}),e,this)}))),function(e,t){return S.apply(this,arguments)})},{key:"toStorage",value:function(){return{keys:this.keys,firstUse:this.firstUse}}},{key:"hasKeys",value:function(){return(0,a.default)(this.keys).length>0}},{key:"getId",value:function(e){return e=e||"master",this.keys[e]?g(this.keys[e])[1]:null}},{key:"resetKeys",value:(E=(0,n.coroutine)(u.default.mark((function e(r){var a,c,l,d,f,p,h,m,y,_;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._callbacks.saveCrossSigningKeys){e.next=2;break}throw new Error("No saveCrossSigningKeys callback supplied");case 2:if(!(void 0===r||r&b.MASTER)&&this.keys.master){e.next=6;break}r=b.MASTER|b.USER_SIGNING|b.SELF_SIGNING,e.next=8;break;case 6:if(0!==r){e.next=8;break}return e.abrupt("return");case 8:if(a={},c={},l=void 0,d=void 0,e.prev=12,!(r&b.MASTER)){e.next=20;break}l=new t.Olm.PkSigning,a.master=l.generate_seed(),d=l.init_with_seed(a.master),c.master={user_id:this.userId,usage:["master"],keys:(0,s.default)({},"ed25519:"+d,d)},e.next=26;break;case 20:return e.next=22,(0,n.resolve)(this.getCrossSigningyKey("master"));case 22:f=e.sent,p=(0,i.default)(f,2),d=p[0],l=p[1];case 26:if(r&b.SELF_SIGNING){h=new t.Olm.PkSigning;try{a.self_signing=h.generate_seed(),m=h.init_with_seed(a.self_signing),c.self_signing={user_id:this.userId,usage:["self_signing"],keys:(0,s.default)({},"ed25519:"+m,m)},(0,v.pkSign)(c.self_signing,l,this.userId,d)}finally{h.free()}}if(r&b.USER_SIGNING){y=new t.Olm.PkSigning;try{a.user_signing=y.generate_seed(),_=y.init_with_seed(a.user_signing),c.user_signing={user_id:this.userId,usage:["user_signing"],keys:(0,s.default)({},"ed25519:"+_,_)},(0,v.pkSign)(c.user_signing,l,this.userId,d)}finally{y.free()}}(0,o.default)(this.keys,c),this._callbacks.saveCrossSigningKeys(a);case 30:return e.prev=30,l&&l.free(),e.finish(30);case 33:case"end":return e.stop()}}),e,this,[[12,,30,33]])}))),function(e){return E.apply(this,arguments)})},{key:"setKeys",value:function(e){var t={};if(e.master){if(e.master.user_id!==this.userId){var r="Mismatched user ID "+e.master.user_id+" in master key from "+this.userId;throw y.default.error(r),new Error(r)}this.keys.master?g(e.master)[1]!==this.getId()&&(this.firstUse=!1):this.firstUse=!0,t.master=e.master}else{if(!this.keys.master)throw new Error("Tried to set cross-signing keys without a master key");t.master=this.keys.master}var n=g(t.master)[1];if(e.user_signing){if(e.user_signing.user_id!==this.userId){var o="Mismatched user ID "+e.master.user_id+" in user_signing key from "+this.userId;throw y.default.error(o),new Error(o)}try{(0,v.pkVerify)(e.user_signing,n,this.userId)}catch(e){throw y.default.error("invalid signature on user-signing key"),e}}if(e.self_signing){if(e.self_signing.user_id!==this.userId){var i="Mismatched user ID "+e.master.user_id+" in self_signing key from "+this.userId;throw y.default.error(i),new Error(i)}try{(0,v.pkVerify)(e.self_signing,n,this.userId)}catch(e){throw y.default.error("invalid signature on self-signing key"),e}}e.master&&(this.keys.master=e.master,delete this.keys.self_signing,delete this.keys.user_signing),e.self_signing&&(this.keys.self_signing=e.self_signing),e.user_signing&&(this.keys.user_signing=e.user_signing)}},{key:"signObject",value:(_=(0,n.coroutine)(u.default.mark((function e(t,r){var o,s,a,c;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.keys[r]){e.next=2;break}throw new Error("Attempted to sign with "+r+" key but no such key present");case 2:return e.next=4,(0,n.resolve)(this.getCrossSigningKey(r));case 4:return o=e.sent,s=(0,i.default)(o,2),a=s[0],c=s[1],e.prev=8,(0,v.pkSign)(t,c,this.userId,a),e.abrupt("return",t);case 11:return e.prev=11,c.free(),e.finish(11);case 14:case"end":return e.stop()}}),e,this,[[8,,11,14]])}))),function(e,t){return _.apply(this,arguments)})},{key:"signUser",value:(m=(0,n.method)((function(e){if(this.keys.user_signing)return this.signObject(e.keys.master,"user_signing")})),function(e){return m.apply(this,arguments)})},{key:"signDevice",value:(h=(0,n.method)((function(e,t){if(e!==this.userId)throw new Error("Trying to sign "+e+"'s device; can only sign our own device");if(this.keys.self_signing)return this.signObject({algorithms:t.algorithms,keys:t.keys,device_id:t.deviceId,user_id:e},"self_signing")})),function(e,t){return h.apply(this,arguments)})},{key:"checkUserTrust",value:function(e){if(this.userId===e.userId&&this.getId()&&this.getId()===e.getId()&&this.getId("self_signing")&&this.getId("self_signing")===e.getId("self_signing"))return new k(!0,this.firstUse);if(!this.keys.user_signing)return new k(!1,e.firstUse);var t=void 0,r=e.keys.master,n=this.getId("user_signing");try{(0,v.pkVerify)(r,n,this.userId),t=!0}catch(e){t=!1}return new k(t,e.firstUse)}},{key:"checkDeviceTrust",value:function(e,t,r){var n=this.checkUserTrust(e),o=e.keys.self_signing;if(!o)return new w(!1,!1,r);var i=function(e,t){return{algorithms:e.algorithms,keys:e.keys,device_id:e.deviceId,user_id:t,signatures:e.signatures}}(t,e.userId);try{return(0,v.pkVerify)(o,e.getId(),e.userId),(0,v.pkVerify)(i,g(o)[1],e.userId),w.fromUserTrustLevel(n,r)}catch(e){return new w(!1,!1,r)}}}],[{key:"fromStorage",value:function(e,t){var n=new r(t);for(var o in e)e.hasOwnProperty(o)&&(n[o]=e[o]);return n}}]),r}(m.EventEmitter);var b=r.CrossSigningLevel={MASTER:4,USER_SIGNING:2,SELF_SIGNING:1},k=r.UserTrustLevel=function(){function e(t,r){(0,l.default)(this,e),this._crossSigningVerified=t,this._tofu=r}return(0,d.default)(e,[{key:"isVerified",value:function(){return this.isCrossSigningVerified()}},{key:"isCrossSigningVerified",value:function(){return this._crossSigningVerified}},{key:"isTofu",value:function(){return this._tofu}}]),e}(),w=r.DeviceTrustLevel=function(){function e(t,r,n){(0,l.default)(this,e),this._crossSigningVerified=t,this._tofu=r,this._localVerified=n}return(0,d.default)(e,[{key:"isVerified",value:function(){return this.isCrossSigningVerified()||this.isLocallyVerified()}},{key:"isCrossSigningVerified",value:function(){return this._crossSigningVerified}},{key:"isLocallyVerified",value:function(){return this._localVerified}},{key:"isTofu",value:function(){return this._tofu}}],[{key:"fromUserTrustLevel",value:function(t,r){return new e(t._crossSigningVerified,t._tofu,r)}}]),e}()}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":37,"./olmlib":21,"babel-runtime/core-js/object/assign":76,"babel-runtime/core-js/object/entries":79,"babel-runtime/core-js/object/get-prototype-of":81,"babel-runtime/core-js/object/keys":82,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,"babel-runtime/helpers/defineProperty":94,"babel-runtime/helpers/inherits":95,"babel-runtime/helpers/possibleConstructorReturn":96,"babel-runtime/helpers/slicedToArray":97,"babel-runtime/regenerator":100,bluebird:103,events:257}],9:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n,o,i=x(e("babel-runtime/helpers/slicedToArray")),s=x(e("babel-runtime/core-js/object/entries")),a=e("bluebird"),u=x(a),c=x(e("babel-runtime/regenerator")),l=x(e("babel-runtime/core-js/object/keys")),d=x(e("babel-runtime/core-js/get-iterator")),f=x(e("babel-runtime/core-js/object/get-prototype-of")),p=x(e("babel-runtime/helpers/classCallCheck")),h=x(e("babel-runtime/helpers/createClass")),v=x(e("babel-runtime/helpers/possibleConstructorReturn")),m=x(e("babel-runtime/helpers/inherits")),y=(n=(0,a.coroutine)(c.default.mark((function e(t,r,n,o){var i,s,u,l;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=!1,e.t0=c.default.keys(n);case 2:if((e.t1=e.t0()).done){e.next=9;break}if(s=e.t1.value,n.hasOwnProperty(s)){e.next=6;break}return e.abrupt("continue",2);case 6:s in o||(b.default.log("Device "+r+":"+s+" has been removed"),delete n[s],i=!0),e.next=2;break;case 9:e.t2=c.default.keys(o);case 10:if((e.t3=e.t2()).done){e.next=27;break}if(u=e.t3.value,o.hasOwnProperty(u)){e.next=14;break}return e.abrupt("continue",10);case 14:if((l=o[u]).user_id===r){e.next=18;break}return b.default.warn("Mismatched user_id "+l.user_id+" in keys from "+r+":"+u),e.abrupt("continue",10);case 18:if(l.device_id===u){e.next=21;break}return b.default.warn("Mismatched device_id "+l.device_id+" in keys from "+r+":"+u),e.abrupt("continue",10);case 21:return e.next=23,(0,a.resolve)(_(t,n,l));case 23:if(!e.sent){e.next=25;break}i=!0;case 25:e.next=10;break;case 27:return e.abrupt("return",i);case 28:case"end":return e.stop()}}),e,this)}))),function(e,t,r,o){return n.apply(this,arguments)}),_=(o=(0,a.coroutine)(c.default.mark((function e(t,r,n){var o,i,s,u,l,d,f;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.keys){e.next=2;break}return e.abrupt("return",!1);case 2:if(o=n.device_id,i=n.user_id,s="ed25519:"+o,u=n.keys[s]){e.next=9;break}return b.default.warn("Device "+i+":"+o+" has no ed25519 key"),e.abrupt("return",!1);case 9:return l=n.unsigned||{},d=n.signatures||{},e.prev=11,e.next=14,(0,a.resolve)(E.default.verifySignature(t,n,i,o,u));case 14:e.next=20;break;case 16:return e.prev=16,e.t0=e.catch(11),b.default.warn("Unable to verify signature on device "+i+":"+o+":"+e.t0),e.abrupt("return",!1);case 20:if(f=void 0,!(o in r)){e.next=28;break}if((f=r[o]).getFingerprint()==u){e.next=26;break}return b.default.warn("Ed25519 key for device "+i+":"+o+" has changed"),e.abrupt("return",!1);case 26:e.next=29;break;case 28:r[o]=f=new k.default(o);case 29:return f.keys=n.keys||{},f.algorithms=n.algorithms||[],f.unsigned=l,f.signatures=d,e.abrupt("return",!0);case 34:case"end":return e.stop()}}),e,this,[[11,16]])}))),function(e,t,r){return o.apply(this,arguments)}),g=e("events"),b=x(e("../logger")),k=x(e("./deviceinfo")),w=e("./CrossSigning"),E=x(e("./olmlib")),S=x(e("./store/indexeddb-crypto-store"));function x(e){return e&&e.__esModule?e:{default:e}}var R=function(e){function t(e,r,n){(0,p.default)(this,t);var o=(0,v.default)(this,(t.__proto__||(0,f.default)(t)).call(this));return o._cryptoStore=r,o._devices={},o._crossSigningInfo={},o._userByIdentityKey={},o._deviceTrackingStatus={},o._syncToken=null,o._serialiser=new T(e,n,o),o._keyDownloadsInProgressByUser={},o._dirty=!1,o._savePromise=null,o._resolveSavePromise=null,o._savePromiseTime=null,o._saveTimer=null,o}var r,n;return(0,m.default)(t,e),(0,h.default)(t,[{key:"load",value:(n=(0,a.coroutine)(c.default.mark((function e(){var t,r,n,o,i,s,u=this;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,a.resolve)(this._cryptoStore.doTxn("readonly",[S.default.STORE_DEVICE_DATA],(function(e){u._cryptoStore.getEndToEndDeviceData(e,(function(e){u._devices=e?e.devices:{},u._ssks=e&&e.self_signing_keys||{},u._deviceTrackingStatus=e?e.trackingStatus:{},u._syncToken=e?e.syncToken:null,u._userByIdentityKey={};var t=!0,r=!1,n=void 0;try{for(var o,i=(0,d.default)((0,l.default)(u._devices));!(t=(o=i.next()).done);t=!0){var s=o.value,a=u._devices[s],c=!0,f=!1,p=void 0;try{for(var h,v=(0,d.default)((0,l.default)(a));!(c=(h=v.next()).done);c=!0){var m=h.value,y=a[m].keys["curve25519:"+m];void 0!==y&&(u._userByIdentityKey[y]=s)}}catch(e){f=!0,p=e}finally{try{!c&&v.return&&v.return()}finally{if(f)throw p}}}}catch(e){r=!0,n=e}finally{try{!t&&i.return&&i.return()}finally{if(r)throw n}}}))})));case 2:for(t=!0,r=!1,n=void 0,e.prev=5,o=(0,d.default)((0,l.default)(this._deviceTrackingStatus));!(t=(i=o.next()).done);t=!0)s=i.value,2==this._deviceTrackingStatus[s]&&(this._deviceTrackingStatus[s]=1);e.next=13;break;case 9:e.prev=9,e.t0=e.catch(5),r=!0,n=e.t0;case 13:e.prev=13,e.prev=14,!t&&o.return&&o.return();case 16:if(e.prev=16,!r){e.next=19;break}throw n;case 19:return e.finish(16);case 20:return e.finish(13);case 21:case"end":return e.stop()}}),e,this,[[5,9,13,21],[14,,16,20]])}))),function(){return n.apply(this,arguments)})},{key:"stop",value:function(){null!==this._saveTimer&&clearTimeout(this._saveTimer)}},{key:"saveIfDirty",value:(r=(0,a.method)((function(e){var t=this;if(!this._dirty)return u.default.resolve(!1);void 0===e&&(e=500);var r=Date.now+e;this._savePromiseTime&&r<this._savePromiseTime&&(clearTimeout(this._saveTimer),this._saveTimer=null,this._savePromiseTime=null);var n=this._savePromise;if(null===n&&(n=new u.default((function(e,r){t._resolveSavePromise=e})),this._savePromise=n),null===this._saveTimer){var o=this._resolveSavePromise;this._savePromiseTime=r,this._saveTimer=setTimeout((function(){b.default.log("Saving device tracking data at token "+t._syncToken),t._savePromiseTime=null,t._saveTimer=null,t._savePromise=null,t._resolveSavePromise=null,t._dirty=!1,t._cryptoStore.doTxn("readwrite",[S.default.STORE_DEVICE_DATA],(function(e){t._cryptoStore.storeEndToEndDeviceData({devices:t._devices,self_signing_keys:t._ssks,trackingStatus:t._deviceTrackingStatus,syncToken:t._syncToken},e)})).then((function(){o()}))}),e)}return n})),function(e){return r.apply(this,arguments)})},{key:"getSyncToken",value:function(){return this._syncToken}},{key:"setSyncToken",value:function(e){this._syncToken=e}},{key:"downloadKeys",value:function(e,t){var r=this,n=[],o=[];if(e.forEach((function(e){var i=r._deviceTrackingStatus[e];r._keyDownloadsInProgressByUser[e]?(b.default.log("downloadKeys: already have a download in progress for "+e+": awaiting its result"),o.push(r._keyDownloadsInProgressByUser[e])):(t||3!=i)&&n.push(e)})),0!=n.length){b.default.log("downloadKeys: downloading for",n);var i=this._doKeyDownload(n);o.push(i)}return 0===o.length&&b.default.log("downloadKeys: already have all necessary keys"),u.default.all(o).then((function(){return r._getDevicesFromStore(e)}))}},{key:"_getDevicesFromStore",value:function(e){var t={},r=this;return e.map((function(e){t[e]={},(r.getStoredDevicesForUser(e)||[]).map((function(r){t[e][r.deviceId]=r}))})),t}},{key:"getStoredDevicesForUser",value:function(e){var t=this._devices[e];if(!t)return null;var r=[];for(var n in t)t.hasOwnProperty(n)&&r.push(k.default.fromStorage(t[n],n));return r}},{key:"getRawStoredDevicesForUser",value:function(e){return this._devices[e]}},{key:"getStoredCrossSigningForUser",value:function(e){return this._crossSigningInfo[e]?w.CrossSigningInfo.fromStorage(this._crossSigningInfo[e],e):null}},{key:"storeCrossSigningForUser",value:function(e,t){this._crossSigningInfo[e]=t,this._dirty=!0}},{key:"getStoredDevice",value:function(e,t){var r=this._devices[e];if(r&&r[t])return k.default.fromStorage(r[t],t)}},{key:"getDeviceByIdentityKey",value:function(e,t){var r=this._userByIdentityKey[t];if(!r)return null;if(e!==E.default.OLM_ALGORITHM&&e!==E.default.MEGOLM_ALGORITHM)return null;var n=this._devices[r];if(!n)return null;for(var o in n)if(n.hasOwnProperty(o)){var i=n[o];for(var s in i.keys){if(i.keys.hasOwnProperty(s))if(0===s.indexOf("curve25519:"))if(i.keys[s]==t)return k.default.fromStorage(i,o)}}return null}},{key:"storeDevicesForUser",value:function(e,t){if(void 0!==this._devices[e]){var r=!0,n=!1,o=void 0;try{for(var a,u=(0,d.default)((0,s.default)(this._devices[e]));!(r=(a=u.next()).done);r=!0){var c=(0,i.default)(a.value,2),l=c[0],f=c[1].keys["curve25519:"+l];delete this._userByIdentityKey[f]}}catch(e){n=!0,o=e}finally{try{!r&&u.return&&u.return()}finally{if(n)throw o}}}this._devices[e]=t;var p=!0,h=!1,v=void 0;try{for(var m,y=(0,d.default)((0,s.default)(t));!(p=(m=y.next()).done);p=!0){var _=(0,i.default)(m.value,2),g=(l=_[0],_[1].keys["curve25519:"+l]);this._userByIdentityKey[g]=e}}catch(e){h=!0,v=e}finally{try{!p&&y.return&&y.return()}finally{if(h)throw v}}this._dirty=!0}},{key:"startTrackingDeviceList",value:function(e){if("string"!=typeof e)throw new Error("userId must be a string; was "+e);this._deviceTrackingStatus[e]||(b.default.log("Now tracking device list for "+e),this._deviceTrackingStatus[e]=1,this._dirty=!0)}},{key:"stopTrackingDeviceList",value:function(e){this._deviceTrackingStatus[e]&&(b.default.log("No longer tracking device list for "+e),this._deviceTrackingStatus[e]=0,this._dirty=!0)}},{key:"stopTrackingAllDeviceLists",value:function(){var e=!0,t=!1,r=void 0;try{for(var n,o=(0,d.default)((0,l.default)(this._deviceTrackingStatus));!(e=(n=o.next()).done);e=!0){var i=n.value;this._deviceTrackingStatus[i]=0}}catch(e){t=!0,r=e}finally{try{!e&&o.return&&o.return()}finally{if(t)throw r}}this._dirty=!0}},{key:"invalidateUserDeviceList",value:function(e){this._deviceTrackingStatus[e]&&(b.default.log("Marking device list outdated for",e),this._deviceTrackingStatus[e]=1,this._dirty=!0)}},{key:"refreshOutdatedDeviceLists",value:function(){this.saveIfDirty();var e=[],t=!0,r=!1,n=void 0;try{for(var o,i=(0,d.default)((0,l.default)(this._deviceTrackingStatus));!(t=(o=i.next()).done);t=!0){var s=o.value;1==this._deviceTrackingStatus[s]&&e.push(s)}}catch(e){r=!0,n=e}finally{try{!t&&i.return&&i.return()}finally{if(r)throw n}}return this._doKeyDownload(e)}},{key:"_setRawStoredDevicesForUser",value:function(e,t){if(void 0!==this._devices[e]){var r=!0,n=!1,o=void 0;try{for(var a,u=(0,d.default)((0,s.default)(this._devices[e]));!(r=(a=u.next()).done);r=!0){var c=(0,i.default)(a.value,2),l=c[0],f=c[1].keys["curve25519:"+l];delete this._userByIdentityKey[f]}}catch(e){n=!0,o=e}finally{try{!r&&u.return&&u.return()}finally{if(n)throw o}}}this._devices[e]=t;var p=!0,h=!1,v=void 0;try{for(var m,y=(0,d.default)((0,s.default)(t));!(p=(m=y.next()).done);p=!0){var _=(0,i.default)(m.value,2),g=(l=_[0],_[1].keys["curve25519:"+l]);this._userByIdentityKey[g]=e}}catch(e){h=!0,v=e}finally{try{!p&&y.return&&y.return()}finally{if(h)throw v}}}},{key:"setRawStoredCrossSigningForUser",value:function(e,t){this._crossSigningInfo[e]=t}},{key:"_doKeyDownload",value:function(e){var t=this;if(0===e.length)return u.default.resolve();var r=this._serialiser.updateDevicesForUsers(e,this._syncToken).then((function(){n(!0)}),(function(t){throw b.default.error("Error downloading keys for "+e+":",t),n(!1),t}));e.forEach((function(e){t._keyDownloadsInProgressByUser[e]=r,1==t._deviceTrackingStatus[e]&&(t._deviceTrackingStatus[e]=2)}));var n=function(n){e.forEach((function(e){(t._dirty=!0,t._keyDownloadsInProgressByUser[e]===r)?(delete t._keyDownloadsInProgressByUser[e],2==t._deviceTrackingStatus[e]&&(n?(t._deviceTrackingStatus[e]=3,b.default.log("Device list for",e,"now up to date")):t._deviceTrackingStatus[e]=1)):b.default.log("Another update in the queue for",e,"- not marking up-to-date")})),t.saveIfDirty(),t.emit("crypto.devicesUpdated",e)};return r}}]),t}(g.EventEmitter);r.default=R;var T=function(){function e(t,r,n){(0,p.default)(this,e),this._baseApis=t,this._olmDevice=r,this._deviceList=n,this._downloadInProgress=!1,this._keyDownloadsQueuedByUser={},this._queuedQueryDeferred=null,this._syncToken=null}var t;return(0,h.default)(e,[{key:"updateDevicesForUsers",value:function(e,t){var r=this;return e.forEach((function(e){r._keyDownloadsQueuedByUser[e]=!0})),this._queuedQueryDeferred||(this._queuedQueryDeferred=u.default.defer()),this._syncToken=t,this._downloadInProgress?(b.default.log("Queued key download for",e),this._queuedQueryDeferred.promise):this._doQueuedQueries()}},{key:"_doQueuedQueries",value:function(){var e=this;if(this._downloadInProgress)throw new Error("DeviceListUpdateSerialiser._doQueuedQueries called with request active");var t=(0,l.default)(this._keyDownloadsQueuedByUser);this._keyDownloadsQueuedByUser={};var r=this._queuedQueryDeferred;this._queuedQueryDeferred=null,b.default.log("Starting key download for",t),this._downloadInProgress=!0;var n={};return this._syncToken&&(n.token=this._syncToken),this._baseApis.downloadKeysForUsers(t,n).then((function(r){var n=r.device_keys||{},o=r.master_keys||{},i=r.self_signing_keys||{},s=r.user_signing_keys||{},a=u.default.resolve(),c=!0,l=!1,f=void 0;try{for(var p,h=function(){var t=p.value;a=a.delay(5).then((function(){return e._processQueryResponseForUser(t,n[t],{master:o[t],self_signing:i[t],user_signing:s[t]})}))},v=(0,d.default)(t);!(c=(p=v.next()).done);c=!0)h()}catch(e){l=!0,f=e}finally{try{!c&&v.return&&v.return()}finally{if(l)throw f}}return a})).done((function(){b.default.log("Completed key download for "+t),e._downloadInProgress=!1,r.resolve(),e._queuedQueryDeferred&&e._doQueuedQueries()}),(function(n){b.default.warn("Error downloading keys for "+t+":",n),e._downloadInProgress=!1,r.reject(n)})),r.promise}},{key:"_processQueryResponseForUser",value:(t=(0,a.coroutine)(c.default.mark((function e(t,r,n,o){var i,s,u,d;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return b.default.log("got device keys for "+t+":",r),b.default.log("got cross-signing keys for "+t+":",n),i={},(s=this._deviceList.getRawStoredDevicesForUser(t))&&(0,l.default)(s).forEach((function(e){var t=k.default.fromStorage(s[e],e);i[e]=t})),e.next=7,(0,a.resolve)(y(this._olmDevice,t,i,r||{}));case 7:u={},(0,l.default)(i).forEach((function(e){u[e]=i[e].toStorage()})),this._deviceList._setRawStoredDevicesForUser(t,u),n&&(n.master||n.self_signing||n.user_signing)&&((d=this._deviceList.getStoredCrossSigningForUser(t)||new w.CrossSigningInfo(t)).setKeys(n),this._deviceList.setRawStoredCrossSigningForUser(t,d.toStorage()),this._deviceList.emit("userCrossSigningUpdated",t));case 11:case"end":return e.stop()}}),e,this)}))),function(e,r,n,o){return t.apply(this,arguments)})}]),e}()},{"../logger":37,"./CrossSigning":8,"./deviceinfo":18,"./olmlib":21,"./store/indexeddb-crypto-store":24,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/object/entries":79,"babel-runtime/core-js/object/get-prototype-of":81,"babel-runtime/core-js/object/keys":82,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,"babel-runtime/helpers/inherits":95,"babel-runtime/helpers/possibleConstructorReturn":96,"babel-runtime/helpers/slicedToArray":97,"babel-runtime/regenerator":100,bluebird:103,events:257}],10:[function(e,t,r){(function(r){"use strict";var n,o=f(e("babel-runtime/core-js/get-iterator")),i=f(e("babel-runtime/core-js/object/keys")),s=f(e("babel-runtime/core-js/object/assign")),a=f(e("babel-runtime/regenerator")),u=e("bluebird"),c=(n=(0,u.coroutine)(a.default.mark((function e(t,r,n){return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.resolve)(t.doTxn("readwrite",[d.default.STORE_ACCOUNT],(function(e){t.getAccount(e,(function(o){null!==o?n.unpickle(r,o):(n.create(),o=n.pickle(r),t.storeAccount(e,o))}))})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return n.apply(this,arguments)}),l=f(e("../logger")),d=f(e("./store/indexeddb-crypto-store"));function f(e){return e&&e.__esModule?e:{default:e}}var p,h,v,m,y,_,g,b,k,w,E,S,x,R=49152;function T(e){if(void 0===e)throw new Error("payloadString undefined");if(e.length>R)throw new Error("Message too long ("+e.length+" bytes). The maximum for an encrypted message is "+R+" bytes.")}function I(e){this._cryptoStore=e,this._pickleKey="DEFAULT_KEY",this.deviceCurve25519Key=null,this.deviceEd25519Key=null,this._maxOneTimeKeys=null,this._outboundGroupSessionStore={},this._inboundGroupSessionMessageIndexes={},this._sessionsInProgress={}}I.prototype.init=(0,u.coroutine)(a.default.mark((function e(){var t,n;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=void 0,n=new r.Olm.Account,e.prev=2,e.next=5,(0,u.resolve)(c(this._cryptoStore,this._pickleKey,n));case 5:t=JSON.parse(n.identity_keys()),this._maxOneTimeKeys=n.max_number_of_one_time_keys();case 7:return e.prev=7,n.free(),e.finish(7);case 10:this.deviceCurve25519Key=t.curve25519,this.deviceEd25519Key=t.ed25519;case 12:case"end":return e.stop()}}),e,this,[[2,,7,10]])}))),I.getOlmVersion=function(){return r.Olm.get_library_version()},I.prototype._getAccount=function(e,t){var n=this;this._cryptoStore.getAccount(e,(function(e){var o=new r.Olm.Account;try{o.unpickle(n._pickleKey,e),t(o)}finally{o.free()}}))},I.prototype._storeAccount=function(e,t){this._cryptoStore.storeAccount(e,t.pickle(this._pickleKey))},I.prototype._getSession=function(e,t,r,n){var o=this;this._cryptoStore.getEndToEndSession(e,t,r,(function(e){o._unpickleSession(e,n)}))},I.prototype._unpickleSession=function(e,t){var n=new r.Olm.Session;try{n.unpickle(this._pickleKey,e.session),t((0,s.default)({},e,{session:n}))}finally{n.free()}},I.prototype._saveSession=function(e,t,r){var n=t.session.session_id(),o=(0,s.default)(t,{session:t.session.pickle(this._pickleKey)});this._cryptoStore.storeEndToEndSession(e,n,o,r)},I.prototype._getUtility=function(e){var t=new r.Olm.Utility;try{return e(t)}finally{t.free()}},I.prototype.sign=(p=(0,u.coroutine)(a.default.mark((function e(t){var r,n=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=void 0,e.next=3,(0,u.resolve)(this._cryptoStore.doTxn("readonly",[d.default.STORE_ACCOUNT],(function(e){n._getAccount(e,(function(e){r=e.sign(t)}))})));case 3:return e.abrupt("return",r);case 4:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)}),I.prototype.getOneTimeKeys=(0,u.coroutine)(a.default.mark((function e(){var t,r=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=void 0,e.next=3,(0,u.resolve)(this._cryptoStore.doTxn("readonly",[d.default.STORE_ACCOUNT],(function(e){r._getAccount(e,(function(e){t=JSON.parse(e.one_time_keys())}))})));case 3:return e.abrupt("return",t);case 4:case"end":return e.stop()}}),e,this)}))),I.prototype.maxNumberOfOneTimeKeys=function(){return this._maxOneTimeKeys},I.prototype.markKeysAsPublished=(0,u.coroutine)(a.default.mark((function e(){var t=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.resolve)(this._cryptoStore.doTxn("readwrite",[d.default.STORE_ACCOUNT],(function(e){t._getAccount(e,(function(r){r.mark_keys_as_published(),t._storeAccount(e,r)}))})));case 2:case"end":return e.stop()}}),e,this)}))),I.prototype.generateOneTimeKeys=function(e){var t=this;return this._cryptoStore.doTxn("readwrite",[d.default.STORE_ACCOUNT],(function(r){t._getAccount(r,(function(n){n.generate_one_time_keys(e),t._storeAccount(r,n)}))}))},I.prototype.createOutboundSession=(h=(0,u.coroutine)(a.default.mark((function e(t,n){var o,i=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=void 0,e.next=3,(0,u.resolve)(this._cryptoStore.doTxn("readwrite",[d.default.STORE_ACCOUNT,d.default.STORE_SESSIONS],(function(e){i._getAccount(e,(function(s){var a=new r.Olm.Session;try{a.create_outbound(s,t,n),o=a.session_id(),i._storeAccount(e,s);var u={session:a,lastReceivedMessageTs:Date.now()};i._saveSession(t,u,e)}finally{a.free()}}))})));case 3:return e.abrupt("return",o);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return h.apply(this,arguments)}),I.prototype.createInboundSession=(v=(0,u.coroutine)(a.default.mark((function e(t,n,o){var i,s=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===n){e.next=2;break}throw new Error("Need messageType == 0 to create inbound session");case 2:return i=void 0,e.next=5,(0,u.resolve)(this._cryptoStore.doTxn("readwrite",[d.default.STORE_ACCOUNT,d.default.STORE_SESSIONS],(function(e){s._getAccount(e,(function(a){var u=new r.Olm.Session;try{u.create_inbound_from(a,t,o),a.remove_one_time_keys(u),s._storeAccount(e,a);var c=u.decrypt(n,o),l={session:u,lastReceivedMessageTs:Date.now()};s._saveSession(t,l,e),i={payload:c,session_id:u.session_id()}}finally{u.free()}}))})));case 5:return e.abrupt("return",i);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return v.apply(this,arguments)}),I.prototype.getSessionIdsForDevice=(m=(0,u.coroutine)(a.default.mark((function e(t){var r,n=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._sessionsInProgress[t]){e.next=9;break}return l.default.log("waiting for session to be created"),e.prev=2,e.next=5,(0,u.resolve)(this._sessionsInProgress[t]);case 5:e.next=9;break;case 7:e.prev=7,e.t0=e.catch(2);case 9:return r=void 0,e.next=12,(0,u.resolve)(this._cryptoStore.doTxn("readonly",[d.default.STORE_SESSIONS],(function(e){n._cryptoStore.getEndToEndSessions(t,e,(function(e){r=(0,i.default)(e)}))})));case 12:return e.abrupt("return",r);case 13:case"end":return e.stop()}}),e,this,[[2,7]])}))),function(e){return m.apply(this,arguments)}),I.prototype.getSessionIdForDevice=(y=(0,u.coroutine)(a.default.mark((function e(t,r){var n,o,i,s,c,l,d;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.resolve)(this.getSessionInfoForDevice(t,r));case 2:if(0!==(n=e.sent).length){e.next=5;break}return e.abrupt("return",null);case 5:for(o=0,i=1;i<n.length;i++)s=n[i],c=void 0===s.lastReceivedMessageTs?0:s.lastReceivedMessageTs,l=n[o],d=void 0===l.lastReceivedMessageTs?0:l.lastReceivedMessageTs,(c>d||c===d&&s.sessionId<l.sessionId)&&(o=i);return e.abrupt("return",n[o].sessionId);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return y.apply(this,arguments)}),I.prototype.getSessionInfoForDevice=(_=(0,u.coroutine)(a.default.mark((function e(t,r){var n,s=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._sessionsInProgress[t]||r){e.next=9;break}return l.default.log("waiting for session to be created"),e.prev=2,e.next=5,(0,u.resolve)(this._sessionsInProgress[t]);case 5:e.next=9;break;case 7:e.prev=7,e.t0=e.catch(2);case 9:return n=[],e.next=12,(0,u.resolve)(this._cryptoStore.doTxn("readonly",[d.default.STORE_SESSIONS],(function(e){s._cryptoStore.getEndToEndSessions(t,e,(function(e){var t=(0,i.default)(e).sort(),r=!0,a=!1,u=void 0;try{for(var c,l=function(){var t=c.value;s._unpickleSession(e[t],(function(e){n.push({lastReceivedMessageTs:e.lastReceivedMessageTs,hasReceivedMessage:e.session.has_received_message(),sessionId:t})}))},d=(0,o.default)(t);!(r=(c=d.next()).done);r=!0)l()}catch(e){a=!0,u=e}finally{try{!r&&d.return&&d.return()}finally{if(a)throw u}}}))})));case 12:return e.abrupt("return",n);case 13:case"end":return e.stop()}}),e,this,[[2,7]])}))),function(e,t){return _.apply(this,arguments)}),I.prototype.encryptMessage=(g=(0,u.coroutine)(a.default.mark((function e(t,r,n){var o,i=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return T(n),o=void 0,e.next=4,(0,u.resolve)(this._cryptoStore.doTxn("readwrite",[d.default.STORE_SESSIONS],(function(e){i._getSession(t,r,e,(function(s){var a=s.session.describe();console.log("Session ID "+r+" to "+t+": "+a),o=s.session.encrypt(n),i._saveSession(t,s,e)}))})));case 4:return e.abrupt("return",o);case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return g.apply(this,arguments)}),I.prototype.decryptMessage=(b=(0,u.coroutine)(a.default.mark((function e(t,r,n,o){var i,s=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=void 0,e.next=3,(0,u.resolve)(this._cryptoStore.doTxn("readwrite",[d.default.STORE_SESSIONS],(function(e){s._getSession(t,r,e,(function(a){var u=a.session.describe();console.log("Session ID "+r+" to "+t+": "+u),i=a.session.decrypt(n,o),a.lastReceivedMessageTs=Date.now(),s._saveSession(t,a,e)}))})));case 3:return e.abrupt("return",i);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return b.apply(this,arguments)}),I.prototype.matchesSession=(k=(0,u.coroutine)(a.default.mark((function e(t,r,n,o){var i,s=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(0===n){e.next=2;break}return e.abrupt("return",!1);case 2:return i=void 0,e.next=5,(0,u.resolve)(this._cryptoStore.doTxn("readonly",[d.default.STORE_SESSIONS],(function(e){s._getSession(t,r,e,(function(e){i=e.session.matches_inbound(o)}))})));case 5:return e.abrupt("return",i);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return k.apply(this,arguments)}),I.prototype._saveOutboundGroupSession=function(e){var t=e.pickle(this._pickleKey);this._outboundGroupSessionStore[e.session_id()]=t},I.prototype._getOutboundGroupSession=function(e,t){var n=this._outboundGroupSessionStore[e];if(void 0===n)throw new Error("Unknown outbound group session "+e);var o=new r.Olm.OutboundGroupSession;try{return o.unpickle(this._pickleKey,n),t(o)}finally{o.free()}},I.prototype.createOutboundGroupSession=function(){var e=new r.Olm.OutboundGroupSession;try{return e.create(),this._saveOutboundGroupSession(e),e.session_id()}finally{e.free()}},I.prototype.encryptGroupMessage=function(e,t){var r=this;return T(t),this._getOutboundGroupSession(e,(function(e){var n=e.encrypt(t);return r._saveOutboundGroupSession(e),n}))},I.prototype.getOutboundGroupSessionKey=function(e){return this._getOutboundGroupSession(e,(function(e){return{chain_index:e.message_index(),key:e.session_key()}}))},I.prototype._unpickleInboundGroupSession=function(e,t){var n=new r.Olm.InboundGroupSession;try{return n.unpickle(this._pickleKey,e.session),t(n)}finally{n.free()}},I.prototype._getInboundGroupSession=function(e,t,r,n,o){var i=this;this._cryptoStore.getEndToEndInboundGroupSession(t,r,n,(function(t){if(null!==t){if(null!==e&&e!==t.room_id)throw new Error("Mismatched room_id for inbound group session (expected "+t.room_id+", was "+e+")");i._unpickleInboundGroupSession(t,(function(e){o(e,t)}))}else o(null)}))},I.prototype.addInboundGroupSession=(w=(0,u.coroutine)(a.default.mark((function e(t,n,o,i,s,c,f){var p=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.resolve)(this._cryptoStore.doTxn("readwrite",[d.default.STORE_INBOUND_GROUP_SESSIONS],(function(e){p._getInboundGroupSession(t,n,i,e,(function(a,u){var d=new r.Olm.InboundGroupSession;try{if(f?d.import_session(s):d.create(s),i!=d.session_id())throw new Error("Mismatched group session ID from senderKey: "+n);if(a&&(l.default.log("Update for megolm session "+n+"/"+i),a.first_known_index()<=d.first_known_index()))return void l.default.log("Keeping existing session");var h={room_id:t,session:d.pickle(p._pickleKey),keysClaimed:c,forwardingCurve25519KeyChain:o};p._cryptoStore.storeEndToEndInboundGroupSession(n,i,h,e)}finally{d.free()}}))})));case 2:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,o,i,s){return w.apply(this,arguments)}),I.prototype.decryptGroupMessage=(E=(0,u.coroutine)(a.default.mark((function e(t,r,n,o,i,s){var c,l=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return c=void 0,e.next=3,(0,u.resolve)(this._cryptoStore.doTxn("readwrite",[d.default.STORE_INBOUND_GROUP_SESSIONS],(function(e){l._getInboundGroupSession(t,r,n,e,(function(t,a){if(null!==t){var u=t.decrypt(o),d=u.plaintext;if(void 0===d)d=u;else{var f=r+"|"+n+"|"+u.message_index;if(f in l._inboundGroupSessionMessageIndexes){var p=l._inboundGroupSessionMessageIndexes[f];if(p.id!==i||p.timestamp!==s)throw new Error("Duplicate message index, possible replay attack: "+f)}l._inboundGroupSessionMessageIndexes[f]={id:i,timestamp:s}}a.session=t.pickle(l._pickleKey),l._cryptoStore.storeEndToEndInboundGroupSession(r,n,a,e),c={result:d,keysClaimed:a.keysClaimed||{},senderKey:r,forwardingCurve25519KeyChain:a.forwardingCurve25519KeyChain||[]}}else c=null}))})));case 3:return e.abrupt("return",c);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,o,i){return E.apply(this,arguments)}),I.prototype.hasInboundSessionKeys=(S=(0,u.coroutine)(a.default.mark((function e(t,r,n){var o,i=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return o=void 0,e.next=3,(0,u.resolve)(this._cryptoStore.doTxn("readonly",[d.default.STORE_INBOUND_GROUP_SESSIONS],(function(e){i._cryptoStore.getEndToEndInboundGroupSession(r,n,e,(function(e){null!==e?t!==e.room_id?(l.default.warn("requested keys for inbound group session "+r+"|"+n+", with incorrect room_id (expected "+e.room_id+", was "+t+")"),o=!1):o=!0:o=!1}))})));case 3:return e.abrupt("return",o);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return S.apply(this,arguments)}),I.prototype.getInboundGroupSessionKey=(x=(0,u.coroutine)(a.default.mark((function e(t,r,n,o){var i,s=this;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=void 0,e.next=3,(0,u.resolve)(this._cryptoStore.doTxn("readonly",[d.default.STORE_INBOUND_GROUP_SESSIONS],(function(e){s._getInboundGroupSession(t,r,n,e,(function(e,t){if(null!==e){void 0===o&&(o=e.first_known_index());var r=e.export_session(o),n=(t.keysClaimed||{}).ed25519||null;i={chain_index:o,key:r,forwarding_curve25519_key_chain:t.forwardingCurve25519KeyChain||[],sender_claimed_ed25519_key:n}}else i=null}))})));case 3:return e.abrupt("return",i);case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return x.apply(this,arguments)}),I.prototype.exportInboundGroupSession=function(e,t,r){return this._unpickleInboundGroupSession(r,(function(n){var o=n.first_known_index();return{sender_key:e,sender_claimed_keys:r.keysClaimed,room_id:r.room_id,session_id:t,session_key:n.export_session(o),forwarding_curve25519_key_chain:n.forwardingCurve25519KeyChain||[],first_known_index:n.first_known_index()}}))},I.prototype.verifySignature=function(e,t,r){this._getUtility((function(n){n.ed25519_verify(e,t,r)}))},t.exports=I}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":37,"./store/indexeddb-crypto-store":24,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/object/assign":76,"babel-runtime/core-js/object/keys":82,"babel-runtime/regenerator":100,bluebird:103}],11:[function(e,t,r){(function(t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=d(e("babel-runtime/core-js/get-iterator")),o=d(e("babel-runtime/regenerator")),i=e("bluebird"),s=d(i),a=d(e("babel-runtime/helpers/classCallCheck")),u=d(e("babel-runtime/helpers/createClass")),c=d(e("../logger")),l=d(e("../utils"));function d(e){return e&&e.__esModule?e:{default:e}}var f=0,p=1,h=2,v=3,m=function(){function e(t,r,n){(0,a.default)(this,e),this._baseApis=t,this._deviceId=r,this._cryptoStore=n,this._sendOutgoingRoomKeyRequestsTimer=null,this._sendOutgoingRoomKeyRequestsRunning=!1,this._clientRunning=!1}var r;return(0,u.default)(e,[{key:"start",value:function(){this._clientRunning=!0,this._startTimer()}},{key:"stop",value:function(){c.default.log("stopping OutgoingRoomKeyRequestManager"),this._clientRunning=!1}},{key:"sendRoomKeyRequest",value:(r=(0,i.coroutine)(o.default.mark((function e(t,r){var n,s,a,u,l=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.resolve)(this._cryptoStore.getOutgoingRoomKeyRequest(t));case 2:if(n=e.sent){e.next=8;break}return e.next=6,(0,i.resolve)(this._cryptoStore.getOrAddOutgoingRoomKeyRequest({requestBody:t,recipients:r,requestId:this._baseApis.makeTxnId(),state:f}));case 6:e.next=35;break;case 8:e.t0=n.state,e.next=e.t0===v?11:e.t0===f?11:e.t0===h?12:e.t0===p?16:34;break;case 11:return e.abrupt("return");case 12:return s=l?v:p,e.next=15,(0,i.resolve)(this._cryptoStore.updateOutgoingRoomKeyRequest(n.requestId,h,{state:s,cancellationTxnId:this._baseApis.makeTxnId()}));case 15:return e.abrupt("break",35);case 16:if(!l){e.next=33;break}return a=v,e.next=20,(0,i.resolve)(this._cryptoStore.updateOutgoingRoomKeyRequest(n.requestId,p,{state:a,cancellationTxnId:this._baseApis.makeTxnId(),requestTxnId:this._baseApis.makeTxnId()}));case 20:if(u=e.sent){e.next=25;break}return e.next=24,(0,i.resolve)(this.sendRoomKeyRequest(t,r,l));case 24:return e.abrupt("return",e.sent);case 25:return e.prev=25,e.next=28,(0,i.resolve)(this._sendOutgoingRoomKeyRequestCancellation(u,!0));case 28:e.next=33;break;case 30:e.prev=30,e.t1=e.catch(25),c.default.error("Error sending room key request cancellation; will retry later.",e.t1);case 33:return e.abrupt("break",35);case 34:throw new Error("unhandled state: "+n.state);case 35:this._startTimer();case 36:case"end":return e.stop()}}),e,this,[[25,30]])}))),function(e,t,n){return r.apply(this,arguments)})},{key:"cancelRoomKeyRequest",value:function(e){var t=this;return this._cryptoStore.getOutgoingRoomKeyRequest(e).then((function(r){if(r)switch(r.state){case h:case v:return;case f:return c.default.log("deleting unnecessary room key request for "+y(e)),t._cryptoStore.deleteOutgoingRoomKeyRequest(r.requestId,f);case p:return t._cryptoStore.updateOutgoingRoomKeyRequest(r.requestId,p,{state:h,cancellationTxnId:t._baseApis.makeTxnId()}).then((function(r){r?t._sendOutgoingRoomKeyRequestCancellation(r).catch((function(e){c.default.error("Error sending room key request cancellation; will retry later.",e),t._startTimer()})):c.default.log("Tried to cancel room key request for "+y(e)+" but it was already cancelled in another tab")}));default:throw new Error("unhandled state: "+r.state)}}))}},{key:"getOutgoingSentRoomKeyRequest",value:function(e,t){return this._cryptoStore.getOutgoingRoomKeyRequestsByTarget(e,t,[p])}},{key:"_startTimer",value:function(){var e=this;if(!this._sendOutgoingRoomKeyRequestsTimer){this._sendOutgoingRoomKeyRequestsTimer=t.setTimeout((function(){if(e._sendOutgoingRoomKeyRequestsRunning)throw new Error("RoomKeyRequestSend already in progress!");e._sendOutgoingRoomKeyRequestsRunning=!0,e._sendOutgoingRoomKeyRequests().finally((function(){e._sendOutgoingRoomKeyRequestsRunning=!1})).catch((function(e){c.default.warn("error in OutgoingRoomKeyRequestManager: "+e)}))}),500)}}},{key:"_sendOutgoingRoomKeyRequests",value:function(){var e=this;return this._clientRunning?(c.default.log("Looking for queued outgoing room key requests"),this._cryptoStore.getOutgoingRoomKeyRequestByState([h,v,f]).then((function(t){if(!t)return c.default.log("No more outgoing room key requests"),void(e._sendOutgoingRoomKeyRequestsTimer=null);var r=void 0;switch(t.state){case f:r=e._sendOutgoingRoomKeyRequest(t);break;case h:r=e._sendOutgoingRoomKeyRequestCancellation(t);break;case v:r=e._sendOutgoingRoomKeyRequestCancellation(t,!0)}return r.then((function(){return e._sendOutgoingRoomKeyRequests()})).catch((function(t){c.default.error("Error sending room key request; will retry later.",t),e._sendOutgoingRoomKeyRequestsTimer=null,e._startTimer()}))}))):(this._sendOutgoingRoomKeyRequestsTimer=null,s.default.resolve())}},{key:"_sendOutgoingRoomKeyRequest",value:function(e){var t=this;c.default.log("Requesting keys for "+y(e.requestBody)+" from "+_(e.recipients)+"(id "+e.requestId+")");var r={action:"request",requesting_device_id:this._deviceId,request_id:e.requestId,body:e.requestBody};return this._sendMessageToDevices(r,e.recipients,e.requestTxnId||e.requestId).then((function(){return t._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,f,{state:p})}))}},{key:"_sendOutgoingRoomKeyRequestCancellation",value:function(e,t){var r=this;c.default.log("Sending cancellation for key request for "+y(e.requestBody)+" to "+_(e.recipients)+" (cancellation id "+e.cancellationTxnId+")");var n={action:"request_cancellation",requesting_device_id:this._deviceId,request_id:e.requestId};return this._sendMessageToDevices(n,e.recipients,e.cancellationTxnId).then((function(){return t?r._cryptoStore.updateOutgoingRoomKeyRequest(e.requestId,v,{state:f}):r._cryptoStore.deleteOutgoingRoomKeyRequest(e.requestId,h)}))}},{key:"_sendMessageToDevices",value:function(e,t,r){var o={},i=!0,s=!1,a=void 0;try{for(var u,c=(0,n.default)(t);!(i=(u=c.next()).done);i=!0){var l=u.value;o[l.userId]||(o[l.userId]={}),o[l.userId][l.deviceId]=e}}catch(e){s=!0,a=e}finally{try{!i&&c.return&&c.return()}finally{if(s)throw a}}return this._baseApis.sendToDevice("m.room_key_request",o,r)}}]),e}();function y(e){return e.room_id+" / "+e.session_id}function _(e){return"["+l.default.map(e,(function(e){return e.userId+":"+e.deviceId})).join(",")+"]"}r.default=m}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":37,"../utils":65,"babel-runtime/core-js/get-iterator":69,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,"babel-runtime/regenerator":100,bluebird:103}],12:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=u(e("babel-runtime/regenerator")),o=e("bluebird"),i=u(e("babel-runtime/helpers/classCallCheck")),s=u(e("babel-runtime/helpers/createClass")),a=u(e("./store/indexeddb-crypto-store"));function u(e){return e&&e.__esModule?e:{default:e}}var c=function(){function e(t){(0,i.default)(this,e),this._cryptoStore=t,this._roomEncryption={}}var t,r;return(0,s.default)(e,[{key:"init",value:(r=(0,o.coroutine)(n.default.mark((function e(){var t=this;return n.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,o.resolve)(this._cryptoStore.doTxn("readwrite",[a.default.STORE_ROOMS],(function(e){t._cryptoStore.getEndToEndRooms(e,(function(e){t._roomEncryption=e}))})));case 2:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"getRoomEncryption",value:function(e){return this._roomEncryption[e]||null}},{key:"isRoomEncrypted",value:function(e){return Boolean(this.getRoomEncryption(e))}},{key:"setRoomEncryption",value:(t=(0,o.coroutine)(n.default.mark((function e(t,r){var i=this;return n.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._roomEncryption[t]=r,e.next=3,(0,o.resolve)(this._cryptoStore.doTxn("readwrite",[a.default.STORE_ROOMS],(function(e){i._cryptoStore.storeEndToEndRoom(t,r,e)})));case 3:case"end":return e.stop()}}),e,this)}))),function(e,r){return t.apply(this,arguments)})}]),e}();r.default=c},{"./store/indexeddb-crypto-store":24,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,"babel-runtime/regenerator":100,bluebird:103}],13:[function(e,t,r){(function(t){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.SECRET_STORAGE_ALGORITHM_V1=void 0;var n=w(e("babel-runtime/helpers/defineProperty")),o=w(e("babel-runtime/core-js/object/keys")),i=w(e("babel-runtime/helpers/slicedToArray")),s=w(e("babel-runtime/core-js/get-iterator")),a=w(e("babel-runtime/regenerator")),u=e("bluebird"),c=w(e("babel-runtime/core-js/promise")),l=w(e("babel-runtime/core-js/object/get-prototype-of")),d=w(e("babel-runtime/helpers/classCallCheck")),f=w(e("babel-runtime/helpers/createClass")),p=w(e("babel-runtime/helpers/possibleConstructorReturn")),h=w(e("babel-runtime/helpers/inherits")),v=e("events"),m=w(e("../logger")),y=e("./olmlib"),_=w(y),g=e("../randomstring"),b=e("./key_passphrase"),k=e("./recoverykey");function w(e){return e&&e.__esModule?e:{default:e}}var E=r.SECRET_STORAGE_ALGORITHM_V1="m.secret_storage.v1.curve25519-aes-sha2",S=function(e){function r(e,t,n){(0,d.default)(this,r);var o=(0,p.default)(this,(r.__proto__||(0,l.default)(r)).call(this));return o._baseApis=e,o._cryptoCallbacks=t,o._crossSigningInfo=n,o._requests={},o._incomingRequests={},o}var v,w,S,x,R;return(0,h.default)(r,e),(0,f.default)(r,[{key:"getDefaultKeyId",value:function(){var e=this._baseApis.getAccountData("m.secret_storage.default_key");return e?e.getContent().key:null}},{key:"setDefaultKeyId",value:function(e){var t=this;return new c.default((function(r){t._baseApis.on("accountData",(function n(o){"m.secret_storage.default_key"===o.getType()&&o.getContent().key===e&&(t._baseApis.removeListener("accountData",n),r())})),t._baseApis.setAccountData("m.secret_storage.default_key",{key:e})}))}},{key:"addKey",value:(R=(0,u.coroutine)(a.default.mark((function e(r,n,o){var i,s,c;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i={algorithm:r},n||(n={}),n.name&&(i.name=n.name),e.t0=r,e.next=e.t0===E?6:22;break;case 6:if(s=new t.Olm.PkDecryption,e.prev=7,!n.passphrase){e.next=17;break}return e.next=11,(0,u.resolve)((0,b.keyFromPassphrase)(n.passphrase));case 11:c=e.sent,i.passphrase={algorithm:"m.pbkdf2",iterations:c.iterations,salt:c.salt},n.encodedkey=(0,k.encodeRecoveryKey)(c.key),i.pubkey=s.init_with_private_key(c.key),e.next=18;break;case 17:n.privkey?(i.pubkey=s.init_with_private_key(n.privkey),n.encodedkey=(0,k.encodeRecoveryKey)(n.privkey)):(i.pubkey=s.generate_key(),n.encodedkey=(0,k.encodeRecoveryKey)(s.get_private_key()));case 18:return e.prev=18,s.free(),e.finish(18);case 21:return e.abrupt("break",23);case 22:throw new Error("Unknown key algorithm "+n.algorithm);case 23:if(!o)do{o=(0,g.randomString)(32)}while(this._baseApis.getAccountData("m.secret_storage.key."+o));return e.next=26,(0,u.resolve)(this._crossSigningInfo.signObject(i,"master"));case 26:return e.next=28,(0,u.resolve)(this._baseApis.setAccountData("m.secret_storage.key."+o,i));case 28:return e.abrupt("return",o);case 29:case"end":return e.stop()}}),e,this,[[7,,18,21]])}))),function(e,t,r){return R.apply(this,arguments)})},{key:"store",value:(x=(0,u.coroutine)(a.default.mark((function e(r,n,o){var i,c,l,d,f,p,h,v,_,g,b;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i={},o){e.next=6;break}if(c=this.getDefaultKeyId()){e.next=5;break}throw new Error("No keys specified and no default key present");case 5:o=[c];case 6:if(0!==o.length){e.next=8;break}throw new Error("Zero keys given to encrypt with!");case 8:l=!0,d=!1,f=void 0,e.prev=11,p=(0,s.default)(o);case 13:if(l=(h=p.next()).done){e.next=30;break}if(v=h.value,_=this._baseApis.getAccountData("m.secret_storage.key."+v)){e.next=18;break}throw new Error("Unknown key: "+v);case 18:g=_.getContent(),(0,y.pkVerify)(g,this._crossSigningInfo.getId("master"),this._crossSigningInfo.userId),e.t0=g.algorithm,e.next=e.t0===E?23:26;break;case 23:b=new t.Olm.PkEncryption;try{b.set_recipient_key(g.pubkey),i[v]=b.encrypt(n)}finally{b.free()}return e.abrupt("break",27);case 26:m.default.warn("unknown algorithm for secret storage key "+v+": "+g.algorithm);case 27:l=!0,e.next=13;break;case 30:e.next=36;break;case 32:e.prev=32,e.t1=e.catch(11),d=!0,f=e.t1;case 36:e.prev=36,e.prev=37,!l&&p.return&&p.return();case 39:if(e.prev=39,!d){e.next=42;break}throw f;case 42:return e.finish(39);case 43:return e.finish(36);case 44:return e.next=46,(0,u.resolve)(this._baseApis.setAccountData(r,{encrypted:i}));case 46:case"end":return e.stop()}}),e,this,[[11,32,36,44],[37,,39,43]])}))),function(e,t,r){return x.apply(this,arguments)})},{key:"get",value:(S=(0,u.coroutine)(a.default.mark((function e(t){var r,n,c,l,d,f,p,h,v,m,y,_,g,b,k,w;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this._baseApis.getAccountData(t)){e.next=3;break}return e.abrupt("return");case 3:if((n=r.getContent()).encrypted){e.next=6;break}throw new Error("Content is not encrypted!");case 6:c={},l=!0,d=!1,f=void 0,e.prev=10,p=(0,s.default)((0,o.default)(n.encrypted));case 12:if(l=(h=p.next()).done){e.next=24;break}v=h.value,m=this._baseApis.getAccountData("m.secret_storage.key."+v).getContent(),y=n.encrypted[v],e.t0=m.algorithm,e.next=e.t0===E?19:21;break;case 19:return m.pubkey&&y.ciphertext&&y.mac&&y.ephemeral&&(c[v]=m),e.abrupt("break",21);case 21:l=!0,e.next=12;break;case 24:e.next=30;break;case 26:e.prev=26,e.t1=e.catch(10),d=!0,f=e.t1;case 30:e.prev=30,e.prev=31,!l&&p.return&&p.return();case 33:if(e.prev=33,!d){e.next=36;break}throw f;case 36:return e.finish(33);case 37:return e.finish(30);case 38:return _=void 0,g=void 0,e.prev=40,e.next=43,(0,u.resolve)(this._getSecretStorageKey(c));case 43:b=e.sent,k=(0,i.default)(b,2),_=k[0],g=k[1],w=n.encrypted[_],e.t2=c[_].algorithm,e.next=e.t2===E?51:52;break;case 51:return e.abrupt("return",g.decrypt(w.ephemeral,w.mac,w.ciphertext));case 52:return e.prev=52,g&&g.free(),e.finish(52);case 55:case"end":return e.stop()}}),e,this,[[10,26,30,38],[31,,33,37],[40,,52,55]])}))),function(e){return S.apply(this,arguments)})},{key:"isStored",value:function(e,t){var r=this._baseApis.getAccountData(e);if(!r)return!1;void 0===t&&(t=!0);var n=r.getContent();if(!n.encrypted)return!1;var i=!0,a=!1,u=void 0;try{for(var c,l=(0,s.default)((0,o.default)(n.encrypted));!(i=(c=l.next()).done);i=!0){var d=c.value,f=this._baseApis.getAccountData("m.secret_storage.key."+d).getContent(),p=n.encrypted[d];switch(t&&(0,y.pkVerify)(f,this._crossSigningInfo.getId("master"),this._crossSigningInfo.userId),f.algorithm){case E:if(f.pubkey&&p.ciphertext&&p.mac&&p.ephemeral)return!0}}}catch(e){a=!0,u=e}finally{try{!i&&l.return&&l.return()}finally{if(a)throw u}}return!1}},{key:"request",value:function(e,t){var r=this,o=this._baseApis.makeTxnId(),i=this._requests[o]={devices:t},a=new c.default((function(e,t){i.resolve=e,i.reject=t})),u={name:e,action:"request",requesting_device_id:this._baseApis.deviceId,request_id:o},l={},d=!0,f=!1,p=void 0;try{for(var h,v=(0,s.default)(t);!(d=(h=v.next()).done);d=!0){l[h.value]=u}}catch(e){f=!0,p=e}finally{try{!d&&v.return&&v.return()}finally{if(f)throw p}}return this._baseApis.sendToDevice("m.secret.request",(0,n.default)({},this._baseApis.getUserId(),l)),{request_id:o,promise:a,cancel:function(e){var a={action:"request_cancellation",requesting_device_id:r._baseApis.deviceId,request_id:o},u={},c=!0,l=!1,d=void 0;try{for(var f,p=(0,s.default)(t);!(c=(f=p.next()).done);c=!0){u[f.value]=a}}catch(e){l=!0,d=e}finally{try{!c&&p.return&&p.return()}finally{if(l)throw d}}r._baseApis.sendToDevice("m.secret.request",(0,n.default)({},r._baseApis.getUserId(),u)),i.reject(new Error(e||"Cancelled"))}}}},{key:"_onRequestReceived",value:(w=(0,u.coroutine)(a.default.mark((function e(t){var r,o,i,s,c,l,d;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.getSender(),o=t.getContent(),r===this._baseApis.getUserId()&&o.name&&o.action&&o.requesting_device_id&&o.request_id){e.next=4;break}return e.abrupt("return");case 4:if(i=o.requesting_device_id,"request_cancellation"!==o.action){e.next=9;break}this._incomingRequests[i]&&this._incomingRequests[i][o.request_id]&&(m.default.info("received request cancellation for secret ("+r+", "+i+", "+o.request_id+")"),this.baseApis.emit("crypto.secrets.requestCancelled",{user_id:r,device_id:i,request_id:o.request_id})),e.next=40;break;case 9:if("request"!==o.action){e.next=40;break}if(i!==this._baseApis.deviceId){e.next=12;break}return e.abrupt("return");case 12:if(m.default.info("received request for secret ("+r+", "+i+", "+o.request_id+")"),this._cryptoCallbacks.onSecretRequested){e.next=15;break}return e.abrupt("return");case 15:return e.next=17,(0,u.resolve)(this._cryptoCallbacks.onSecretRequested({user_id:r,device_id:i,request_id:o.request_id,name:o.name,device_trust:this._baseApis.checkDeviceTrust(r,i)}));case 17:if(!(s=e.sent)){e.next=40;break}return c={type:"m.secret.send",content:{request_id:o.request_id,secret:s}},l={algorithm:_.default.OLM_ALGORITHM,sender_key:this._baseApis._crypto._olmDevice.deviceCurve25519Key,ciphertext:{}},e.t0=u.resolve,e.t1=_.default,e.t2=this._baseApis._crypto._olmDevice,e.t3=this._baseApis,e.t4=n.default,e.t5={},e.t6=r,e.next=30,(0,u.resolve)(this._baseApis.getStoredDevice(r,i));case 30:return e.t7=e.sent,e.t8=[e.t7],e.t9=(0,e.t4)(e.t5,e.t6,e.t8),e.t10=e.t1.ensureOlmSessionsForDevices.call(e.t1,e.t2,e.t3,e.t9),e.next=36,(0,e.t0)(e.t10);case 36:return e.next=38,(0,u.resolve)(_.default.encryptMessageForDevice(l.ciphertext,this._baseApis.getUserId(),this._baseApis.deviceId,this._baseApis._crypto._olmDevice,r,this._baseApis._crypto.getStoredDevice(r,i),c));case 38:d=(0,n.default)({},r,(0,n.default)({},i,l)),this._baseApis.sendToDevice("m.room.encrypted",d);case 40:case"end":return e.stop()}}),e,this)}))),function(e){return w.apply(this,arguments)})},{key:"_onSecretReceived",value:function(e){if(e.getSender()===this._baseApis.getUserId()){var t=e.getContent();m.default.log("got secret share for request ",t.request_id);var r=this._requests[t.request_id];if(r){var n=this._baseApis._crypto._deviceList.getDeviceByIdentityKey(_.default.OLM_ALGORITHM,e.getSenderKey());if(!n)return void m.default.log("secret share from unknown device with key",e.getSenderKey());if(!r.devices.includes(n.deviceId))return void m.default.log("unsolicited secret share from device",n.deviceId);r.resolve(t.secret)}}}},{key:"_getSecretStorageKey",value:(v=(0,u.coroutine)(a.default.mark((function e(r){var n,o,s,l,d,f;return a.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._cryptoCallbacks.getSecretStorageKey){e.next=2;break}throw new Error("No getSecretStorageKey callback supplied");case 2:return e.next=4,(0,u.resolve)(c.default.resolve(this._cryptoCallbacks.getSecretStorageKey({keys:r})));case 4:if(n=e.sent){e.next=7;break}throw new Error("getSecretStorageKey callback returned falsey");case 7:if(!(n.length<2)){e.next=9;break}throw new Error("getSecretStorageKey callback returned invalid data");case 9:if(o=(0,i.default)(n,2),s=o[0],l=o[1],r[s]){e.next=12;break}throw new Error("App returned unknown key from getSecretStorageKey!");case 12:e.t0=r[s].algorithm,e.next=e.t0===E?15:29;break;case 15:d=new t.Olm.PkDecryption,f=void 0,e.prev=17,f=d.init_with_private_key(l),e.next=25;break;case 21:throw e.prev=21,e.t1=e.catch(17),d.free(),new Error("getSecretStorageKey callback returned invalid key");case 25:if(f===r[s].pubkey){e.next=28;break}throw d.free(),new Error("getSecretStorageKey callback returned incorrect key");case 28:return e.abrupt("return",[s,d]);case 29:throw new Error("Unknown key type: "+r[s].algorithm);case 30:case"end":return e.stop()}}),e,this,[[17,21]])}))),function(e){return v.apply(this,arguments)})}]),r}(v.EventEmitter);r.default=S}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":37,"../randomstring":52,"./key_passphrase":20,"./olmlib":21,"./recoverykey":22,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/object/get-prototype-of":81,"babel-runtime/core-js/object/keys":82,"babel-runtime/core-js/promise":85,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,"babel-runtime/helpers/defineProperty":94,"babel-runtime/helpers/inherits":95,"babel-runtime/helpers/possibleConstructorReturn":96,"babel-runtime/helpers/slicedToArray":97,"babel-runtime/regenerator":100,bluebird:103,events:257}],14:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.UnknownDeviceError=r.DecryptionError=r.DecryptionAlgorithm=r.EncryptionAlgorithm=r.DECRYPTION_CLASSES=r.ENCRYPTION_CLASSES=void 0;var n=l(e("babel-runtime/core-js/object/keys")),o=l(e("babel-runtime/core-js/object/get-prototype-of")),i=l(e("babel-runtime/helpers/possibleConstructorReturn")),s=l(e("babel-runtime/helpers/inherits")),a=l(e("babel-runtime/helpers/classCallCheck")),u=l(e("babel-runtime/helpers/createClass"));r.registerAlgorithm=function(e,t,r){d[e]=t,f[e]=r};var c=l(e("bluebird"));function l(e){return e&&e.__esModule?e:{default:e}}var d=r.ENCRYPTION_CLASSES={},f=r.DECRYPTION_CLASSES={},p=function(){function e(t){(0,a.default)(this,e),this._userId=t.userId,this._deviceId=t.deviceId,this._crypto=t.crypto,this._olmDevice=t.olmDevice,this._baseApis=t.baseApis,this._roomId=t.roomId}return(0,u.default)(e,[{key:"onRoomMembership",value:function(e,t,r){}}]),e}();r.EncryptionAlgorithm=p;var h=function(){function e(t){(0,a.default)(this,e),this._userId=t.userId,this._crypto=t.crypto,this._olmDevice=t.olmDevice,this._baseApis=t.baseApis,this._roomId=t.roomId}return(0,u.default)(e,[{key:"onRoomKeyEvent",value:function(e){}},{key:"importRoomKey",value:function(e){}},{key:"hasKeysForKeyRequest",value:function(e){return c.default.resolve(!1)}},{key:"shareKeysWithDevice",value:function(e){throw new Error("shareKeysWithDevice not supported for this DecryptionAlgorithm")}}]),e}();r.DecryptionAlgorithm=h;var v=function(e){function t(e,r,s){(0,a.default)(this,t);var u=(0,i.default)(this,(t.__proto__||(0,o.default)(t)).call(this,r));return u.code=e,u.name="DecryptionError",u.detailedString=function(e,t){var r=e.name+"[msg: "+e.message;t&&(r+=", "+(0,n.default)(t).map((function(e){return e+": "+t[e]})).join(", "));return r+="]"}(u,s),u}return(0,s.default)(t,e),t}(Error);r.DecryptionError=v;r.UnknownDeviceError=function(e){function t(e,r){(0,a.default)(this,t);var n=(0,i.default)(this,(t.__proto__||(0,o.default)(t)).call(this,e));return n.name="UnknownDeviceError",n.devices=r,n}return(0,s.default)(t,e),t}(Error)},{"babel-runtime/core-js/object/get-prototype-of":81,"babel-runtime/core-js/object/keys":82,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,"babel-runtime/helpers/inherits":95,"babel-runtime/helpers/possibleConstructorReturn":96,bluebird:103}],15:[function(e,t,r){"use strict";var n=e("./base");e("./olm"),e("./megolm"),t.exports.ENCRYPTION_CLASSES=n.ENCRYPTION_CLASSES,t.exports.DECRYPTION_CLASSES=n.DECRYPTION_CLASSES,t.exports.DecryptionError=n.DecryptionError},{"./base":14,"./megolm":16,"./olm":17}],16:[function(e,t,r){"use strict";var n=p(e("babel-runtime/helpers/toConsumableArray")),o=p(e("babel-runtime/core-js/set")),i=p(e("babel-runtime/core-js/json/stringify")),s=p(e("babel-runtime/helpers/defineProperty")),a=p(e("babel-runtime/core-js/object/keys")),u=p(e("babel-runtime/core-js/get-iterator")),c=p(e("babel-runtime/regenerator")),l=e("bluebird"),d=p(l),f=p(e("../../logger"));function p(e){return e&&e.__esModule?e:{default:e}}var h,v,m,y,_,g,b=e("../../utils"),k=e("../olmlib"),w=e("./base");function E(e){this.sessionId=e,this.useCount=0,this.creationTime=(new Date).getTime(),this.sharedWithDevices={}}function S(e){w.EncryptionAlgorithm.call(this,e),this._setupPromise=d.default.resolve(),this._outboundSessions={},this._sessionRotationPeriodMsgs=100,this._sessionRotationPeriodMs=6048e5,void 0!==e.config.rotation_period_ms&&(this._sessionRotationPeriodMs=e.config.rotation_period_ms),void 0!==e.config.rotation_period_msgs&&(this._sessionRotationPeriodMsgs=e.config.rotation_period_msgs)}function x(e){w.DecryptionAlgorithm.call(this,e),this._pendingEvents={},this.olmlib=k}E.prototype.needsRotation=function(e,t){var r=(new Date).getTime()-this.creationTime;return(this.useCount>=e||r>=t)&&(f.default.log("Rotating megolm session after "+this.useCount+" messages, "+r+"ms"),!0)},E.prototype.markSharedWithDevice=function(e,t,r){this.sharedWithDevices[e]||(this.sharedWithDevices[e]={}),this.sharedWithDevices[e][t]=r},E.prototype.sharedWithTooManyDevices=function(e){for(var t in this.sharedWithDevices)if(this.sharedWithDevices.hasOwnProperty(t)){if(!e.hasOwnProperty(t))return f.default.log("Starting new session because we shared with "+t),!0;for(var r in this.sharedWithDevices[t])if(this.sharedWithDevices[t].hasOwnProperty(r)&&!e[t].hasOwnProperty(r))return f.default.log("Starting new session because we shared with "+t+":"+r),!0}},b.inherits(S,w.EncryptionAlgorithm),S.prototype._ensureOutboundSession=function(e){var t,r=(t=(0,l.coroutine)(c.default.mark((function t(r){var i,s,a,u,d;return c.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if((o=r)&&o.needsRotation(n._sessionRotationPeriodMsgs,n._sessionRotationPeriodMs)&&(f.default.log("Starting new megolm session because we need to rotate."),o=null),o&&o.sharedWithTooManyDevices(e)&&(o=null),o){t.next=9;break}return f.default.log("Starting new megolm session for room "+n._roomId),t.next=7,(0,l.resolve)(n._prepareNewSession());case 7:o=t.sent,n._outboundSessions[o.sessionId]=o;case 9:i={},t.t0=c.default.keys(e);case 11:if((t.t1=t.t0()).done){t.next=30;break}if(s=t.t1.value,e.hasOwnProperty(s)){t.next=15;break}return t.abrupt("continue",11);case 15:a=e[s],t.t2=c.default.keys(a);case 17:if((t.t3=t.t2()).done){t.next=28;break}if(u=t.t3.value,a.hasOwnProperty(u)){t.next=21;break}return t.abrupt("continue",17);case 21:if((d=a[u]).getIdentityKey()!=n._olmDevice.deviceCurve25519Key){t.next=25;break}return t.abrupt("continue",17);case 25:o.sharedWithDevices[s]&&void 0!==o.sharedWithDevices[s][u]||(i[s]=i[s]||[],i[s].push(d)),t.next=17;break;case 28:t.next=11;break;case 30:return t.abrupt("return",n._shareKeyWithDevices(o,i));case 31:case"end":return t.stop()}}),t,this)}))),function(e){return t.apply(this,arguments)}),n=this,o=void 0;function i(){return o}var s=this._setupPromise.then(r);return this._setupPromise=s.then(i,i),s.then(i)},S.prototype._prepareNewSession=(0,l.coroutine)(c.default.mark((function e(){var t,r;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._olmDevice.createOutboundGroupSession(),r=this._olmDevice.getOutboundGroupSessionKey(t),e.next=4,(0,l.resolve)(this._olmDevice.addInboundGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,[],t,r.key,{ed25519:this._olmDevice.deviceEd25519Key}));case 4:return this._crypto.backupInfo&&this._crypto.backupGroupSession(this._roomId,this._olmDevice.deviceCurve25519Key,[],t,r.key).catch((function(e){f.default.log("Failed to back up group session",e)})),e.abrupt("return",new E(t));case 6:case"end":return e.stop()}}),e,this)}))),S.prototype._splitUserDeviceMap=function(e,t,r,n){var o=[],i=0,s=0,c=!0,l=!1,d=void 0;try{for(var p,h=(0,u.default)((0,a.default)(n));!(c=(p=h.next()).done);c=!0)for(var v=p.value,m=n[v],y=r[v],_=0;_<m.length;_++){var g=m[_],b=g.deviceId;y[b].sessionId?(f.default.log("share keys with device "+v+":"+b),s>20&&(s=0,i++),o[i]||(o[i]=[]),o[i].push({userId:v,deviceInfo:g}),s++):e.markSharedWithDevice(v,b,t)}}catch(e){l=!0,d=e}finally{try{!c&&h.return&&h.return()}finally{if(l)throw d}}return o},S.prototype._encryptAndSendKeysToDevices=function(e,t,r,n){for(var o=this,i={algorithm:k.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},s={},c=[],l=0;l<r.length;l++){var f=r[l],p=f.userId,h=f.deviceInfo,v=h.deviceId;s[p]||(s[p]={}),s[p][v]=i,c.push(k.encryptMessageForDevice(i.ciphertext,this._userId,this._deviceId,this._olmDevice,p,h,n))}return d.default.all(c).then((function(){return o._baseApis.sendToDevice("m.room.encrypted",s).then((function(){var r=!0,n=!1,o=void 0;try{for(var i,c=(0,u.default)((0,a.default)(s));!(r=(i=c.next()).done);r=!0){var l=i.value,d=!0,f=!1,p=void 0;try{for(var h,v=(0,u.default)((0,a.default)(s[l]));!(d=(h=v.next()).done);d=!0){var m=h.value;e.markSharedWithDevice(l,m,t)}}catch(e){f=!0,p=e}finally{try{!d&&v.return&&v.return()}finally{if(f)throw p}}}}catch(e){n=!0,o=e}finally{try{!r&&c.return&&c.return()}finally{if(n)throw o}}}))}))},S.prototype.reshareKeyWithDevice=(h=(0,l.coroutine)(c.default.mark((function e(t,r,n,o){var i,a,u,d,p;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=this._outboundSessions[r]){e.next=4;break}return f.default.debug("Session ID "+r+" not found: not re-sharing keys"),e.abrupt("return");case 4:if(void 0!==i.sharedWithDevices[n]){e.next=7;break}return f.default.debug("Session ID "+r+" never shared with user "+n),e.abrupt("return");case 7:if(void 0!==(a=i.sharedWithDevices[n][o.deviceId])){e.next=11;break}return f.default.debug("Session ID "+r+" never shared with device "+n+":"+o.deviceId),e.abrupt("return");case 11:return e.next=13,(0,l.resolve)(this._olmDevice.getInboundGroupSessionKey(this._roomId,t,r,a));case 13:if(u=e.sent){e.next=17;break}return f.default.warn("No outbound session key found for "+r+": not re-sharing keys"),e.abrupt("return");case 17:return e.next=19,(0,l.resolve)(k.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,(0,s.default)({},n,(0,s.default)({},o.deviceId,o))));case 19:return d={type:"m.forwarded_room_key",content:{algorithm:k.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:r,session_key:u.key,chain_index:u.chain_index,sender_key:t,sender_claimed_ed25519_key:u.sender_claimed_ed25519_key,forwarding_curve25519_key_chain:u.forwarding_curve25519_key_chain}},p={algorithm:k.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},e.next=23,(0,l.resolve)(k.encryptMessageForDevice(p.ciphertext,this._userId,this._deviceId,this._olmDevice,n,o,d));case 23:return e.next=25,(0,l.resolve)(this._baseApis.sendToDevice("m.room.encrypted",(0,s.default)({},n,(0,s.default)({},o.deviceId,p))));case 25:f.default.debug("Re-shared key for session "+r+"  with "+n+":"+o.deviceId);case 26:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n){return h.apply(this,arguments)}),S.prototype._shareKeyWithDevices=(v=(0,l.coroutine)(c.default.mark((function e(t,r){var n,o,i,s,a;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._olmDevice.getOutboundGroupSessionKey(t.sessionId),o={type:"m.room_key",content:{algorithm:k.MEGOLM_ALGORITHM,room_id:this._roomId,session_id:t.sessionId,session_key:n.key,chain_index:n.chain_index}},e.next=4,(0,l.resolve)(k.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,r));case 4:i=e.sent,s=this._splitUserDeviceMap(t,n.chain_index,i,r),a=0;case 7:if(!(a<s.length)){e.next=21;break}return e.prev=8,e.next=11,(0,l.resolve)(this._encryptAndSendKeysToDevices(t,n.chain_index,s[a],o));case 11:f.default.log("Completed megolm keyshare in "+this._roomId+" (slice "+(a+1)+"/"+s.length+")"),e.next=18;break;case 14:throw e.prev=14,e.t0=e.catch(8),f.default.log("megolm keyshare in "+this._roomId+" (slice "+(a+1)+"/"+s.length+") failed"),e.t0;case 18:a++,e.next=7;break;case 21:case"end":return e.stop()}}),e,this,[[8,14]])}))),function(e,t){return v.apply(this,arguments)}),S.prototype.encryptMessage=function(e,t,r){var n=this;return f.default.log("Starting to encrypt event for "+this._roomId),this._getDevicesInRoom(e).then((function(e){return n._checkForUnknownDevices(e),n._ensureOutboundSession(e)})).then((function(e){var o={room_id:n._roomId,type:t,content:r},s=n._olmDevice.encryptGroupMessage(e.sessionId,(0,i.default)(o)),a={algorithm:k.MEGOLM_ALGORITHM,sender_key:n._olmDevice.deviceCurve25519Key,ciphertext:s,session_id:e.sessionId,device_id:n._deviceId};return e.useCount++,a}))},S.prototype.forceDiscardSession=function(){this._setupPromise=this._setupPromise.then((function(){return null}))},S.prototype._checkForUnknownDevices=function(e){var t={};if((0,a.default)(e).forEach((function(r){(0,a.default)(e[r]).forEach((function(n){var o=e[r][n];o.isUnverified()&&!o.isKnown()&&(t[r]||(t[r]={}),t[r][n]=o)}))})),(0,a.default)(t).length)throw new w.UnknownDeviceError("This room contains unknown devices which have not been verified. We strongly recommend you verify them before continuing.",t)},S.prototype._getDevicesInRoom=(m=(0,l.coroutine)(c.default.mark((function e(t){var r,n,o,i,s,a,u;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,l.resolve)(t.getEncryptionTargetMembers());case 2:return r=e.sent,n=b.map(r,(function(e){return e.userId})),o=this._crypto.getGlobalBlacklistUnverifiedDevices(),"boolean"==typeof t.getBlacklistUnverifiedDevices()&&(o=t.getBlacklistUnverifiedDevices()),e.next=8,(0,l.resolve)(this._crypto.downloadKeys(n,!1));case 8:i=e.sent,e.t0=c.default.keys(i);case 10:if((e.t1=e.t0()).done){e.next=25;break}if(s=e.t1.value,i.hasOwnProperty(s)){e.next=14;break}return e.abrupt("continue",10);case 14:a=i[s],e.t2=c.default.keys(a);case 16:if((e.t3=e.t2()).done){e.next=23;break}if(u=e.t3.value,a.hasOwnProperty(u)){e.next=20;break}return e.abrupt("continue",16);case 20:(a[u].isBlocked()||a[u].isUnverified()&&o)&&delete a[u],e.next=16;break;case 23:e.next=10;break;case 25:return e.abrupt("return",i);case 26:case"end":return e.stop()}}),e,this)}))),function(e){return m.apply(this,arguments)}),b.inherits(x,w.DecryptionAlgorithm),x.prototype.decryptEvent=(y=(0,l.coroutine)(c.default.mark((function e(t){var r,n,o,i;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if((r=t.getWireContent()).sender_key&&r.session_id&&r.ciphertext){e.next=3;break}throw new w.DecryptionError("MEGOLM_MISSING_FIELDS","Missing fields in input");case 3:return this._addEventToPendingList(t),n=void 0,e.prev=5,e.next=8,(0,l.resolve)(this._olmDevice.decryptGroupMessage(t.getRoomId(),r.sender_key,r.session_id,r.ciphertext,t.getId(),t.getTs()));case 8:n=e.sent,e.next=16;break;case 11:throw e.prev=11,e.t0=e.catch(5),o="OLM_DECRYPT_GROUP_MESSAGE_ERROR",e.t0&&"OLM.UNKNOWN_MESSAGE_INDEX"===e.t0.message&&(this._requestKeysForEvent(t),o="OLM_UNKNOWN_MESSAGE_INDEX"),new w.DecryptionError(o,e.t0?e.t0.toString():"Unknown Error: Error is undefined",{session:r.sender_key+"|"+r.session_id});case 16:if(null!==n){e.next=19;break}throw this._requestKeysForEvent(t),new w.DecryptionError("MEGOLM_UNKNOWN_INBOUND_SESSION_ID","The sender's device has not sent us the keys for this message.",{session:r.sender_key+"|"+r.session_id});case 19:if(this._removeEventFromPendingList(t),(i=JSON.parse(n.result)).room_id===t.getRoomId()){e.next=23;break}throw new w.DecryptionError("MEGOLM_BAD_ROOM","Message intended for room "+i.room_id);case 23:return e.abrupt("return",{clearEvent:i,senderCurve25519Key:n.senderKey,claimedEd25519Key:n.keysClaimed.ed25519,forwardingCurve25519KeyChain:n.forwardingCurve25519KeyChain});case 24:case"end":return e.stop()}}),e,this,[[5,11]])}))),function(e){return y.apply(this,arguments)}),x.prototype._requestKeysForEvent=function(e){var t=e.getWireContent(),r=e.getKeyRequestRecipients(this._userId);this._crypto.requestRoomKey({room_id:e.getRoomId(),algorithm:t.algorithm,sender_key:t.sender_key,session_id:t.session_id},r)},x.prototype._addEventToPendingList=function(e){var t=e.getWireContent(),r=t.sender_key+"|"+t.session_id;this._pendingEvents[r]||(this._pendingEvents[r]=new o.default),this._pendingEvents[r].add(e)},x.prototype._removeEventFromPendingList=function(e){var t=e.getWireContent(),r=t.sender_key+"|"+t.session_id;this._pendingEvents[r]&&(this._pendingEvents[r].delete(e),0===this._pendingEvents[r].size&&delete this._pendingEvents[r])},x.prototype.onRoomKeyEvent=function(e){var t=this,r=e.getContent(),n=r.session_id,o=e.getSenderKey(),i=[],s=!1,a=void 0;if(r.room_id&&n&&r.session_key){if(o){if("m.forwarded_room_key"==e.getType()){if(s=!0,i=r.forwarding_curve25519_key_chain,b.isArray(i)||(i=[]),(i=i.slice()).push(o),!(o=r.sender_key))return void f.default.error("forwarded_room_key event is missing sender_key field");var u=r.sender_claimed_ed25519_key;if(!u)return void f.default.error("forwarded_room_key_event is missing sender_claimed_ed25519_key field");a={ed25519:u}}else a=e.getKeysClaimed();return f.default.log("Adding key for megolm session "+o+"|"+n),this._olmDevice.addInboundGroupSession(r.room_id,o,i,n,r.session_key,a,s).then((function(){t._retryDecryption(o,n).then((function(e){e&&t._crypto.cancelRoomKeyRequest({algorithm:r.algorithm,room_id:r.room_id,session_id:r.session_id,sender_key:o})}))})).then((function(){t._crypto.backupInfo&&t._crypto.backupGroupSession(r.room_id,o,i,r.session_id,r.session_key,a,s).catch((function(e){f.default.log("Failed to back up group session",e)}))})).catch((function(e){f.default.error("Error handling m.room_key_event: "+e)}))}f.default.error("key event has no sender key (not encrypted?)")}else f.default.error("key event is missing fields")},x.prototype.hasKeysForKeyRequest=function(e){var t=e.requestBody;return this._olmDevice.hasInboundSessionKeys(t.room_id,t.sender_key,t.session_id)},x.prototype.shareKeysWithDevice=function(e){var t=this,r=e.userId,n=e.deviceId,o=this._crypto.getStoredDevice(r,n),i=e.requestBody;this.olmlib.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,(0,s.default)({},r,[o])).then((function(e){return e[r][n].sessionId?(f.default.log("sharing keys for session "+i.sender_key+"|"+i.session_id+" with device "+r+":"+n),t._buildKeyForwardingMessage(i.room_id,i.sender_key,i.session_id)):null})).then((function(e){var i={algorithm:k.OLM_ALGORITHM,sender_key:t._olmDevice.deviceCurve25519Key,ciphertext:{}};return t.olmlib.encryptMessageForDevice(i.ciphertext,t._userId,t._deviceId,t._olmDevice,r,o,e).then((function(){var e=(0,s.default)({},r,(0,s.default)({},n,i));return t._baseApis.sendToDevice("m.room.encrypted",e)}))})).done()},x.prototype._buildKeyForwardingMessage=(_=(0,l.coroutine)(c.default.mark((function e(t,r,n){var o;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,l.resolve)(this._olmDevice.getInboundGroupSessionKey(t,r,n));case 2:return o=e.sent,e.abrupt("return",{type:"m.forwarded_room_key",content:{algorithm:k.MEGOLM_ALGORITHM,room_id:t,sender_key:r,sender_claimed_ed25519_key:o.sender_claimed_ed25519_key,session_id:n,session_key:o.key,chain_index:o.chain_index,forwarding_curve25519_key_chain:o.forwarding_curve25519_key_chain}});case 4:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return _.apply(this,arguments)}),x.prototype.importRoomKey=function(e){var t=this;return this._olmDevice.addInboundGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0).then((function(){t._crypto.backupInfo&&t._crypto.backupGroupSession(e.room_id,e.sender_key,e.forwarding_curve25519_key_chain,e.session_id,e.session_key,e.sender_claimed_keys,!0).catch((function(e){f.default.log("Failed to back up group session",e)})),t._retryDecryption(e.sender_key,e.session_id)}))},x.prototype._retryDecryption=(g=(0,l.coroutine)(c.default.mark((function e(t,r){var o,i,s=this;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=t+"|"+r,i=this._pendingEvents[o]){e.next=4;break}return e.abrupt("return",!0);case 4:return delete this._pendingEvents[o],e.next=7,(0,l.resolve)(d.default.all([].concat((0,n.default)(i)).map(function(){var e=(0,l.coroutine)(c.default.mark((function e(t){return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,l.resolve)(t.attemptDecryption(s._crypto));case 3:e.next=7;break;case 5:e.prev=5,e.t0=e.catch(0);case 7:case"end":return e.stop()}}),e,s,[[0,5]])})));return function(t){return e.apply(this,arguments)}}())));case 7:return e.abrupt("return",!this._pendingEvents[o]);case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return g.apply(this,arguments)}),w.registerAlgorithm(k.MEGOLM_ALGORITHM,S,x)},{"../../logger":37,"../../utils":65,"../olmlib":21,"./base":14,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/json/stringify":71,"babel-runtime/core-js/object/keys":82,"babel-runtime/core-js/set":89,"babel-runtime/helpers/defineProperty":94,"babel-runtime/helpers/toConsumableArray":98,"babel-runtime/regenerator":100,bluebird:103}],17:[function(e,t,r){"use strict";var n=u(e("babel-runtime/core-js/json/stringify")),o=u(e("babel-runtime/regenerator")),i=e("bluebird"),s=u(i),a=u(e("../../logger"));function u(e){return e&&e.__esModule?e:{default:e}}var c,l,d,f=e("../../utils"),p=e("../olmlib"),h=e("../deviceinfo").DeviceVerification,v=e("./base");function m(e){v.EncryptionAlgorithm.call(this,e),this._sessionPrepared=!1,this._prepPromise=null}function y(e){v.DecryptionAlgorithm.call(this,e)}f.inherits(m,v.EncryptionAlgorithm),m.prototype._ensureSession=function(e){if(this._prepPromise)return this._prepPromise;if(this._sessionPrepared)return s.default.resolve();var t=this;return this._prepPromise=t._crypto.downloadKeys(e).then((function(r){return t._crypto.ensureOlmSessionsForUsers(e)})).then((function(){t._sessionPrepared=!0})).finally((function(){t._prepPromise=null})),this._prepPromise},m.prototype.encryptMessage=(c=(0,i.coroutine)(o.default.mark((function e(t,r,n){var a,u,c,l,d,v,m,y,_,g,b;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.resolve)(t.getEncryptionTargetMembers());case 2:return a=e.sent,u=f.map(a,(function(e){return e.userId})),c=this,e.next=7,(0,i.resolve)(this._ensureSession(u));case 7:l={room_id:t.roomId,type:r,content:n},d={algorithm:p.OLM_ALGORITHM,sender_key:c._olmDevice.deviceCurve25519Key,ciphertext:{}},v=[],m=0;case 11:if(!(m<u.length)){e.next=29;break}y=u[m],_=c._crypto.getStoredDevicesForUser(y),g=0;case 15:if(!(g<_.length)){e.next=26;break}if((b=_[g]).getIdentityKey()!=c._olmDevice.deviceCurve25519Key){e.next=20;break}return e.abrupt("continue",23);case 20:if(b.verified!=h.BLOCKED){e.next=22;break}return e.abrupt("continue",23);case 22:v.push(p.encryptMessageForDevice(d.ciphertext,c._userId,c._deviceId,c._olmDevice,y,b,l));case 23:++g,e.next=15;break;case 26:++m,e.next=11;break;case 29:return e.next=31,(0,i.resolve)(s.default.all(v).return(d));case 31:return e.abrupt("return",e.sent);case 32:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return c.apply(this,arguments)}),f.inherits(y,v.DecryptionAlgorithm),y.prototype.decryptEvent=(l=(0,i.coroutine)(o.default.mark((function e(t){var r,n,s,a,u,c,l;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.getWireContent(),n=r.sender_key,s=r.ciphertext){e.next=5;break}throw new v.DecryptionError("OLM_MISSING_CIPHERTEXT","Missing ciphertext");case 5:if(this._olmDevice.deviceCurve25519Key in s){e.next=7;break}throw new v.DecryptionError("OLM_NOT_INCLUDED_IN_RECIPIENTS","Not included in recipients");case 7:return a=s[this._olmDevice.deviceCurve25519Key],u=void 0,e.prev=9,e.next=12,(0,i.resolve)(this._decryptMessage(n,a));case 12:u=e.sent,e.next=18;break;case 15:throw e.prev=15,e.t0=e.catch(9),new v.DecryptionError("OLM_BAD_ENCRYPTED_MESSAGE","Bad Encrypted Message",{sender:n,err:e.t0});case 18:if((c=JSON.parse(u)).recipient==this._userId){e.next=21;break}throw new v.DecryptionError("OLM_BAD_RECIPIENT","Message was intented for "+c.recipient);case 21:if(c.recipient_keys.ed25519==this._olmDevice.deviceEd25519Key){e.next=23;break}throw new v.DecryptionError("OLM_BAD_RECIPIENT_KEY","Message not intended for this device",{intended:c.recipient_keys.ed25519,our_key:this._olmDevice.deviceEd25519Key});case 23:if(c.sender==t.getSender()){e.next=25;break}throw new v.DecryptionError("OLM_FORWARDED_MESSAGE","Message forwarded from "+c.sender,{reported_sender:t.getSender()});case 25:if(c.room_id===t.getRoomId()){e.next=27;break}throw new v.DecryptionError("OLM_BAD_ROOM","Message intended for room "+c.room_id,{reported_room:t.room_id});case 27:return l=c.keys||{},e.abrupt("return",{clearEvent:c,senderCurve25519Key:n,claimedEd25519Key:l.ed25519||null});case 29:case"end":return e.stop()}}),e,this,[[9,15]])}))),function(e){return l.apply(this,arguments)}),y.prototype._decryptMessage=(d=(0,i.coroutine)(o.default.mark((function e(t,r){var s,u,c,l,d,f;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.resolve)(this._olmDevice.getSessionIdsForDevice(t));case 2:s=e.sent,u={},c=0;case 5:if(!(c<s.length)){e.next=26;break}return l=s[c],e.prev=7,e.next=10,(0,i.resolve)(this._olmDevice.decryptMessage(t,l,r.type,r.body));case 10:return d=e.sent,a.default.log("Decrypted Olm message from "+t+" with session "+l),e.abrupt("return",d);case 15:return e.prev=15,e.t0=e.catch(7),e.next=19,(0,i.resolve)(this._olmDevice.matchesSession(t,l,r.type,r.body));case 19:if(!e.sent){e.next=22;break}throw new Error("Error decrypting prekey message with existing session id "+l+": "+e.t0.message);case 22:u[l]=e.t0.message;case 23:c++,e.next=5;break;case 26:if(0===r.type){e.next=30;break}if(0!==s.length){e.next=29;break}throw new Error("No existing sessions");case 29:throw new Error("Error decrypting non-prekey message with existing sessions: "+(0,n.default)(u));case 30:return f=void 0,e.prev=31,e.next=34,(0,i.resolve)(this._olmDevice.createInboundSession(t,r.type,r.body));case 34:f=e.sent,e.next=41;break;case 37:throw e.prev=37,e.t1=e.catch(31),u["(new)"]=e.t1.message,new Error("Error decrypting prekey message: "+(0,n.default)(u));case 41:return a.default.log("created new inbound Olm session ID "+f.session_id+" with "+t),e.abrupt("return",f.payload);case 43:case"end":return e.stop()}}),e,this,[[7,15],[31,37]])}))),function(e,t){return d.apply(this,arguments)}),v.registerAlgorithm(p.OLM_ALGORITHM,m,y)},{"../../logger":37,"../../utils":65,"../deviceinfo":18,"../olmlib":21,"./base":14,"babel-runtime/core-js/json/stringify":71,"babel-runtime/regenerator":100,bluebird:103}],18:[function(e,t,r){"use strict";function n(e){Object.defineProperty(this,"deviceId",{enumerable:!0,value:e}),this.algorithms=[],this.keys={},this.verified=o.UNVERIFIED,this.known=!1,this.unsigned={},this.signatures={}}n.fromStorage=function(e,t){var r=new n(t);for(var o in e)e.hasOwnProperty(o)&&(r[o]=e[o]);return r},n.prototype.toStorage=function(){return{algorithms:this.algorithms,keys:this.keys,verified:this.verified,known:this.known,unsigned:this.unsigned,signatures:this.signatures}},n.prototype.getFingerprint=function(){return this.keys["ed25519:"+this.deviceId]},n.prototype.getIdentityKey=function(){return this.keys["curve25519:"+this.deviceId]},n.prototype.getDisplayName=function(){return this.unsigned.device_display_name||null},n.prototype.isBlocked=function(){return this.verified==o.BLOCKED},n.prototype.isVerified=function(){return this.verified==o.VERIFIED},n.prototype.isUnverified=function(){return this.verified==o.UNVERIFIED},n.prototype.isKnown=function(){return 1==this.known},n.DeviceVerification={VERIFIED:1,UNVERIFIED:0,BLOCKED:-1};var o=n.DeviceVerification;t.exports=n},{}],19:[function(e,t,r){(function(t){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.verificationMethods=void 0;var n,o,i=j(e("babel-runtime/helpers/classCallCheck")),s=j(e("babel-runtime/core-js/set")),a=e("bluebird"),u=j(a),c=j(e("babel-runtime/core-js/json/stringify")),l=j(e("babel-runtime/helpers/toConsumableArray")),d=j(e("babel-runtime/core-js/object/assign")),f=j(e("babel-runtime/helpers/slicedToArray")),p=j(e("babel-runtime/core-js/object/entries")),h=j(e("babel-runtime/core-js/object/keys")),v=j(e("babel-runtime/regenerator")),m=j(e("babel-runtime/core-js/get-iterator")),y=j(e("babel-runtime/core-js/map")),_=j(e("babel-runtime/helpers/defineProperty")),g=(o=(0,a.coroutine)(v.default.mark((function e(t){var r,n,o,i,s,c;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,a.resolve)(t._olmDevice.getOneTimeKeys());case 2:for(i in r=e.sent,n={},o=[],r.curve25519)r.curve25519.hasOwnProperty(i)&&(s={key:r.curve25519[i]},n["signed_curve25519:"+i]=s,o.push(t._signObject(s)));return e.next=8,(0,a.resolve)(u.default.all(o));case 8:return e.next=10,(0,a.resolve)(t._baseApis.uploadKeysRequest({one_time_keys:n},{device_id:t._deviceId}));case 10:return c=e.sent,e.next=13,(0,a.resolve)(t._olmDevice.markKeysAsPublished());case 13:return e.abrupt("return",c);case 14:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)});r.isCryptoAvailable=function(){return Boolean(t.Olm)},r.default=fe;var b=e("events"),k=j(e("../ReEmitter")),w=j(e("../logger")),E=e("../randomstring"),S=e("./CrossSigning"),x=j(e("./SecretStorage")),R=j(e("./OutgoingRoomKeyRequestManager")),T=j(e("./store/indexeddb-crypto-store")),I=e("./verification/QRCode"),C=j(e("./verification/SAS")),O=e("./verification/Error");function j(e){return e&&e.__esModule?e:{default:e}}var A=e("another-json"),D=e("../utils"),M=e("./OlmDevice"),P=e("./olmlib"),U=e("./algorithms"),L=e("./deviceinfo"),F=L.DeviceVerification,N=e("./DeviceList").default,K=(n={},(0,_.default)(n,I.ScanQRCode.NAME,I.ScanQRCode),(0,_.default)(n,I.ShowQRCode.NAME,I.ShowQRCode),(0,_.default)(n,C.default.NAME,C.default),n);r.verificationMethods={QR_CODE_SCAN:I.ScanQRCode.NAME,QR_CODE_SHOW:I.ShowQRCode.NAME,SAS:C.default.NAME};function q(e,t,r){var n=!1;t&&(n=e.isRoomEncrypted(t)),n&&e.on("Event.decrypted",r),e.on("event",r);var o=!0;return function(){return o&&(n&&e.off("Event.decrypted",r),e.off("event",r),o=!1),null}}var B,G,V,$,W,H,z,Y,Q,X,J,Z,ee,te,re,ne,oe,ie,se,ae,ue,ce,le,de;function fe(e,t,r,n,o,i,s,a){if(this._onDeviceListUserCrossSigningUpdated=this._onDeviceListUserCrossSigningUpdated.bind(this),this._reEmitter=new k.default(this),this._baseApis=e,this._sessionStore=t,this._userId=r,this._deviceId=n,this._clientStore=o,this._cryptoStore=i,this._roomList=s,this._verificationMethods=new y.default,a){var u=!0,c=!1,l=void 0;try{for(var d,f=(0,m.default)(a);!(u=(d=f.next()).done);u=!0){var p=d.value;"string"==typeof p?K[p]&&this._verificationMethods.set(p,K[p]):p.NAME&&this._verificationMethods.set(p.NAME,p)}}catch(e){c=!0,l=e}finally{try{!u&&f.return&&f.return()}finally{if(c)throw l}}}this.backupInfo=null,this.backupKey=null,this._checkedForBackup=!1,this._sendingBackups=!1,this._olmDevice=new M(i),this._deviceList=new N(e,i,this._olmDevice),this._deviceList.on("userCrossSigningUpdated",this._onDeviceListUserCrossSigningUpdated),this._reEmitter.reEmit(this._deviceList,["crypto.devicesUpdated"]),this._lastOneTimeKeyCheck=null,this._oneTimeKeyCheckInProgress=!1,this._roomEncryptors={},this._roomDecryptors={},this._supportedAlgorithms=D.keys(U.DECRYPTION_CLASSES),this._deviceKeys={},this._globalBlacklistUnverifiedDevices=!1,this._outgoingRoomKeyRequestManager=new R.default(e,this._deviceId,this._cryptoStore),this._receivedRoomKeyRequests=[],this._receivedRoomKeyRequestCancellations=[],this._processingRoomKeyRequests=!1,this._lazyLoadMembers=!1,this._roomDeviceTrackingState={},this._lastNewSessionForced={},this._verificationTransactions=new y.default,this._crossSigningInfo=new S.CrossSigningInfo(r,this._baseApis._cryptoCallbacks),this._secretStorage=new x.default(e,this._baseApis._cryptoCallbacks,this._crossSigningInfo)}function pe(e){var t=5;if(!e._oneTimeKeyCheckInProgress){var r=Date.now();if(!(null!==e._lastOneTimeKeyCheck&&r-e._lastOneTimeKeyCheck<6e4)){e._lastOneTimeKeyCheck=r;var n=e._olmDevice.maxNumberOfOneTimeKeys(),o=Math.floor(n/2);e._oneTimeKeyCheckInProgress=!0,u.default.resolve().then((function(){return void 0!==e._oneTimeKeyCount?u.default.resolve(e._oneTimeKeyCount):e._baseApis.uploadKeysRequest({},{device_id:e._deviceId}).then((function(e){return e.one_time_key_counts.signed_curve25519||0}))})).then((function(r){return function r(n){if(o<=n)return u.default.resolve();var i=Math.min(o-n,t);return e._olmDevice.generateOneTimeKeys(i).then((function(){return g(e)})).then((function(e){if(e.one_time_key_counts&&e.one_time_key_counts.signed_curve25519)return r(e.one_time_key_counts.signed_curve25519);throw new Error("response for uploading keys does not contain one_time_key_counts.signed_curve25519")}))}(r)})).catch((function(e){w.default.error("Error uploading one-time keys",e.stack||e)})).finally((function(){e._oneTimeKeyCount=void 0,e._oneTimeKeyCheckInProgress=!1})).done()}}}function he(e,t,r,n){return function(o){if(o.getRoomId()===r&&o.getSender()===t&&"m.room.encrypted"!==o.getType()){var i=o.getRelation();i&&i.rel_type&&"m.reference"===i.rel_type&&i.event_id&&i.event_id===n&&e.handleEvent(o)}}}D.inherits(fe,b.EventEmitter),fe.prototype.init=(0,a.coroutine)(v.default.mark((function e(){var r,n,o=this;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return w.default.log("Crypto: initialising Olm..."),e.next=3,(0,a.resolve)(t.Olm.init());case 3:return w.default.log("Crypto: initialising Olm device..."),e.next=6,(0,a.resolve)(this._olmDevice.init());case 6:return w.default.log("Crypto: loading device list..."),e.next=9,(0,a.resolve)(this._deviceList.load());case 9:return this._deviceKeys["ed25519:"+this._deviceId]=this._olmDevice.deviceEd25519Key,this._deviceKeys["curve25519:"+this._deviceId]=this._olmDevice.deviceCurve25519Key,w.default.log("Crypto: fetching own devices..."),(r=this._deviceList.getRawStoredDevicesForUser(this._userId))||(r={}),r[this._deviceId]||(w.default.log("Crypto: adding this device to the store..."),n={keys:this._deviceKeys,algorithms:this._supportedAlgorithms,verified:F.VERIFIED,known:!0},r[this._deviceId]=n,this._deviceList.storeDevicesForUser(this._userId,r),this._deviceList.saveIfDirty()),e.next=17,(0,a.resolve)(this._cryptoStore.doTxn("readonly",[T.default.STORE_ACCOUNT],(function(e){o._cryptoStore.getCrossSigningKeys(e,(function(e){e&&o._crossSigningInfo.setKeys(e)}))})));case 17:this._deviceList.startTrackingDeviceList(this._userId),w.default.log("Crypto: checking for key backup..."),this._checkAndStartKeyBackup();case 20:case"end":return e.stop()}}),e,this)}))),fe.prototype.addSecretKey=function(e,t,r){return this._secretStorage.addKey(e,t,r)},fe.prototype.storeSecret=function(e,t,r){return this._secretStorage.store(e,t,r)},fe.prototype.getSecret=function(e){return this._secretStorage.get(e)},fe.prototype.isSecretStored=function(e,t){return this._secretStorage.isStored(e,t)},fe.prototype.requestSecret=function(e,t){return t||(t=(0,h.default)(this._deviceList.getRawStoredDevicesForUser(this._userId))),this._secretStorage.request(e,t)},fe.prototype.getDefaultSecretStorageKeyId=function(){return this._secretStorage.getDefaultKeyId()},fe.prototype.setDefaultSecretStorageKeyId=function(e){return this._secretStorage.setDefaultKeyId(e)},fe.prototype.checkPrivateKey=function(e,r){var n=null;try{return(n=new t.Olm.PkSigning).init_with_seed(e)===r}finally{n&&n.free()}},fe.prototype.doesCrossSigningHaveKeys=function(){return this._crossSigningInfo.hasKeys()},fe.prototype.resetCrossSigningKeys=(B=(0,a.coroutine)(v.default.mark((function e(t,r){var n,o,i,s,u,c,l,d,y,g,b,k,E,x,R,I,C,O,j,A,D,M,P,U,L,F,N,K,q,B=this;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,a.resolve)(this._crossSigningInfo.resetKeys(r));case 2:return e.next=4,(0,a.resolve)(this._signObject(this._crossSigningInfo.keys.master));case 4:return e.next=6,(0,a.resolve)(this._cryptoStore.doTxn("readwrite",[T.default.STORE_ACCOUNT],(function(e){B._cryptoStore.storeCrossSigningKeys(e,B._crossSigningInfo.keys)})));case 6:for(n={},o=!0,i=!1,s=void 0,e.prev=10,u=(0,m.default)((0,p.default)(this._crossSigningInfo.keys));!(o=(c=u.next()).done);o=!0)l=(0,f.default)(c.value,2),d=l[0],y=l[1],n[d+"_key"]=y;e.next=18;break;case 14:e.prev=14,e.t0=e.catch(10),i=!0,s=e.t0;case 18:e.prev=18,e.prev=19,!o&&u.return&&u.return();case 21:if(e.prev=21,!i){e.next=24;break}throw s;case 24:return e.finish(21);case 25:return e.finish(18);case 26:return e.next=28,(0,a.resolve)(this._baseApis.uploadDeviceSigningKeys(t||{},n));case 28:return this._baseApis.emit("crossSigning.keysChanged",{}),g=this._deviceList.getStoredDevice(this._userId,this._deviceId),e.next=32,(0,a.resolve)(this._crossSigningInfo.signDevice(this._userId,g));case 32:return b=e.sent,e.next=35,(0,a.resolve)(this._baseApis.uploadKeySignatures((0,_.default)({},this._userId,(0,_.default)({},this._deviceId,b))));case 35:k={},E=!0,x=!1,R=void 0,e.prev=39,I=(0,m.default)((0,p.default)(this._deviceList._crossSigningInfo));case 41:if(E=(C=I.next()).done){e.next=50;break}return O=(0,f.default)(C.value,2),j=O[0],A=O[1],e.next=45,(0,a.resolve)(this._checkForDeviceVerificationUpgrade(j,S.CrossSigningInfo.fromStorage(A,j)));case 45:(D=e.sent)&&(k[j]=D);case 47:E=!0,e.next=41;break;case 50:e.next=56;break;case 52:e.prev=52,e.t1=e.catch(39),x=!0,R=e.t1;case 56:e.prev=56,e.prev=57,!E&&I.return&&I.return();case 59:if(e.prev=59,!x){e.next=62;break}throw R;case 62:return e.finish(59);case 63:return e.finish(56);case 64:if(M=this._baseApis._cryptoCallbacks.shouldUpgradeDeviceVerifications,!((0,h.default)(k).length>0&&M)){e.next=103;break}return e.prev=66,e.next=69,(0,a.resolve)(M({users:k}));case 69:if(!(P=e.sent)){e.next=98;break}U=!0,L=!1,F=void 0,e.prev=74,N=(0,m.default)(P);case 76:if(U=(K=N.next()).done){e.next=84;break}if(!((q=K.value)in k)){e.next=81;break}return e.next=81,(0,a.resolve)(this._baseApis.setDeviceVerified(q,k[q].crossSigningInfo.getId()));case 81:U=!0,e.next=76;break;case 84:e.next=90;break;case 86:e.prev=86,e.t2=e.catch(74),L=!0,F=e.t2;case 90:e.prev=90,e.prev=91,!U&&N.return&&N.return();case 93:if(e.prev=93,!L){e.next=96;break}throw F;case 96:return e.finish(93);case 97:return e.finish(90);case 98:e.next=103;break;case 100:e.prev=100,e.t3=e.catch(66),w.default.log("shouldUpgradeDeviceVerifications threw an error: not upgrading",e.t3);case 103:case"end":return e.stop()}}),e,this,[[10,14,18,26],[19,,21,25],[39,52,56,64],[57,,59,63],[66,100],[74,86,90,98],[91,,93,97]])}))),function(e,t){return B.apply(this,arguments)}),fe.prototype._checkForDeviceVerificationUpgrade=(G=(0,a.coroutine)(v.default.mark((function e(t,r){var n,o,i;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this._crossSigningInfo.checkUserTrust(r),!r.firstUse||n.verified){e.next=8;break}return o=this._deviceList.getRawStoredDevicesForUser(t),e.next=5,(0,a.resolve)(this._checkForValidDeviceSignature(t,r.keys.master,o));case 5:if(!(i=e.sent).length){e.next=8;break}return e.abrupt("return",{devices:i.map((function(e){return L.fromStorage(o[e],e)})),crossSigningInfo:r});case 8:case"end":return e.stop()}}),e,this)}))),function(e,t){return G.apply(this,arguments)}),fe.prototype._checkForValidDeviceSignature=(V=(0,a.coroutine)(v.default.mark((function e(t,r,n){var o,i,s,u,c,l,d,p,y,_;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=[],!(n&&r.signatures&&r.signatures[t])){e.next=36;break}i=!0,s=!1,u=void 0,e.prev=5,c=(0,m.default)((0,h.default)(r.signatures[t]));case 7:if(i=(l=c.next()).done){e.next=22;break}if(d=l.value,p=d.split(":",2),y=(0,f.default)(p,2),!((_=y[1])in n&&n[_].verified===F.VERIFIED)){e.next=19;break}return e.prev=11,e.next=14,(0,a.resolve)(P.verifySignature(this._olmDevice,r,t,_,n[_].keys[d]));case 14:o.push(_),e.next=19;break;case 17:e.prev=17,e.t0=e.catch(11);case 19:i=!0,e.next=7;break;case 22:e.next=28;break;case 24:e.prev=24,e.t1=e.catch(5),s=!0,u=e.t1;case 28:e.prev=28,e.prev=29,!i&&c.return&&c.return();case 31:if(e.prev=31,!s){e.next=34;break}throw u;case 34:return e.finish(31);case 35:return e.finish(28);case 36:return e.abrupt("return",o);case 37:case"end":return e.stop()}}),e,this,[[5,24,28,36],[11,17],[29,,31,35]])}))),function(e,t,r){return V.apply(this,arguments)}),fe.prototype.getCrossSigningId=function(e){return this._crossSigningInfo.getId(e)},fe.prototype.getStoredCrossSigningForUser=function(e){return this._deviceList.getStoredCrossSigningForUser(e)},fe.prototype.checkUserTrust=function(e){var t=this._deviceList.getStoredCrossSigningForUser(e);return t?this._crossSigningInfo.checkUserTrust(t):new S.UserTrustLevel(!1,!1)},fe.prototype.checkDeviceTrust=function(e,t){var r=this._deviceList.getStoredDevice(e,t),n=r&&r.isVerified(),o=this._deviceList.getStoredCrossSigningForUser(e);return r&&o?this._crossSigningInfo.checkDeviceTrust(o,r,n):new S.DeviceTrustLevel(!1,!1,n)},fe.prototype._onDeviceListUserCrossSigningUpdated=($=(0,a.coroutine)(v.default.mark((function e(t){var r,n,o,i;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t!==this._userId){e.next=13;break}if(r=this._deviceList.getStoredCrossSigningForUser(t),n=r?r.getId():null,o=this._crossSigningInfo.getId(),i=o!==n,!o||!n||i){e.next=10;break}return e.next=8,(0,a.resolve)(this.checkOwnCrossSigningTrust());case 8:e.next=11;break;case 10:this.emit("crossSigning.keysChanged",{});case 11:e.next=16;break;case 13:return e.next=15,(0,a.resolve)(this._checkDeviceVerifications(t));case 15:this.emit("userTrustStatusChanged",t,this.checkUserTrust(t));case 16:case"end":return e.stop()}}),e,this)}))),function(e){return $.apply(this,arguments)}),fe.prototype.checkOwnCrossSigningTrust=(0,a.coroutine)(v.default.mark((function e(){var t,r,n,o,i,s,u,c,l,d,f,p=this;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=this._userId,r=this._deviceList.getStoredCrossSigningForUser(t)){e.next=5;break}return w.default.error("Got cross-signing update event for user "+t+" but no new cross-signing information found!"),e.abrupt("return");case 5:if(n=r.getId(),!(o=this._crossSigningInfo.getId()!==n)){e.next=19;break}return w.default.info("Got new master key",n),i=null,e.prev=10,e.next=13,(0,a.resolve)(this._crossSigningInfo.getCrossSigningKey("master",n));case 13:s=e.sent,i=s[1];case 15:return e.prev=15,i.free(),e.finish(15);case 18:w.default.info("Got matching private key from callback for new public master key");case 19:return u=this._crossSigningInfo.getId("self_signing"),c=this._crossSigningInfo.getId("user_signing"),this._crossSigningInfo.setKeys(r.keys),e.next=24,(0,a.resolve)(this._cryptoStore.doTxn("readwrite",[T.default.STORE_ACCOUNT],(function(e){p._cryptoStore.storeCrossSigningKeys(e,p._crossSigningInfo.keys)})));case 24:if(l={},u===r.getId("self_signing")){e.next=32;break}return w.default.info("Got new self-signing key",r.getId("self_signing")),d=this._deviceList.getStoredDevice(this._userId,this._deviceId),e.next=30,(0,a.resolve)(this._crossSigningInfo.signDevice(this._userId,d));case 30:f=e.sent,l[this._deviceId]=f;case 32:if(c!==r.getId("user_signing")&&w.default.info("Got new user-signing key",r.getId("user_signing")),!o){e.next=37;break}return e.next=36,(0,a.resolve)(this._signObject(this._crossSigningInfo.keys.master));case 36:l[this._crossSigningInfo.getId()]=this._crossSigningInfo.keys.master;case 37:if(!(0,h.default)(l).length){e.next=40;break}return e.next=40,(0,a.resolve)(this._baseApis.uploadKeySignatures((0,_.default)({},this._userId,l)));case 40:return this.emit("userTrustStatusChanged",t,this.checkUserTrust(t)),e.next=43,(0,a.resolve)(this.checkKeyBackup());case 43:case"end":return e.stop()}}),e,this,[[10,,15,18]])}))),fe.prototype._checkDeviceVerifications=(W=(0,a.coroutine)(v.default.mark((function e(t){var r,n,o;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._crossSigningInfo.keys.user_signing){e.next=14;break}if(!(r=this._deviceList.getStoredCrossSigningForUser(t))){e.next=14;break}return e.next=5,(0,a.resolve)(this._checkForDeviceVerificationUpgrade(t,r));case 5:if(n=e.sent,o=this._baseApis._cryptoCallbacks.shouldUpgradeDeviceVerifications,!n||!o){e.next=14;break}return e.next=10,(0,a.resolve)(o({users:(0,_.default)({},t,n)}));case 10:if(!e.sent.includes(t)){e.next=14;break}return e.next=14,(0,a.resolve)(this._baseApis.setDeviceVerified(t,r.getId()));case 14:case"end":return e.stop()}}),e,this)}))),function(e){return W.apply(this,arguments)}),fe.prototype._checkAndStartKeyBackup=(0,a.coroutine)(v.default.mark((function e(){var t,r;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(w.default.log("Checking key backup status..."),!this._baseApis.isGuest()){e.next=5;break}return w.default.log("Skipping key backup check since user is guest"),this._checkedForBackup=!0,e.abrupt("return",null);case 5:return t=void 0,e.prev=6,e.next=9,(0,a.resolve)(this._baseApis.getKeyBackupVersion());case 9:t=e.sent,e.next=17;break;case 12:return e.prev=12,e.t0=e.catch(6),w.default.log("Error checking for active key backup",e.t0),e.t0.httpStatus/100==4&&(this._checkedForBackup=!0),e.abrupt("return",null);case 17:return this._checkedForBackup=!0,e.next=20,(0,a.resolve)(this.isKeyBackupTrusted(t));case 20:return(r=e.sent).usable&&!this.backupInfo?(w.default.log("Found usable key backup v"+t.version+": enabling key backups"),this._baseApis.enableKeyBackup(t)):!r.usable&&this.backupInfo?(w.default.log("No usable key backup: disabling key backup"),this._baseApis.disableKeyBackup()):r.usable||this.backupInfo?r.usable&&this.backupInfo&&(t.version!==this.backupInfo.version?(w.default.log("On backup version "+this.backupInfo.version+" but found version "+t.version+": switching."),this._baseApis.disableKeyBackup(),this._baseApis.enableKeyBackup(t)):w.default.log("Backup version "+t.version+" still current")):w.default.log("No usable key backup: not enabling key backup"),e.abrupt("return",{backupInfo:t,trustInfo:r});case 23:case"end":return e.stop()}}),e,this,[[6,12]])}))),fe.prototype.setTrustedBackupPubKey=(H=(0,a.coroutine)(v.default.mark((function e(t){return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._sessionStore.setLocalTrustedBackupPubKey(t),e.next=3,(0,a.resolve)(this.checkKeyBackup());case 3:case"end":return e.stop()}}),e,this)}))),function(e){return H.apply(this,arguments)}),fe.prototype.checkKeyBackup=(0,a.coroutine)(v.default.mark((function e(){var t;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this._checkedForBackup=!1,e.next=3,(0,a.resolve)(this._checkAndStartKeyBackup());case 3:return t=e.sent,e.abrupt("return",t);case 5:case"end":return e.stop()}}),e,this)}))),fe.prototype.isKeyBackupTrusted=(z=(0,a.coroutine)(v.default.mark((function e(t){var r,n,o,i,s,u,c,l,f,p,y,_,g;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r={usable:!1,trusted_locally:!1,sigs:[]},t&&t.algorithm&&t.auth_data&&t.auth_data.public_key&&t.auth_data.signatures){e.next=4;break}return w.default.info("Key backup is absent or missing required data"),e.abrupt("return",r);case 4:n=this._sessionStore.getLocalTrustedBackupPubKey(),t.auth_data.public_key===n&&(w.default.info("Backup public key "+n+" is trusted locally"),r.trusted_locally=!0),o=t.auth_data.signatures[this._userId]||[],i=!0,s=!1,u=void 0,e.prev=10,c=(0,m.default)((0,h.default)(o));case 12:if(i=(l=c.next()).done){e.next=55;break}if(f=l.value,"ed25519"===(p=f.split(":"))[0]){e.next=18;break}return w.default.log("Ignoring unknown signature type: "+p[0]),e.abrupt("continue",52);case 18:if(y={deviceId:p[1]},(_=this._crossSigningInfo.getId())!==f){e.next=34;break}return y.cross_signing_key=_,e.prev=22,e.next=25,(0,a.resolve)(P.verifySignature(this._olmDevice,t.auth_data,this._userId,y.deviceId,_));case 25:y.valid=!0,e.next=32;break;case 28:e.prev=28,e.t0=e.catch(22),w.default.warning("Bad signature from cross signing key "+_,e.t0),y.valid=!1;case 32:return r.sigs.push(y),e.abrupt("continue",52);case 34:if(!(g=this._deviceList.getStoredDevice(this._userId,y.deviceId))){e.next=49;break}return y.device=g,e.prev=37,e.next=40,(0,a.resolve)(P.verifySignature(this._olmDevice,(0,d.default)({},t.auth_data),this._userId,g.deviceId,g.getFingerprint()));case 40:y.valid=!0,e.next=47;break;case 43:e.prev=43,e.t1=e.catch(37),w.default.info("Bad signature from key ID "+f+" userID "+this._userId+" device ID "+g.deviceId+" fingerprint: "+g.getFingerprint(),t.auth_data,e.t1),y.valid=!1;case 47:e.next=51;break;case 49:y.valid=null,w.default.info("Ignoring signature from unknown key "+f);case 51:r.sigs.push(y);case 52:i=!0,e.next=12;break;case 55:e.next=61;break;case 57:e.prev=57,e.t2=e.catch(10),s=!0,u=e.t2;case 61:e.prev=61,e.prev=62,!i&&c.return&&c.return();case 64:if(e.prev=64,!s){e.next=67;break}throw u;case 67:return e.finish(64);case 68:return e.finish(61);case 69:return r.usable=r.sigs.some((function(e){return e.valid&&(e.device&&e.device.isVerified()||e.cross_signing_key)})),r.usable|=r.trusted_locally,e.abrupt("return",r);case 72:case"end":return e.stop()}}),e,this,[[10,57,61,69],[22,28],[37,43],[62,,64,68]])}))),function(e){return z.apply(this,arguments)}),fe.prototype.enableLazyLoading=function(){this._lazyLoadMembers=!0},fe.prototype.registerEventHandlers=function(e){var t=this;e.on("RoomMember.membership",(function(e,r,n){try{t._onRoomMembership(e,r,n)}catch(e){w.default.error("Error handling membership change:",e)}})),e.on("toDeviceEvent",(function(e){t._onToDeviceEvent(e)}))},fe.prototype.start=function(){this._outgoingRoomKeyRequestManager.start()},fe.prototype.stop=function(){this._outgoingRoomKeyRequestManager.stop(),this._deviceList.stop()},fe.getOlmVersion=function(){return M.getOlmVersion()},fe.prototype.getDeviceEd25519Key=function(){return this._olmDevice.deviceEd25519Key},fe.prototype.setGlobalBlacklistUnverifiedDevices=function(e){this._globalBlacklistUnverifiedDevices=e},fe.prototype.getGlobalBlacklistUnverifiedDevices=function(){return this._globalBlacklistUnverifiedDevices},fe.prototype.uploadDeviceKeys=function(){var e=this,t=e._userId,r=e._deviceId,n={algorithms:e._supportedAlgorithms,device_id:r,keys:e._deviceKeys,user_id:t};return e._signObject(n).then((function(){return e._baseApis.uploadKeysRequest({device_keys:n},{device_id:r})}))},fe.prototype.updateOneTimeKeyCount=function(e){if(!isFinite(e))throw new TypeError("Parameter for updateOneTimeKeyCount has to be a number");this._oneTimeKeyCount=e},fe.prototype.downloadKeys=function(e,t){return this._deviceList.downloadKeys(e,t)},fe.prototype.getStoredDevicesForUser=function(e){return this._deviceList.getStoredDevicesForUser(e)},fe.prototype.getStoredDevice=function(e,t){return this._deviceList.getStoredDevice(e,t)},fe.prototype.saveDeviceList=function(e){return this._deviceList.saveIfDirty(e)},fe.prototype.setDeviceVerification=(Y=(0,a.coroutine)(v.default.mark((function e(t,r,n,o,i){var s,u,c,l,d,f,p,h;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===n&&(n=null),void 0===o&&(o=null),void 0===i&&(i=null),!(s=this._deviceList.getStoredCrossSigningForUser(t))||s.getId()!==r){e.next=16;break}if(null===o&&null===i){e.next=7;break}throw new Error("Cannot set blocked or known for a cross-signing key");case 7:if(n){e.next=9;break}throw new Error("Cannot set a cross-signing key as unverified");case 9:return e.next=11,(0,a.resolve)(this._crossSigningInfo.signUser(s));case 11:if(!(u=e.sent)){e.next=15;break}return e.next=15,(0,a.resolve)(this._baseApis.uploadKeySignatures((0,_.default)({},t,(0,_.default)({},r,u))));case 15:return e.abrupt("return",u);case 16:if((c=this._deviceList.getRawStoredDevicesForUser(t))&&c[r]){e.next=19;break}throw new Error("Unknown device "+t+":"+r);case 19:if(l=c[r],d=l.verified,n?d=F.VERIFIED:null!==n&&d==F.VERIFIED&&(d=F.UNVERIFIED),o?d=F.BLOCKED:null!==o&&d==F.BLOCKED&&(d=F.UNVERIFIED),f=l.known,null!==i&&(f=i),l.verified===d&&l.known===f||(l.verified=d,l.known=f,this._deviceList.storeDevicesForUser(t,c),this._deviceList.saveIfDirty()),!n||t!==this._userId){e.next=33;break}return e.next=29,(0,a.resolve)(this._crossSigningInfo.signDevice(t,L.fromStorage(l,r)));case 29:if(!(p=e.sent)){e.next=33;break}return e.next=33,(0,a.resolve)(this._baseApis.uploadKeySignatures((0,_.default)({},t,(0,_.default)({},r,p))));case 33:return h=L.fromStorage(l,r),this.emit("deviceVerificationChanged",t,r,h),e.abrupt("return",h);case 36:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,o){return Y.apply(this,arguments)}),fe.prototype.requestVerificationDM=(Q=(0,a.coroutine)(v.default.mark((function e(t,r,n){var o,i,s,c,d,f,p,h,_,g,b=this;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o=void 0,!n){e.next=24;break}for(o=new y.default,i=!0,s=!1,c=void 0,e.prev=6,d=(0,m.default)(n);!(i=(f=d.next()).done);i=!0)"string"==typeof(p=f.value)?o.set(p,K[p]):p.NAME&&o.set(p.NAME,p);e.next=14;break;case 10:e.prev=10,e.t0=e.catch(6),s=!0,c=e.t0;case 14:e.prev=14,e.prev=15,!i&&d.return&&d.return();case 17:if(e.prev=17,!s){e.next=20;break}throw c;case 20:return e.finish(17);case 21:return e.finish(14);case 22:e.next=25;break;case 24:o=this._baseApis._crypto._verificationMethods;case 25:return h=void 0,_=new u.default((function(e,n){var i=q(b._baseApis,r,(function(e){if(e.getRoomId()===r&&e.getSender()===t){var n=e.getRelation();if(n&&n.rel_type&&"m.reference"===n.rel_type&&n.event_id&&n.event_id===h){var i=e.getContent();switch(e.getType()){case"m.key.verification.start":var u=new(o.get(i.method))(b._baseApis,t,i.from_device,h,r,e);u.handler=he(u,t,r,h);var c=q(b._baseApis,r,u.handler);u.setEventsSubscription(c),s(u);break;case"m.key.verification.cancel":a(e)}}}})),s=function(){i&&(i=i()),e.apply(void 0,arguments)},a=function(){i&&(i=i()),n.apply(void 0,arguments)}})),e.next=29,(0,a.resolve)(this._baseApis.sendEvent(r,"m.room.message",{body:this._baseApis.getUserId()+" is requesting to verify your key, but your client does not support in-chat key verification.  You will need to use legacy key verification to verify keys.",msgtype:"m.key.verification.request",to:t,from_device:this._baseApis.getDeviceId(),methods:[].concat((0,l.default)(o.keys()))}));case 29:return g=e.sent,h=g.event_id,e.abrupt("return",_);case 32:case"end":return e.stop()}}),e,this,[[6,10,14,22],[15,,17,21]])}))),function(e,t,r){return Q.apply(this,arguments)}),fe.prototype.acceptVerificationDM=function(e,t){"string"==typeof t&&(t=K[t]);var r=e.getContent(),n=new t(this._baseApis,e.getSender(),r.from_device,e.getId(),e.getRoomId());n.handler=he(n,e.getSender(),e.getRoomId(),e.getId());var o=q(this._baseApis,e.getRoomId(),n.handler);return n.setEventsSubscription(o),n},fe.prototype.requestVerification=function(e,t,r){var n=this;t||(t=[].concat((0,l.default)(this._verificationMethods.keys()))),r||(r=(0,h.default)(this._deviceList.getRawStoredDevicesForUser(e))),this._verificationTransactions.has(e)||this._verificationTransactions.set(e,new y.default);var o=(0,E.randomString)(32),i=new u.default((function(i,s){n._verificationTransactions.get(e).set(o,{request:{methods:t,devices:r,resolve:i,reject:s}})})),s={transaction_id:o,from_device:this._baseApis.deviceId,methods:t,timestamp:Date.now()},a={},c=!0,d=!1,f=void 0;try{for(var p,v=(0,m.default)(r);!(c=(p=v.next()).done);c=!0){a[p.value]=s}}catch(e){d=!0,f=e}finally{try{!c&&v.return&&v.return()}finally{if(d)throw f}}return this._baseApis.sendToDevice("m.key.verification.request",(0,_.default)({},e,a)),i},fe.prototype.beginKeyVerification=function(e,t,r,n){if(this._verificationTransactions.has(t)||this._verificationTransactions.set(t,new y.default),n=n||(0,E.randomString)(32),this._verificationMethods.has(e)){var o=new(this._verificationMethods.get(e))(this._baseApis,t,r,n);return this._verificationTransactions.get(t).has(n)||this._verificationTransactions.get(t).set(n,{}),this._verificationTransactions.get(t).get(n).verifier=o,o}throw(0,O.newUnknownMethodError)()},fe.prototype.getOlmSessionsForUser=(X=(0,a.coroutine)(v.default.mark((function e(t){var r,n,o,i,s,u;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=this.getStoredDevicesForUser(t)||[],n={},o=0;case 3:if(!(o<r.length)){e.next=13;break}return i=r[o],s=i.getIdentityKey(),e.next=8,(0,a.resolve)(this._olmDevice.getSessionInfoForDevice(s));case 8:u=e.sent,n[i.deviceId]={deviceIdKey:s,sessions:u};case 10:++o,e.next=3;break;case 13:return e.abrupt("return",n);case 14:case"end":return e.stop()}}),e,this)}))),function(e){return X.apply(this,arguments)}),fe.prototype.getEventSenderDeviceInfo=function(e){var t=e.getSenderKey(),r=e.getWireContent().algorithm;if(!t||!r)return null;if(e.getForwardingCurve25519KeyChain().length>0)return null;var n=this._deviceList.getDeviceByIdentityKey(r,t);if(null===n)return null;var o=e.getClaimedEd25519Key();return o?o!==n.getFingerprint()?(w.default.warn("Event "+e.getId()+" claims ed25519 key "+o+"but sender device has key "+n.getFingerprint()),null):n:(w.default.warn("Event "+e.getId()+" claims no ed25519 key: cannot verify sending device"),null)},fe.prototype.forceDiscardSession=function(e){var t=this._roomEncryptors[e];if(void 0===t)throw new Error("Room not encrypted");if(void 0===t.forceDiscardSession)throw new Error("Room encryption algorithm doesn't support session discarding");t.forceDiscardSession()},fe.prototype.setRoomEncryption=(J=(0,a.coroutine)(v.default.mark((function e(t,r,n){var o,i,s,u;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r.algorithm){e.next=3;break}return console.log("Ignoring setRoomEncryption with no algorithm"),e.abrupt("return");case 3:if(!(o=this._roomList.getRoomEncryption(t))){e.next=8;break}if((0,c.default)(o)==(0,c.default)(r)){e.next=8;break}return w.default.error("Ignoring m.room.encryption event which requests a change of config in "+t),e.abrupt("return");case 8:if(!this._roomEncryptors[t]){e.next=11;break}return e.abrupt("return");case 11:if(i=null,o||(i=this._roomList.setRoomEncryption(t,r)),s=U.ENCRYPTION_CLASSES[r.algorithm]){e.next=16;break}throw new Error("Unable to encrypt with "+r.algorithm);case 16:if(u=new s({userId:this._userId,deviceId:this._deviceId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:t,config:r}),this._roomEncryptors[t]=u,!i){e.next=21;break}return e.next=21,(0,a.resolve)(i);case 21:if(this._lazyLoadMembers){e.next=28;break}return w.default.log("Enabling encryption in "+t+"; starting to track device lists for all users therein"),e.next=25,(0,a.resolve)(this.trackRoomDevices(t));case 25:this.inhibitDeviceQuery||this._deviceList.refreshOutdatedDeviceLists(),e.next=29;break;case 28:w.default.log("Enabling encryption in "+t);case 29:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return J.apply(this,arguments)}),fe.prototype.trackRoomDevices=function(e){var t,r=this,n=(t=(0,a.coroutine)(v.default.mark((function t(){var n;return v.default.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(r._roomEncryptors[e]){t.next=2;break}return t.abrupt("return");case 2:if(n=r._clientStore.getRoom(e)){t.next=5;break}throw new Error("Unable to start tracking devices in unknown room "+e);case 5:return w.default.log("Starting to track devices for room "+e+" ..."),t.next=8,(0,a.resolve)(n.getEncryptionTargetMembers());case 8:t.sent.forEach((function(e){r._deviceList.startTrackingDeviceList(e.userId)}));case 10:case"end":return t.stop()}}),t,r)}))),function(){return t.apply(this,arguments)}),o=this._roomDeviceTrackingState[e];return o||(o=n(),this._roomDeviceTrackingState[e]=o),o},fe.prototype.ensureOlmSessionsForUsers=function(e){for(var t={},r=0;r<e.length;++r){var n=e[r];t[n]=[];for(var o=this.getStoredDevicesForUser(n)||[],i=0;i<o.length;++i){var s=o[i];s.getIdentityKey()!=this._olmDevice.deviceCurve25519Key&&(s.verified!=F.BLOCKED&&t[n].push(s))}}return P.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,t)},fe.prototype.exportRoomKeys=(0,a.coroutine)(v.default.mark((function e(){var t,r=this;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=[],e.next=3,(0,a.resolve)(this._cryptoStore.doTxn("readonly",[T.default.STORE_INBOUND_GROUP_SESSIONS],(function(e){r._cryptoStore.getAllEndToEndInboundGroupSessions(e,(function(e){if(null!==e){var n=r._olmDevice.exportInboundGroupSession(e.senderKey,e.sessionId,e.sessionData);delete n.first_known_index,n.algorithm=P.MEGOLM_ALGORITHM,t.push(n)}}))})));case 3:return e.abrupt("return",t);case 4:case"end":return e.stop()}}),e,this)}))),fe.prototype.importRoomKeys=function(e){var t=this;return u.default.map(e,(function(e){return e.room_id&&e.algorithm?t._getRoomDecryptor(e.room_id,e.algorithm).importRoomKey(e):(w.default.warn("ignoring room key entry with missing fields",e),null)}))},fe.prototype.scheduleKeyBackupSend=(Z=(0,a.coroutine)(v.default.mark((function e(){var t,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e4;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._sendingBackups){e.next=2;break}return e.abrupt("return");case 2:return this._sendingBackups=!0,e.prev=3,t=Math.random()*n,e.next=7,(0,a.resolve)(u.default.delay(t));case 7:r=0;case 8:if(this.backupKey){e.next=11;break}return e.abrupt("return");case 11:return e.prev=11,e.next=14,(0,a.resolve)(this._backupPendingKeys(200));case 14:if(0!==e.sent){e.next=17;break}return e.abrupt("return");case 17:r=0,e.next=30;break;case 20:if(e.prev=20,e.t0=e.catch(11),r++,w.default.log("Key backup request failed",e.t0),!e.t0.data){e.next=30;break}if("M_NOT_FOUND"!=e.t0.data.errcode&&"M_WRONG_ROOM_KEYS_VERSION"!=e.t0.data.errcode){e.next=30;break}return e.next=28,(0,a.resolve)(this.checkKeyBackup());case 28:throw this.emit("crypto.keyBackupFailed",e.t0.data.errcode),e.t0;case 30:if(!r){e.next=33;break}return e.next=33,(0,a.resolve)(u.default.delay(1e3*Math.pow(2,Math.min(r-1,4))));case 33:e.next=8;break;case 35:return e.prev=35,this._sendingBackups=!1,e.finish(35);case 38:case"end":return e.stop()}}),e,this,[[3,,35,38],[11,20]])}))),function(e){return Z.apply(this,arguments)}),fe.prototype._backupPendingKeys=(ee=(0,a.coroutine)(v.default.mark((function e(t){var r,n,o,i,s,u,l,d,f,p,h,y,_,g,b;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,a.resolve)(this._cryptoStore.getSessionsNeedingBackup(t));case 2:if((r=e.sent).length){e.next=5;break}return e.abrupt("return",0);case 5:return e.next=7,(0,a.resolve)(this._cryptoStore.countSessionsNeedingBackup());case 7:n=e.sent,this.emit("crypto.keyBackupSessionsRemaining",n),o={},i=!0,s=!1,u=void 0,e.prev=13,l=(0,m.default)(r);case 15:if(i=(d=l.next()).done){e.next=34;break}return f=d.value,p=f.sessionData.room_id,void 0===o[p]&&(o[p]={sessions:{}}),e.next=21,(0,a.resolve)(this._olmDevice.exportInboundGroupSession(f.senderKey,f.sessionId,f.sessionData));case 21:(h=e.sent).algorithm=P.MEGOLM_ALGORITHM,delete h.session_id,delete h.room_id,y=h.first_known_index,delete h.first_known_index,_=this.backupKey.encrypt((0,c.default)(h)),g=(h.forwarding_curve25519_key_chain||[]).length,b=this._deviceList.getDeviceByIdentityKey(P.MEGOLM_ALGORITHM,f.senderKey),o[p].sessions[f.sessionId]={first_message_index:y,forwarded_count:g,is_verified:!(!b||!b.isVerified()),session_data:_};case 31:i=!0,e.next=15;break;case 34:e.next=40;break;case 36:e.prev=36,e.t0=e.catch(13),s=!0,u=e.t0;case 40:e.prev=40,e.prev=41,!i&&l.return&&l.return();case 43:if(e.prev=43,!s){e.next=46;break}throw u;case 46:return e.finish(43);case 47:return e.finish(40);case 48:return e.next=50,(0,a.resolve)(this._baseApis.sendKeyBackup(void 0,void 0,this.backupInfo.version,{rooms:o}));case 50:return e.next=52,(0,a.resolve)(this._cryptoStore.unmarkSessionsNeedingBackup(r));case 52:return e.next=54,(0,a.resolve)(this._cryptoStore.countSessionsNeedingBackup());case 54:return n=e.sent,this.emit("crypto.keyBackupSessionsRemaining",n),e.abrupt("return",r.length);case 57:case"end":return e.stop()}}),e,this,[[13,36,40,48],[41,,43,47]])}))),function(e){return ee.apply(this,arguments)}),fe.prototype.backupGroupSession=(te=(0,a.coroutine)(v.default.mark((function e(t,r,n,o,i,s,u){return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.backupInfo){e.next=2;break}throw new Error("Key backups are not enabled");case 2:return e.next=4,(0,a.resolve)(this._cryptoStore.markSessionsNeedingBackup([{senderKey:r,sessionId:o}]));case 4:this.scheduleKeyBackupSend();case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,o,i,s){return te.apply(this,arguments)}),fe.prototype.scheduleAllGroupSessionsForBackup=(0,a.coroutine)(v.default.mark((function e(){return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,a.resolve)(this.flagAllGroupSessionsForBackup());case 2:this.scheduleKeyBackupSend(0);case 3:case"end":return e.stop()}}),e,this)}))),fe.prototype.flagAllGroupSessionsForBackup=(0,a.coroutine)(v.default.mark((function e(){var t,r=this;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,a.resolve)(this._cryptoStore.doTxn("readwrite",[T.default.STORE_INBOUND_GROUP_SESSIONS,T.default.STORE_BACKUP],(function(e){r._cryptoStore.getAllEndToEndInboundGroupSessions(e,(function(t){null!==t&&r._cryptoStore.markSessionsNeedingBackup([t],e)}))})));case 2:return e.next=4,(0,a.resolve)(this._cryptoStore.countSessionsNeedingBackup());case 4:return t=e.sent,this.emit("crypto.keyBackupSessionsRemaining",t),e.abrupt("return",t);case 7:case"end":return e.stop()}}),e,this)}))),fe.prototype.encryptEvent=(re=(0,a.coroutine)(v.default.mark((function e(t,r){var n,o,i,s,u;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r){e.next=2;break}throw new Error("Cannot send encrypted messages in unknown rooms");case 2:if(n=t.getRoomId(),o=this._roomEncryptors[n]){e.next=6;break}throw new Error("Room was previously configured to use encryption, but is no longer. Perhaps the homeserver is hiding the configuration event.");case 6:return this._roomDeviceTrackingState[n]||this.trackRoomDevices(n),e.next=9,(0,a.resolve)(this._roomDeviceTrackingState[n]);case 9:return i=t.getContent(),(s=i["m.relates_to"])&&delete(i=(0,d.default)({},i))["m.relates_to"],e.next=14,(0,a.resolve)(o.encryptMessage(r,t.getType(),i));case 14:u=e.sent,s&&(u["m.relates_to"]=s),t.makeEncrypted("m.room.encrypted",u,this._olmDevice.deviceCurve25519Key,this._olmDevice.deviceEd25519Key);case 17:case"end":return e.stop()}}),e,this)}))),function(e,t){return re.apply(this,arguments)}),fe.prototype.decryptEvent=function(e){if(e.isRedacted())return u.default.resolve({clearEvent:{room_id:e.getRoomId(),type:"m.room.message",content:{}}});var t=e.getWireContent();return this._getRoomDecryptor(e.getRoomId(),t.algorithm).decryptEvent(e)},fe.prototype.handleDeviceListChanges=(ne=(0,a.coroutine)(v.default.mark((function e(t,r){return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.oldSyncToken){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,(0,a.resolve)(this._evalDeviceListChanges(r));case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return ne.apply(this,arguments)}),fe.prototype.requestRoomKey=function(e,t){var r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this._outgoingRoomKeyRequestManager.sendRoomKeyRequest(e,t,r).catch((function(e){w.default.error("Error requesting key for event",e)})).done()},fe.prototype.cancelRoomKeyRequest=function(e){this._outgoingRoomKeyRequestManager.cancelRoomKeyRequest(e).catch((function(e){w.default.warn("Error clearing pending room key requests",e)})).done()},fe.prototype.onCryptoEvent=(oe=(0,a.coroutine)(v.default.mark((function e(t){var r,n;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.getRoomId(),n=t.getContent(),e.prev=2,e.next=5,(0,a.resolve)(this.setRoomEncryption(r,n,!0));case 5:e.next=10;break;case 7:e.prev=7,e.t0=e.catch(2),w.default.error("Error configuring encryption in room "+r+":",e.t0);case 10:case"end":return e.stop()}}),e,this,[[2,7]])}))),function(e){return oe.apply(this,arguments)}),fe.prototype.onSyncWillProcess=(ie=(0,a.method)((function(e){e.oldSyncToken||(w.default.log("Initial sync performed - resetting device tracking state"),this._deviceList.stopTrackingAllDeviceLists(),this._deviceList.startTrackingDeviceList(this._userId),this._roomDeviceTrackingState={})})),function(e){return ie.apply(this,arguments)}),fe.prototype.onSyncCompleted=(se=(0,a.method)((function(e){var t=e.nextSyncToken;this._deviceList.setSyncToken(e.nextSyncToken),this._deviceList.saveIfDirty(),this._deviceList.lastKnownSyncToken=t,this._deviceList.startTrackingDeviceList(this._userId),this._deviceList.refreshOutdatedDeviceLists(),e.catchingUp||(pe(this),this._processReceivedRoomKeyRequests())})),function(e){return se.apply(this,arguments)}),fe.prototype._evalDeviceListChanges=(ae=(0,a.coroutine)(v.default.mark((function e(t){var r,n=this;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.changed&&Array.isArray(t.changed)&&t.changed.forEach((function(e){n._deviceList.invalidateUserDeviceList(e)})),!(t.left&&Array.isArray(t.left)&&t.left.length)){e.next=8;break}return e.t0=s.default,e.next=5,(0,a.resolve)(this._getTrackedE2eUsers());case 5:e.t1=e.sent,r=new e.t0(e.t1),t.left.forEach((function(e){r.has(e)||n._deviceList.stopTrackingDeviceList(e)}));case 8:case"end":return e.stop()}}),e,this)}))),function(e){return ae.apply(this,arguments)}),fe.prototype._getTrackedE2eUsers=(0,a.coroutine)(v.default.mark((function e(){var t,r,n,o,i,s,u,c,l,d,f,p,h,y;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=[],r=!0,n=!1,o=void 0,e.prev=4,i=(0,m.default)(this._getTrackedE2eRooms());case 6:if(r=(s=i.next()).done){e.next=33;break}return u=s.value,e.next=10,(0,a.resolve)(u.getEncryptionTargetMembers());case 10:for(c=e.sent,l=!0,d=!1,f=void 0,e.prev=14,p=(0,m.default)(c);!(l=(h=p.next()).done);l=!0)y=h.value,t.push(y.userId);e.next=22;break;case 18:e.prev=18,e.t0=e.catch(14),d=!0,f=e.t0;case 22:e.prev=22,e.prev=23,!l&&p.return&&p.return();case 25:if(e.prev=25,!d){e.next=28;break}throw f;case 28:return e.finish(25);case 29:return e.finish(22);case 30:r=!0,e.next=6;break;case 33:e.next=39;break;case 35:e.prev=35,e.t1=e.catch(4),n=!0,o=e.t1;case 39:e.prev=39,e.prev=40,!r&&i.return&&i.return();case 42:if(e.prev=42,!n){e.next=45;break}throw o;case 45:return e.finish(42);case 46:return e.finish(39);case 47:return e.abrupt("return",t);case 48:case"end":return e.stop()}}),e,this,[[4,35,39,47],[14,18,22,30],[23,,25,29],[40,,42,46]])}))),fe.prototype._getTrackedE2eRooms=function(){var e=this;return this._clientStore.getRooms().filter((function(t){if(!e._roomEncryptors[t.roomId])return!1;if(!e._roomDeviceTrackingState[t.roomId])return!1;var r=t.getMyMembership();return"join"===r||"invite"===r}))},fe.prototype._onToDeviceEvent=function(e){var t=this;try{"m.room_key"==e.getType()||"m.forwarded_room_key"==e.getType()?this._onRoomKeyEvent(e):"m.room_key_request"==e.getType()?this._onRoomKeyRequestEvent(e):"m.secret.request"===e.getType()?this._secretStorage._onRequestReceived(e):"m.secret.send"===e.getType()?this._secretStorage._onSecretReceived(e):"m.key.verification.request"===e.getType()?this._onKeyVerificationRequest(e):"m.key.verification.start"===e.getType()?this._onKeyVerificationStart(e):e.getContent().transaction_id?this._onKeyVerificationMessage(e):"m.bad.encrypted"===e.getContent().msgtype?this._onToDeviceBadEncrypted(e):e.isBeingDecrypted()&&e.once("Event.decrypted",(function(e){t._onToDeviceEvent(e)}))}catch(e){w.default.error("Error handling toDeviceEvent:",e)}},fe.prototype._onRoomKeyEvent=function(e){var t=e.getContent();t.room_id&&t.algorithm?(this._checkedForBackup||this._checkAndStartKeyBackup(),this._getRoomDecryptor(t.room_id,t.algorithm).onRoomKeyEvent(e)):w.default.error("key event is missing fields")},fe.prototype._onKeyVerificationRequest=function(e){var t=this;if(e.isCancelled())w.default.warn("Ignoring flagged verification request from "+e.getSender());else{var r=e.getContent();if("from_device"in r&&"string"==typeof r.from_device&&"transaction_id"in r&&"string"==typeof r.from_device&&"methods"in r&&r.methods instanceof Array&&"timestamp"in r&&"number"==typeof r.timestamp){var n=Date.now();if(n<r.timestamp-3e5||n>r.timestamp+6e5)w.default.log("received verification that is too old or from the future");else{var o=e.getSender();if(o!==this._userId||r.from_device!==this._deviceId){if(this._verificationTransactions.has(o)){if(this._verificationTransactions.get(o).has(r.transaction_id)){var i=(0,O.newUnexpectedMessageError)({transaction_id:r.transaction_id});return this._verificationTransactions.get(o).get(r.transaction_id).verifier?this._verificationTransactions.get(o).get(r.transaction_id).verifier.cancel(i):(this._verificationTransactions.get(o).get(r.transaction_id).reject(i),this.sendToDevice("m.key.verification.cancel",(0,_.default)({},o,(0,_.default)({},r.from_device,i.getContent())))),void this._verificationTransactions.get(o).delete(r.transaction_id)}}else this._verificationTransactions.set(o,new y.default);var s=[],a=!0,u=!1,c=void 0;try{for(var l,d=(0,m.default)(r.methods);!(a=(l=d.next()).done);a=!0){var f=l.value;"string"==typeof f&&(this._verificationMethods.has(f)&&s.push(f))}}catch(i){u=!0,c=i}finally{try{!a&&d.return&&d.return()}finally{if(u)throw c}}if(0===s.length)this._baseApis.emit("crypto.verification.request.unknown",e.getSender(),(function(){t.sendToDevice("m.key.verification.cancel",(0,_.default)({},o,(0,_.default)({},r.from_device,(0,O.newUserCancelledError)({transaction_id:r.transaction_id}).getContent())))}));else{var p={event:e,methods:s,beginKeyVerification:function(e){var n=t.beginKeyVerification(e,o,r.from_device,r.transaction_id);return t._verificationTransactions.get(o).get(r.transaction_id).verifier=n,n},cancel:function(){t._baseApis.sendToDevice("m.key.verification.cancel",(0,_.default)({},o,(0,_.default)({},r.from_device,(0,O.newUserCancelledError)({transaction_id:r.transaction_id}).getContent())))}};this._verificationTransactions.get(o).set(r.transaction_id,{request:p}),this._baseApis.emit("crypto.verification.request",p)}}}}else w.default.warn("received invalid verification request from "+e.getSender())}},fe.prototype._onKeyVerificationStart=function(e){var t=this;if(e.isCancelled())w.default.warn("Ignoring flagged verification start from "+e.getSender());else{var r=e.getSender(),n=e.getContent(),o=n.transaction_id,i=n.from_device;if(o&&i){var s=this._verificationTransactions.has(r)&&this._verificationTransactions.get(r).get(o),a=function(e){s.verifier?s.verifier.cancel(e):s.request&&s.request.cancel&&s.request.cancel(e),t.sendToDevice("m.key.verification.cancel",(0,_.default)({},r,(0,_.default)({},i,e.getContent())))};if(this._verificationMethods.has(n.method)){var u=new(this._verificationMethods.get(n.method))(this._baseApis,r,i,n.transaction_id,e,s&&s.request);if(s){if(!s.verifier&&(s.verifier=u,s.request)){if(!s.request.devices.includes(i))return void a((0,O.newUnexpectedMessageError)({transaction_id:n.transactionId}));if(!s.request.methods.includes(n.method))return void a((0,O.newUnknownMethodError)({transaction_id:n.transactionId}));var c={transaction_id:o,code:"m.accepted",reason:"Verification request accepted by another device"},l={},d=!0,f=!1,p=void 0;try{for(var h,v=(0,m.default)(s.request.devices);!(d=(h=v.next()).done);d=!0){var g=h.value;g!==i&&(l[g]=c)}}catch(e){f=!0,p=e}finally{try{!d&&v.return&&v.return()}finally{if(f)throw p}}this._baseApis.sendToDevice("m.key.verification.cancel",(0,_.default)({},r,l)),s.request.resolve(u)}}else this._verificationTransactions.has(r)||this._verificationTransactions.set(r,new y.default),s=this._verificationTransactions.get(r).set(o,{verifier:u});this._baseApis.emit("crypto.verification.start",u)}else a((0,O.newUnknownMethodError)({transaction_id:n.transactionId}))}}},fe.prototype._onKeyVerificationMessage=function(e){var t=e.getSender(),r=e.getContent().transaction_id,n=this._verificationTransactions.has(t)&&this._verificationTransactions.get(t).get(r);if(n)if("m.key.verification.cancel"===e.getType())w.default.log(e),n.verifier?n.verifier.cancel(e):n.request&&n.request.cancel&&n.request.cancel(e);else if(n.verifier){var o=n.verifier;o.events&&o.events.includes(e.getType())&&o.handleEvent(e)}},fe.prototype._onToDeviceBadEncrypted=(ue=(0,a.coroutine)(v.default.mark((function e(t){var r,n,o,i,s,u,c,l,d,f,p,h,y,g,b;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.getWireContent(),n=t.getSender(),o=r.algorithm,i=r.sender_key,void 0!==n&&void 0!==i&&void 0!==i){e.next=6;break}return e.abrupt("return");case 6:if(this._lastNewSessionForced[n]=this._lastNewSessionForced[n]||{},!((s=this._lastNewSessionForced[n][i]||0)+36e5>Date.now())){e.next=11;break}return w.default.debug("New session already forced with device "+n+":"+i+" at "+s+": not forcing another"),e.abrupt("return");case 11:if(u=this._deviceList.getDeviceByIdentityKey(o,i)){e.next=15;break}return w.default.info("Couldn't find device for identity key "+i+": not re-establishing session"),e.abrupt("return");case 15:return(c={})[n]=[u],e.next=19,(0,a.resolve)(P.ensureOlmSessionsForDevices(this._olmDevice,this._baseApis,c,!0));case 19:return this._lastNewSessionForced[n][i]=Date.now(),l={algorithm:P.OLM_ALGORITHM,sender_key:this._olmDevice.deviceCurve25519Key,ciphertext:{}},e.next=23,(0,a.resolve)(P.encryptMessageForDevice(l.ciphertext,this._userId,this._deviceId,this._olmDevice,n,u,{type:"m.dummy"}));case 23:return e.next=25,(0,a.resolve)(this._baseApis.sendToDevice("m.room.encrypted",(0,_.default)({},n,(0,_.default)({},u.deviceId,l))));case 25:return e.next=27,(0,a.resolve)(this._outgoingRoomKeyRequestManager.getOutgoingSentRoomKeyRequest(n,u.deviceId));case 27:for(d=e.sent,f=!0,p=!1,h=void 0,e.prev=31,y=(0,m.default)(d);!(f=(g=y.next()).done);f=!0)b=g.value,this.requestRoomKey(b.requestBody,b.recipients,!0);e.next=39;break;case 35:e.prev=35,e.t0=e.catch(31),p=!0,h=e.t0;case 39:e.prev=39,e.prev=40,!f&&y.return&&y.return();case 42:if(e.prev=42,!p){e.next=45;break}throw h;case 45:return e.finish(42);case 46:return e.finish(39);case 47:case"end":return e.stop()}}),e,this,[[31,35,39,47],[40,,42,46]])}))),function(e){return ue.apply(this,arguments)}),fe.prototype._onRoomMembership=function(e,t,r){var n=t.roomId,o=this._roomEncryptors[n];o&&(this._roomDeviceTrackingState[n]&&("join"==t.membership?(w.default.log("Join event for "+t.userId+" in "+n),this._deviceList.startTrackingDeviceList(t.userId)):"invite"==t.membership&&this._clientStore.getRoom(n).shouldEncryptForInvitedMembers()&&(w.default.log("Invite event for "+t.userId+" in "+n),this._deviceList.startTrackingDeviceList(t.userId))),o.onRoomMembership(e,t,r))},fe.prototype._onRoomKeyRequestEvent=function(e){var t=e.getContent();if("request"===t.action){var r=new ve(e);this._receivedRoomKeyRequests.push(r)}else if("request_cancellation"===t.action){var n=new me(e);this._receivedRoomKeyRequestCancellations.push(n)}},fe.prototype._processReceivedRoomKeyRequests=(0,a.coroutine)(v.default.mark((function e(){var t,r,n=this;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._processingRoomKeyRequests){e.next=2;break}return e.abrupt("return");case 2:return this._processingRoomKeyRequests=!0,e.prev=3,t=this._receivedRoomKeyRequests,this._receivedRoomKeyRequests=[],r=this._receivedRoomKeyRequestCancellations,this._receivedRoomKeyRequestCancellations=[],e.next=10,(0,a.resolve)(u.default.map(t,(function(e){return n._processReceivedRoomKeyRequest(e)})));case 10:return e.next=12,(0,a.resolve)(u.default.map(r,(function(e){return n._processReceivedRoomKeyRequestCancellation(e)})));case 12:e.next=17;break;case 14:e.prev=14,e.t0=e.catch(3),w.default.error("Error processing room key requsts: "+e.t0);case 17:return e.prev=17,this._processingRoomKeyRequests=!1,e.finish(17);case 20:case"end":return e.stop()}}),e,this,[[3,14,17,20]])}))),fe.prototype._processReceivedRoomKeyRequest=(ce=(0,a.coroutine)(v.default.mark((function e(t){var r,n,o,i,s,u,c,l,d;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=t.userId,n=t.deviceId,o=t.requestBody,i=o.room_id,s=o.algorithm,w.default.log("m.room_key_request from "+r+":"+n+" for "+i+" / "+o.session_id+" (id "+t.requestId+")"),r===this._userId){e.next=24;break}if(this._roomEncryptors[i]){e.next=10;break}return w.default.debug("room key request for unencrypted room "+i),e.abrupt("return");case 10:if(u=this._roomEncryptors[i],c=this._deviceList.getStoredDevice(r,n)){e.next=15;break}return w.default.debug("Ignoring keyshare for unknown device "+r+":"+n),e.abrupt("return");case 15:return e.prev=15,e.next=18,(0,a.resolve)(u.reshareKeyWithDevice(o.sender_key,o.session_id,r,c));case 18:e.next=23;break;case 20:e.prev=20,e.t0=e.catch(15),w.default.warn("Failed to re-share keys for session "+o.session_id+" with device "+r+":"+c.deviceId,e.t0);case 23:return e.abrupt("return");case 24:if(this._roomDecryptors[i]){e.next=27;break}return w.default.log("room key request for unencrypted room "+i),e.abrupt("return");case 27:if(l=this._roomDecryptors[i][s]){e.next=31;break}return w.default.log("room key request for unknown alg "+s+" in room "+i),e.abrupt("return");case 31:return e.next=33,(0,a.resolve)(l.hasKeysForKeyRequest(t));case 33:if(e.sent){e.next=36;break}return w.default.log("room key request for unknown session "+i+" / "+o.session_id),e.abrupt("return");case 36:if(t.share=function(){l.shareKeysWithDevice(t)},!(d=this._deviceList.getStoredDevice(r,n))||!d.isVerified()){e.next=42;break}return w.default.log("device is already verified: sharing keys"),t.share(),e.abrupt("return");case 42:this.emit("crypto.roomKeyRequest",t);case 43:case"end":return e.stop()}}),e,this,[[15,20]])}))),function(e){return ce.apply(this,arguments)}),fe.prototype._processReceivedRoomKeyRequestCancellation=(le=(0,a.method)((function(e){w.default.log("m.room_key_request cancellation for "+e.userId+":"+e.deviceId+" (id "+e.requestId+")"),this.emit("crypto.roomKeyRequestCancellation",e)})),function(e){return le.apply(this,arguments)}),fe.prototype._getRoomDecryptor=function(e,t){var r=void 0,n=void 0;if((e=e||null)&&((r=this._roomDecryptors[e])||(this._roomDecryptors[e]=r={}),n=r[t]))return n;var o=U.DECRYPTION_CLASSES[t];if(!o)throw new U.DecryptionError("UNKNOWN_ENCRYPTION_ALGORITHM",'Unknown encryption algorithm "'+t+'".');return n=new o({userId:this._userId,crypto:this,olmDevice:this._olmDevice,baseApis:this._baseApis,roomId:e}),r&&(r[t]=n),n},fe.prototype._signObject=(de=(0,a.coroutine)(v.default.mark((function e(t){var r,n;return v.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=t.signatures||{},n=t.unsigned,delete t.signatures,delete t.unsigned,r[this._userId]=r[this._userId]||{},e.next=7,(0,a.resolve)(this._olmDevice.sign(A.stringify(t)));case 7:r[this._userId]["ed25519:"+this._deviceId]=e.sent,t.signatures=r,void 0!==n&&(t.unsigned=n);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return de.apply(this,arguments)});var ve=function e(t){(0,i.default)(this,e);var r=t.getContent();this.userId=t.getSender(),this.deviceId=r.requesting_device_id,this.requestId=r.request_id,this.requestBody=r.body||{},this.share=function(){throw new Error("don't know how to share keys for this request yet")}},me=function e(t){(0,i.default)(this,e);var r=t.getContent();this.userId=t.getSender(),this.deviceId=r.requesting_device_id,this.requestId=r.request_id}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../ReEmitter":2,"../logger":37,"../randomstring":52,"../utils":65,"./CrossSigning":8,"./DeviceList":9,"./OlmDevice":10,"./OutgoingRoomKeyRequestManager":11,"./SecretStorage":13,"./algorithms":15,"./deviceinfo":18,"./olmlib":21,"./store/indexeddb-crypto-store":24,"./verification/Error":28,"./verification/QRCode":29,"./verification/SAS":30,"another-json":67,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/json/stringify":71,"babel-runtime/core-js/map":72,"babel-runtime/core-js/object/assign":76,"babel-runtime/core-js/object/entries":79,"babel-runtime/core-js/object/keys":82,"babel-runtime/core-js/set":89,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/defineProperty":94,"babel-runtime/helpers/slicedToArray":97,"babel-runtime/helpers/toConsumableArray":98,"babel-runtime/regenerator":100,bluebird:103,events:257}],20:[function(e,t,r){(function(t){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.keyFromPassphrase=r.keyFromAuthData=void 0;var n,o,i,s,a=e("babel-runtime/regenerator"),u=(n=a)&&n.__esModule?n:{default:n},c=e("bluebird"),l=(r.keyFromAuthData=(o=(0,c.coroutine)(u.default.mark((function e(r,n){return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.Olm){e.next=2;break}throw new Error("Olm is not available");case 2:if(r.private_key_salt&&r.private_key_iterations){e.next=4;break}throw new Error("Salt and/or iterations not found: this backup cannot be restored with a passphrase");case 4:return e.next=6,(0,c.resolve)(l(n,r.private_key_salt,r.private_key_iterations));case 6:return e.abrupt("return",e.sent);case 7:case"end":return e.stop()}}),e,this)}))),function(e,t){return o.apply(this,arguments)}),r.keyFromPassphrase=(i=(0,c.coroutine)(u.default.mark((function e(r){var n,o;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.Olm){e.next=2;break}throw new Error("Olm is not available");case 2:return n=(0,d.randomString)(32),e.next=5,(0,c.resolve)(l(r,n,f));case 5:return o=e.sent,e.abrupt("return",{key:o,salt:n,iterations:f});case 7:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)}),s=(0,c.coroutine)(u.default.mark((function e(r,n,o){var i,s,a,l;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(i=t.crypto.subtle,s=t.TextEncoder,i&&s){e.next=4;break}throw new Error("Password-based backup is not avaiable on this platform");case 4:return e.next=6,(0,c.resolve)(i.importKey("raw",(new s).encode(r),{name:"PBKDF2"},!1,["deriveBits"]));case 6:return a=e.sent,e.next=9,(0,c.resolve)(i.deriveBits({name:"PBKDF2",salt:(new s).encode(n),iterations:o,hash:"SHA-512"},a,8*t.Olm.PRIVATE_KEY_LENGTH));case 9:return l=e.sent,e.abrupt("return",new Uint8Array(l));case 11:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return s.apply(this,arguments)}),d=e("../randomstring");var f=5e5}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../randomstring":52,"babel-runtime/regenerator":100,bluebird:103}],21:[function(e,t,r){(function(r){"use strict";var n,o=p(e("babel-runtime/core-js/object/assign")),i=e("bluebird"),s=p(i),a=p(e("babel-runtime/core-js/object/values")),u=p(e("babel-runtime/core-js/get-iterator")),c=p(e("babel-runtime/regenerator")),l=p(e("babel-runtime/core-js/json/stringify")),d=(n=(0,i.coroutine)(c.default.mark((function e(t,r,n,o){var s,a;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return s=o.deviceId,e.prev=1,e.next=4,(0,i.resolve)(g(t,r,n,s,o.getFingerprint()));case 4:e.next=10;break;case 6:return e.prev=6,e.t0=e.catch(1),f.default.error("Unable to verify signature on one-time key for device "+n+":"+s+":",e.t0),e.abrupt("return",null);case 10:return a=void 0,e.prev=11,e.next=14,(0,i.resolve)(t.createOutboundSession(o.getIdentityKey(),r.key));case 14:a=e.sent,e.next=21;break;case 17:return e.prev=17,e.t1=e.catch(11),f.default.error("Error starting session with device "+n+":"+s+": "+e.t1),e.abrupt("return",null);case 21:return f.default.log("Started new sessionid "+a+" for device "+n+":"+s),e.abrupt("return",a);case 23:case"end":return e.stop()}}),e,this,[[1,6],[11,17]])}))),function(e,t,r,o){return n.apply(this,arguments)}),f=p(e("../logger"));function p(e){return e&&e.__esModule?e:{default:e}}var h,v,m=e("another-json"),y=e("../utils");t.exports.OLM_ALGORITHM="m.olm.v1.curve25519-aes-sha2",t.exports.MEGOLM_ALGORITHM="m.megolm.v1.aes-sha2",t.exports.MEGOLM_BACKUP_ALGORITHM="m.megolm_backup.v1.curve25519-aes-sha2",t.exports.encryptMessageForDevice=(h=(0,i.coroutine)(c.default.mark((function e(t,r,n,o,s,a,u){var d,p,h;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d=a.getIdentityKey(),e.next=3,(0,i.resolve)(o.getSessionIdForDevice(d));case 3:if(null!==(p=e.sent)){e.next=6;break}return e.abrupt("return");case 6:return f.default.log("Using sessionid "+p+" for device "+s+":"+a.deviceId),h={sender:r,sender_device:n,keys:{ed25519:o.deviceEd25519Key},recipient:s,recipient_keys:{ed25519:a.getFingerprint()}},y.extend(h,u),e.next=11,(0,i.resolve)(o.encryptMessage(d,p,(0,l.default)(h)));case 11:t[d]=e.sent;case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,r,n,o,i,s){return h.apply(this,arguments)}),t.exports.ensureOlmSessionsForDevices=(v=(0,i.coroutine)(c.default.mark((function e(t,r,n,o){var l,p,h,v,m,y,_,g,b,k,w,E,S,x,R,T,I,C,O=this;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:l=[],p={},h={},e.t0=c.default.keys(n);case 4:if((e.t1=e.t0()).done){e.next=19;break}if(v=e.t1.value,n.hasOwnProperty(v)){e.next=8;break}return e.abrupt("continue",4);case 8:p[v]={},m=n[v],y=c.default.mark((function e(r){var n,a,u,d;return c.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=m[r],a=n.deviceId,u=n.getIdentityKey(),t._sessionsInProgress[u]||(t._sessionsInProgress[u]=new s.default((function(e,r){h[u]={resolve:function(){delete t._sessionsInProgress[u],e.apply(void 0,arguments)},reject:function(){delete t._sessionsInProgress[u],r.apply(void 0,arguments)}}}))),e.next=6,(0,i.resolve)(t.getSessionIdForDevice(u,h[u]));case 6:null!==(d=e.sent)&&h[u]&&(delete t._sessionsInProgress[u],h[u].resolve(),delete h[u]),(null===d||o)&&l.push([v,a]),p[v][a]={device:n,sessionId:d};case 10:case"end":return e.stop()}}),e,O)})),_=0;case 12:if(!(_<m.length)){e.next=17;break}return e.delegateYield(y(_),"t2",14);case 14:_++,e.next=12;break;case 17:e.next=4;break;case 19:if(0!==l.length){e.next=21;break}return e.abrupt("return",p);case 21:return g="signed_curve25519",b=void 0,e.prev=23,e.next=26,(0,i.resolve)(r.claimOneTimeKeys(l,g));case 26:b=e.sent,e.next=52;break;case 29:for(e.prev=29,e.t3=e.catch(23),k=!0,w=!1,E=void 0,e.prev=34,S=(0,u.default)((0,a.default)(h));!(k=(x=S.next()).done);k=!0)x.value.resolve();e.next=42;break;case 38:e.prev=38,e.t4=e.catch(34),w=!0,E=e.t4;case 42:e.prev=42,e.prev=43,!k&&S.return&&S.return();case 45:if(e.prev=45,!w){e.next=48;break}throw E;case 48:return e.finish(45);case 49:return e.finish(42);case 50:throw f.default.log("failed to claim one-time keys",e.t3,l),e.t3;case 52:R=b.one_time_keys||{},T=[],I=function(e){if(!n.hasOwnProperty(e))return"continue";for(var r=R[e]||{},i=n[e],s=function(n){var s=i[n],a=s.deviceId,u=s.getIdentityKey();if(p[e][a].sessionId&&!o)return"continue";var c=r[a]||{},l=null;for(var v in c)0===v.indexOf(g+":")&&(l=c[v]);if(!l){var m="No one-time keys (alg="+g+") for device "+e+":"+a;return f.default.warn(m),h[u]&&h[u].resolve(),"continue"}T.push(d(t,l,e,s).then((function(t){h[u]&&h[u].resolve(t),p[e][a].sessionId=t}),(function(e){throw h[u]&&h[u].resolve(),e})))},a=0;a<i.length;a++)s(a)},e.t5=c.default.keys(n);case 56:if((e.t6=e.t5()).done){e.next=63;break}if(C=e.t6.value,"continue"!==I(C)){e.next=61;break}return e.abrupt("continue",56);case 61:e.next=56;break;case 63:return e.next=65,(0,i.resolve)(s.default.all(T));case 65:return e.abrupt("return",p);case 66:case"end":return e.stop()}}),e,this,[[23,29],[34,38,42,50],[43,,45,49]])}))),function(e,t,r,n){return v.apply(this,arguments)});var _,g=t.exports.verifySignature=(_=(0,i.method)((function(e,t,r,n,i){var s="ed25519:"+n,a=((t.signatures||{})[r]||{})[s];if(!a)throw Error("No signature");var u=(0,o.default)({},t);delete u.unsigned,delete u.signatures;var c=m.stringify(u);e.verifySignature(i,c,a)})),function(e,t,r,n,o){return _.apply(this,arguments)});t.exports.pkSign=function(e,t,n,o){var i=!1;if(t instanceof Uint8Array){var s=new r.Olm.PkSigning;o=s.init_with_seed(t),t=s,i=!0}var a=e.signatures||{};delete e.signatures;var u=e.unsigned;e.unsigned&&delete e.unsigned;try{var c=a[n]||{};return a[n]=c,c["ed25519:"+o]=t.sign(m.stringify(e))}finally{e.signatures=a,u&&(e.unsigned=u),i&&t.free()}},t.exports.pkVerify=function(e,t,n){var o="ed25519:"+t;if(!(e.signatures&&e.signatures[n]&&e.signatures[n][o]))throw new Error("No signature");var i=e.signatures[n][o],s=new r.Olm.Utility,a=e.signatures;delete e.signatures;var u=e.unsigned;e.unsigned&&delete e.unsigned;try{s.ed25519_verify(t,m.stringify(e),i)}finally{e.signatures=a,u&&(e.unsigned=u),s.free()}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":37,"../utils":65,"another-json":67,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/json/stringify":71,"babel-runtime/core-js/object/assign":76,"babel-runtime/core-js/object/values":84,"babel-runtime/regenerator":100,bluebird:103}],22:[function(e,t,r){(function(t,n){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var o=s(e("babel-runtime/core-js/get-iterator"));r.encodeRecoveryKey=function(e){var t=new n(a.length+e.length+1);t.set(a,0),t.set(e,a.length);for(var r=0,o=0;o<t.length-1;++o)r^=t[o];return t[t.length-1]=r,i.default.encode(t).match(/.{1,4}/g).join(" ")},r.decodeRecoveryKey=function(e){var r=i.default.decode(e.replace(/ /g,"")),n=0,s=!0,u=!1,c=void 0;try{for(var l,d=(0,o.default)(r);!(s=(l=d.next()).done);s=!0){var f=l.value;n^=f}}catch(e){u=!0,c=e}finally{try{!s&&d.return&&d.return()}finally{if(u)throw c}}if(0!==n)throw new Error("Incorrect parity");for(var p=0;p<a.length;++p)if(r[p]!==a[p])throw new Error("Incorrect prefix");if(r.length!==a.length+t.Olm.PRIVATE_KEY_LENGTH+1)throw new Error("Incorrect length");return r.slice(a.length,a.length+t.Olm.PRIVATE_KEY_LENGTH)};var i=s(e("bs58"));function s(e){return e&&e.__esModule?e:{default:e}}var a=[139,1]}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("buffer").Buffer)},{"babel-runtime/core-js/get-iterator":69,bs58:105,buffer:106}],23:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.Backend=r.VERSION=void 0;var n=c(e("babel-runtime/core-js/object/assign")),o=c(e("babel-runtime/helpers/classCallCheck")),i=c(e("babel-runtime/helpers/createClass"));r.upgradeDatabase=function(e,t){a.default.log("Upgrading IndexedDBCryptoStore from version "+t+" to "+l),t<1&&function(e){var t=e.createObjectStore("outgoingRoomKeyRequests",{keyPath:"requestId"});t.createIndex("session",["requestBody.room_id","requestBody.session_id"]),t.createIndex("state","state")}(e);t<2&&e.createObjectStore("account");if(t<3){e.createObjectStore("sessions",{keyPath:["deviceKey","sessionId"]}).createIndex("deviceKey","deviceKey")}t<4&&e.createObjectStore("inbound_group_sessions",{keyPath:["senderCurve25519Key","sessionId"]});t<5&&e.createObjectStore("device_data");t<6&&e.createObjectStore("rooms");t<7&&e.createObjectStore("sessions_needing_backup",{keyPath:["senderCurve25519Key","sessionId"]})};var s=c(e("bluebird")),a=c(e("../../logger")),u=c(e("../../utils"));function c(e){return e&&e.__esModule?e:{default:e}}var l=r.VERSION=7;r.Backend=function(){function e(t){var r=this;(0,o.default)(this,e),this._db=t,t.onversionchange=function(e){a.default.log("versionchange for indexeddb "+r._dbName+": closing"),t.close()}}return(0,i.default)(e,[{key:"getOrAddOutgoingRoomKeyRequest",value:function(e){var t=e.requestBody,r=s.default.defer(),n=this._db.transaction("outgoingRoomKeyRequests","readwrite");return n.onerror=r.reject,this._getOutgoingRoomKeyRequest(n,t,(function(o){if(o)return a.default.log("already have key request outstanding for "+t.room_id+" / "+t.session_id+": not sending another"),void r.resolve(o);a.default.log("enqueueing key request for "+t.room_id+" / "+t.session_id),n.oncomplete=function(){r.resolve(e)},n.objectStore("outgoingRoomKeyRequests").add(e)})),r.promise}},{key:"getOutgoingRoomKeyRequest",value:function(e){var t=s.default.defer(),r=this._db.transaction("outgoingRoomKeyRequests","readonly");return r.onerror=t.reject,this._getOutgoingRoomKeyRequest(r,e,(function(e){t.resolve(e)})),t.promise}},{key:"_getOutgoingRoomKeyRequest",value:function(e,t,r){e.objectStore("outgoingRoomKeyRequests").index("session").openCursor([t.room_id,t.session_id]).onsuccess=function(e){var n=e.target.result;if(n){var o=n.value;u.default.deepCompare(o.requestBody,t)?r(o):n.continue()}else r(null)}}},{key:"getOutgoingRoomKeyRequestByState",value:function(e){if(0===e.length)return s.default.resolve(null);var t=0,r=void 0;var n=this._db.transaction("outgoingRoomKeyRequests","readonly"),o=n.objectStore("outgoingRoomKeyRequests"),i=e[t];return o.index("state").openCursor(i).onsuccess=function n(o){var i=o.target.result;if(i)r=i.value;else if(!(++t>=e.length)){var s=e[t];o.target.source.openCursor(s).onsuccess=n}},f(n).then((function(){return r}))}},{key:"getOutgoingRoomKeyRequestsByTarget",value:function(e,t,r){var n=0,o=[];var i=this._db.transaction("outgoingRoomKeyRequests","readonly"),s=i.objectStore("outgoingRoomKeyRequests"),a=r[n];return s.index("state").openCursor(a).onsuccess=function i(s){var a=s.target.result;if(a){var u=a.value;u.recipients.includes({userId:e,deviceId:t})&&o.push(u),a.continue()}else{if(++n>=r.length)return;var c=r[n];s.target.source.openCursor(c).onsuccess=i}},f(i).then((function(){return o}))}},{key:"updateOutgoingRoomKeyRequest",value:function(e,t,r){var o=null;var i=this._db.transaction("outgoingRoomKeyRequests","readwrite");return i.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(e){var i=e.target.result;if(i){var s=i.value;s.state==t?((0,n.default)(s,r),i.update(s),o=s):a.default.warn("Cannot update room key request from "+t+" as it was already updated to "+s.state)}},f(i).then((function(){return o}))}},{key:"deleteOutgoingRoomKeyRequest",value:function(e,t){var r=this._db.transaction("outgoingRoomKeyRequests","readwrite");return r.objectStore("outgoingRoomKeyRequests").openCursor(e).onsuccess=function(e){var r=e.target.result;if(r){var n=r.value;n.state==t?r.delete():a.default.warn("Cannot delete room key request in state "+n.state+" (expected "+t+")")}},f(r)}},{key:"getAccount",value:function(e,t){var r=e.objectStore("account").get("-");r.onsuccess=function(){try{t(r.result||null)}catch(t){d(e,t)}}}},{key:"storeAccount",value:function(e,t){e.objectStore("account").put(t,"-")}},{key:"getCrossSigningKeys",value:function(e,t){var r=e.objectStore("account").get("crossSigningKeys");r.onsuccess=function(){try{t(r.result||null)}catch(t){d(e,t)}}}},{key:"storeCrossSigningKeys",value:function(e,t){e.objectStore("account").put(t,"crossSigningKeys")}},{key:"countEndToEndSessions",value:function(e,t){var r=e.objectStore("sessions").count();r.onsuccess=function(){t(r.result)}}},{key:"getEndToEndSessions",value:function(e,t,r){var n=t.objectStore("sessions").index("deviceKey").openCursor(e),o={};n.onsuccess=function(){var e=n.result;if(e)o[e.value.sessionId]={session:e.value.session,lastReceivedMessageTs:e.value.lastReceivedMessageTs},e.continue();else try{r(o)}catch(e){d(t,e)}}}},{key:"getEndToEndSession",value:function(e,t,r,n){var o=r.objectStore("sessions").get([e,t]);o.onsuccess=function(){try{o.result?n({session:o.result.session,lastReceivedMessageTs:o.result.lastReceivedMessageTs}):n(null)}catch(e){d(r,e)}}}},{key:"getAllEndToEndSessions",value:function(e,t){var r=e.objectStore("sessions").openCursor();r.onsuccess=function(){var n=r.result;if(n)t(n.value),n.continue();else try{t(null)}catch(t){d(e,t)}}}},{key:"storeEndToEndSession",value:function(e,t,r,n){n.objectStore("sessions").put({deviceKey:e,sessionId:t,session:r.session,lastReceivedMessageTs:r.lastReceivedMessageTs})}},{key:"getEndToEndInboundGroupSession",value:function(e,t,r,n){var o=r.objectStore("inbound_group_sessions").get([e,t]);o.onsuccess=function(){try{o.result?n(o.result.session):n(null)}catch(e){d(r,e)}}}},{key:"getAllEndToEndInboundGroupSessions",value:function(e,t){var r=e.objectStore("inbound_group_sessions").openCursor();r.onsuccess=function(){var n=r.result;if(n){try{t({senderKey:n.value.senderCurve25519Key,sessionId:n.value.sessionId,sessionData:n.value.session})}catch(t){d(e,t)}n.continue()}else try{t(null)}catch(t){d(e,t)}}}},{key:"addEndToEndInboundGroupSession",value:function(e,t,r,n){var o=n.objectStore("inbound_group_sessions").add({senderCurve25519Key:e,sessionId:t,session:r});o.onerror=function(r){"ConstraintError"===o.error.name?(r.stopPropagation(),r.preventDefault(),a.default.log("Ignoring duplicate inbound group session: "+e+" / "+t)):d(n,new Error("Failed to add inbound group session: "+o.error))}}},{key:"storeEndToEndInboundGroupSession",value:function(e,t,r,n){n.objectStore("inbound_group_sessions").put({senderCurve25519Key:e,sessionId:t,session:r})}},{key:"getEndToEndDeviceData",value:function(e,t){var r=e.objectStore("device_data").get("-");r.onsuccess=function(){try{t(r.result||null)}catch(t){d(e,t)}}}},{key:"storeEndToEndDeviceData",value:function(e,t){t.objectStore("device_data").put(e,"-")}},{key:"storeEndToEndRoom",value:function(e,t,r){r.objectStore("rooms").put(t,e)}},{key:"getEndToEndRooms",value:function(e,t){var r={},n=e.objectStore("rooms").openCursor();n.onsuccess=function(){var o=n.result;if(o)r[o.key]=o.value,o.continue();else try{t(r)}catch(t){d(e,t)}}}},{key:"getSessionsNeedingBackup",value:function(e){var t=this;return new s.default((function(r,n){var o=[],i=t._db.transaction(["sessions_needing_backup","inbound_group_sessions"],"readonly");i.onerror=n,i.oncomplete=function(){r(o)};var s=i.objectStore("sessions_needing_backup"),a=i.objectStore("inbound_group_sessions"),u=s.openCursor();u.onsuccess=function(){var t=u.result;if(t){var r=a.get(t.key);r.onsuccess=function(){o.push({senderKey:r.result.senderCurve25519Key,sessionId:r.result.sessionId,sessionData:r.result.session})},(!e||o.length<e)&&t.continue()}}}))}},{key:"countSessionsNeedingBackup",value:function(e){e||(e=this._db.transaction("sessions_needing_backup","readonly"));var t=e.objectStore("sessions_needing_backup");return new s.default((function(e,r){var n=t.count();n.onerror=r,n.onsuccess=function(){return e(n.result)}}))}},{key:"unmarkSessionsNeedingBackup",value:function(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));var r=t.objectStore("sessions_needing_backup");return s.default.all(e.map((function(e){return new s.default((function(t,n){var o=r.delete([e.senderKey,e.sessionId]);o.onsuccess=t,o.onerror=n}))})))}},{key:"markSessionsNeedingBackup",value:function(e,t){t||(t=this._db.transaction("sessions_needing_backup","readwrite"));var r=t.objectStore("sessions_needing_backup");return s.default.all(e.map((function(e){return new s.default((function(t,n){var o=r.put({senderCurve25519Key:e.senderKey,sessionId:e.sessionId});o.onsuccess=t,o.onerror=n}))})))}},{key:"doTxn",value:function(e,t,r){var n=this._db.transaction(t,e),o=f(n),i=r(n);return o.then((function(){return i}))}}]),e}();function d(e,t){e._mx_abortexception=t;try{e.abort()}catch(t){}}function f(e){return new s.default((function(t,r){e.oncomplete=function(){void 0!==e._mx_abortexception&&r(e._mx_abortexception),t()},e.onerror=function(t){void 0!==e._mx_abortexception?r(e._mx_abortexception):(a.default.log("Error performing indexeddb txn",t),r(t.target.error))},e.onabort=function(t){void 0!==e._mx_abortexception?r(e._mx_abortexception):(a.default.log("Error performing indexeddb txn",t),r(t.target.error))}}))}},{"../../logger":37,"../../utils":65,"babel-runtime/core-js/object/assign":76,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,bluebird:103}],24:[function(e,t,r){(function(t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=p(e("babel-runtime/helpers/classCallCheck")),o=p(e("babel-runtime/helpers/createClass")),i=p(e("bluebird")),s=p(e("../../logger")),a=p(e("./localStorage-crypto-store")),u=p(e("./memory-crypto-store")),c=f(e("./indexeddb-crypto-store-backend")),l=e("../../errors"),d=f(e("../../indexeddb-helpers"));function f(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function p(e){return e&&e.__esModule?e:{default:e}}var h=function(){function e(t,r){(0,n.default)(this,e),this._indexedDB=t,this._dbName=r,this._backendPromise=null}return(0,o.default)(e,[{key:"_connect",value:function(){var r=this;return this._backendPromise?this._backendPromise:(this._backendPromise=new i.default((function(e,t){if(r._indexedDB){s.default.log("connecting to indexeddb "+r._dbName);var n=r._indexedDB.open(r._dbName,c.VERSION);n.onupgradeneeded=function(e){var t=e.target.result,r=e.oldVersion;c.upgradeDatabase(t,r)},n.onblocked=function(){s.default.log("can't yet open IndexedDBCryptoStore because it is open elsewhere")},n.onerror=function(e){s.default.log("Error connecting to indexeddb",e),t(e.target.error)},n.onsuccess=function(t){var n=t.target.result;s.default.log("connected to indexeddb "+r._dbName),e(new c.Backend(n))}}else t(new Error("no indexeddb support available"))})).then((function(t){return t.doTxn("readonly",[e.STORE_INBOUND_GROUP_SESSIONS],(function(e){t.getEndToEndInboundGroupSession("","",e,(function(){}))})).then((function(){return t}))})).catch((function(e){if("VersionError"===e.name)throw s.default.warn("Crypto DB is too new for us to use!",e),new l.InvalidCryptoStoreError(l.InvalidCryptoStoreError.TOO_NEW);s.default.warn("unable to connect to indexeddb "+r._dbName+": falling back to localStorage store: "+e);try{return new a.default(t.localStorage)}catch(e){return s.default.warn("unable to open localStorage: falling back to in-memory store: "+e),new u.default}})),this._backendPromise)}},{key:"deleteAllData",value:function(){var e=this;return new i.default((function(t,r){if(e._indexedDB){s.default.log("Removing indexeddb instance: "+e._dbName);var n=e._indexedDB.deleteDatabase(e._dbName);n.onblocked=function(){s.default.log("can't yet delete IndexedDBCryptoStore because it is open elsewhere")},n.onerror=function(e){s.default.log("Error deleting data from indexeddb",e),r(e.target.error)},n.onsuccess=function(){s.default.log("Removed indexeddb instance: "+e._dbName),t()}}else r(new Error("no indexeddb support available"))})).catch((function(e){s.default.warn("unable to delete IndexedDBCryptoStore: "+e)}))}},{key:"getOrAddOutgoingRoomKeyRequest",value:function(e){return this._connect().then((function(t){return t.getOrAddOutgoingRoomKeyRequest(e)}))}},{key:"getOutgoingRoomKeyRequest",value:function(e){return this._connect().then((function(t){return t.getOutgoingRoomKeyRequest(e)}))}},{key:"getOutgoingRoomKeyRequestByState",value:function(e){return this._connect().then((function(t){return t.getOutgoingRoomKeyRequestByState(e)}))}},{key:"getOutgoingRoomKeyRequestsByTarget",value:function(e,t,r){return this._connect().then((function(n){return n.getOutgoingRoomKeyRequestsByTarget(e,t,r)}))}},{key:"updateOutgoingRoomKeyRequest",value:function(e,t,r){return this._connect().then((function(n){return n.updateOutgoingRoomKeyRequest(e,t,r)}))}},{key:"deleteOutgoingRoomKeyRequest",value:function(e,t){return this._connect().then((function(r){return r.deleteOutgoingRoomKeyRequest(e,t)}))}},{key:"getAccount",value:function(e,t){this._backendPromise.value().getAccount(e,t)}},{key:"storeAccount",value:function(e,t){this._backendPromise.value().storeAccount(e,t)}},{key:"getCrossSigningKeys",value:function(e,t){this._backendPromise.value().getCrossSigningKeys(e,t)}},{key:"storeCrossSigningKeys",value:function(e,t){this._backendPromise.value().storeCrossSigningKeys(e,t)}},{key:"countEndToEndSessions",value:function(e,t){this._backendPromise.value().countEndToEndSessions(e,t)}},{key:"getEndToEndSession",value:function(e,t,r,n){this._backendPromise.value().getEndToEndSession(e,t,r,n)}},{key:"getEndToEndSessions",value:function(e,t,r){this._backendPromise.value().getEndToEndSessions(e,t,r)}},{key:"getAllEndToEndSessions",value:function(e,t){this._backendPromise.value().getAllEndToEndSessions(e,t)}},{key:"storeEndToEndSession",value:function(e,t,r,n){this._backendPromise.value().storeEndToEndSession(e,t,r,n)}},{key:"getEndToEndInboundGroupSession",value:function(e,t,r,n){this._backendPromise.value().getEndToEndInboundGroupSession(e,t,r,n)}},{key:"getAllEndToEndInboundGroupSessions",value:function(e,t){this._backendPromise.value().getAllEndToEndInboundGroupSessions(e,t)}},{key:"addEndToEndInboundGroupSession",value:function(e,t,r,n){this._backendPromise.value().addEndToEndInboundGroupSession(e,t,r,n)}},{key:"storeEndToEndInboundGroupSession",value:function(e,t,r,n){this._backendPromise.value().storeEndToEndInboundGroupSession(e,t,r,n)}},{key:"storeEndToEndDeviceData",value:function(e,t){this._backendPromise.value().storeEndToEndDeviceData(e,t)}},{key:"getEndToEndDeviceData",value:function(e,t){this._backendPromise.value().getEndToEndDeviceData(e,t)}},{key:"storeEndToEndRoom",value:function(e,t,r){this._backendPromise.value().storeEndToEndRoom(e,t,r)}},{key:"getEndToEndRooms",value:function(e,t){this._backendPromise.value().getEndToEndRooms(e,t)}},{key:"getSessionsNeedingBackup",value:function(e){return this._connect().then((function(t){return t.getSessionsNeedingBackup(e)}))}},{key:"countSessionsNeedingBackup",value:function(e){return this._connect().then((function(t){return t.countSessionsNeedingBackup(e)}))}},{key:"unmarkSessionsNeedingBackup",value:function(e,t){return this._connect().then((function(r){return r.unmarkSessionsNeedingBackup(e,t)}))}},{key:"markSessionsNeedingBackup",value:function(e,t){return this._connect().then((function(r){return r.markSessionsNeedingBackup(e,t)}))}},{key:"doTxn",value:function(e,t,r){return this._connect().then((function(n){return n.doTxn(e,t,r)}))}}],[{key:"exists",value:function(e,t){return d.exists(e,t)}}]),e}();r.default=h,h.STORE_ACCOUNT="account",h.STORE_SESSIONS="sessions",h.STORE_INBOUND_GROUP_SESSIONS="inbound_group_sessions",h.STORE_DEVICE_DATA="device_data",h.STORE_ROOMS="rooms",h.STORE_BACKUP="sessions_needing_backup"}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../../errors":31,"../../indexeddb-helpers":35,"../../logger":37,"./indexeddb-crypto-store-backend":23,"./localStorage-crypto-store":25,"./memory-crypto-store":26,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,bluebird:103}],25:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=y(e("babel-runtime/core-js/json/stringify")),o=y(e("babel-runtime/core-js/object/keys")),i=y(e("babel-runtime/core-js/object/values")),s=y(e("babel-runtime/helpers/slicedToArray")),a=y(e("babel-runtime/core-js/object/entries")),u=y(e("babel-runtime/core-js/get-iterator")),c=y(e("babel-runtime/core-js/object/get-prototype-of")),l=y(e("babel-runtime/helpers/classCallCheck")),d=y(e("babel-runtime/helpers/createClass")),f=y(e("babel-runtime/helpers/possibleConstructorReturn")),p=y(e("babel-runtime/helpers/inherits")),h=y(e("bluebird")),v=y(e("../../logger")),m=y(e("./memory-crypto-store"));function y(e){return e&&e.__esModule?e:{default:e}}var _="crypto.",g=_+"account",b=_+"cross_signing_keys",k=_+"device_data",w=_+"inboundgroupsessions/",E=_+"rooms/",S=_+"sessionsneedingbackup";function x(e){return _+"sessions/"+e}function R(e,t){return w+e+"/"+t}function T(e){return E+e}var I=function(e){function t(e){(0,l.default)(this,t);var r=(0,f.default)(this,(t.__proto__||(0,c.default)(t)).call(this));return r.store=e,r}return(0,p.default)(t,e),(0,d.default)(t,[{key:"countEndToEndSessions",value:function(e,t){for(var r=0,n=0;n<this.store.length;++n)this.store.key(n).startsWith(x(""))&&++r;t(r)}},{key:"_getEndToEndSessions",value:function(e,t,r){var n=C(this.store,x(e)),o={},i=!0,c=!1,l=void 0;try{for(var d,f=(0,u.default)((0,a.default)(n||{}));!(i=(d=f.next()).done);i=!0){var p=(0,s.default)(d.value,2),h=p[0],v=p[1];o[h]="string"==typeof v?{session:v}:v}}catch(e){c=!0,l=e}finally{try{!i&&f.return&&f.return()}finally{if(c)throw l}}return o}},{key:"getEndToEndSession",value:function(e,t,r,n){n(this._getEndToEndSessions(e)[t]||{})}},{key:"getEndToEndSessions",value:function(e,t,r){r(this._getEndToEndSessions(e)||{})}},{key:"getAllEndToEndSessions",value:function(e,t){for(var r=0;r<this.store.length;++r)if(this.store.key(r).startsWith(x(""))){var n=this.store.key(r).split("/")[1],o=!0,s=!1,a=void 0;try{for(var c,l=(0,u.default)((0,i.default)(this._getEndToEndSessions(n)));!(o=(c=l.next()).done);o=!0){t(c.value)}}catch(e){s=!0,a=e}finally{try{!o&&l.return&&l.return()}finally{if(s)throw a}}}}},{key:"storeEndToEndSession",value:function(e,t,r,n){var o=this._getEndToEndSessions(e)||{};o[t]=r,O(this.store,x(e),o)}},{key:"getEndToEndInboundGroupSession",value:function(e,t,r,n){n(C(this.store,R(e,t)))}},{key:"getAllEndToEndInboundGroupSessions",value:function(e,t){for(var r=0;r<this.store.length;++r){var n=this.store.key(r);n.startsWith(w)&&t({senderKey:n.substr(w.length,43),sessionId:n.substr(w.length+44),sessionData:C(this.store,n)})}t(null)}},{key:"addEndToEndInboundGroupSession",value:function(e,t,r,n){C(this.store,R(e,t))||this.storeEndToEndInboundGroupSession(e,t,r,n)}},{key:"storeEndToEndInboundGroupSession",value:function(e,t,r,n){O(this.store,R(e,t),r)}},{key:"getEndToEndDeviceData",value:function(e,t){t(C(this.store,k))}},{key:"storeEndToEndDeviceData",value:function(e,t){O(this.store,k,e)}},{key:"storeEndToEndRoom",value:function(e,t,r){O(this.store,T(e),t)}},{key:"getEndToEndRooms",value:function(e,t){for(var r={},n=T(""),o=0;o<this.store.length;++o){var i=this.store.key(o);if(i.startsWith(n))r[i.substr(n.length)]=C(this.store,i)}t(r)}},{key:"getSessionsNeedingBackup",value:function(e){var t=this,r=C(this.store,S)||{},n=[];for(var o in r){if(Object.prototype.hasOwnProperty.call(r,o))if("break"===function(){var r=o.substr(0,43),i=o.substr(44);if(t.getEndToEndInboundGroupSession(r,i,null,(function(e){n.push({senderKey:r,sessionId:i,sessionData:e})})),e&&o.length>=e)return"break"}())break}return h.default.resolve(n)}},{key:"countSessionsNeedingBackup",value:function(){var e=C(this.store,S)||{};return h.default.resolve((0,o.default)(e).length)}},{key:"unmarkSessionsNeedingBackup",value:function(e){var t=C(this.store,S)||{},r=!0,n=!1,o=void 0;try{for(var i,s=(0,u.default)(e);!(r=(i=s.next()).done);r=!0){var a=i.value;delete t[a.senderKey+"/"+a.sessionId]}}catch(e){n=!0,o=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw o}}return O(this.store,S,t),h.default.resolve()}},{key:"markSessionsNeedingBackup",value:function(e){var t=C(this.store,S)||{},r=!0,n=!1,o=void 0;try{for(var i,s=(0,u.default)(e);!(r=(i=s.next()).done);r=!0){var a=i.value;t[a.senderKey+"/"+a.sessionId]=!0}}catch(e){n=!0,o=e}finally{try{!r&&s.return&&s.return()}finally{if(n)throw o}}return O(this.store,S,t),h.default.resolve()}},{key:"deleteAllData",value:function(){return this.store.removeItem(g),h.default.resolve()}},{key:"getAccount",value:function(e,t){t(C(this.store,g))}},{key:"storeAccount",value:function(e,t){O(this.store,g,t)}},{key:"getCrossSigningKeys",value:function(e,t){t(C(this.store,b))}},{key:"storeCrossSigningKeys",value:function(e,t){O(this.store,b,t)}},{key:"doTxn",value:function(e,t,r){return h.default.resolve(r(null))}}],[{key:"exists",value:function(e){for(var t=e.length,r=0;r<t;r++)if(e.key(r).startsWith(_))return!0;return!1}}]),t}(m.default);function C(e,t){try{return JSON.parse(e.getItem(t))}catch(e){v.default.log("Error: Failed to get key %s: %s",t,e.stack||e),v.default.log(e.stack)}return null}function O(e,t,r){e.setItem(t,(0,n.default)(r))}r.default=I},{"../../logger":37,"./memory-crypto-store":26,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/json/stringify":71,"babel-runtime/core-js/object/entries":79,"babel-runtime/core-js/object/get-prototype-of":81,"babel-runtime/core-js/object/keys":82,"babel-runtime/core-js/object/values":84,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,"babel-runtime/helpers/inherits":95,"babel-runtime/helpers/possibleConstructorReturn":96,"babel-runtime/helpers/slicedToArray":97,bluebird:103}],26:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=f(e("babel-runtime/core-js/object/values")),o=f(e("babel-runtime/core-js/object/keys")),i=f(e("babel-runtime/core-js/object/assign")),s=f(e("babel-runtime/core-js/get-iterator")),a=f(e("babel-runtime/helpers/classCallCheck")),u=f(e("babel-runtime/helpers/createClass")),c=f(e("bluebird")),l=f(e("../../logger")),d=f(e("../../utils"));function f(e){return e&&e.__esModule?e:{default:e}}var p=function(){function e(){(0,a.default)(this,e),this._outgoingRoomKeyRequests=[],this._account=null,this._crossSigningKeys=null,this._sessions={},this._inboundGroupSessions={},this._deviceData=null,this._rooms={},this._sessionsNeedingBackup={}}return(0,u.default)(e,[{key:"deleteAllData",value:function(){return c.default.resolve()}},{key:"getOrAddOutgoingRoomKeyRequest",value:function(e){var t=this,r=e.requestBody;return c.default.try((function(){var n=t._getOutgoingRoomKeyRequest(r);return n?(l.default.log("already have key request outstanding for "+r.room_id+" / "+r.session_id+": not sending another"),n):(l.default.log("enqueueing key request for "+r.room_id+" / "+r.session_id),t._outgoingRoomKeyRequests.push(e),e)}))}},{key:"getOutgoingRoomKeyRequest",value:function(e){return c.default.resolve(this._getOutgoingRoomKeyRequest(e))}},{key:"_getOutgoingRoomKeyRequest",value:function(e){var t=!0,r=!1,n=void 0;try{for(var o,i=(0,s.default)(this._outgoingRoomKeyRequests);!(t=(o=i.next()).done);t=!0){var a=o.value;if(d.default.deepCompare(a.requestBody,e))return a}}catch(e){r=!0,n=e}finally{try{!t&&i.return&&i.return()}finally{if(r)throw n}}return null}},{key:"getOutgoingRoomKeyRequestByState",value:function(e){var t=!0,r=!1,n=void 0;try{for(var o,i=(0,s.default)(this._outgoingRoomKeyRequests);!(t=(o=i.next()).done);t=!0){var a=o.value,u=!0,l=!1,d=void 0;try{for(var f,p=(0,s.default)(e);!(u=(f=p.next()).done);u=!0){var h=f.value;if(a.state===h)return c.default.resolve(a)}}catch(e){l=!0,d=e}finally{try{!u&&p.return&&p.return()}finally{if(l)throw d}}}}catch(e){r=!0,n=e}finally{try{!t&&i.return&&i.return()}finally{if(r)throw n}}return c.default.resolve(null)}},{key:"getOutgoingRoomKeyRequestsByTarget",value:function(e,t,r){var n=[],o=!0,i=!1,a=void 0;try{for(var u,l=(0,s.default)(this._outgoingRoomKeyRequests);!(o=(u=l.next()).done);o=!0){var d=u.value,f=!0,p=!1,h=void 0;try{for(var v,m=(0,s.default)(r);!(f=(v=m.next()).done);f=!0){var y=v.value;d.state===y&&d.recipients.includes({userId:e,deviceId:t})&&n.push(d)}}catch(e){p=!0,h=e}finally{try{!f&&m.return&&m.return()}finally{if(p)throw h}}}}catch(e){i=!0,a=e}finally{try{!o&&l.return&&l.return()}finally{if(i)throw a}}return c.default.resolve(n)}},{key:"updateOutgoingRoomKeyRequest",value:function(e,t,r){var n=!0,o=!1,a=void 0;try{for(var u,d=(0,s.default)(this._outgoingRoomKeyRequests);!(n=(u=d.next()).done);n=!0){var f=u.value;if(f.requestId===e)return f.state!=t?(l.default.warn("Cannot update room key request from "+t+" as it was already updated to "+f.state),c.default.resolve(null)):((0,i.default)(f,r),c.default.resolve(f))}}catch(e){o=!0,a=e}finally{try{!n&&d.return&&d.return()}finally{if(o)throw a}}return c.default.resolve(null)}},{key:"deleteOutgoingRoomKeyRequest",value:function(e,t){for(var r=0;r<this._outgoingRoomKeyRequests.length;r++){var n=this._outgoingRoomKeyRequests[r];if(n.requestId===e)return n.state!=t?(l.default.warn("Cannot delete room key request in state "+n.state+" (expected "+t+")"),c.default.resolve(null)):(this._outgoingRoomKeyRequests.splice(r,1),c.default.resolve(n))}return c.default.resolve(null)}},{key:"getAccount",value:function(e,t){t(this._account)}},{key:"storeAccount",value:function(e,t){this._account=t}},{key:"getCrossSigningKeys",value:function(e,t){t(this._crossSigningKeys)}},{key:"storeCrossSigningKeys",value:function(e,t){this._crossSigningKeys=t}},{key:"countEndToEndSessions",value:function(e,t){return(0,o.default)(this._sessions).length}},{key:"getEndToEndSession",value:function(e,t,r,n){n((this._sessions[e]||{})[t]||null)}},{key:"getEndToEndSessions",value:function(e,t,r){r(this._sessions[e]||{})}},{key:"getAllEndToEndSessions",value:function(e,t){var r=!0,o=!1,i=void 0;try{for(var a,u=(0,s.default)((0,n.default)(this._sessions));!(r=(a=u.next()).done);r=!0){var c=a.value,l=!0,d=!1,f=void 0;try{for(var p,h=(0,s.default)((0,n.default)(c));!(l=(p=h.next()).done);l=!0){t(p.value)}}catch(e){d=!0,f=e}finally{try{!l&&h.return&&h.return()}finally{if(d)throw f}}}}catch(e){o=!0,i=e}finally{try{!r&&u.return&&u.return()}finally{if(o)throw i}}}},{key:"storeEndToEndSession",value:function(e,t,r,n){var o=this._sessions[e];void 0===o&&(o={},this._sessions[e]=o),o[t]=r}},{key:"getEndToEndInboundGroupSession",value:function(e,t,r,n){n(this._inboundGroupSessions[e+"/"+t]||null)}},{key:"getAllEndToEndInboundGroupSessions",value:function(e,t){var r=!0,n=!1,i=void 0;try{for(var a,u=(0,s.default)((0,o.default)(this._inboundGroupSessions));!(r=(a=u.next()).done);r=!0){var c=a.value;t({senderKey:c.substr(0,43),sessionId:c.substr(44),sessionData:this._inboundGroupSessions[c]})}}catch(e){n=!0,i=e}finally{try{!r&&u.return&&u.return()}finally{if(n)throw i}}t(null)}},{key:"addEndToEndInboundGroupSession",value:function(e,t,r,n){var o=e+"/"+t;void 0===this._inboundGroupSessions[o]&&(this._inboundGroupSessions[o]=r)}},{key:"storeEndToEndInboundGroupSession",value:function(e,t,r,n){this._inboundGroupSessions[e+"/"+t]=r}},{key:"getEndToEndDeviceData",value:function(e,t){t(this._deviceData)}},{key:"storeEndToEndDeviceData",value:function(e,t){this._deviceData=e}},{key:"storeEndToEndRoom",value:function(e,t,r){this._rooms[e]=t}},{key:"getEndToEndRooms",value:function(e,t){t(this._rooms)}},{key:"getSessionsNeedingBackup",value:function(e){var t=[];for(var r in this._sessionsNeedingBackup)if(this._inboundGroupSessions[r]&&(t.push({senderKey:r.substr(0,43),sessionId:r.substr(44),sessionData:this._inboundGroupSessions[r]}),e&&r.length>=e))break;return c.default.resolve(t)}},{key:"countSessionsNeedingBackup",value:function(){return c.default.resolve((0,o.default)(this._sessionsNeedingBackup).length)}},{key:"unmarkSessionsNeedingBackup",value:function(e){var t=!0,r=!1,n=void 0;try{for(var o,i=(0,s.default)(e);!(t=(o=i.next()).done);t=!0){var a=o.value,u=a.senderKey+"/"+a.sessionId;delete this._sessionsNeedingBackup[u]}}catch(e){r=!0,n=e}finally{try{!t&&i.return&&i.return()}finally{if(r)throw n}}return c.default.resolve()}},{key:"markSessionsNeedingBackup",value:function(e){var t=!0,r=!1,n=void 0;try{for(var o,i=(0,s.default)(e);!(t=(o=i.next()).done);t=!0){var a=o.value,u=a.senderKey+"/"+a.sessionId;this._sessionsNeedingBackup[u]=!0}}catch(e){r=!0,n=e}finally{try{!t&&i.return&&i.return()}finally{if(r)throw n}}return c.default.resolve()}},{key:"doTxn",value:function(e,t,r){return c.default.resolve(r(null))}}]),e}();r.default=p},{"../../logger":37,"../../utils":65,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/object/assign":76,"babel-runtime/core-js/object/keys":82,"babel-runtime/core-js/object/values":84,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,bluebird:103}],27:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=k(e("babel-runtime/regenerator")),o=k(e("babel-runtime/helpers/slicedToArray")),i=k(e("babel-runtime/core-js/object/entries")),s=k(e("babel-runtime/core-js/get-iterator")),a=e("bluebird"),u=k(e("babel-runtime/helpers/defineProperty")),c=k(e("babel-runtime/core-js/promise")),l=k(e("babel-runtime/core-js/object/assign")),d=k(e("babel-runtime/core-js/object/get-prototype-of")),f=k(e("babel-runtime/helpers/classCallCheck")),p=k(e("babel-runtime/helpers/createClass")),h=k(e("babel-runtime/helpers/possibleConstructorReturn")),v=k(e("babel-runtime/helpers/inherits")),m=e("../../models/event"),y=e("events"),_=k(e("../../logger")),g=k(e("../deviceinfo")),b=e("./Error");function k(e){return e&&e.__esModule?e:{default:e}}var w=new Error("Verification timed out"),E=function(e){function t(e,r,n,o,i,s,a){(0,f.default)(this,t);var u=(0,h.default)(this,(t.__proto__||(0,d.default)(t)).call(this));return u._baseApis=e,u.userId=r,u.deviceId=n,u.transactionId=o,"string"==typeof i||i instanceof String?(u.roomId=i,u.startEvent=s,u.request=a):(u.startEvent=i,u.request=s),u.cancelled=!1,u._done=!1,u._promise=null,u._transactionTimeoutTimer=null,u._eventsSubscription=null,u._resetTimer(),u.roomId?u._sendWithTxnId=u._sendMessage:u._sendWithTxnId=u._sendToDevice,u}var r;return(0,v.default)(t,e),(0,p.default)(t,[{key:"_resetTimer",value:function(){var e=this;_.default.info("Refreshing/starting the verification transaction timeout timer"),null!==this._transactionTimeoutTimer&&clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=setTimeout((function(){e._done||e.cancelled||(_.default.info("Triggering verification timeout"),e.cancel(w))}),6e5)}},{key:"_endTimer",value:function(){null!==this._transactionTimeoutTimer&&(clearTimeout(this._transactionTimeoutTimer),this._transactionTimeoutTimer=null)}},{key:"_contentFromEventWithTxnId",value:function(e){if(this.roomId){var t=(0,l.default)({},e.getContent());return t["m.relates_to"]=e.getRelation(),t}return e.getContent()}},{key:"_contentWithTxnId",value:function(e){var t=(0,l.default)({},e);return this.roomId?t["m.relates_to"]={rel_type:"m.reference",event_id:this.transactionId}:t.transaction_id=this.transactionId,t}},{key:"_send",value:function(e,t){var r=this._contentWithTxnId(t);return this._sendWithTxnId(e,r)}},{key:"_sendToDevice",value:function(e,t){return this._done?c.default.reject(new Error("Verification is already done")):this._baseApis.sendToDevice(e,(0,u.default)({},this.userId,(0,u.default)({},this.deviceId,t)))}},{key:"_sendMessage",value:function(e,t){return this._done?c.default.reject(new Error("Verification is already done")):this._baseApis.sendEvent(this.roomId,e,t)}},{key:"_waitForEvent",value:function(e){var t=this;return this._done?c.default.reject(new Error("Verification is already done")):(this._expectedEvent=e,new c.default((function(e,r){t._resolveEvent=e,t._rejectEvent=r})))}},{key:"handleEvent",value:function(e){if(!this._done)if(e.getType()===this._expectedEvent)this._expectedEvent=void 0,this._rejectEvent=void 0,this._resetTimer(),this._resolveEvent(e);else if("m.key.verification.cancel"===e.getType()){var t=this._reject;this._reject=void 0,t(new Error("Other side cancelled verification"))}else{var r=new Error("Unexpected message: expecting "+this._expectedEvent+" but got "+e.getType());if(this._expectedEvent=void 0,this._rejectEvent){var n=this._rejectEvent;this._rejectEvent=void 0,n(r)}this.cancel(r)}}},{key:"done",value:function(){this._endTimer(),this._done||(this.roomId&&this._send("m.key.verification.done",{}),this._resolve())}},{key:"cancel",value:function(e){if(this._endTimer(),!this._done){if(this.cancelled=!0,this.userId&&this.deviceId&&this.transactionId)if(e===w){var t=(0,b.newTimeoutError)();this._send(t.getType(),t.getContent())}else if(e instanceof m.MatrixEvent){if(e.getSender()!==this.userId){var r=e.getContent();"m.key.verification.cancel"===e.getType()?(r.code=r.code||"m.unknown",r.reason=r.reason||r.body||"Unknown reason",r.transaction_id=this.transactionId,this._send("m.key.verification.cancel",r)):this._send("m.key.verification.cancel",{code:"m.unknown",reason:r.body||"Unknown reason",transaction_id:this.transactionId})}}else this._send("m.key.verification.cancel",{code:"m.unknown",reason:e.toString(),transaction_id:this.transactionId});null!==this._promise?this._reject&&this._reject(e):(this._eventsSubscription&&(this._eventsSubscription=this._eventsSubscription()),this._promise=c.default.reject(e)),this.emit("cancel",e)}}},{key:"verify",value:function(){var e=this;return this._promise?this._promise:(this._promise=new c.default((function(t,r){e._resolve=function(){e._done=!0,e._endTimer(),e.handler&&e._eventsSubscription&&(e._eventsSubscription=e._eventsSubscription()),t.apply(void 0,arguments)},e._reject=function(){e._done=!0,e._endTimer(),e.handler&&e._eventsSubscription&&(e._eventsSubscription=e._eventsSubscription()),r.apply(void 0,arguments)}})),this._doVerification&&!this._started&&(this._started=!0,this._resetTimer(),c.default.resolve(this._doVerification()).then(this.done.bind(this),this.cancel.bind(this))),this._promise)}},{key:"_verifyKeys",value:(r=(0,a.coroutine)(n.default.mark((function e(t,r,c){var l,d,f,p,h,v,m,y,b,k,w,E,S,x,R,T,I,C;return n.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:l=[],d=!0,f=!1,p=void 0,e.prev=4,h=(0,s.default)((0,i.default)(r));case 6:if(d=(v=h.next()).done){e.next=29;break}return m=(0,o.default)(v.value,2),y=m[0],b=m[1],k=y.split(":",2)[1],e.next=11,(0,a.resolve)(this._baseApis.getStoredDevice(t,k));case 11:if(!(w=e.sent)){e.next=18;break}return e.next=15,(0,a.resolve)(c(y,w,b));case 15:l.push(k),e.next=26;break;case 18:if(!(E=this._baseApis._crypto._deviceList.getStoredCrossSigningForUser(t))||E.getId()!==k){e.next=25;break}return e.next=22,(0,a.resolve)(c(y,g.default.fromStorage({keys:(0,u.default)({},y,k)},k),b));case 22:l.push(k),e.next=26;break;case 25:_.default.warn("verification: Could not find device "+k+" to verify");case 26:d=!0,e.next=6;break;case 29:e.next=35;break;case 31:e.prev=31,e.t0=e.catch(4),f=!0,p=e.t0;case 35:e.prev=35,e.prev=36,!d&&h.return&&h.return();case 38:if(e.prev=38,!f){e.next=41;break}throw p;case 41:return e.finish(38);case 42:return e.finish(35);case 43:if(l.length){e.next=45;break}throw new Error("No devices could be verified");case 45:S=!0,x=!1,R=void 0,e.prev=48,T=(0,s.default)(l);case 50:if(S=(I=T.next()).done){e.next=57;break}return C=I.value,e.next=54,(0,a.resolve)(this._baseApis.setDeviceVerified(t,C));case 54:S=!0,e.next=50;break;case 57:e.next=63;break;case 59:e.prev=59,e.t1=e.catch(48),x=!0,R=e.t1;case 63:e.prev=63,e.prev=64,!S&&T.return&&T.return();case 66:if(e.prev=66,!x){e.next=69;break}throw R;case 69:return e.finish(66);case 70:return e.finish(63);case 71:case"end":return e.stop()}}),e,this,[[4,31,35,43],[36,,38,42],[48,59,63,71],[64,,66,70]])}))),function(e,t,n){return r.apply(this,arguments)})},{key:"setEventsSubscription",value:function(e){this._eventsSubscription=e}}]),t}(y.EventEmitter);r.default=E},{"../../logger":37,"../../models/event":42,"../deviceinfo":18,"./Error":28,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/object/assign":76,"babel-runtime/core-js/object/entries":79,"babel-runtime/core-js/object/get-prototype-of":81,"babel-runtime/core-js/promise":85,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,"babel-runtime/helpers/defineProperty":94,"babel-runtime/helpers/inherits":95,"babel-runtime/helpers/possibleConstructorReturn":96,"babel-runtime/helpers/slicedToArray":97,"babel-runtime/regenerator":100,bluebird:103,events:257}],28:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.newInvalidMessageError=r.newUserMismatchError=r.newKeyMismatchError=r.newUnexpectedMessageError=r.newUnknownMethodError=r.newUnknownTransactionError=r.newTimeoutError=r.newUserCancelledError=void 0,r.newVerificationError=o,r.errorFactory=i;var n=e("../../models/event");function o(e,t,r){return(r=r||{}).code=e,r.reason=t,new n.MatrixEvent({type:"m.key.verification.cancel",content:r})}function i(e,t){return function(r){return o(e,t,r)}}r.newUserCancelledError=i("m.user","Cancelled by user"),r.newTimeoutError=i("m.timeout","Timed out"),r.newUnknownTransactionError=i("m.unknown_transaction","Unknown transaction"),r.newUnknownMethodError=i("m.unknown_method","Unknown method"),r.newUnexpectedMessageError=i("m.unexpected_message","Unexpected message"),r.newKeyMismatchError=i("m.key_mismatch","Key mismatch"),r.newUserMismatchError=i("m.user_error","User mismatch"),r.newInvalidMessageError=i("m.invalid_message","Invalid message")},{"../../models/event":42}],29:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.ScanQRCode=r.ShowQRCode=void 0;var n=m(e("babel-runtime/regenerator")),o=m(e("babel-runtime/helpers/slicedToArray")),i=m(e("babel-runtime/core-js/get-iterator")),s=m(e("babel-runtime/core-js/object/keys")),a=m(e("babel-runtime/core-js/promise")),u=e("bluebird"),c=m(e("babel-runtime/core-js/object/get-prototype-of")),l=m(e("babel-runtime/helpers/classCallCheck")),d=m(e("babel-runtime/helpers/createClass")),f=m(e("babel-runtime/helpers/possibleConstructorReturn")),p=m(e("babel-runtime/helpers/inherits")),h=m(e("./Base")),v=e("./Error");function m(e){return e&&e.__esModule?e:{default:e}}var y=/^(?:https?:\/\/)?(?:www\.)?matrix\.to\/#\/([#@!+][^?]+)\?(.+)$/,_=/^key_([^:]+:.+)$/,g=(0,v.errorFactory)("m.qr_code.invalid","Invalid QR code");(r.ShowQRCode=function(e){function t(){return(0,l.default)(this,t),(0,f.default)(this,(t.__proto__||(0,c.default)(t)).apply(this,arguments))}return(0,p.default)(t,e),(0,d.default)(t,[{key:"_doVerification",value:function(){if(!this._done){var e="https://matrix.to/#/"+this._baseApis.getUserId()+"?device="+encodeURIComponent(this._baseApis.deviceId)+"&action=verify&key_ed25519%3A"+encodeURIComponent(this._baseApis.deviceId)+"="+encodeURIComponent(this._baseApis.getDeviceEd25519Key());this.emit("show_qr_code",{url:e})}}}]),t}(h.default)).NAME="m.qr_code.show.v1",(r.ScanQRCode=function(e){function t(){return(0,l.default)(this,t),(0,f.default)(this,(t.__proto__||(0,c.default)(t)).apply(this,arguments))}var r;return(0,p.default)(t,e),(0,d.default)(t,[{key:"_doVerification",value:(r=(0,u.coroutine)(n.default.mark((function e(){var t,r,c,l,d,f,p,h,m,b,k,w,E,S,x,R,T=this;return n.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,u.resolve)(new a.default((function(e,t){T.emit("scan",{done:e,cancel:function(){return t((0,v.newUserCancelledError)())}})})));case 2:if(t=e.sent,r=t.match(y),c=void 0,l={},r){e.next=8;break}throw g();case 8:for(d=r[1],f=r[2].split("&").map((function(e){return e.split("=",2).map(decodeURIComponent)})),p=void 0,h=!0,m=!1,b=void 0,e.prev=14,k=(0,i.default)(f);!(h=(w=k.next()).done);h=!0)E=(0,o.default)(w.value,2),S=E[0],x=E[1],"device"===S?c=x:"action"===S?p=x:(R=S.match(_))&&(l[R[1]]=x);e.next=22;break;case 18:e.prev=18,e.t0=e.catch(14),m=!0,b=e.t0;case 22:e.prev=22,e.prev=23,!h&&k.return&&k.return();case 25:if(e.prev=25,!m){e.next=28;break}throw b;case 28:return e.finish(25);case 29:return e.finish(22);case 30:if(c&&"verify"===p&&0!==(0,s.default)(l).length){e.next=32;break}throw g();case 32:if(this.userId){e.next=37;break}return e.next=35,(0,u.resolve)(new a.default((function(e,t){T.emit("confirm_user_id",{userId:d,confirm:e,cancel:function(){return t((0,v.newUserMismatchError)())}})})));case 35:e.next=39;break;case 37:if(this.userId===d){e.next=39;break}throw(0,v.newUserMismatchError)({expected:this.userId,actual:d});case 39:return e.next=41,(0,u.resolve)(this._verifyKeys(d,l,(function(e,t,r){if(t.keys[e]!==r)throw(0,v.newKeyMismatchError)()})));case 41:case"end":return e.stop()}}),e,this,[[14,18,22,30],[23,,25,29]])}))),function(){return r.apply(this,arguments)})}],[{key:"factory",value:function(){for(var e=arguments.length,r=Array(e),n=0;n<e;n++)r[n]=arguments[n];return new(Function.prototype.bind.apply(t,[null].concat(r)))}}]),t}(h.default)).NAME="m.qr_code.scan.v1"},{"./Base":27,"./Error":28,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/object/get-prototype-of":81,"babel-runtime/core-js/object/keys":82,"babel-runtime/core-js/promise":85,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,"babel-runtime/helpers/inherits":95,"babel-runtime/helpers/possibleConstructorReturn":96,"babel-runtime/helpers/slicedToArray":97,"babel-runtime/regenerator":100,bluebird:103}],30:[function(e,t,r){(function(t){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=_(e("babel-runtime/helpers/slicedToArray")),o=_(e("babel-runtime/core-js/promise")),i=_(e("babel-runtime/regenerator")),s=e("bluebird"),a=_(e("babel-runtime/core-js/object/get-prototype-of")),u=_(e("babel-runtime/helpers/classCallCheck")),c=_(e("babel-runtime/helpers/createClass")),l=_(e("babel-runtime/helpers/possibleConstructorReturn")),d=_(e("babel-runtime/helpers/inherits")),f=_(e("babel-runtime/core-js/set")),p=_(e("babel-runtime/core-js/object/keys")),h=_(e("babel-runtime/core-js/get-iterator")),v=_(e("./Base")),m=_(e("another-json")),y=e("./Error");function _(e){return e&&e.__esModule?e:{default:e}}var g=["m.key.verification.accept","m.key.verification.key","m.key.verification.mac"],b=void 0,k=(0,y.errorFactory)("m.mismatched_sas","Mismatched short authentication string"),w=(0,y.errorFactory)("m.mismatched_commitment","Mismatched commitment");var E=[["","dog"],["","cat"],["","lion"],["","horse"],["","unicorn"],["","pig"],["","elephant"],["","rabbit"],["","panda"],["","rooster"],["","penguin"],["","turtle"],["","fish"],["","octopus"],["","butterfly"],["","flower"],["","tree"],["","cactus"],["","mushroom"],["","globe"],["","moon"],["","cloud"],["","fire"],["","banana"],["","apple"],["","strawberry"],["","corn"],["","pizza"],["","cake"],["","heart"],["","smiley"],["","robot"],["","hat"],["","glasses"],["","spanner"],["","santa"],["","thumbs up"],["","umbrella"],["","hourglass"],["","clock"],["","gift"],["","light bulb"],["","book"],["","pencil"],["","paperclip"],["","scissors"],["","padlock"],["","key"],["","hammer"],["","telephone"],["","flag"],["","train"],["","bicycle"],["","aeroplane"],["","rocket"],["","trophy"],["","ball"],["","guitar"],["","trumpet"],["","bell"],["","anchor"],["","headphones"],["","folder"],["","pin"]];var S={decimal:function(e){return[1e3+(e[0]<<5|e[1]>>3),1e3+((7&e[1])<<10|e[2]<<2|e[3]>>6),1e3+((63&e[3])<<7|e[4]>>1)]},emoji:function(e){return[e[0]>>2,(3&e[0])<<4|e[1]>>4,(15&e[1])<<2|e[2]>>6,63&e[2],e[3]>>2,(3&e[3])<<4|e[4]>>4,(15&e[4])<<2|e[5]>>6].map((function(e){return E[e]}))}};function x(e,t){var r={},n=!0,o=!1,i=void 0;try{for(var s,a=(0,h.default)(t);!(n=(s=a.next()).done);n=!0){var u=s.value;u in S&&(r[u]=S[u](e))}}catch(e){o=!0,i=e}finally{try{!n&&a.return&&a.return()}finally{if(o)throw i}}return r}var R={"hkdf-hmac-sha256":"calculate_mac","hmac-sha256":"calculate_mac_long_kdf"},T=["curve25519"],I=["sha256"],C=["hkdf-hmac-sha256","hmac-sha256"],O=(0,p.default)(S),j=new f.default(T),A=new f.default(I),D=new f.default(C),M=new f.default(O);function P(e,t){return e instanceof Array?e.filter((function(e){return t.has(e)})):[]}var U=function(e){function r(){return(0,u.default)(this,r),(0,l.default)(this,(r.__proto__||(0,a.default)(r)).apply(this,arguments))}var h,v,_,E;return(0,d.default)(r,e),(0,c.default)(r,[{key:"_doVerification",value:(E=(0,s.coroutine)(i.default.mark((function e(){return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,s.resolve)(t.Olm.init());case 2:return b=b||new t.Olm.Utility,e.next=5,(0,s.resolve)(this._baseApis.downloadKeys([this.userId]));case 5:if(!this.startEvent){e.next=11;break}return e.next=8,(0,s.resolve)(this._doRespondVerification());case 8:return e.abrupt("return",e.sent);case 11:return e.next=13,(0,s.resolve)(this._doSendVerification());case 13:return e.abrupt("return",e.sent);case 14:case"end":return e.stop()}}),e,this)}))),function(){return E.apply(this,arguments)})},{key:"_doSendVerification",value:(_=(0,s.coroutine)(i.default.mark((function e(){var a,u,c,l,d,f,p,h,v,_,g,E,S,R=this;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return a=this._contentWithTxnId({method:r.NAME,from_device:this._baseApis.deviceId,key_agreement_protocols:T,hashes:I,message_authentication_codes:C,short_authentication_string:O}),this._sendWithTxnId("m.key.verification.start",a),e.next=4,(0,s.resolve)(this._waitForEvent("m.key.verification.accept"));case 4:if(u=e.sent,c=u.getContent(),l=P(c.short_authentication_string,M),j.has(c.key_agreement_protocol)&&A.has(c.hash)&&D.has(c.message_authentication_code)&&l.length){e.next=9;break}throw(0,y.newUnknownMethodError)();case 9:if("string"==typeof c.commitment){e.next=11;break}throw(0,y.newInvalidMessageError)();case 11:return d=c.message_authentication_code,f=c.commitment,p=new t.Olm.SAS,e.prev=14,this._send("m.key.verification.key",{key:p.get_pubkey()}),e.next=18,(0,s.resolve)(this._waitForEvent("m.key.verification.key"));case 18:if(u=e.sent,c=u.getContent(),h=c.key+m.default.stringify(a),b.sha256(h)===f){e.next=23;break}throw w();case 23:return p.set_their_key(c.key),v="MATRIX_KEY_VERIFICATION_SAS"+this._baseApis.getUserId()+this._baseApis.deviceId+this.userId+this.deviceId+this.transactionId,_=p.generate_bytes(v,6),g=new o.default((function(e,t){R.emit("show_sas",{sas:x(_,l),confirm:function(){R._sendMAC(p,d),e()},cancel:function(){return t((0,y.newUserCancelledError)())},mismatch:function(){return t(k())}})})),e.next=29,(0,s.resolve)(o.default.all([this._waitForEvent("m.key.verification.mac"),g]));case 29:return E=e.sent,S=(0,n.default)(E,1),u=S[0],c=u.getContent(),e.next=35,(0,s.resolve)(this._checkMAC(p,c,d));case 35:return e.prev=35,p.free(),e.finish(35);case 38:case"end":return e.stop()}}),e,this,[[14,,35,38]])}))),function(){return _.apply(this,arguments)})},{key:"_doRespondVerification",value:(v=(0,s.coroutine)(i.default.mark((function e(){var r,a,u,c,l,d,p,h,v,_,g,w,E,S=this;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this._contentFromEventWithTxnId(this.startEvent),a=P(T,new f.default(r.key_agreement_protocols))[0],u=P(I,new f.default(r.hashes))[0],c=P(C,new f.default(r.message_authentication_codes))[0],l=P(r.short_authentication_string,M),void 0!==a&&void 0!==u&&void 0!==c&&l.length){e.next=7;break}throw(0,y.newUnknownMethodError)();case 7:return d=new t.Olm.SAS,e.prev=8,p=d.get_pubkey()+m.default.stringify(r),this._send("m.key.verification.accept",{key_agreement_protocol:a,hash:u,message_authentication_code:c,short_authentication_string:l,commitment:b.sha256(p)}),e.next=13,(0,s.resolve)(this._waitForEvent("m.key.verification.key"));case 13:return h=e.sent,r=h.getContent(),d.set_their_key(r.key),this._send("m.key.verification.key",{key:d.get_pubkey()}),v="MATRIX_KEY_VERIFICATION_SAS"+this.userId+this.deviceId+this._baseApis.getUserId()+this._baseApis.deviceId+this.transactionId,_=d.generate_bytes(v,6),g=new o.default((function(e,t){S.emit("show_sas",{sas:x(_,l),confirm:function(){S._sendMAC(d,c),e()},cancel:function(){return t((0,y.newUserCancelledError)())},mismatch:function(){return t(k())}})})),e.next=22,(0,s.resolve)(o.default.all([this._waitForEvent("m.key.verification.mac"),g]));case 22:return w=e.sent,E=(0,n.default)(w,1),h=E[0],r=h.getContent(),e.next=28,(0,s.resolve)(this._checkMAC(d,r,c));case 28:return e.prev=28,d.free(),e.finish(28);case 31:case"end":return e.stop()}}),e,this,[[8,,28,31]])}))),function(){return v.apply(this,arguments)})},{key:"_sendMAC",value:function(e,t){var r={},n=[],o="MATRIX_KEY_VERIFICATION_MAC"+this._baseApis.getUserId()+this._baseApis.deviceId+this.userId+this.deviceId+this.transactionId,i="ed25519:"+this._baseApis.deviceId;r[i]=e[R[t]](this._baseApis.getDeviceEd25519Key(),o+i),n.push(i);var s=this._baseApis.getCrossSigningId();if(s){var a="ed25519:"+s;r[a]=e[R[t]](s,o+a),n.push(a)}var u=e[R[t]](n.sort().join(","),o+"KEY_IDS");this._send("m.key.verification.mac",{mac:r,keys:u})}},{key:"_checkMAC",value:(h=(0,s.coroutine)(i.default.mark((function e(t,r,n){var o;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(o="MATRIX_KEY_VERIFICATION_MAC"+this.userId+this.deviceId+this._baseApis.getUserId()+this._baseApis.deviceId+this.transactionId,r.keys===t[R[n]]((0,p.default)(r.mac).sort().join(","),o+"KEY_IDS")){e.next=3;break}throw(0,y.newKeyMismatchError)();case 3:return e.next=5,(0,s.resolve)(this._verifyKeys(this.userId,r.mac,(function(e,r,i){if(i!==t[R[n]](r.keys[e],o+e))throw(0,y.newKeyMismatchError)()})));case 5:case"end":return e.stop()}}),e,this)}))),function(e,t,r){return h.apply(this,arguments)})},{key:"events",get:function(){return g}}]),r}(v.default);r.default=U,U.NAME="m.sas.v1"}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./Base":27,"./Error":28,"another-json":67,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/object/get-prototype-of":81,"babel-runtime/core-js/object/keys":82,"babel-runtime/core-js/promise":85,"babel-runtime/core-js/set":89,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,"babel-runtime/helpers/inherits":95,"babel-runtime/helpers/possibleConstructorReturn":96,"babel-runtime/helpers/slicedToArray":97,"babel-runtime/regenerator":100,bluebird:103}],31:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=a(e("babel-runtime/core-js/object/create")),o=a(e("babel-runtime/core-js/reflect/get-prototype-of")),i=a(e("babel-runtime/core-js/reflect/set-prototype-of")),s=a(e("babel-runtime/core-js/reflect/construct"));function a(e){return e&&e.__esModule?e:{default:e}}function u(e,t){var r="Store is invalid because "+e+", please stop the client, delete all data and start the client again",n=(0,s.default)(Error,[r]);return(0,i.default)(n,(0,o.default)(this)),n.reason=e,n.value=t,n}function c(e){var t="Crypto store is invalid because "+e+", please stop the client, delete all data and start the client again",r=(0,s.default)(Error,[t]);return(0,i.default)(r,(0,o.default)(this)),r.reason=e,r.name="InvalidCryptoStoreError",r}r.InvalidStoreError=u,r.InvalidCryptoStoreError=c,u.TOGGLED_LAZY_LOADING="TOGGLED_LAZY_LOADING",u.prototype=(0,n.default)(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),(0,i.default)(u,Error),c.TOO_NEW="TOO_NEW",c.prototype=(0,n.default)(Error.prototype,{constructor:{value:Error,enumerable:!1,writable:!0,configurable:!0}}),(0,i.default)(c,Error)},{"babel-runtime/core-js/object/create":77,"babel-runtime/core-js/reflect/construct":86,"babel-runtime/core-js/reflect/get-prototype-of":87,"babel-runtime/core-js/reflect/set-prototype-of":88}],32:[function(e,t,r){"use strict";var n,o=e("babel-runtime/core-js/object/keys"),i=(n=o)&&n.__esModule?n:{default:n};function s(e){this.filter_json=e,this.types=e.types||null,this.not_types=e.not_types||[],this.rooms=e.rooms||null,this.not_rooms=e.not_rooms||[],this.senders=e.senders||null,this.not_senders=e.not_senders||[],this.contains_url=e.contains_url||null}s.prototype.check=function(e){return this._checkFields(e.getRoomId(),e.getSender(),e.getType(),!!e.getContent()&&void 0!==e.getContent().url)},s.prototype._checkFields=function(e,t,r,n){for(var o={rooms:function(t){return e===t},senders:function(e){return t===e},types:function(e){return function(e,t){if(t.endsWith("*")){var r=t.slice(0,-1);return e.substr(0,r.length)===r}return e===t}(r,e)}},s=0;s<(0,i.default)(o).length;s++){var a=(0,i.default)(o)[s],u=o[a];if(this["not_"+a].filter(u).length>0)return!1;var c=this[a];if(c&&!c.map(u))return!1}var l=this.filter_json.contains_url;return void 0===l||l===n},s.prototype.filter=function(e){return e.filter(this.check,this)},s.prototype.limit=function(){return void 0!==this.filter_json.limit?this.filter_json.limit:10},t.exports=s},{"babel-runtime/core-js/object/keys":82}],33:[function(e,t,r){"use strict";var n=e("./filter-component");function o(e,t,r){for(var n=t.split("."),o=e,i=0;i<n.length-1;i++)o[n[i]]||(o[n[i]]={}),o=o[n[i]];o[n[n.length-1]]=r}function i(e,t){this.userId=e,this.filterId=t,this.definition={}}i.LAZY_LOADING_MESSAGES_FILTER={lazy_load_members:!0},i.LAZY_LOADING_SYNC_FILTER={room:{state:i.LAZY_LOADING_MESSAGES_FILTER}},i.prototype.getFilterId=function(){return this.filterId},i.prototype.getDefinition=function(){return this.definition},i.prototype.setDefinition=function(e){this.definition=e;var t=e.room,r={};t&&(t.rooms&&(r.rooms=t.rooms),t.rooms&&(r.not_rooms=t.not_rooms),this._include_leave=t.include_leave||!1),this._room_filter=new n(r),this._room_timeline_filter=new n(t&&t.timeline||{})},i.prototype.getRoomTimelineFilterComponent=function(){return this._room_timeline_filter},i.prototype.filterRoomTimeline=function(e){return this._room_timeline_filter.filter(this._room_filter.filter(e))},i.prototype.setTimelineLimit=function(e){o(this.definition,"room.timeline.limit",e)},i.prototype.setIncludeLeaveRooms=function(e){o(this.definition,"room.include_leave",e)},i.fromJson=function(e,t,r){var n=new i(e,t);return n.setDefinition(r),n},t.exports=i},{"./filter-component":32}],34:[function(e,t,r){(function(r){"use strict";var n=u(e("babel-runtime/core-js/object/create")),o=u(e("babel-runtime/core-js/json/stringify")),i=u(e("babel-runtime/helpers/typeof")),s=u(e("bluebird")),a=u(e("./logger"));function u(e){return e&&e.__esModule?e:{default:e}}var c=e("content-type").parse,l=e("./utils"),d=e("./realtime-callbacks");t.exports.PREFIX_R0="/_matrix/client/r0",t.exports.PREFIX_UNSTABLE="/_matrix/client/unstable",t.exports.PREFIX_IDENTITY_V1="/_matrix/identity/api/v1",t.exports.PREFIX_IDENTITY_V2="/_matrix/identity/v2",t.exports.PREFIX_MEDIA_R0="/_matrix/media/r0",t.exports.MatrixHttpApi=function(e,t){l.checkObjectHasKeys(t,["baseUrl","request","prefix"]),t.onlyData=t.onlyData||!1,this.event_emitter=e,this.opts=t,this.useAuthorizationHeader=Boolean(t.useAuthorizationHeader),this.uploads=[]},t.exports.MatrixHttpApi.prototype={setIdBaseUrl:function(e){this.opts.idBaseUrl=e},getContentUri:function(){var e={access_token:this.opts.accessToken};return{base:this.opts.baseUrl,path:"/_matrix/media/r0/upload",params:e}},uploadContent:function(e,t){l.isFunction(t)?t={callback:t}:void 0===t&&(t={});var n=!1!==t.includeFilename,o=t.type||e.type||"application/octet-stream",i=t.name||e.name,u=e;u.stream&&"function"!=typeof u.stream&&(a.default.warn("Using `file.stream` as the content to upload. Future versions of the js-sdk will change this to expect `file` to be the content directly."),u=u.stream);var c=t.rawResponse;void 0===c&&(r.XMLHttpRequest?c=!1:(a.default.warn("Returning the raw JSON from uploadContent(). Future versions of the js-sdk will change this default, to return the parsed object. Set opts.rawResponse=false to change this behaviour now."),c=!0));var p=t.onlyContentUri;c||void 0!==p||(r.XMLHttpRequest?(a.default.warn("Returning only the content-uri from uploadContent(). Future versions of the js-sdk will change this default, to return the whole response object. Set opts.onlyContentUri=false to change this behaviour now."),p=!0):p=!1);var h={loaded:0,total:0},v=void 0,m=null;if(c||(m=function(e){var t=JSON.parse(e);if(p&&void 0===(t=t.content_uri))throw Error("Bad response");return t}),r.XMLHttpRequest){var y=s.default.defer(),_=new r.XMLHttpRequest;h.xhr=_;var g=f(y,t.callback,this.opts.onlyData),b=function(){_.abort(),g(new Error("Timeout"))};_.timeout_timer=d.setTimeout(b,3e4),_.onreadystatechange=function(){switch(_.readyState){case r.XMLHttpRequest.DONE:var e;d.clearTimeout(_.timeout_timer);try{if(!_.responseText)throw new Error("No response body.");e=_.responseText,m&&(e=m(e))}catch(e){return e.http_status=_.status,void g(e)}g(void 0,_,e)}},_.upload.addEventListener("progress",(function(e){d.clearTimeout(_.timeout_timer),h.loaded=e.loaded,h.total=e.total,_.timeout_timer=d.setTimeout(b,3e4),t.progressHandler&&t.progressHandler({loaded:e.loaded,total:e.total})}));var k=this.opts.baseUrl+"/_matrix/media/r0/upload",w=[];n&&i&&w.push("filename="+encodeURIComponent(i)),this.useAuthorizationHeader||w.push("access_token="+encodeURIComponent(this.opts.accessToken)),w.length>0&&(k+="?"+w.join("&")),_.open("POST",k),this.useAuthorizationHeader&&_.setRequestHeader("Authorization","Bearer "+this.opts.accessToken),_.setRequestHeader("Content-Type",o),_.send(u),(v=y.promise).abort=_.abort.bind(_)}else{var E={};n&&i&&(E.filename=i),v=this.authedRequest(t.callback,"POST","/upload",E,u,{prefix:"/_matrix/media/r0",headers:{"Content-Type":o},json:!1,bodyParser:m})}var S=this,x=v.finally((function(){for(var e=0;e<S.uploads.length;++e)if(S.uploads[e]===h)return void S.uploads.splice(e,1)}));return x.abort=v.abort,h.promise=x,this.uploads.push(h),x},cancelUpload:function(e){return!!e.abort&&(e.abort(),!0)},getCurrentUploads:function(){return this.uploads},idServerRequest:function(e,t,r,n,o,a){if(!this.opts.idBaseUrl)throw new Error("No Identity Server base URL set");var u=this.opts.idBaseUrl+o+r;if(void 0!==e&&!l.isFunction(e))throw Error("Expected callback to be a function but got "+(void 0===e?"undefined":(0,i.default)(e)));var c={uri:u,method:t,withCredentials:!1,json:!0,_matrix_opts:this.opts,headers:{}};"GET"===t?c.qs=n:"object"===(void 0===n?"undefined":(0,i.default)(n))&&(c.json=n),a&&(c.headers.Authorization="Bearer "+a);var d=s.default.defer();return this.opts.request(c,f(d,e,this.opts.onlyData)),d.promise},authedRequest:function(e,t,r,n,o,i){n||(n={}),this.useAuthorizationHeader?(isFinite(i)&&(i={localTimeoutMs:i}),i||(i={}),i.headers||(i.headers={}),i.headers.Authorization||(i.headers.Authorization="Bearer "+this.opts.accessToken),n.access_token&&delete n.access_token):n.access_token||(n.access_token=this.opts.accessToken);var s=this.request(e,t,r,n,o,i),a=this;return s.catch((function(e){"M_UNKNOWN_TOKEN"==e.errcode?a.event_emitter.emit("Session.logged_out",e):"M_CONSENT_NOT_GIVEN"==e.errcode&&a.event_emitter.emit("no_consent",e.message,e.data.consent_uri)})),s},request:function(e,t,r,n,o,i){var s=void 0!==(i=i||{}).prefix?i.prefix:this.opts.prefix,a=this.opts.baseUrl+s+r;return this.requestOtherUrl(e,t,a,n,o,i)},requestOtherUrl:function(e,t,r,n,o,i){return null==i?i={}:isFinite(i)&&(i={localTimeoutMs:i}),this._request(e,t,r,n,o,i)},getUrl:function(e,t,r){var n="";return t&&(n="?"+l.encodeParams(t)),this.opts.baseUrl+r+e+n},_request:function(e,r,n,a,u,c){if(void 0!==e&&!l.isFunction(e))throw Error("Expected callback to be a function but got "+(void 0===e?"undefined":(0,i.default)(e)));c=c||{};var p=this;if(this.opts.extraParams)for(var h in this.opts.extraParams)this.opts.extraParams.hasOwnProperty(h)&&(a[h]=this.opts.extraParams[h]);var v=l.extend({},c.headers||{}),m=void 0===c.json||c.json,y=c.bodyParser;m&&(u&&(u=(0,o.default)(u),v["content-type"]="application/json"),v.accept||(v.accept="application/json"),void 0===y&&(y=function(e){return JSON.parse(e)}));var _=s.default.defer(),g=void 0,b=!1,k=void 0,w=c.localTimeoutMs||this.opts.localTimeoutMs,E=function(){w&&(g&&d.clearTimeout(g),g=d.setTimeout((function(){b=!0,k&&k.abort&&k.abort(),_.reject(new t.exports.MatrixError({error:"Locally timed out waiting for a response",errcode:"ORG.MATRIX.JSSDK_TIMEOUT",timeout:w}))}),w))};E();var S=_.promise;try{(k=this.opts.request({uri:n,method:r,withCredentials:!1,qs:a,qsStringifyOptions:c.qsStringifyOptions,useQuerystring:!0,body:u,json:!1,timeout:w,headers:v||{},_matrix_opts:this.opts},(function(t,r,n){w&&(d.clearTimeout(g),b)||f(_,e,p.opts.onlyData,y)(t,r,n)})))&&("onprogress"in k&&(k.onprogress=function(e){E()}),k.abort&&(S.abort=k.abort.bind(k)))}catch(t){_.reject(t),e&&e(t)}return S}};var f=function(e,r,n,o){return r=r||function(){},function(s,a,u){if(!s)try{a.statusCode>=400?s=function(e,r){var n=e.statusCode,o=function(e){var t=void 0;e.getResponseHeader?t=e.getResponseHeader("Content-Type"):e.headers&&(t=e.headers["content-type"]||null);if(!t)return null;try{return c(t)}catch(e){throw new Error("Error parsing Content-Type '"+t+"': "+e)}}(e),s=void 0;if(o)if("application/json"===o.type){var a="object"===(void 0===r?"undefined":(0,i.default)(r))?r:JSON.parse(r);s=new t.exports.MatrixError(a)}else"text/plain"===o.type&&(s=new Error("Server returned "+n+" error: "+r));s||(s=new Error("Server returned "+n+" error"));return s.httpStatus=n,s}(a,u):o&&(u=o(u))}catch(e){s=new Error("Error parsing server response: "+e)}if(s)e.reject(s),r(s);else{var l={code:a.statusCode,headers:a.headers,data:u};e.resolve(n?u:l),r(null,n?u:l)}}};t.exports.MatrixError=function(e){e=e||{},this.errcode=e.errcode,this.name=e.errcode||"Unknown error code",this.message=e.error||"Unknown message",this.data=e},t.exports.MatrixError.prototype=(0,n.default)(Error.prototype),t.exports.MatrixError.prototype.constructor=t.exports.MatrixError}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./logger":37,"./realtime-callbacks":53,"./utils":65,"babel-runtime/core-js/json/stringify":71,"babel-runtime/core-js/object/create":77,"babel-runtime/helpers/typeof":99,bluebird:103,"content-type":107}],35:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.exists=function(e,t){return new i.default((function(r,n){var o=!0,i=e.open(t);i.onupgradeneeded=function(){o=!1},i.onblocked=function(){return n()},i.onsuccess=function(){i.result.close(),o||e.deleteDatabase(t),r(o)},i.onerror=function(e){return n(e.target.error)}}))};var n,o=e("bluebird"),i=(n=o)&&n.__esModule?n:{default:n}},{bluebird:103}],36:[function(e,t,r){"use strict";var n=c(e("babel-runtime/core-js/get-iterator")),o=c(e("babel-runtime/core-js/json/stringify")),i=c(e("babel-runtime/regenerator")),s=e("bluebird"),a=c(s),u=c(e("./logger"));function c(e){return e&&e.__esModule?e:{default:e}}var l,d,f,p=e("url"),h=e("./utils");function v(e){this._matrixClient=e.matrixClient,this._data=e.authData||{},this._requestCallback=e.doRequest,this._busyChangedCallback=e.busyChanged,this._stateUpdatedCallback=e.stateUpdated||e.startAuthStage,this._resolveFunc=null,this._rejectFunc=null,this._inputs=e.inputs||{},this._requestEmailTokenCallback=e.requestEmailToken,e.sessionId&&(this._data.session=e.sessionId),this._clientSecret=e.clientSecret||this._matrixClient.generateClientSecret(),this._emailSid=e.emailSid,void 0===this._emailSid&&(this._emailSid=null),this._requestingEmailToken=!1,this._chosenFlow=null,this._currentStage=null,this._submitPromise=null}v.prototype={attemptAuth:function(){var e=this;return new a.default((function(t,r){e._resolveFunc=t,e._rejectFunc=r,e._data.flows?e._startNextAuthStage():(e._busyChangedCallback&&e._busyChangedCallback(!0),e._doRequest(e._data).finally((function(){e._busyChangedCallback&&e._busyChangedCallback(!1)})))}))},poll:(f=(0,s.coroutine)(i.default.mark((function e(){var t,r,n;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._data.session){e.next=2;break}return e.abrupt("return");case 2:if(!this._submitPromise){e.next=4;break}return e.abrupt("return");case 4:if(t={},"m.login.email.identity"!=this._currentStage){e.next=14;break}if(!this._emailSid){e.next=14;break}return r={sid:this._emailSid,client_secret:this._clientSecret},e.next=10,(0,s.resolve)(this._matrixClient.doesServerRequireIdServerParam());case 10:if(!e.sent){e.next=13;break}n=p.parse(this._matrixClient.getIdentityServerUrl()),r.id_server=n.host;case 13:t={type:"m.login.email.identity",threepid_creds:r};case 14:this.submitAuthDict(t,!0);case 15:case"end":return e.stop()}}),e,this)}))),function(){return f.apply(this,arguments)}),getSessionId:function(){return this._data?this._data.session:void 0},getClientSecret:function(){return this._clientSecret},getStageParams:function(e){var t={};return this._data&&this._data.params&&(t=this._data.params),t[e]},getChosenFlow:function(){return this._chosenFlow},submitAuthDict:(d=(0,s.coroutine)(i.default.mark((function e(t,r){var n;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._resolveFunc){e.next=2;break}throw new Error("submitAuthDict() called before attemptAuth()");case 2:!r&&this._busyChangedCallback&&this._busyChangedCallback(!0);case 3:if(!this._submitPromise){e.next=13;break}return e.prev=4,e.next=7,(0,s.resolve)(this._submitPromise);case 7:e.next=11;break;case 9:e.prev=9,e.t0=e.catch(4);case 11:e.next=3;break;case 13:return n={session:this._data.session},h.extend(n,t),e.prev=15,this._submitPromise=this._doRequest(n,r),e.next=19,(0,s.resolve)(this._submitPromise);case 19:return e.prev=19,this._submitPromise=null,!r&&this._busyChangedCallback&&this._busyChangedCallback(!1),e.finish(19);case 23:case"end":return e.stop()}}),e,this,[[4,9],[15,,19,23]])}))),function(e,t){return d.apply(this,arguments)}),getEmailSid:function(){return this._emailSid},setEmailSid:function(e){this._emailSid=e},_doRequest:(l=(0,s.coroutine)(i.default.mark((function e(t,r){var n,o,a,c;return i.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,(0,s.resolve)(this._requestCallback(t,r));case 3:n=e.sent,this._resolveFunc(n),e.next=30;break;case 7:if(e.prev=7,e.t0=e.catch(0),o=e.t0.data?e.t0.data.flows:null,a=Boolean(this._data.flows)||Boolean(o),401===e.t0.httpStatus&&e.t0.data&&a||(r?u.default.log("Background poll request failed doing UI auth: ignoring",e.t0):this._rejectFunc(e.t0)),e.t0.data.flows||e.t0.data.completed||e.t0.data.session||(e.t0.data.flows=this._data.flows,e.t0.data.completed=this._data.completed,e.t0.data.session=this._data.session),this._data=e.t0.data,this._startNextAuthStage(),this._emailSid||this._requestingEmailToken||!this._chosenFlow.stages.includes("m.login.email.identity")){e.next=30;break}return this._requestingEmailToken=!0,e.prev=17,e.next=20,(0,s.resolve)(this._requestEmailTokenCallback(this._inputs.emailAddress,this._clientSecret,1,this._data.session));case 20:c=e.sent,this._emailSid=c.sid,e.next=27;break;case 24:e.prev=24,e.t1=e.catch(17),this._rejectFunc(e.t1);case 27:return e.prev=27,this._requestingEmailToken=!1,e.finish(27);case 30:case"end":return e.stop()}}),e,this,[[0,7],[17,24,27,30]])}))),function(e,t){return l.apply(this,arguments)}),_startNextAuthStage:function(){var e=this._chooseStage();if(!e)throw new Error("No incomplete flows from the server");if(this._currentStage=e,"m.login.dummy"!==e)if(this._data.errcode||this._data.error)this._stateUpdatedCallback(e,{errcode:this._data.errcode||"",error:this._data.error||""});else{var t={};"m.login.email.identity"==e&&(t.emailSid=this._emailSid),this._stateUpdatedCallback(e,t)}else this.submitAuthDict({type:"m.login.dummy"})},_chooseStage:function(){null===this._chosenFlow&&(this._chosenFlow=this._chooseFlow()),u.default.log("Active flow => %s",(0,o.default)(this._chosenFlow));var e=this._firstUncompletedStage(this._chosenFlow);return u.default.log("Next stage: %s",e),e},_chooseFlow:function(){var e=this._data.flows||[],t=Boolean(this._inputs.emailAddress)||Boolean(this._emailSid),r=Boolean(this._inputs.phoneCountry)&&Boolean(this._inputs.phoneNumber),o=!0,i=!1,s=void 0;try{for(var a,u=(0,n.default)(e);!(o=(a=u.next()).done);o=!0){var c=a.value,l=!1,d=!1,f=!0,p=!1,h=void 0;try{for(var v,m=(0,n.default)(c.stages);!(f=(v=m.next()).done);f=!0){var y=v.value;"m.login.email.identity"===y?l=!0:"m.login.msisdn"==y&&(d=!0)}}catch(_){p=!0,h=_}finally{try{!f&&m.return&&m.return()}finally{if(p)throw h}}if(l==t&&d==r)return c}}catch(_){i=!0,s=_}finally{try{!o&&u.return&&u.return()}finally{if(i)throw s}}var _=new Error("No appropriate authentication flow found");throw _.name="NoAuthFlowFoundError",_.required_stages=[],t&&_.required_stages.push("m.login.email.identity"),r&&_.required_stages.push("m.login.msisdn"),_.available_flows=e,_},_firstUncompletedStage:function(e){for(var t=(this._data||{}).completed||[],r=0;r<e.stages.length;++r){var n=e.stages[r];if(-1===t.indexOf(n))return n}}},t.exports=v},{"./logger":37,"./utils":65,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/json/stringify":71,"babel-runtime/regenerator":100,bluebird:103,url:276}],37:[function(e,t,r){"use strict";var n=e("loglevel"),o=n.getLogger("matrix");o.setLevel(n.levels.DEBUG),t.exports=o},{loglevel:259}],38:[function(e,t,r){(function(r){"use strict";t.exports.ContentHelpers=e("./content-helpers"),t.exports.MatrixEvent=e("./models/event").MatrixEvent,t.exports.EventStatus=e("./models/event").EventStatus,t.exports.MemoryStore=e("./store/memory").MemoryStore,t.exports.MatrixInMemoryStore=t.exports.MemoryStore,t.exports.IndexedDBStore=e("./store/indexeddb").IndexedDBStore,t.exports.IndexedDBStoreBackend=e("./store/indexeddb").IndexedDBStoreBackend,t.exports.SyncAccumulator=e("./sync-accumulator"),t.exports.MatrixHttpApi=e("./http-api").MatrixHttpApi,t.exports.MatrixError=e("./http-api").MatrixError,t.exports.InvalidStoreError=e("./errors").InvalidStoreError,t.exports.MatrixClient=e("./client").MatrixClient,t.exports.Room=e("./models/room"),t.exports.Group=e("./models/group"),t.exports.EventTimeline=e("./models/event-timeline"),t.exports.EventTimelineSet=e("./models/event-timeline-set"),t.exports.RoomMember=e("./models/room-member"),t.exports.RoomState=e("./models/room-state"),t.exports.User=e("./models/user"),t.exports.MatrixScheduler=e("./scheduler"),t.exports.WebStorageSessionStore=e("./store/session/webstorage"),t.exports.CRYPTO_ENABLED=e("./client").CRYPTO_ENABLED,t.exports.ContentRepo=e("./content-repo"),t.exports.Filter=e("./filter"),t.exports.TimelineWindow=e("./timeline-window").TimelineWindow,t.exports.InteractiveAuth=e("./interactive-auth"),t.exports.AutoDiscovery=e("./autodiscovery").AutoDiscovery,t.exports.SERVICE_TYPES=e("./service-types").SERVICE_TYPES,t.exports.MemoryCryptoStore=e("./crypto/store/memory-crypto-store").default,t.exports.IndexedDBCryptoStore=e("./crypto/store/indexeddb-crypto-store").default,t.exports.createNewMatrixCall=e("./webrtc/call").createNewMatrixCall,t.exports.setMatrixCallAudioOutput=e("./webrtc/call").setAudioOutput,t.exports.setMatrixCallAudioInput=e("./webrtc/call").setAudioInput,t.exports.setMatrixCallVideoInput=e("./webrtc/call").setVideoInput;var n=void 0;t.exports.request=function(e){n=e},t.exports.getRequest=function(){return n},t.exports.wrapRequest=function(e){var t=n;n=function(r,n){return e(t,r,n)}};var o=function(){return new t.exports.MemoryCryptoStore};t.exports.setCryptoStoreFactory=function(e){o=e},t.exports.createClient=function(e){return"string"==typeof e&&(e={baseUrl:e}),e.request=e.request||n,e.store=e.store||new t.exports.MemoryStore({localStorage:r.localStorage}),e.scheduler=e.scheduler||new t.exports.MatrixScheduler,e.cryptoStore=e.cryptoStore||o(),new t.exports.MatrixClient(e)}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./autodiscovery":3,"./client":5,"./content-helpers":6,"./content-repo":7,"./crypto/store/indexeddb-crypto-store":24,"./crypto/store/memory-crypto-store":26,"./errors":31,"./filter":33,"./http-api":34,"./interactive-auth":36,"./models/event":42,"./models/event-timeline":41,"./models/event-timeline-set":40,"./models/group":43,"./models/room":48,"./models/room-member":45,"./models/room-state":46,"./models/user":50,"./scheduler":54,"./service-types":55,"./store/indexeddb":58,"./store/memory":59,"./store/session/webstorage":60,"./sync-accumulator":62,"./timeline-window":64,"./webrtc/call":66}],39:[function(e,t,r){"use strict";function n(e){this._timeline=[e],this._ourEventIndex=0,this._paginateTokens={b:null,f:null},this._paginateRequests={b:null,f:null}}n.prototype.getEvent=function(){return this._timeline[this._ourEventIndex]},n.prototype.getTimeline=function(){return this._timeline},n.prototype.getOurEventIndex=function(){return this._ourEventIndex},n.prototype.getPaginateToken=function(e){return this._paginateTokens[e?"b":"f"]},n.prototype.setPaginateToken=function(e,t){this._paginateTokens[t?"b":"f"]=e},n.prototype.addEvents=function(e,t){t?(this._timeline=e.concat(this._timeline),this._ourEventIndex+=e.length):this._timeline=this._timeline.concat(e)},t.exports=n},{}],40:[function(e,t,r){"use strict";var n=e("./event"),o=s(e("../logger")),i=s(e("./relations"));function s(e){return e&&e.__esModule?e:{default:e}}var a=e("events").EventEmitter,u=e("../utils"),c=e("./event-timeline"),l=void 0;function d(e,t){this.room=e,this._timelineSupport=Boolean(t.timelineSupport),this._liveTimeline=new c(this),this._unstableClientRelationAggregation=!!t.unstableClientRelationAggregation,this._timelines=[this._liveTimeline],this._eventIdToTimeline={},this._filter=t.filter||null,this._unstableClientRelationAggregation&&(this._relations={})}l=o.default.log.bind(o.default),u.inherits(d,a),d.prototype.getTimelines=function(){return this._timelines},d.prototype.getFilter=function(){return this._filter},d.prototype.setFilter=function(e){this._filter=e},d.prototype.getPendingEvents=function(){return this.room?this._filter?this._filter.filterRoomTimeline(this.room.getPendingEvents()):this.room.getPendingEvents():[]},d.prototype.getLiveTimeline=function(){return this._liveTimeline},d.prototype.eventIdToTimeline=function(e){return this._eventIdToTimeline[e]},d.prototype.replaceEventId=function(e,t){var r=this._eventIdToTimeline[e];r&&(delete this._eventIdToTimeline[e],this._eventIdToTimeline[t]=r)},d.prototype.resetLiveTimeline=function(e,t){var r=!this._timelineSupport||!t,n=this._liveTimeline,o=r?n.forkLive(c.FORWARDS):n.fork(c.FORWARDS);r?(this._timelines=[o],this._eventIdToTimeline={}):this._timelines.push(o),t&&n.setPaginationToken(t,c.FORWARDS),o.setPaginationToken(e,c.BACKWARDS),this._liveTimeline=o,this.emit("Room.timelineReset",this.room,this,r)},d.prototype.getTimelineForEvent=function(e){var t=this._eventIdToTimeline[e];return void 0===t?null:t},d.prototype.findEventById=function(e){var t=this.getTimelineForEvent(e);if(t)return u.findElement(t.getEvents(),(function(t){return t.getId()==e}))},d.prototype.addTimeline=function(){if(!this._timelineSupport)throw new Error("timeline support is disabled. Set the 'timelineSupport' parameter to true when creating MatrixClient to enable it.");var e=new c(this);return this._timelines.push(e),e},d.prototype.addEventsToTimeline=function(e,t,r,n){if(!r)throw new Error("'timeline' not specified for EventTimelineSet.addEventsToTimeline");if(!t&&r==this._liveTimeline)throw new Error("EventTimelineSet.addEventsToTimeline cannot be used for adding events to the live timeline - use Room.addLiveEvents instead");if(!this._filter||(e=this._filter.filterRoomTimeline(e)).length){for(var i=t?c.BACKWARDS:c.FORWARDS,s=t?c.FORWARDS:c.BACKWARDS,a=!1,u=!1,d=0;d<e.length;d++){var f=e[d],p=f.getId(),h=this._eventIdToTimeline[p];if(h)if(u=!1,h!=r){var v=r.getNeighbouringTimeline(i);if(v)l(h==v?"Event "+p+" in neighbouring timeline - switching to "+h:"Event "+p+" already in a different timeline "+h),r=h;else{o.default.info("Already have timeline for "+p+" - joining timeline "+r+" to "+h);var m=h===this._liveTimeline,y=r===this._liveTimeline,_=i===c.BACKWARDS&&m,g=i===c.FORWARDS&&y;_||g?(_&&o.default.warn("Refusing to set a preceding existingTimeLine on our timeline as the existingTimeLine is live ("+h+")"),g&&o.default.warn("Refusing to set our preceding timeline on a existingTimeLine as our timeline is live ("+r+")")):(r.setNeighbouringTimeline(h,i),h.setNeighbouringTimeline(r,s),r=h,a=!0)}}else l("Event "+p+" already in timeline "+r);else this.addEventToTimeline(f,r,t),u=!0,a=!0}if(u||!a){if(i===c.FORWARDS&&r===this._liveTimeline)return o.default.warn({lastEventWasNew:u,didUpdate:a}),void o.default.warn("Refusing to set forwards pagination token of live timeline "+r+" to "+n);r.setPaginationToken(n,i)}}},d.prototype.addLiveEvent=function(e,t){if(this._filter&&!this._filter.filterRoomTimeline([e]).length)return;var r=this._eventIdToTimeline[e.getId()];if(r)if("replace"===t){l("EventTimelineSet.addLiveEvent: replacing duplicate event "+e.getId());for(var n=r.getEvents(),o=0;o<n.length;o++)if(n[o].getId()===e.getId()){c.setEventMetadata(e,r.getState(c.FORWARDS),!1),n[o].encryptedType||(n[o]=e);break}}else l("EventTimelineSet.addLiveEvent: ignoring duplicate event "+e.getId());else this.addEventToTimeline(e,this._liveTimeline,!1)},d.prototype.addEventToTimeline=function(e,t,r){var n=e.getId();t.addEvent(e,r),this._eventIdToTimeline[n]=t,this.setRelationsTarget(e),this.aggregateRelations(e);var o={timeline:t,liveEvent:!r&&t==this._liveTimeline};this.emit("Room.timeline",e,this.room,Boolean(r),!1,o)},d.prototype.handleRemoteEcho=function(e,t,r){var n=this._eventIdToTimeline[t];n?(delete this._eventIdToTimeline[t],this._eventIdToTimeline[r]=n):this._filter?this._filter.filterRoomTimeline([e]).length&&this.addEventToTimeline(e,this._liveTimeline,!1):this.addEventToTimeline(e,this._liveTimeline,!1)},d.prototype.removeEvent=function(e){var t=this._eventIdToTimeline[e];if(!t)return null;var r=t.removeEvent(e);if(r){delete this._eventIdToTimeline[e];var n={timeline:t};this.emit("Room.timeline",r,this.room,void 0,!0,n)}return r},d.prototype.compareEventOrdering=function(e,t){if(e==t)return 0;var r=this._eventIdToTimeline[e],n=this._eventIdToTimeline[t];if(void 0===r)return null;if(void 0===n)return null;if(r===n){for(var o=void 0,i=void 0,s=r.getEvents(),a=0;a<s.length&&(void 0===o||void 0===i);a++){var u=s[a].getId();u==e&&(o=a),u==t&&(i=a)}return o-i}for(var l=r;l;){if(l===n)return-1;l=l.getNeighbouringTimeline(c.FORWARDS)}for(l=r;l;){if(l===n)return 1;l=l.getNeighbouringTimeline(c.BACKWARDS)}return null},d.prototype.getRelationsForEvent=function(e,t,r){if(!this._unstableClientRelationAggregation)throw new Error("Client-side relation aggregation is disabled");if(!e||!t||!r)throw new Error("Invalid arguments for `getRelationsForEvent`");return((this._relations[e]||{})[t]||{})[r]},d.prototype.setRelationsTarget=function(e){if(this._unstableClientRelationAggregation){var t=this._relations[e.getId()];if(t){var r=t["m.replace"];if(r){var n=r["m.room.message"];n&&n.setTargetEvent(e)}}}},d.prototype.aggregateRelations=function(e){var t=this;if(this._unstableClientRelationAggregation&&!e.isRedacted()&&e.status!==n.EventStatus.CANCELLED)if(e.isBeingDecrypted())e.once("Event.decrypted",(function(){t.aggregateRelations(e)}));else{var r=e.getRelation();if(r){var o=r.event_id,s=r.rel_type,a=e.getType(),u=this._relations[o];u||(u=this._relations[o]={});var c=u[s];c||(c=u[s]={});var l=c[a],d=!1,f=void 0;l||(l=c[a]=new i.default(s,a,this.room),d=!0,(f=this.findEventById(o))&&l.setTargetEvent(f)),l.addEvent(e),d&&f&&f.emit("Event.relationsCreated",s,a)}}},t.exports=d},{"../logger":37,"../utils":65,"./event":42,"./event-timeline":41,"./relations":44,events:257}],41:[function(e,t,r){"use strict";var n=i(e("babel-runtime/core-js/object/freeze")),o=i(e("babel-runtime/core-js/get-iterator"));function i(e){return e&&e.__esModule?e:{default:e}}var s=e("./room-state");function a(e){this._eventTimelineSet=e,this._roomId=e.room?e.room.roomId:null,this._events=[],this._baseIndex=0,this._startState=new s(this._roomId),this._startState.paginationToken=null,this._endState=new s(this._roomId),this._endState.paginationToken=null,this._prevTimeline=null,this._nextTimeline=null,this._paginationRequests={b:null,f:null},this._name=this._roomId+":"+(new Date).toISOString()}a.BACKWARDS="b",a.FORWARDS="f",a.prototype.initialiseState=function(e){if(this._events.length>0)throw new Error("Cannot initialise state after events are added");var t=!0,r=!1,i=void 0;try{for(var s,a=(0,o.default)(e);!(t=(s=a.next()).done);t=!0){var u=s.value;(0,n.default)(u)}}catch(e){r=!0,i=e}finally{try{!t&&a.return&&a.return()}finally{if(r)throw i}}this._startState.setStateEvents(e),this._endState.setStateEvents(e)},a.prototype.forkLive=function(e){var t=this.getState(e),r=new a(this._eventTimelineSet);return r._startState=t.clone(),r._endState=t,this._endState=t.clone(),r},a.prototype.fork=function(e){var t=this.getState(e),r=new a(this._eventTimelineSet);return r._startState=t.clone(),r._endState=t.clone(),r},a.prototype.getRoomId=function(){return this._roomId},a.prototype.getFilter=function(){return this._eventTimelineSet.getFilter()},a.prototype.getTimelineSet=function(){return this._eventTimelineSet},a.prototype.getBaseIndex=function(){return this._baseIndex},a.prototype.getEvents=function(){return this._events},a.prototype.getState=function(e){if(e==a.BACKWARDS)return this._startState;if(e==a.FORWARDS)return this._endState;throw new Error("Invalid direction '"+e+"'")},a.prototype.getPaginationToken=function(e){return this.getState(e).paginationToken},a.prototype.setPaginationToken=function(e,t){this.getState(t).paginationToken=e},a.prototype.getNeighbouringTimeline=function(e){if(e==a.BACKWARDS)return this._prevTimeline;if(e==a.FORWARDS)return this._nextTimeline;throw new Error("Invalid direction '"+e+"'")},a.prototype.setNeighbouringTimeline=function(e,t){if(this.getNeighbouringTimeline(t))throw new Error("timeline already has a neighbouring timeline - cannot reset neighbour (direction: "+t+")");if(t==a.BACKWARDS)this._prevTimeline=e;else{if(t!=a.FORWARDS)throw new Error("Invalid direction '"+t+"'");this._nextTimeline=e}this.setPaginationToken(null,t)},a.prototype.addEvent=function(e,t){var r=t?this._startState:this._endState,n=this.getTimelineSet();n.room&&n.room.getUnfilteredTimelineSet()===n&&(a.setEventMetadata(e,r,t),e.isState()&&(r.setStateEvents([e]),e.sender&&("m.room.member"!==e.getType()||t)||a.setEventMetadata(e,r,t)));var o=void 0;o=t?0:this._events.length,this._events.splice(o,0,e),t&&this._baseIndex++},a.setEventMetadata=function(e,t,r){e.sender=t.getSentinelMember(e.getSender()),"m.room.member"===e.getType()&&(e.target=t.getSentinelMember(e.getStateKey())),e.isState()&&r&&(e.forwardLooking=!1)},a.prototype.removeEvent=function(e){for(var t=this._events.length-1;t>=0;t--){var r=this._events[t];if(r.getId()==e)return this._events.splice(t,1),t<this._baseIndex&&this._baseIndex--,r}return null},a.prototype.toString=function(){return this._name},t.exports=a},{"./room-state":46,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/object/freeze":80}],42:[function(e,t,r){"use strict";var n=l(e("babel-runtime/core-js/number/is-finite")),o=l(e("babel-runtime/regenerator")),i=e("bluebird"),s=l(i),a=e("events"),u=l(e("../utils.js")),c=l(e("../logger"));function l(e){return e&&e.__esModule?e:{default:e}}t.exports.EventStatus={NOT_SENT:"not_sent",ENCRYPTING:"encrypting",SENDING:"sending",QUEUED:"queued",SENT:"sent",CANCELLED:"cancelled"};var d,f,p={};function h(e){return p[e]||(p[e]=e),p[e]}t.exports.MatrixEvent=function(e){["state_key","type","sender","room_id","membership"].forEach((function(t){e[t]&&(e[t]=h(e[t]))})),["membership","avatar_url","displayname"].forEach((function(t){e.content&&e.content[t]&&(e.content[t]=h(e.content[t]))})),["rel_type"].forEach((function(t){e.content&&e.content["m.relates_to"]&&e.content["m.relates_to"][t]&&(e.content["m.relates_to"][t]=h(e.content["m.relates_to"][t]))})),this.event=e||{},this.sender=null,this.target=null,this.status=null,this.error=null,this.forwardLooking=!0,this._pushActions=null,this._replacingEvent=null,this._localRedactionEvent=null,this._isCancelled=!1,this._clearEvent={},this._senderCurve25519Key=null,this._claimedEd25519Key=null,this._forwardingCurve25519KeyChain=[],this._decryptionPromise=null,this._retryDecryption=!1},u.default.inherits(t.exports.MatrixEvent,a.EventEmitter),u.default.extend(t.exports.MatrixEvent.prototype,{getId:function(){return this.event.event_id},getSender:function(){return this.event.sender||this.event.user_id},getType:function(){return this._clearEvent.type||this.event.type},getWireType:function(){return this.event.type},getRoomId:function(){return this.event.room_id},getTs:function(){return this.event.origin_server_ts},getDate:function(){return this.event.origin_server_ts?new Date(this.event.origin_server_ts):null},getOriginalContent:function(){return this._localRedactionEvent?{}:this._clearEvent.content||this.event.content||{}},getContent:function(){return this._localRedactionEvent?{}:this._replacingEvent?this._replacingEvent.getContent()["m.new_content"]||{}:this.getOriginalContent()},getWireContent:function(){return this.event.content||{}},getPrevContent:function(){return this.getUnsigned().prev_content||this.event.prev_content||{}},getDirectionalContent:function(){return this.forwardLooking?this.getContent():this.getPrevContent()},getAge:function(){return this.getUnsigned().age||this.event.age},getStateKey:function(){return this.event.state_key},isState:function(){return void 0!==this.event.state_key},makeEncrypted:function(e,t,r,n){this._clearEvent={type:this.event.type,content:this.event.content},this.event.type=e,this.event.content=t,this._senderCurve25519Key=r,this._claimedEd25519Key=n},isBeingDecrypted:function(){return null!=this._decryptionPromise},isDecryptionFailure:function(){return this._clearEvent&&this._clearEvent.content&&"m.bad.encrypted"===this._clearEvent.content.msgtype},attemptDecryption:(f=(0,i.method)((function(e){if(!this.isEncrypted())throw new Error("Attempt to decrypt event which isn't encrypted");if(this._clearEvent&&this._clearEvent.content&&"m.bad.encrypted"!==this._clearEvent.content.msgtype)throw new Error("Attempt to decrypt event which has already been encrypted");return this._decryptionPromise?(c.default.log("Event "+this.getId()+" already being decrypted; queueing a retry"),this._retryDecryption=!0,this._decryptionPromise):(this._decryptionPromise=this._decryptionLoop(e),this._decryptionPromise)})),function(e){return f.apply(this,arguments)}),cancelAndResendKeyRequest:function(e,t){var r=this.getWireContent();return e.requestRoomKey({algorithm:r.algorithm,room_id:this.getRoomId(),session_id:r.session_id,sender_key:r.sender_key},this.getKeyRequestRecipients(t),!0)},getKeyRequestRecipients:function(e){var t=this.getWireContent(),r=[{userId:e,deviceId:"*"}],n=this.getSender();return n!==e&&r.push({userId:n,deviceId:t.device_id}),r},_decryptionLoop:(d=(0,i.coroutine)(o.default.mark((function e(t){var r,n;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,i.resolve)(s.default.resolve());case 2:if(this._retryDecryption=!1,r=void 0,n=void 0,e.prev=6,t){e.next=11;break}r=this._badEncryptedMessage("Encryption not enabled"),e.next=14;break;case 11:return e.next=13,(0,i.resolve)(t.decryptEvent(this));case 13:r=e.sent;case 14:e.next=29;break;case 16:if(e.prev=16,e.t0=e.catch(6),"DecryptionError"===e.t0.name){e.next=23;break}return c.default.error("Error decrypting event (id="+this.getId()+"): "+(e.t0.stack||e.t0)),this._decryptionPromise=null,this._retryDecryption=!1,e.abrupt("return");case 23:if(n=e.t0,!this._retryDecryption){e.next=27;break}return c.default.log("Got error decrypting event (id="+this.getId()+": "+e.t0+"), but retrying"),e.abrupt("continue",2);case 27:c.default.warn("Error decrypting event (id="+this.getId()+"): "+e.t0.detailedString),r=this._badEncryptedMessage(e.t0.message);case 29:return this._decryptionPromise=null,this._retryDecryption=!1,this._setClearData(r),this.setPushActions(null),this.emit("Event.decrypted",this,n),e.abrupt("return");case 37:case"end":return e.stop()}}),e,this,[[6,16]])}))),function(e){return d.apply(this,arguments)}),_badEncryptedMessage:function(e){return{clearEvent:{type:"m.room.message",content:{msgtype:"m.bad.encrypted",body:"** Unable to decrypt: "+e+" **"}}}},_setClearData:function(e){this._clearEvent=e.clearEvent,this._senderCurve25519Key=e.senderCurve25519Key||null,this._claimedEd25519Key=e.claimedEd25519Key||null,this._forwardingCurve25519KeyChain=e.forwardingCurve25519KeyChain||[]},getClearContent:function(){var e=this._clearEvent;return e&&e.content?e.content:null},isEncrypted:function(){return"m.room.encrypted"===this.event.type},getSenderKey:function(){return this._senderCurve25519Key},getKeysClaimed:function(){return{ed25519:this._claimedEd25519Key}},getClaimedEd25519Key:function(){return this._claimedEd25519Key},getForwardingCurve25519KeyChain:function(){return this._forwardingCurve25519KeyChain},getUnsigned:function(){return this.event.unsigned||{}},unmarkLocallyRedacted:function(){var e=this._localRedactionEvent;return this._localRedactionEvent=null,this.event.unsigned&&(this.event.unsigned.redacted_because=null),!!e},markLocallyRedacted:function(e){this._localRedactionEvent||(this.emit("Event.beforeRedaction",this,e),this._localRedactionEvent=e,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event)},makeRedacted:function(e){if(!e.event)throw new Error("invalid redaction_event in makeRedacted");this._localRedactionEvent=null,this.emit("Event.beforeRedaction",this,e),this._replacingEvent=null,this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=e.event;var t=void 0;for(t in this.event)this.event.hasOwnProperty(t)&&(v[t]||delete this.event[t]);var r=m[this.getType()]||{},n=this.getContent();for(t in n)n.hasOwnProperty(t)&&(r[t]||delete n[t])},isRedacted:function(){return Boolean(this.getUnsigned().redacted_because)},isRedaction:function(){return"m.room.redaction"===this.getType()},getPushActions:function(){return this._pushActions},setPushActions:function(e){this._pushActions=e},handleRemoteEcho:function(e){var t=this.getUnsigned(),r=this.getId();this.event=e,t.redacted_because&&(this.event.unsigned||(this.event.unsigned={}),this.event.unsigned.redacted_because=t.redacted_because),this.setStatus(null),this.getId()!==r&&this.emit("Event.localEventIdReplaced",this)},isSending:function(){return!!this.status},setStatus:function(e){this.status=e,this.emit("Event.status",this,e)},replaceLocalEventId:function(e){this.event.event_id=e,this.emit("Event.localEventIdReplaced",this)},isRelation:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:void 0,t=this.getWireContent(),r=t&&t["m.relates_to"];return r&&r.rel_type&&r.event_id&&(e&&r.rel_type===e||!e)},getRelation:function(){return this.isRelation()?this.getWireContent()["m.relates_to"]:null},makeReplaced:function(e){this.isRedacted()&&e||this._replacingEvent!==e&&(this._replacingEvent=e,this.emit("Event.replaced",this))},getAssociatedStatus:function(){return this._replacingEvent?this._replacingEvent.status:this._localRedactionEvent?this._localRedactionEvent.status:this.status},getServerAggregatedRelation:function(e){var t=this.getUnsigned()["m.relations"];if(t)return t[e]},replacingEventId:function(){var e=this.getServerAggregatedRelation("m.replace");return e?e.event_id:this._replacingEvent?this._replacingEvent.getId():void 0},replacingEvent:function(){return this._replacingEvent},replacingEventDate:function(){var e=this.getServerAggregatedRelation("m.replace");if(e){var t=e.origin_server_ts;if((0,n.default)(t))return new Date(t)}else if(this._replacingEvent)return this._replacingEvent.getDate()},localRedactionEvent:function(){return this._localRedactionEvent},getAssociatedId:function(){var e=this.getRelation();return e?e.event_id:this.isRedaction()?this.event.redacts:void 0},hasAssocation:function(){return!!this.getAssociatedId()},updateAssociatedId:function(e){var t=this.getRelation();t?t.event_id=e:this.isRedaction()&&(this.event.redacts=e)},flagCancelled:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this._isCancelled=e},isCancelled:function(){return this._isCancelled},toJSON:function(){var e={type:this.getType(),sender:this.getSender(),content:this.getContent(),event_id:this.getId(),origin_server_ts:this.getTs(),unsigned:this.getUnsigned(),room_id:this.getRoomId()};return this.isRedaction()&&(e.redacts=this.event.redacts),this.isEncrypted()?{decrypted:e,encrypted:this.event}:e}});var v=["event_id","type","room_id","user_id","sender","state_key","prev_state","content","unsigned","origin_server_ts"].reduce((function(e,t){return e[t]=1,e}),{}),m={"m.room.member":{membership:1},"m.room.create":{creator:1},"m.room.join_rules":{join_rule:1},"m.room.power_levels":{ban:1,events:1,events_default:1,kick:1,redact:1,state_default:1,users:1,users_default:1},"m.room.aliases":{aliases:1}}},{"../logger":37,"../utils.js":65,"babel-runtime/core-js/number/is-finite":73,"babel-runtime/regenerator":100,bluebird:103,events:257}],43:[function(e,t,r){"use strict";var n=e("events").EventEmitter;function o(e){this.groupId=e,this.name=null,this.avatarUrl=null,this.myMembership=null,this.inviter=null}e("../utils").inherits(o,n),o.prototype.setProfile=function(e,t){this.name===e&&this.avatarUrl===t||(this.name=e||this.groupId,this.avatarUrl=t,this.emit("Group.profile",this))},o.prototype.setMyMembership=function(e){this.myMembership!==e&&(this.myMembership=e,this.emit("Group.myMembership",this))},o.prototype.setInviter=function(e){this.inviter=e},t.exports=o},{"../utils":65,events:257}],44:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=f(e("babel-runtime/helpers/toConsumableArray")),o=f(e("babel-runtime/core-js/set")),i=f(e("babel-runtime/core-js/object/get-prototype-of")),s=f(e("babel-runtime/helpers/classCallCheck")),a=f(e("babel-runtime/helpers/createClass")),u=f(e("babel-runtime/helpers/possibleConstructorReturn")),c=f(e("babel-runtime/helpers/inherits")),l=f(e("events")),d=e("../../lib/models/event");function f(e){return e&&e.__esModule?e:{default:e}}var p=function(e){function t(e,r,n){(0,s.default)(this,t);var a=(0,u.default)(this,(t.__proto__||(0,i.default)(t)).call(this));return a._onEventStatus=function(e,t){e.isSending()?t===d.EventStatus.CANCELLED&&(e.removeListener("Event.status",a._onEventStatus),a._removeEvent(e)):e.removeListener("Event.status",a._onEventStatus)},a._onBeforeRedaction=function(e){a._relations.has(e)&&(a._relations.delete(e),"m.annotation"===a.relationType?a._removeAnnotationFromAggregation(e):"m.replace"===a.relationType&&a._targetEvent&&a._targetEvent.makeReplaced(a.getLastReplacement()),e.removeListener("Event.beforeRedaction",a._onBeforeRedaction),a.emit("Relations.redaction",e))},a.relationType=e,a.eventType=r,a._relations=new o.default,a._annotationsByKey={},a._annotationsBySender={},a._sortedAnnotationsByKey=[],a._targetEvent=null,a}return(0,c.default)(t,e),(0,a.default)(t,[{key:"addEvent",value:function(e){if(!this._relations.has(e)){var t=e.getRelation();if(t){var r=t.rel_type,n=e.getType();this.relationType===r&&this.eventType===n?(e.isSending()&&e.on("Event.status",this._onEventStatus),this._relations.add(e),"m.annotation"===this.relationType?this._addAnnotationToAggregation(e):"m.replace"===this.relationType&&this._targetEvent&&this._targetEvent.makeReplaced(this.getLastReplacement()),e.on("Event.beforeRedaction",this._onBeforeRedaction),this.emit("Relations.add",e)):console.error("Event relation info doesn't match this container")}else console.error("Event must have relation info")}}},{key:"_removeEvent",value:function(e){if(this._relations.has(e)){var t=e.getRelation();if(t){var r=t.rel_type,n=e.getType();this.relationType===r&&this.eventType===n?(this._relations.delete(e),"m.annotation"===this.relationType?this._removeAnnotationFromAggregation(e):"m.replace"===this.relationType&&this._targetEvent&&this._targetEvent.makeReplaced(this.getLastReplacement()),this.emit("Relations.remove",e)):console.error("Event relation info doesn't match this container")}else console.error("Event must have relation info")}}},{key:"getRelations",value:function(){return[].concat((0,n.default)(this._relations))}},{key:"_addAnnotationToAggregation",value:function(e){var t=e.getRelation().key;if(t){var r=this._annotationsByKey[t];r||(r=this._annotationsByKey[t]=new o.default,this._sortedAnnotationsByKey.push([t,r])),r.add(e),this._sortedAnnotationsByKey.sort((function(e,t){var r=e[1];return t[1].size-r.size}));var n=e.getSender(),i=this._annotationsBySender[n];i||(i=this._annotationsBySender[n]=new o.default),i.add(e)}}},{key:"_removeAnnotationFromAggregation",value:function(e){var t=e.getRelation().key;if(t){var r=this._annotationsByKey[t];r&&(r.delete(e),this._sortedAnnotationsByKey.sort((function(e,t){var r=e[1];return t[1].size-r.size})));var n=e.getSender(),o=this._annotationsBySender[n];o&&o.delete(e)}}},{key:"getSortedAnnotationsByKey",value:function(){return"m.annotation"!==this.relationType?null:this._sortedAnnotationsByKey}},{key:"getAnnotationsBySender",value:function(){return"m.annotation"!==this.relationType?null:this._annotationsBySender}},{key:"getLastReplacement",value:function(){var e=this;if("m.replace"!==this.relationType)return null;if(!this._targetEvent)return null;var t=this._targetEvent.getServerAggregatedRelation("m.replace"),r=t&&t.origin_server_ts;return this.getRelations().reduce((function(t,n){return n.getSender()!==e._targetEvent.getSender()?t:r&&r>n.getTs()?t:t&&t.getTs()>n.getTs()?t:n}),null)}},{key:"setTargetEvent",value:function(e){if(!this._targetEvent&&(this._targetEvent=e,"m.replace"===this.relationType)){var t=this.getLastReplacement();t&&this._targetEvent.makeReplaced(t)}}}]),t}(l.default);r.default=p},{"../../lib/models/event":42,"babel-runtime/core-js/object/get-prototype-of":81,"babel-runtime/core-js/set":89,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93,"babel-runtime/helpers/inherits":95,"babel-runtime/helpers/possibleConstructorReturn":96,"babel-runtime/helpers/toConsumableArray":98,events:257}],45:[function(e,t,r){"use strict";var n=e("events").EventEmitter,o=e("../content-repo"),i=e("../utils");function s(e,t){this.roomId=e,this.userId=t,this.typing=!1,this.name=t,this.rawDisplayName=t,this.powerLevel=0,this.powerLevelNorm=0,this.user=null,this.membership=null,this.events={member:null},this._isOutOfBand=!1,this._updateModifiedTime()}i.inherits(s,n),s.prototype.markOutOfBand=function(){this._isOutOfBand=!0},s.prototype.isOutOfBand=function(){return this._isOutOfBand},s.prototype.setMembershipEvent=function(e,t){if("m.room.member"===e.getType()){this._isOutOfBand=!1,this.events.member=e;var r=this.membership;this.membership=e.getDirectionalContent().membership;var n=this.name;this.name=function(e,t,r){if(!t||t===e)return e;if(!i.removeHiddenChars(t))return e;if(!r)return t;var n=/@.+:.+/.test(t);if(!n){var o=r.getUserIdsWithDisplayName(t);n=o.some((function(t){return t!==e}))}if(n)return t+" ("+e+")";return t}(this.userId,e.getDirectionalContent().displayname,t),this.rawDisplayName=e.getDirectionalContent().displayname||this.userId,r!==this.membership&&(this._updateModifiedTime(),this.emit("RoomMember.membership",e,this,r)),n!==this.name&&(this._updateModifiedTime(),this.emit("RoomMember.name",e,this,n))}},s.prototype.setPowerLevelEvent=function(e){if("m.room.power_levels"===e.getType()){var t=e.getDirectionalContent(),r=t.users_default||0;i.forEach(i.values(t.users),(function(e){r=Math.max(r,e)}));var n=this.powerLevel,o=this.powerLevelNorm;t.users&&void 0!==t.users[this.userId]?this.powerLevel=t.users[this.userId]:void 0!==t.users_default?this.powerLevel=t.users_default:this.powerLevel=0,this.powerLevelNorm=0,r>0&&(this.powerLevelNorm=100*this.powerLevel/r),n===this.powerLevel&&o===this.powerLevelNorm||(this._updateModifiedTime(),this.emit("RoomMember.powerLevel",e,this))}},s.prototype.setTypingEvent=function(e){if("m.typing"===e.getType()){var t=this.typing;this.typing=!1;var r=e.getContent().user_ids;i.isArray(r)&&(-1!==r.indexOf(this.userId)&&(this.typing=!0),t!==this.typing&&(this._updateModifiedTime(),this.emit("RoomMember.typing",e,this)))}},s.prototype._updateModifiedTime=function(){this._modified=Date.now()},s.prototype.getLastModifiedTime=function(){return this._modified},s.prototype.isKicked=function(){return"leave"===this.membership&&this.events.member.getSender()!==this.events.member.getStateKey()},s.prototype.getDMInviter=function(){if(this.events.member){var e=this.events.member,t=e.getContent(),r=e.getSender();if("join"===t.membership&&(t=e.getPrevContent(),r=e.getUnsigned().prev_sender),"invite"===t.membership&&t.is_direct)return r}},s.prototype.getAvatarUrl=function(e,t,r,n,i,s){void 0===i&&(i=!0);var a=this.getMxcAvatarUrl();if(!a&&!i)return null;var u=o.getHttpUriForMxc(e,a,t,r,n,s);return u||(i?o.getIdenticonUri(e,this.userId,t,r):null)},s.prototype.getMxcAvatarUrl=function(){return this.events.member?this.events.member.getDirectionalContent().avatar_url:this.user?this.user.avatarUrl:null},t.exports=s},{"../content-repo":7,"../utils":65,events:257}],46:[function(e,t,r){"use strict";var n=a(e("babel-runtime/core-js/number/is-finite")),o=a(e("babel-runtime/core-js/object/keys")),i=a(e("babel-runtime/core-js/object/values")),s=a(e("../logger"));function a(e){return e&&e.__esModule?e:{default:e}}var u=e("events").EventEmitter,c=e("../utils"),l=e("./room-member"),d=1;function f(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:void 0;this.roomId=e,this.members={},this.events={},this.paginationToken=null,this._sentinels={},this._updateModifiedTime(),this._displayNameToUserIds={},this._userIdsToDisplayNames={},this._tokenToInvite={},this._joinedMemberCount=null,this._summaryJoinedMemberCount=null,this._invitedMemberCount=null,this._summaryInvitedMemberCount=null,t||(t={status:d}),this._oobMemberFlags=t}function p(e,t,r){var n=e._userIdsToDisplayNames[t];if(delete e._userIdsToDisplayNames[t],n){var o=c.removeHiddenChars(n),i=e._displayNameToUserIds[o];if(i){var s=i.filter((function(e){return e!==t}));e._displayNameToUserIds[o]=s}}e._userIdsToDisplayNames[t]=r;var a=r&&c.removeHiddenChars(r);a&&(e._displayNameToUserIds[a]||(e._displayNameToUserIds[a]=[]),e._displayNameToUserIds[a].push(t))}c.inherits(f,u),f.prototype.getJoinedMemberCount=function(){return null!==this._summaryJoinedMemberCount?this._summaryJoinedMemberCount:(null===this._joinedMemberCount&&(this._joinedMemberCount=this.getMembers().reduce((function(e,t){return"join"===t.membership?e+1:e}),0)),this._joinedMemberCount)},f.prototype.setJoinedMemberCount=function(e){this._summaryJoinedMemberCount=e},f.prototype.getInvitedMemberCount=function(){return null!==this._summaryInvitedMemberCount?this._summaryInvitedMemberCount:(null===this._invitedMemberCount&&(this._invitedMemberCount=this.getMembers().reduce((function(e,t){return"invite"===t.membership?e+1:e}),0)),this._invitedMemberCount)},f.prototype.setInvitedMemberCount=function(e){this._summaryInvitedMemberCount=e},f.prototype.getMembers=function(){return c.values(this.members)},f.prototype.getMembersExcept=function(e){return c.values(this.members).filter((function(t){return!e.includes(t.userId)}))},f.prototype.getMember=function(e){return this.members[e]||null},f.prototype.getSentinelMember=function(e){if(!e)return null;var t=this._sentinels[e];if(void 0===t){t=new l(this.roomId,e);var r=this.members[e];r&&t.setMembershipEvent(r.events.member,this),this._sentinels[e]=t}return t},f.prototype.getStateEvents=function(e,t){if(!this.events[e])return void 0===t?[]:null;if(void 0===t)return c.values(this.events[e]);var r=this.events[e][t];return r||null},f.prototype.clone=function(){var e=new f(this.roomId,this._oobMemberFlags),t=this._oobMemberFlags.status;return this._oobMemberFlags.status=d,(0,i.default)(this.events).forEach((function(t){var r=(0,i.default)(t);e.setStateEvents(r)})),this._oobMemberFlags.status=t,null!==this._summaryInvitedMemberCount&&e.setInvitedMemberCount(this.getInvitedMemberCount()),null!==this._summaryJoinedMemberCount&&e.setJoinedMemberCount(this.getJoinedMemberCount()),3==this._oobMemberFlags.status&&this.getMembers().forEach((function(t){t.isOutOfBand()&&e.getMember(t.userId).markOutOfBand()})),e},f.prototype.setUnknownStateEvents=function(e){var t=this,r=e.filter((function(e){return void 0===t.events[e.getType()]||void 0===t.events[e.getType()][e.getStateKey()]}));this.setStateEvents(r)},f.prototype.setStateEvents=function(e){var t=this;this._updateModifiedTime(),c.forEach(e,(function(e){e.getRoomId()===t.roomId&&e.isState()&&(t._setStateEvent(e),"m.room.member"===e.getType()&&(p(t,e.getStateKey(),e.getContent().displayname),function(e,t){if(!t.getContent().third_party_invite)return;var r=(t.getContent().third_party_invite.signed||{}).token;if(!r)return;if(!e.getStateEvents("m.room.third_party_invite",r))return;e._tokenToInvite[r]=t}(t,e)),t.emit("RoomState.events",e,t))})),c.forEach(e,(function(e){if(e.getRoomId()===t.roomId&&e.isState())if("m.room.member"===e.getType()){var r=e.getStateKey();"leave"!==e.getContent().membership&&"ban"!==e.getContent().membership||(e.getContent().avatar_url=e.getContent().avatar_url||e.getPrevContent().avatar_url,e.getContent().displayname=e.getContent().displayname||e.getPrevContent().displayname);var n=t._getOrCreateMember(r,e);n.setMembershipEvent(e,t),t._updateMember(n),t.emit("RoomState.members",e,t,n)}else if("m.room.power_levels"===e.getType()){var o=c.values(t.members);c.forEach(o,(function(r){r.setPowerLevelEvent(e),t.emit("RoomState.members",e,t,r)})),t._sentinels={}}}))},f.prototype._getOrCreateMember=function(e,t){var r=this.members[e];return r||(r=new l(this.roomId,e),this.members[e]=r,this.emit("RoomState.newMember",t,this,r)),r},f.prototype._setStateEvent=function(e){void 0===this.events[e.getType()]&&(this.events[e.getType()]={}),this.events[e.getType()][e.getStateKey()]=e},f.prototype._updateMember=function(e){var t=this.getStateEvents("m.room.power_levels","");t&&e.setPowerLevelEvent(t),delete this._sentinels[e.userId],this.members[e.userId]=e,this._joinedMemberCount=null,this._invitedMemberCount=null},f.prototype.needsOutOfBandMembers=function(){return this._oobMemberFlags.status===d},f.prototype.markOutOfBandMembersStarted=function(){this._oobMemberFlags.status===d&&(this._oobMemberFlags.status=2)},f.prototype.markOutOfBandMembersFailed=function(){2===this._oobMemberFlags.status&&(this._oobMemberFlags.status=d)},f.prototype.clearOutOfBandMembers=function(){var e=this,t=0;(0,o.default)(this.members).forEach((function(r){e.members[r].isOutOfBand()&&(++t,delete e.members[r])})),s.default.log("LL: RoomState removed "+t+" members..."),this._oobMemberFlags.status=d},f.prototype.setOutOfBandMembers=function(e){var t=this;s.default.log("LL: RoomState about to set "+e.length+" OOB members ..."),2===this._oobMemberFlags.status&&(s.default.log("LL: RoomState put in OOB_STATUS_FINISHED state ..."),this._oobMemberFlags.status=3,e.forEach((function(e){return t._setOutOfBandMember(e)})))},f.prototype._setOutOfBandMember=function(e){if("m.room.member"===e.getType()){var t=e.getStateKey(),r=this.getMember(t);if(!r||r.isOutOfBand()){var n=this._getOrCreateMember(t,e);n.setMembershipEvent(e,this),n.markOutOfBand(),p(this,n.userId,n.name),this._setStateEvent(e),this._updateMember(n),this.emit("RoomState.members",e,this,n)}}},f.prototype.setTypingEvent=function(e){c.forEach(c.values(this.members),(function(t){t.setTypingEvent(e)}))},f.prototype.getInviteForThreePidToken=function(e){return this._tokenToInvite[e]||null},f.prototype._updateModifiedTime=function(){this._modified=Date.now()},f.prototype.getLastModifiedTime=function(){return this._modified},f.prototype.getUserIdsWithDisplayName=function(e){return this._displayNameToUserIds[c.removeHiddenChars(e)]||[]},f.prototype.maySendRedactionForEvent=function(e,t){var r=this.getMember(t);if(!r||"leave"===r.membership)return!1;if(e.status||e.isRedacted())return!1;var n=this.maySendEvent("m.room.redaction",t);return e.getSender()===t?n:this._hasSufficientPowerLevelFor("redact",r.powerLevel)},f.prototype._hasSufficientPowerLevelFor=function(e,t){var r=this.getStateEvents("m.room.power_levels",""),n={};r&&(n=r.getContent());var o=50;return c.isNumber(n[e])&&(o=n[e]),t>=o},f.prototype.maySendMessage=function(e){return this._maySendEventOfType("m.room.message",e,!1)},f.prototype.maySendEvent=function(e,t){return this._maySendEventOfType(e,t,!1)},f.prototype.mayClientSendStateEvent=function(e,t){return!t.isGuest()&&this.maySendStateEvent(e,t.credentials.userId)},f.prototype.maySendStateEvent=function(e,t){return this._maySendEventOfType(e,t,!0)},f.prototype._maySendEventOfType=function(e,t,r){var o=this.getStateEvents("m.room.power_levels",""),i=void 0,s={},a=0,u=0,c=0;if(o){s=(i=o.getContent()).events||{},a=(0,n.default)(i.state_default)?i.state_default:50;var l=i.users&&i.users[t];(0,n.default)(l)?c=l:(0,n.default)(i.users_default)&&(c=i.users_default),(0,n.default)(i.events_default)&&(u=i.events_default)}var d=r?a:u;return(0,n.default)(s[e])&&(d=s[e]),c>=d},f.prototype.mayTriggerNotifOfType=function(e,t){var r=this.getMember(t);if(!r)return!1;var n=this.getStateEvents("m.room.power_levels",""),o=50;return n&&n.getContent()&&n.getContent().notifications&&c.isNumber(n.getContent().notifications[e])&&(o=n.getContent().notifications[e]),r.powerLevel>=o},t.exports=f},{"../logger":37,"../utils":65,"./room-member":45,"babel-runtime/core-js/number/is-finite":73,"babel-runtime/core-js/object/keys":82,"babel-runtime/core-js/object/values":84,events:257}],47:[function(e,t,r){"use strict";t.exports=function(e,t){this.roomId=e,this.info=t}},{}],48:[function(e,t,r){"use strict";var n=h(e("babel-runtime/helpers/slicedToArray")),o=h(e("babel-runtime/core-js/object/assign")),i=h(e("babel-runtime/core-js/number/is-integer")),s=h(e("babel-runtime/core-js/number/min-safe-integer")),a=h(e("babel-runtime/core-js/object/keys")),u=h(e("babel-runtime/regenerator")),c=h(e("babel-runtime/core-js/get-iterator")),l=e("bluebird"),d=h(e("babel-runtime/core-js/promise")),f=h(e("../logger")),p=h(e("../ReEmitter"));function h(e){return e&&e.__esModule?e:{default:e}}var v=e("events").EventEmitter,m=e("./event").EventStatus,y=e("./room-summary"),_=e("./room-member"),g=e("./event").MatrixEvent,b=e("../utils"),k=e("../content-repo"),w=e("./event-timeline"),E=e("./event-timeline-set"),S=["1","2","3","4"];function x(e,t,r){var n={content:{},type:"m.receipt",room_id:t.getRoomId()};return n.content[t.getId()]={},n.content[t.getId()][r]={},n.content[t.getId()][r][e]={ts:t.getTs()},new g(n)}function R(e,t,r,n){if((n=n||{}).pendingEventOrdering=n.pendingEventOrdering||"chronological",this.reEmitter=new p.default(this),-1===["chronological","detached"].indexOf(n.pendingEventOrdering))throw new Error("opts.pendingEventOrdering MUST be either 'chronological' or 'detached'. Got: '"+n.pendingEventOrdering+"'");this.myUserId=r,this.roomId=e,this.name=e,this.tags={},this.accountData={},this.summary=null,this.storageToken=n.storageToken,this._opts=n,this._txnToEvent={},this._receipts={},this._receiptCacheByEventId={},this._realReceipts={},this._notificationCounts={},this._timelineSets=[new E(this,n)],this.reEmitter.reEmit(this.getUnfilteredTimelineSet(),["Room.timeline","Room.timelineReset"]),this._fixUpLegacyTimelineFields(),this._filteredTimelineSets={},"detached"==this._opts.pendingEventOrdering&&(this._pendingEventList=[]),this._blacklistUnverifiedDevices=null,this._selfMembership=null,this._summaryHeroes=null,this._client=t,this._opts.lazyLoadMembers?this._membersPromise=null:this._membersPromise=d.default.resolve()}b.inherits(R,v),R.prototype.getVersion=function(){var e=this.currentState.getStateEvents("m.room.create","");if(!e)return f.default.warn("Room "+this.room_id+" does not have an m.room.create event"),"1";var t=e.getContent().room_version;return void 0===t?"1":t},R.prototype.shouldUpgradeToVersion=function(){return S.includes(this.getVersion())?null:"4"},R.prototype.getRecommendedVersion=(0,l.coroutine)(u.default.mark((function e(){var t,r,n,o,i,s,a,d,p,h;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,l.resolve)(this._client.getCapabilities());case 2:if(t=e.sent,r=t["m.room_versions"]){e.next=25;break}for(r={default:"4",available:{}},n=!0,o=!1,i=void 0,e.prev=9,s=(0,c.default)(S);!(n=(a=s.next()).done);n=!0)d=a.value,r.available[d]="stable";e.next=17;break;case 13:e.prev=13,e.t0=e.catch(9),o=!0,i=e.t0;case 17:e.prev=17,e.prev=18,!n&&s.return&&s.return();case 20:if(e.prev=20,!o){e.next=23;break}throw i;case 23:return e.finish(20);case 24:return e.finish(17);case 25:if(!(p=this._checkVersionAgainstCapability(r)).urgent||!p.needsUpgrade){e.next=38;break}return f.default.warn("Refreshing room version capability because the server looks to be supporting a newer room version we don't know about."),e.next=30,(0,l.resolve)(this._client.getCapabilities(!0));case 30:if(h=e.sent,r=h["m.room_versions"]){e.next=37;break}return f.default.warn("No room version capability - assuming upgrade required."),e.abrupt("return",p);case 37:p=this._checkVersionAgainstCapability(r);case 38:return e.abrupt("return",p);case 39:case"end":return e.stop()}}),e,this,[[9,13,17,25],[18,,20,24]])}))),R.prototype._checkVersionAgainstCapability=function(e){var t=this.getVersion();f.default.log("["+this.roomId+"] Current version: "+t),f.default.log("["+this.roomId+"] Version capability: ",e);var r={version:t,needsUpgrade:!1,urgent:!1};return t===e.default?r:(0,a.default)(e.available).filter((function(t){return"stable"===e.available[t]})).includes(t)?r:(r.version=e.default,r.needsUpgrade=!0,r.urgent=!!this.getVersion().match(/^[0-9]+[0-9.]*$/g),r.urgent?f.default.warn("URGENT upgrade required on "+this.roomId):f.default.warn("Non-urgent upgrade required on "+this.roomId),r)},R.prototype.userMayUpgradeRoom=function(e){return this.currentState.maySendStateEvent("m.room.tombstone",e)},R.prototype.getPendingEvents=function(){if("detached"!==this._opts.pendingEventOrdering)throw new Error("Cannot call getPendingEvents with pendingEventOrdering == "+this._opts.pendingEventOrdering);return this._pendingEventList},R.prototype.hasPendingEvent=function(e){if("detached"!==this._opts.pendingEventOrdering)throw new Error("Cannot call hasPendingEvent with pendingEventOrdering == "+this._opts.pendingEventOrdering);return this._pendingEventList.some((function(t){return t.getId()===e}))},R.prototype.getLiveTimeline=function(){return this.getUnfilteredTimelineSet().getLiveTimeline()},R.prototype.getLastActiveTimestamp=function(){var e=this.getLiveTimeline().getEvents();return e.length?e[e.length-1].getTs():s.default},R.prototype.getMyMembership=function(){return this._selfMembership},R.prototype.getDMInviter=function(){if(this.myUserId){var e=this.getMember(this.myUserId);if(e)return e.getDMInviter()}if("invite"===this._selfMembership&&(2==this.getInvitedAndJoinedMemberCount()&&this._summaryHeroes.length))return this._summaryHeroes[0]},R.prototype.guessDMUserId=function(){var e=this,t=this.getMember(this.myUserId);if(t){var r=t.getDMInviter();if(r)return r}if(Array.isArray(this._summaryHeroes)&&this._summaryHeroes.length)return this._summaryHeroes[0];var n=this.currentState.getMembers().find((function(t){return t.userId!==e.myUserId}));return n?n.userId:this.myUserId},R.prototype.getAvatarFallbackMember=function(){var e=this;if(!(this.getInvitedAndJoinedMemberCount()>2)){var t=Array.isArray(this._summaryHeroes)&&this._summaryHeroes.length;if(t){var r=this._summaryHeroes.map((function(t){return e.getMember(t)})).find((function(e){return!!e}));if(r)return r}var n=this.currentState.getMembers();if(n.length<=2){var o=n.find((function(t){return t.userId!==e.myUserId}));if(o)return o}if(t){var i=this._summaryHeroes.map((function(t){return e._client.getUser(t)})).find((function(e){return!!e}));if(i){var s=new _(this.roomId,i.userId);return s.user=i,s}}}},R.prototype.updateMyMembership=function(e){var t=this._selfMembership;this._selfMembership=e,t!==e&&("leave"===e&&this._cleanupAfterLeaving(),this.emit("Room.myMembership",this,e,t))},R.prototype._loadMembersFromServer=(0,l.coroutine)(u.default.mark((function e(){var t,r,n,o,i;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=this._client.store.getSyncToken(),r=b.encodeParams({not_membership:"leave",at:t}),n=b.encodeUri("/rooms/$roomId/members?"+r,{$roomId:this.roomId}),o=this._client._http,e.next=6,(0,l.resolve)(o.authedRequest(void 0,"GET",n));case 6:return i=e.sent,e.abrupt("return",i.chunk);case 8:case"end":return e.stop()}}),e,this)}))),R.prototype._loadMembers=(0,l.coroutine)(u.default.mark((function e(){var t,r,n;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=!1,e.next=3,(0,l.resolve)(this._client.store.getOutOfBandMembers(this.roomId));case 3:if(null!==(r=e.sent)){e.next=10;break}return t=!0,e.next=8,(0,l.resolve)(this._loadMembersFromServer());case 8:r=e.sent,f.default.log("LL: got "+r.length+" members from server for room "+this.roomId);case 10:return n=r.map(this._client.getEventMapper()),e.abrupt("return",{memberEvents:n,fromServer:t});case 12:case"end":return e.stop()}}),e,this)}))),R.prototype.loadMembersIfNeeded=function(){var e=this;if(this._membersPromise)return this._membersPromise;this.currentState.markOutOfBandMembersStarted();var t=this._loadMembers().then((function(t){return e.currentState.setOutOfBandMembers(t.memberEvents),e._client.isCryptoEnabled()&&e._client.isRoomEncrypted(e.roomId)&&e._client._crypto.trackRoomDevices(e.roomId),t.fromServer})).catch((function(t){throw e._membersPromise=null,e.currentState.markOutOfBandMembersFailed(),t}));return t.then((function(t){if(t){var r=e.currentState.getMembers().filter((function(e){return e.isOutOfBand()})).map((function(e){return e.events.member.event}));return f.default.log("LL: telling store to write "+r.length+" members for room "+e.roomId),e._client.store.setOutOfBandMembers(e.roomId,r).catch((function(e){f.default.log("LL: storing OOB room members failed, oh well",e)}))}})).catch((function(e){f.default.error(e)})),this._membersPromise=t,this._membersPromise},R.prototype.clearLoadedMembersIfNeeded=(0,l.coroutine)(u.default.mark((function e(){return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!this._opts.lazyLoadMembers||!this._membersPromise){e.next=7;break}return e.next=3,(0,l.resolve)(this.loadMembersIfNeeded());case 3:return e.next=5,(0,l.resolve)(this._client.store.clearOutOfBandMembers(this.roomId));case 5:this.currentState.clearOutOfBandMembers(),this._membersPromise=null;case 7:case"end":return e.stop()}}),e,this)}))),R.prototype._cleanupAfterLeaving=function(){var e=this;this.clearLoadedMembersIfNeeded().catch((function(t){f.default.error("error after clearing loaded members from room "+e.roomId+" after leaving"),f.default.log(t)}))},R.prototype.resetLiveTimeline=function(e,t){for(var r=0;r<this._timelineSets.length;r++)this._timelineSets[r].resetLiveTimeline(e,t);this._fixUpLegacyTimelineFields()},R.prototype._fixUpLegacyTimelineFields=function(){this.timeline=this.getLiveTimeline().getEvents(),this.oldState=this.getLiveTimeline().getState(w.BACKWARDS),this.currentState=this.getLiveTimeline().getState(w.FORWARDS)},R.prototype.hasUnverifiedDevices=(0,l.coroutine)(u.default.mark((function e(){var t,r,n,o,i,s,a;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._client.isRoomEncrypted(this.roomId)){e.next=2;break}return e.abrupt("return",!1);case 2:return e.next=4,(0,l.resolve)(this.getEncryptionTargetMembers());case 4:t=e.sent,r=!0,n=!1,o=void 0,e.prev=8,i=(0,c.default)(t);case 10:if(r=(s=i.next()).done){e.next=20;break}return a=s.value,e.next=14,(0,l.resolve)(this._client.getStoredDevicesForUser(a.userId));case 14:if(!e.sent.some((function(e){return e.isUnverified()}))){e.next=17;break}return e.abrupt("return",!0);case 17:r=!0,e.next=10;break;case 20:e.next=26;break;case 22:e.prev=22,e.t0=e.catch(8),n=!0,o=e.t0;case 26:e.prev=26,e.prev=27,!r&&i.return&&i.return();case 29:if(e.prev=29,!n){e.next=32;break}throw o;case 32:return e.finish(29);case 33:return e.finish(26);case 34:return e.abrupt("return",!1);case 35:case"end":return e.stop()}}),e,this,[[8,22,26,34],[27,,29,33]])}))),R.prototype.getTimelineSets=function(){return this._timelineSets},R.prototype.getUnfilteredTimelineSet=function(){return this._timelineSets[0]},R.prototype.getTimelineForEvent=function(e){return this.getUnfilteredTimelineSet().getTimelineForEvent(e)},R.prototype.addTimeline=function(){return this.getUnfilteredTimelineSet().addTimeline()},R.prototype.findEventById=function(e){return this.getUnfilteredTimelineSet().findEventById(e)},R.prototype.getUnreadNotificationCount=function(e){return e=e||"total",this._notificationCounts[e]},R.prototype.setUnreadNotificationCount=function(e,t){this._notificationCounts[e]=t},R.prototype.setSummary=function(e){var t=this,r=e["m.heroes"],n=e["m.joined_member_count"],o=e["m.invited_member_count"];(0,i.default)(n)&&this.currentState.setJoinedMemberCount(n),(0,i.default)(o)&&this.currentState.setInvitedMemberCount(o),Array.isArray(r)&&(this._summaryHeroes=r.filter((function(e){return e!==t.myUserId})))},R.prototype.setBlacklistUnverifiedDevices=function(e){this._blacklistUnverifiedDevices=e},R.prototype.getBlacklistUnverifiedDevices=function(){return this._blacklistUnverifiedDevices},R.prototype.getAvatarUrl=function(e,t,r,n,o){var i=this.currentState.getStateEvents("m.room.avatar","");if(void 0===o&&(o=!0),!i&&!o)return null;var s=i?i.getContent().url:null;return s?k.getHttpUriForMxc(e,s,t,r,n):o?k.getIdenticonUri(e,this.roomId,t,r):null},R.prototype.getAliases=function(){var e=[],t=this.currentState.getStateEvents("m.room.aliases");if(t)for(var r=0;r<t.length;++r){var n=t[r];b.isArray(n.getContent().aliases)&&Array.prototype.push.apply(e,n.getContent().aliases)}return e},R.prototype.getCanonicalAlias=function(){var e=this.currentState.getStateEvents("m.room.canonical_alias","");return e?e.getContent().alias:null},R.prototype.addEventsToTimeline=function(e,t,r,n){r.getTimelineSet().addEventsToTimeline(e,t,r,n)},R.prototype.getMember=function(e){return this.currentState.getMember(e)},R.prototype.getJoinedMembers=function(){return this.getMembersWithMembership("join")},R.prototype.getJoinedMemberCount=function(){return this.currentState.getJoinedMemberCount()},R.prototype.getInvitedMemberCount=function(){return this.currentState.getInvitedMemberCount()},R.prototype.getInvitedAndJoinedMemberCount=function(){return this.getInvitedMemberCount()+this.getJoinedMemberCount()},R.prototype.getMembersWithMembership=function(e){return b.filter(this.currentState.getMembers(),(function(t){return t.membership===e}))},R.prototype.getEncryptionTargetMembers=(0,l.coroutine)(u.default.mark((function e(){var t;return u.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,l.resolve)(this.loadMembersIfNeeded());case 2:return t=this.getMembersWithMembership("join"),this.shouldEncryptForInvitedMembers()&&(t=t.concat(this.getMembersWithMembership("invite"))),e.abrupt("return",t);case 5:case"end":return e.stop()}}),e,this)}))),R.prototype.shouldEncryptForInvitedMembers=function(){var e=this.currentState.getStateEvents("m.room.history_visibility","");return e&&e.getContent()&&"joined"!==e.getContent().history_visibility},R.prototype.getDefaultRoomName=function(e){return I(this,e,!0)},R.prototype.hasMembershipState=function(e,t){var r=this.getMember(e);return!!r&&r.membership===t},R.prototype.getOrCreateFilteredTimelineSet=function(e){if(this._filteredTimelineSets[e.filterId])return this._filteredTimelineSets[e.filterId];var t=(0,o.default)({filter:e},this._opts),r=new E(this,t);this.reEmitter.reEmit(r,["Room.timeline","Room.timelineReset"]),this._filteredTimelineSets[e.filterId]=r,this._timelineSets.push(r);var n=this.getLiveTimeline();n.getEvents().forEach((function(e){r.addLiveEvent(e)}));for(var i=n;i.getNeighbouringTimeline(w.BACKWARDS);)i=i.getNeighbouringTimeline(w.BACKWARDS);return r.getLiveTimeline().setPaginationToken(i.getPaginationToken(w.BACKWARDS),w.BACKWARDS),r},R.prototype.removeFilteredTimelineSet=function(e){var t=this._filteredTimelineSets[e.filterId];delete this._filteredTimelineSets[e.filterId];var r=this._timelineSets.indexOf(t);r>-1&&this._timelineSets.splice(r,1)},R.prototype._addLiveEvent=function(e,t){if(e.isRedaction()){var r=e.event.redacts,n=this.getUnfilteredTimelineSet().findEventById(r);if(n){if(n.makeRedacted(e),n.getStateKey())this.currentState.getStateEvents(n.getType(),n.getStateKey()).getId()===n.getId()&&this.currentState.setStateEvents([n]);this.emit("Room.redaction",e,this)}}if(e.getUnsigned().transaction_id){var o=this._txnToEvent[e.getUnsigned().transaction_id];if(o)return void this._handleRemoteEcho(e,o)}for(var i=0;i<this._timelineSets.length;i++)this._timelineSets[i].addLiveEvent(e,t);e.sender&&"m.room.redaction"!==e.getType()&&this.addReceipt(x(e.sender.userId,e,"m.read"),!0)},R.prototype.addPendingEvent=function(e,t){if(e.status!==m.SENDING)throw new Error("addPendingEvent called on an event with status "+e.status);if(this._txnToEvent[t])throw new Error("addPendingEvent called on an event with known txnId "+t);if(w.setEventMetadata(e,this.getLiveTimeline().getState(w.FORWARDS),!1),this._txnToEvent[t]=e,"detached"==this._opts.pendingEventOrdering){if(this._pendingEventList.some((function(e){return e.status===m.NOT_SENT}))&&(f.default.warn("Setting event as NOT_SENT due to messages in the same state"),e.setStatus(m.NOT_SENT)),this._pendingEventList.push(e),e.isRelation()&&this._aggregateNonLiveRelation(e),e.isRedaction()){var r=e.event.redacts,n=this._pendingEventList&&this._pendingEventList.find((function(e){return e.getId()===r}));n||(n=this.getUnfilteredTimelineSet().findEventById(r)),n&&(n.markLocallyRedacted(e),this.emit("Room.redaction",e,this))}}else for(var o=0;o<this._timelineSets.length;o++){var i=this._timelineSets[o];i.getFilter()?i.getFilter().filterRoomTimeline([e]).length&&i.addEventToTimeline(e,i.getLiveTimeline(),!1):i.addEventToTimeline(e,i.getLiveTimeline(),!1)}this.emit("Room.localEchoUpdated",e,this,null,null)},R.prototype._aggregateNonLiveRelation=function(e){for(var t=0;t<this._timelineSets.length;t++){var r=this._timelineSets[t];r.getFilter()?r.getFilter().filterRoomTimeline([e]).length&&r.aggregateRelations(e):r.aggregateRelations(e)}},R.prototype._handleRemoteEcho=function(e,t){var r=t.getId(),n=e.getId(),o=t.status;delete this._txnToEvent[e.getUnsigned().transaction_id],this._pendingEventList&&b.removeElement(this._pendingEventList,(function(e){return e.getId()==r}),!1),t.handleRemoteEcho(e.event);for(var i=0;i<this._timelineSets.length;i++){this._timelineSets[i].handleRemoteEcho(t,r,n)}this.emit("Room.localEchoUpdated",t,this,r,o)};var T={};function I(e,t,r){if(!r){var n=e.currentState.getStateEvents("m.room.name","");if(n&&n.getContent()&&n.getContent().name)return n.getContent().name}var o=e.getCanonicalAlias();if(!o){var i=e.getAliases();i.length&&(o=i[0])}if(o)return o;var s=e.currentState.getJoinedMemberCount()+e.currentState.getInvitedMemberCount()-1,a=null;if(e._summaryHeroes)a=e._summaryHeroes.map((function(t){var r=e.getMember(t);return r?r.name:t}));else{var u=e.currentState.getMembers().filter((function(e){return e.userId!==t&&("invite"===e.membership||"join"===e.membership)}));u.sort((function(e,t){return e.userId.localeCompare(t.userId)})),a=(u=u.slice(0,5)).map((function(e){return e.name}))}if(s)return C(a,s);if("join"==e.getMyMembership()){var c=e.currentState.getStateEvents("m.room.third_party_invite");if(c&&c.length)return"Inviting "+C(c.map((function(e){return e.getContent().display_name})))}var l=a;return l.length||(l=e.currentState.getMembers().filter((function(e){return e.userId!==t&&"invite"!==e.membership&&"join"!==e.membership})).map((function(e){return e.name}))),l.length?"Empty room (was "+C(l)+")":"Empty room"}function C(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:e.length+1)-1;return e.length?1===e.length&&t<=1?e[0]:2===e.length&&t<=2?e[0]+" and "+e[1]:t>1?e[0]+" and "+t+" others":e[0]+" and 1 other":"Empty room"}T[m.ENCRYPTING]=[m.SENDING,m.NOT_SENT],T[m.SENDING]=[m.ENCRYPTING,m.QUEUED,m.NOT_SENT,m.SENT],T[m.QUEUED]=[m.SENDING,m.CANCELLED],T[m.SENT]=[],T[m.NOT_SENT]=[m.SENDING,m.QUEUED,m.CANCELLED],T[m.CANCELLED]=[],R.prototype.updatePendingEvent=function(e,t,r){if(f.default.log("setting pendingEvent status to "+t+" in "+e.getRoomId()),t==m.SENT&&!r)throw new Error("updatePendingEvent called with status=SENT, but no new event id");if(t==m.SENT&&this.getUnfilteredTimelineSet().eventIdToTimeline(r))return;var o=e.status,i=e.getId();if(!o)throw new Error("updatePendingEventStatus called on an event which is not a local echo.");var s=T[o];if(!s||s.indexOf(t)<0)throw new Error("Invalid EventStatus transition "+o+"->"+t);if(e.setStatus(t),t==m.SENT){e.replaceLocalEventId(r);for(var a=0;a<this._timelineSets.length;a++)this._timelineSets[a].replaceEventId(i,r)}else if(t==m.CANCELLED){if(this._pendingEventList){var u=this._pendingEventList.findIndex((function(e){return e.getId()===i}));if(-1!==u){var c=this._pendingEventList.splice(u,1),l=(0,n.default)(c,1)[0];l.isRedaction()&&this._revertRedactionLocalEcho(l)}}this.removeEvent(i)}this.emit("Room.localEchoUpdated",e,this,i,o)},R.prototype._revertRedactionLocalEcho=function(e){var t=e.event.redacts;if(t){var r=this.getUnfilteredTimelineSet().findEventById(t);r&&(r.unmarkLocallyRedacted(),this.emit("Room.redactionCancelled",e,this),r.isRelation()&&this._aggregateNonLiveRelation(r))}},R.prototype.addLiveEvents=function(e,t){var r=void 0;if(t&&-1===["replace","ignore"].indexOf(t))throw new Error("duplicateStrategy MUST be either 'replace' or 'ignore'");for(r=0;r<this._timelineSets.length;r++){var n=this._timelineSets[r].getLiveTimeline();if(n.getPaginationToken(w.FORWARDS))throw new Error("live timeline "+r+" is no longer live - it has a pagination token ("+n.getPaginationToken(w.FORWARDS)+")");if(n.getNeighbouringTimeline(w.FORWARDS))throw new Error("live timeline "+r+" is no longer live - it has a neighbouring timeline")}for(r=0;r<e.length;r++)this._addLiveEvent(e[r],t)},R.prototype.addEphemeralEvents=function(e){var t=!0,r=!1,n=void 0;try{for(var o,i=(0,c.default)(e);!(t=(o=i.next()).done);t=!0){var s=o.value;"m.typing"===s.getType()?this.currentState.setTypingEvent(s):"m.receipt"===s.getType()&&this.addReceipt(s)}}catch(e){r=!0,n=e}finally{try{!t&&i.return&&i.return()}finally{if(r)throw n}}},R.prototype.removeEvents=function(e){for(var t=0;t<e.length;++t)this.removeEvent(e[t])},R.prototype.removeEvent=function(e){for(var t=!1,r=0;r<this._timelineSets.length;r++){var n=this._timelineSets[r].removeEvent(e);n&&(n.isRedaction()&&this._revertRedactionLocalEcho(n),t=!0)}return t},R.prototype.recalculate=function(){var e=this,t=this.currentState.getStateEvents("m.room.member",this.myUserId);if(t&&"invite"===t.getContent().membership){var r=t.event.invite_room_state||[];b.forEach(r,(function(t){e.currentState.getStateEvents(t.type,t.state_key)||e.currentState.setStateEvents([new g({type:t.type,state_key:t.state_key,content:t.content,event_id:"$fake"+Date.now(),room_id:e.roomId,user_id:e.myUserId})])}))}var n=this.name;this.name=I(this,this.myUserId),this.summary=new y(this.roomId,{title:this.name}),n!==this.name&&this.emit("Room.name",this)},R.prototype.getUsersReadUpTo=function(e){return this.getReceiptsForEvent(e).filter((function(e){return"m.read"===e.type})).map((function(e){return e.userId}))},R.prototype.getEventReadUpTo=function(e,t){var r=this._receipts;return t&&(r=this._realReceipts),void 0===r["m.read"]||void 0===r["m.read"][e]?null:r["m.read"][e].eventId},R.prototype.hasUserReadEvent=function(e,t){var r=this.getEventReadUpTo(e,!1);if(r===t)return!0;if(this.timeline.length&&this.timeline[this.timeline.length-1].getSender()&&this.timeline[this.timeline.length-1].getSender()===e)return!0;for(var n=this.timeline.length-1;n>=0;--n){var o=this.timeline[n];if(o.getId()===t)return!1;if(o.getId()===r)return!0}return!1},R.prototype.getReceiptsForEvent=function(e){return this._receiptCacheByEventId[e.getId()]||[]},R.prototype.addReceipt=function(e,t){void 0===t&&(t=!1),t||this._addReceiptsToStructure(e,this._realReceipts),this._addReceiptsToStructure(e,this._receipts),this._receiptCacheByEventId=this._buildReceiptCache(this._receipts),this.emit("Room.receipt",e,this)},R.prototype._addReceiptsToStructure=function(e,t){var r=this;b.keys(e.getContent()).forEach((function(n){b.keys(e.getContent()[n]).forEach((function(o){b.keys(e.getContent()[n][o]).forEach((function(i){var s=e.getContent()[n][o][i];t[o]||(t[o]={});var a=t[o][i];if(a){var u=r.getUnfilteredTimelineSet().compareEventOrdering(a.eventId,n);if(null!==u&&u>=0)return}else t[o][i]={};t[o][i]={eventId:n,data:s}}))}))}))},R.prototype._buildReceiptCache=function(e){var t={};return b.keys(e).forEach((function(r){b.keys(e[r]).forEach((function(n){var o=e[r][n];t[o.eventId]||(t[o.eventId]=[]),t[o.eventId].push({userId:n,type:r,data:o.data})}))})),t},R.prototype._addLocalEchoReceipt=function(e,t,r){this.addReceipt(x(e,t,r),!0)},R.prototype.addTags=function(e){this.tags=e.getContent().tags||{},this.emit("Room.tags",e,this)},R.prototype.addAccountData=function(e){for(var t=0;t<e.length;t++){var r=e[t];"m.tag"===r.getType()&&this.addTags(r),this.accountData[r.getType()]=r,this.emit("Room.accountData",r,this)}},R.prototype.getAccountData=function(e){return this.accountData[e]},R.prototype.maySendMessage=function(){return"join"===this.getMyMembership()&&this.currentState.maySendEvent("m.room.message",this.myUserId)},t.exports=R},{"../ReEmitter":2,"../content-repo":7,"../logger":37,"../utils":65,"./event":42,"./event-timeline":41,"./event-timeline-set":40,"./room-member":45,"./room-summary":47,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/number/is-integer":74,"babel-runtime/core-js/number/min-safe-integer":75,"babel-runtime/core-js/object/assign":76,"babel-runtime/core-js/object/keys":82,"babel-runtime/core-js/promise":85,"babel-runtime/helpers/slicedToArray":97,"babel-runtime/regenerator":100,bluebird:103,events:257}],49:[function(e,t,r){"use strict";var n=e("./event-context"),o=e("../utils");function i(e,t){this.rank=e,this.context=t}i.fromJson=function(e,t){var r=e.context||{},s=r.events_before||[],a=r.events_after||[],u=new n(t(e.result));return u.setPaginateToken(r.start,!0),u.addEvents(o.map(s,t),!0),u.addEvents(o.map(a,t),!1),u.setPaginateToken(r.end,!1),new i(e.rank,u)},t.exports=i},{"../utils":65,"./event-context":39}],50:[function(e,t,r){"use strict";var n=e("events").EventEmitter;function o(e){this.userId=e,this.presence="offline",this.presenceStatusMsg=null,this._unstable_statusMessage="",this.displayName=e,this.rawDisplayName=e,this.avatarUrl=null,this.lastActiveAgo=0,this.lastPresenceTs=0,this.currentlyActive=!1,this.events={presence:null,profile:null},this._updateModifiedTime()}e("../utils").inherits(o,n),o.prototype.setPresenceEvent=function(e){if("m.presence"===e.getType()){var t=null===this.events.presence;this.events.presence=e;var r=[];(e.getContent().presence!==this.presence||t)&&r.push("User.presence"),e.getContent().avatar_url&&e.getContent().avatar_url!==this.avatarUrl&&r.push("User.avatarUrl"),e.getContent().displayname&&e.getContent().displayname!==this.displayName&&r.push("User.displayName"),void 0!==e.getContent().currently_active&&e.getContent().currently_active!==this.currentlyActive&&r.push("User.currentlyActive"),this.presence=e.getContent().presence,r.push("User.lastPresenceTs"),e.getContent().status_msg&&(this.presenceStatusMsg=e.getContent().status_msg),e.getContent().displayname&&(this.displayName=e.getContent().displayname),e.getContent().avatar_url&&(this.avatarUrl=e.getContent().avatar_url),this.lastActiveAgo=e.getContent().last_active_ago,this.lastPresenceTs=Date.now(),this.currentlyActive=e.getContent().currently_active,this._updateModifiedTime();for(var n=0;n<r.length;n++)this.emit(r[n],e,this)}},o.prototype.setDisplayName=function(e){var t=this.displayName;this.displayName=e,e!==t&&this._updateModifiedTime()},o.prototype.setRawDisplayName=function(e){this.rawDisplayName=e},o.prototype.setAvatarUrl=function(e){var t=this.avatarUrl;this.avatarUrl=e,e!==t&&this._updateModifiedTime()},o.prototype._updateModifiedTime=function(){this._modified=Date.now()},o.prototype.getLastModifiedTime=function(){return this._modified},o.prototype.getLastActiveTs=function(){return this.lastPresenceTs-this.lastActiveAgo},o.prototype._unstable_updateStatusMessage=function(e){e.getContent()?this._unstable_statusMessage=e.getContent().status:this._unstable_statusMessage="",this._updateModifiedTime(),this.emit("User._unstable_statusMessage",this)},t.exports=o},{"../utils":65,events:257}],51:[function(e,t,r){"use strict";var n=u(e("babel-runtime/helpers/typeof")),o=u(e("babel-runtime/core-js/get-iterator")),i=u(e("babel-runtime/core-js/json/stringify")),s=u(e("babel-runtime/core-js/object/keys")),a=e("./utils");function u(e){return e&&e.__esModule?e:{default:e}}var c=["override","content","room","sender","underride"],l=[{rule_id:".m.rule.tombstone",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.room.tombstone"},{kind:"event_match",key:"state_key",pattern:""}],actions:["notify",{set_tweak:"highlight",value:!0}]},{rule_id:".m.rule.reaction",default:!0,enabled:!0,conditions:[{kind:"event_match",key:"type",pattern:"m.reaction"}],actions:["dont_notify"]}];function d(e){var t=this,r={},n=function(e,r,n){for(var o=0;o<c.length;++o)for(var i=c[o],s=r[i],a=0;a<s.length;++a){var l=s[a];if(l.enabled){var d=u(i,l,n);if(d&&t.ruleMatchesEvent(d,e))return l.kind=i,l}}return null},u=function(e,t,r){var n={rule_id:t.rule_id,actions:t.actions,conditions:[]};switch(e){case"underride":case"override":n.conditions=t.conditions;break;case"room":if(!t.rule_id)return null;n.conditions.push({kind:"event_match",key:"room_id",value:t.rule_id});break;case"sender":if(!t.rule_id)return null;n.conditions.push({kind:"event_match",key:"user_id",value:t.rule_id});break;case"content":if(!t.pattern)return null;n.conditions.push({kind:"event_match",key:"content.body",pattern:t.pattern})}return r&&n.conditions.push({kind:"device",profile_tag:r}),n},f=function(e,t){var r={event_match:y,device:m,contains_display_name:v,room_member_count:h,sender_notification_permission:p};return!!r[e.kind]&&r[e.kind](e,t)},p=function(t,r){var n=t.key;if(!n)return!1;var o=e.getRoom(r.getRoomId());return!(!o||!o.currentState)&&o.currentState.mayTriggerNotifOfType(n,r.getSender())},h=function(t,r){if(!t.is)return!1;var n=e.getRoom(r.getRoomId());if(!n||!n.currentState||!n.currentState.members)return!1;var o=n.currentState.getJoinedMemberCount(),i=t.is.match(/^([=<>]*)([0-9]*)$/);if(!i)return!1;var s=i[1],a=parseInt(i[2]);if(isNaN(a))return!1;switch(s){case"":case"==":return o==a;case"<":return o<a;case">":return o>a;case"<=":return o<=a;case">=":return o>=a;default:return!1}},v=function(t,r){var n=r.getContent();if(r.isEncrypted()&&r.getClearContent()&&(n=r.getClearContent()),!n||!n.body||"string"!=typeof n.body)return!1;var o=e.getRoom(r.getRoomId());if(!(o&&o.currentState&&o.currentState.members&&o.currentState.getMember(e.credentials.userId)))return!1;var i=o.currentState.getMember(e.credentials.userId).name,s=new RegExp("(^|\\W)"+(0,a.escapeRegExp)(i)+"(\\W|$)","i");return n.body.search(s)>-1},m=function(e,t){return!1},y=function(e,t){if(!e.key)return!1;var r=g(e.key,t);if(!r||"string"!=typeof r)return!1;if(e.value)return e.value===r;var n=void 0;return n="content.body"==e.key?_("(^|\\W)",e.pattern,"(\\W|$)"):_("^",e.pattern,"$"),!!r.match(n)},_=function(e,t,n){return r[t]?r[t]:(r[t]=new RegExp(e+(0,a.globToRegexp)(t)+n,"i"),r[t])},g=function(e,t){var r=e.split("."),n=void 0,o=r[0];for("content"==o?(n=t.getContent(),r.shift()):"type"==o?(n=t.getType(),r.shift()):n=t.event;r.length>0;){var i=r.shift();if(!n[i])return null;n=n[i]}return n},b=function(t,r){var o=function(t,r){if(!r||!r.device)return null;if(t.getSender()==e.credentials.userId)return null;for(var o=(0,s.default)(r.device),i=0;i<o.length;++i){var a=o[i],u=r.device[a],c=n(u,a);if(c)return c}return n(t,r.global)}(t,r);if(!o)return{};var i=d.actionListToActionsObject(o.actions);return void 0===i.tweaks.highlight&&(i.tweaks.highlight="content"==o.kind),i};this.ruleMatchesEvent=function(e,t){for(var r=!0,n=0;n<e.conditions.length;++n){var o=e.conditions[n];r&=f(o,t)}return r},this.actionsForEvent=function(t){var r=function(e){var t=JSON.parse((0,i.default)(e));e.global||(e.global={}),e.global.override||(e.global.override=[]);var r=e.global.override,n=!0,s=!1,a=void 0;try{for(var u,c=function(){var e=u.value;if(!r.find((function(t){return t.rule_id===e.rule_id}))){var t=e.rule_id;console.warn("Adding default global override for "+t),r.push(e)}},d=(0,o.default)(l);!(n=(u=d.next()).done);n=!0)c()}catch(e){s=!0,a=e}finally{try{!n&&d.return&&d.return()}finally{if(s)throw a}}return t}(e.pushRules);return b(t,r)},this.getPushRuleById=function(t){for(var r=["device","global"],n=0;n<r.length;n++){var i=r[n];if(void 0!==e.pushRules[i]){var s=!0,a=!1,u=void 0;try{for(var l,d=(0,o.default)(c);!(s=(l=d.next()).done);s=!0){var f=l.value;if(void 0!==e.pushRules[i][f]){var p=!0,h=!1,v=void 0;try{for(var m,y=(0,o.default)(e.pushRules[i][f]);!(p=(m=y.next()).done);p=!0){var _=m.value;if(_.rule_id===t)return _}}catch(e){h=!0,v=e}finally{try{!p&&y.return&&y.return()}finally{if(h)throw v}}}}}catch(e){a=!0,u=e}finally{try{!s&&d.return&&d.return()}finally{if(a)throw u}}}}return null}}d.actionListToActionsObject=function(e){for(var t={notify:!1,tweaks:{}},r=0;r<e.length;++r){var o=e[r];"notify"===o?t.notify=!0:"object"===(void 0===o?"undefined":(0,n.default)(o))&&(void 0===o.value&&(o.value=!0),t.tweaks[o.set_tweak]=o.value)}return t},d.rewriteDefaultRules=function(e){var t=JSON.parse((0,i.default)(e));return t||(t={}),t.global||(t.global={}),t.global.override||(t.global.override=[]),t.global.override=t.global.override.map((function(e){var t=l.find((function(t){return t.rule_id===e.rule_id}));return t?(e.default=t.default,e.conditions=t.conditions,e.actions=t.actions,e):e})),t},t.exports=d},{"./utils":65,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/json/stringify":71,"babel-runtime/core-js/object/keys":82,"babel-runtime/helpers/typeof":99}],52:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.randomString=function(e){for(var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",n=0;n<e;++n)t+=r.charAt(Math.floor(Math.random()*r.length));return t}},{}],53:[function(e,t,r){(function(r){"use strict";var n,o=e("./logger"),i=(n=o)&&n.__esModule?n:{default:n};var s=1e3,a=0,u=void 0,c=[],l=function(){};t.exports.setNow=function(e){d=e||Date.now};var d=Date.now;function f(){u&&r.clearTimeout(u);var e=c[0];if(e){var t=d(),n=Math.min(e.runAt-t,s);l("_scheduleRealCallback: now:",t,"delay:",n),u=r.setTimeout(p,n)}else l("_scheduleRealCallback: no more callbacks, not rescheduling")}function p(){var e=void 0,t=d();l("_runCallbacks: now:",t);for(var n=[];;){var o=c[0];if(!o||o.runAt>t)break;e=c.shift(),l("_runCallbacks: popping",e.key),n.push(e)}f();for(var s=0;s<n.length;s++){e=n[s];try{e.func.apply(r,e.params)}catch(e){i.default.error("Uncaught exception in callback function",e.stack||e)}}}function h(e,t){for(var r=0,n=e.length;r<n;){var o=r+n>>1;t(e[o])>0?n=o:r=o+1}return r}t.exports.setTimeout=function(e,t){(t=t||0)<0&&(t=0);var r=Array.prototype.slice.call(arguments,2),n=d()+t,o=a++;l("setTimeout: scheduling cb",o,"at",n,"(delay",t,")");var i={runAt:n,func:e,params:r,key:o},s=h(c,(function(e){return e.runAt-n}));return c.splice(s,0,i),f(),o},t.exports.clearTimeout=function(e){if(0!==c.length){var t=void 0;for(t=0;t<c.length;t++){if(c[t].key==e){c.splice(t,1);break}}0===t&&f()}}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./logger":37}],54:[function(e,t,r){"use strict";var n=i(e("bluebird")),o=i(e("./logger"));function i(e){return e&&e.__esModule?e:{default:e}}var s=e("./utils"),a=!1;function u(e,t){this.retryAlgorithm=e||u.RETRY_BACKOFF_RATELIMIT,this.queueAlgorithm=t||u.QUEUE_MESSAGES,this._queues={},this._activeQueues=[],this._procFn=null}function c(e){e._procFn&&s.forEach(s.filter(s.keys(e._queues),(function(t){return-1===e._activeQueues.indexOf(t)&&e._queues[t].length>0})),(function(t){e._activeQueues.push(t),d("Spinning up queue: '%s'",t),function e(t,r){var o=function(e,t){var r=e._queues[t];if(!s.isArray(r))return null;return r[0]}(t,r);if(!o){var i=t._activeQueues.indexOf(r);return i>=0&&t._activeQueues.splice(i,1),void d("Stopping queue '%s' as it is now empty",r)}d("Queue '%s' has %s pending events",r,t._queues[r].length);n.default.resolve().then((function(){return t._procFn(o.event)})).then((function(n){l(t,r),d("Queue '%s' sent event %s",r,o.event.getId()),o.defer.resolve(n),e(t,r)}),(function(n){o.attempts+=1;var i=t.retryAlgorithm(o.event,o.attempts,n);d("retry(%s) err=%s event_id=%s waitTime=%s",o.attempts,n,o.event.getId(),i),-1===i?(d("Queue '%s' giving up on event %s",r,o.event.getId()),l(t,r),o.defer.reject(n),e(t,r)):setTimeout((function(){e(t,r)}),i)}))}(e,t)}))}function l(e,t){var r=e._queues[t];return s.isArray(r)?r.shift():null}function d(){a&&o.default.log.apply(o.default,arguments)}u.prototype.getQueueForEvent=function(e){var t=this.queueAlgorithm(e);return t&&this._queues[t]?s.map(this._queues[t],(function(e){return e.event})):null},u.prototype.removeEventFromQueue=function(e){var t=this.queueAlgorithm(e);if(!t||!this._queues[t])return!1;var r=!1;return s.removeElement(this._queues[t],(function(t){if(t.event.getId()===e.getId())return r=!0,!0})),r},u.prototype.setProcessFunction=function(e){this._procFn=e,c(this)},u.prototype.queueEvent=function(e){var t=this.queueAlgorithm(e);if(!t)return null;this._queues[t]||(this._queues[t]=[]);var r=n.default.defer();return this._queues[t].push({event:e,defer:r,attempts:0}),d("Queue algorithm dumped event %s into queue '%s'",e.getId(),t),c(this),r.promise},u.RETRY_BACKOFF_RATELIMIT=function(e,t,r){if(400===r.httpStatus||403===r.httpStatus||401===r.httpStatus)return-1;if("rejected"===r.cors)return-1;if("M_LIMIT_EXCEEDED"===r.name){var n=r.data.retry_after_ms;if(n)return n}return t>4?-1:1e3*Math.pow(2,t)},u.QUEUE_MESSAGES=function(e){return"m.room.message"===e.getType()||e.hasAssocation()?"message":null},t.exports=u},{"./logger":37,"./utils":65,bluebird:103}],55:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.SERVICE_TYPES=void 0;var n,o=e("babel-runtime/core-js/object/freeze"),i=(n=o)&&n.__esModule?n:{default:n};r.SERVICE_TYPES=(0,i.default)({IS:"SERVICE_TYPE_IS",IM:"SERVICE_TYPE_IM"})},{"babel-runtime/core-js/object/freeze":80}],56:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=f(e("babel-runtime/core-js/get-iterator")),o=f(e("babel-runtime/regenerator")),i=e("bluebird"),s=f(i),a=f(e("babel-runtime/helpers/slicedToArray")),u=f(e("../sync-accumulator")),c=f(e("../utils")),l=function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}(e("../indexeddb-helpers")),d=f(e("../logger"));function f(e){return e&&e.__esModule?e:{default:e}}function p(e,t,r){var n=e.openCursor(t);return new s.default((function(e,t){var o=[];n.onerror=function(e){t(new Error("Query failed: "+e.target.errorCode))},n.onsuccess=function(t){var n=t.target.result;n?(o.push(r(n)),n.continue()):e(o)}}))}function h(e){return new s.default((function(t,r){e.oncomplete=function(e){t(e)},e.onerror=function(e){r(e.target.error)}}))}function v(e){return new s.default((function(t,r){e.onsuccess=function(e){t(e)},e.onerror=function(e){r(e.target.error)}}))}function m(e){return new s.default((function(t,r){e.onsuccess=function(){return t(e)},e.onerror=function(e){return r(e)}}))}function y(e){return v(e).then((function(e){return e.target.result}))}var _,g,b,k=function(e,t){this.indexedDB=e,this._dbName="matrix-js-sdk:"+(t||"default"),this.db=null,this._disconnected=!0,this._syncAccumulator=new u.default,this._isNewlyCreated=!1};k.exists=function(e,t){return t="matrix-js-sdk:"+(t||"default"),l.exists(e,t)},k.prototype={connect:function(){var e=this;if(!this._disconnected)return d.default.log("LocalIndexedDBStoreBackend.connect: already connected or connecting"),s.default.resolve();this._disconnected=!1,d.default.log("LocalIndexedDBStoreBackend.connect: connecting...");var t=this.indexedDB.open(this._dbName,3);return t.onupgradeneeded=function(t){var r=t.target.result,n=t.oldVersion;d.default.log("LocalIndexedDBStoreBackend.connect: upgrading from "+n),n<1&&(e._isNewlyCreated=!0,function(e){e.createObjectStore("users",{keyPath:["userId"]}),e.createObjectStore("accountData",{keyPath:["type"]}),e.createObjectStore("sync",{keyPath:["clobber"]})}(r)),n<2&&function(e){e.createObjectStore("oob_membership_events",{keyPath:["room_id","state_key"]}).createIndex("room","room_id")}(r),n<3&&function(e){e.createObjectStore("client_options",{keyPath:["clobber"]})}(r)},t.onblocked=function(){d.default.log("can't yet open LocalIndexedDBStoreBackend because it is open elsewhere")},d.default.log("LocalIndexedDBStoreBackend.connect: awaiting connection..."),v(t).then((function(t){return d.default.log("LocalIndexedDBStoreBackend.connect: connected"),e.db=t.target.result,e.db.onversionchange=function(){e.db.close()},e._init()}))},isNewlyCreated:function(){return s.default.resolve(this._isNewlyCreated)},_init:function(){var e=this;return s.default.all([this._loadAccountData(),this._loadSyncData()]).then((function(t){var r=(0,a.default)(t,2),n=r[0],o=r[1];d.default.log("LocalIndexedDBStoreBackend: loaded initial data"),e._syncAccumulator.accumulate({next_batch:o.nextBatch,rooms:o.roomsData,groups:o.groupsData,account_data:{events:n}})}))},getOutOfBandMembers:function(e){var t=this;return new s.default((function(r,n){var o=t.db.transaction(["oob_membership_events"],"readonly").objectStore("oob_membership_events").index("room"),i=IDBKeyRange.only(e),s=o.openCursor(i),a=[],u=!1;s.onsuccess=function(e){var t=e.target.result;if(!t)return a.length||u?r(a):r(null);var n=t.value;n.oob_written?u=!0:a.push(n),t.continue()},s.onerror=function(e){n(e)}})).then((function(t){return d.default.log("LL: got "+(t&&t.length)+" membershipEvents from storage for room "+e+" ..."),t}))},setOutOfBandMembers:(b=(0,i.coroutine)(o.default.mark((function e(t,r){var n,s,a;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return d.default.log("LL: backend about to store "+r.length+" members for "+t),n=this.db.transaction(["oob_membership_events"],"readwrite"),s=n.objectStore("oob_membership_events"),r.forEach((function(e){s.put(e)})),a={room_id:t,oob_written:!0,state_key:0},s.put(a),e.next=8,(0,i.resolve)(h(n));case 8:d.default.log("LL: backend done storing for "+t+"!");case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return b.apply(this,arguments)}),clearOutOfBandMembers:(g=(0,i.coroutine)(o.default.mark((function e(t){var r,n,u,c,l,f,p,h,v,_,g,b,k;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=this.db.transaction(["oob_membership_events"],"readonly"),n=r.objectStore("oob_membership_events"),u=n.index("room"),c=IDBKeyRange.only(t),l=y(u.openKeyCursor(c,"next")).then((function(e){return e&&e.primaryKey[1]})),f=y(u.openKeyCursor(c,"prev")).then((function(e){return e&&e.primaryKey[1]})),e.next=8,(0,i.resolve)(s.default.all([l,f]));case 8:return p=e.sent,h=(0,a.default)(p,2),v=h[0],_=h[1],g=this.db.transaction(["oob_membership_events"],"readwrite"),b=g.objectStore("oob_membership_events"),k=IDBKeyRange.bound([t,v],[t,_]),d.default.log("LL: Deleting all users + marker in storage for room "+t+", with key range:",[t,v],[t,_]),e.next=18,(0,i.resolve)(m(b.delete(k)));case 18:case"end":return e.stop()}}),e,this)}))),function(e){return g.apply(this,arguments)}),clearDatabase:function(){var e=this;return new s.default((function(t,r){d.default.log("Removing indexeddb instance: "+e._dbName);var n=e.indexedDB.deleteDatabase(e._dbName);n.onblocked=function(){d.default.log("can't yet delete indexeddb "+e._dbName+" because it is open elsewhere")},n.onerror=function(e){d.default.warn("unable to delete js-sdk store indexeddb: "+e.target.error),t()},n.onsuccess=function(){d.default.log("Removed indexeddb instance: "+e._dbName),t()}}))},getSavedSync:function(e){void 0===e&&(e=!0);var t=this._syncAccumulator.getJSON();return t.nextBatch?e?s.default.resolve(c.default.deepCopy(t)):s.default.resolve(t):s.default.resolve(null)},getNextBatchToken:function(){return s.default.resolve(this._syncAccumulator.getNextBatchToken())},setSyncData:function(e){var t=this;return s.default.resolve().then((function(){t._syncAccumulator.accumulate(e)}))},syncToDatabase:function(e){var t=this._syncAccumulator.getJSON();return s.default.all([this._persistUserPresenceEvents(e),this._persistAccountData(t.accountData),this._persistSyncData(t.nextBatch,t.roomsData,t.groupsData)])},_persistSyncData:function(e,t,r){var n=this;return d.default.log("Persisting sync data up to ",e),s.default.try((function(){var o=n.db.transaction(["sync"],"readwrite");return o.objectStore("sync").put({clobber:"-",nextBatch:e,roomsData:t,groupsData:r}),h(o)}))},_persistAccountData:function(e){var t=this;return s.default.try((function(){for(var r=t.db.transaction(["accountData"],"readwrite"),n=r.objectStore("accountData"),o=0;o<e.length;o++)n.put(e[o]);return h(r)}))},_persistUserPresenceEvents:function(e){var t=this;return s.default.try((function(){var r=t.db.transaction(["users"],"readwrite"),o=r.objectStore("users"),i=!0,s=!1,a=void 0;try{for(var u,c=(0,n.default)(e);!(i=(u=c.next()).done);i=!0){var l=u.value;o.put({userId:l[0],event:l[1]})}}catch(e){s=!0,a=e}finally{try{!i&&c.return&&c.return()}finally{if(s)throw a}}return h(r)}))},getUserPresenceEvents:function(){var e=this;return s.default.try((function(){return p(e.db.transaction(["users"],"readonly").objectStore("users"),void 0,(function(e){return[e.value.userId,e.value.event]}))}))},_loadAccountData:function(){var e=this;return d.default.log("LocalIndexedDBStoreBackend: loading account data..."),s.default.try((function(){return p(e.db.transaction(["accountData"],"readonly").objectStore("accountData"),void 0,(function(e){return e.value})).then((function(e){return d.default.log("LocalIndexedDBStoreBackend: loaded account data"),e}))}))},_loadSyncData:function(){var e=this;return d.default.log("LocalIndexedDBStoreBackend: loading sync data..."),s.default.try((function(){return p(e.db.transaction(["sync"],"readonly").objectStore("sync"),void 0,(function(e){return e.value})).then((function(e){return d.default.log("LocalIndexedDBStoreBackend: loaded sync data"),e.length>1&&d.default.warn("loadSyncData: More than 1 sync row found."),e.length>0?e[0]:{}}))}))},getClientOptions:function(){var e=this;return s.default.resolve().then((function(){return p(e.db.transaction(["client_options"],"readonly").objectStore("client_options"),void 0,(function(e){if(e.value&&e.value&&e.value.options)return e.value.options})).then((function(e){return e[0]}))}))},storeClientOptions:(_=(0,i.coroutine)(o.default.mark((function e(t){var r;return o.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return(r=this.db.transaction(["client_options"],"readwrite")).objectStore("client_options").put({clobber:"-",options:t}),e.next=5,(0,i.resolve)(h(r));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)})},r.default=k},{"../indexeddb-helpers":35,"../logger":37,"../sync-accumulator":62,"../utils":65,"babel-runtime/core-js/get-iterator":69,"babel-runtime/helpers/slicedToArray":97,"babel-runtime/regenerator":100,bluebird:103}],57:[function(e,t,r){"use strict";Object.defineProperty(r,"__esModule",{value:!0});var n=i(e("bluebird")),o=i(e("../logger"));function i(e){return e&&e.__esModule?e:{default:e}}var s=function(e,t,r){this._workerScript=e,this._dbName=t,this._workerApi=r,this._worker=null,this._nextSeq=0,this._inFlight={},this._startPromise=null};s.prototype={connect:function(){var e=this;return this._ensureStarted().then((function(){return e._doCmd("connect")}))},clearDatabase:function(){var e=this;return this._ensureStarted().then((function(){return e._doCmd("clearDatabase")}))},isNewlyCreated:function(){return this._doCmd("isNewlyCreated")},getSavedSync:function(){return this._doCmd("getSavedSync")},getNextBatchToken:function(){return this._doCmd("getNextBatchToken")},setSyncData:function(e){return this._doCmd("setSyncData",[e])},syncToDatabase:function(e){return this._doCmd("syncToDatabase",[e])},getOutOfBandMembers:function(e){return this._doCmd("getOutOfBandMembers",[e])},setOutOfBandMembers:function(e,t){return this._doCmd("setOutOfBandMembers",[e,t])},clearOutOfBandMembers:function(e){return this._doCmd("clearOutOfBandMembers",[e])},getClientOptions:function(){return this._doCmd("getClientOptions")},storeClientOptions:function(e){return this._doCmd("storeClientOptions",[e])},getUserPresenceEvents:function(){return this._doCmd("getUserPresenceEvents")},_ensureStarted:function(){return null===this._startPromise&&(this._worker=new this._workerApi(this._workerScript),this._worker.onmessage=this._onWorkerMessage.bind(this),this._startPromise=this._doCmd("_setupWorker",[this._dbName]).then((function(){o.default.log("IndexedDB worker is ready")}))),this._startPromise},_doCmd:function(e,t){var r=this;return n.default.resolve().then((function(){var o=r._nextSeq++,i=n.default.defer();return r._inFlight[o]=i,r._worker.postMessage({command:e,seq:o,args:t}),i.promise}))},_onWorkerMessage:function(e){var t=e.data;if("cmd_success"==t.command||"cmd_fail"==t.command){if(void 0===t.seq)return void o.default.error("Got reply from worker with no seq");var r=this._inFlight[t.seq];if(void 0===r)return void o.default.error("Got reply for unknown seq "+t.seq);if(delete this._inFlight[t.seq],"cmd_success"==t.command)r.resolve(t.result);else{var n=new Error(t.error.message);n.name=t.error.name,r.reject(n)}}else o.default.warn("Unrecognised message from worker: "+t)}},r.default=s},{"../logger":37,bluebird:103}],58:[function(e,t,r){(function(r){"use strict";var n=y(e("babel-runtime/regenerator")),o=y(e("babel-runtime/core-js/object/set-prototype-of")),i=e("bluebird"),s=y(i),a=y(e("babel-runtime/core-js/get-iterator")),u=y(e("babel-runtime/helpers/slicedToArray")),c=e("./memory"),l=y(e("../utils")),d=e("events"),f=y(e("./indexeddb-local-backend.js")),p=y(e("./indexeddb-remote-backend.js")),h=y(e("../models/user")),v=e("../models/event"),m=y(e("../logger"));function y(e){return e&&e.__esModule?e:{default:e}}var _=function(e){if(c.MemoryStore.call(this,e),!e.indexedDB)throw new Error("Missing required option: indexedDB");if(e.workerScript){var t=e.workerApi;t||(t=r.Worker),this.backend=new p.default(e.workerScript,e.dbName,t)}else this.backend=new f.default(e.indexedDB,e.dbName);this.startedUp=!1,this._syncTs=0,this._userModifiedMap={}};function g(e,t){return r=(0,i.coroutine)(n.default.mark((function r(){for(var s=arguments.length,a=Array(s),u=0;u<s;u++)a[u]=arguments[u];var l;return n.default.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.prev=0,r.next=3,(0,i.resolve)(e.call.apply(e,[this].concat(a)));case 3:return r.abrupt("return",r.sent);case 6:return r.prev=6,r.t0=r.catch(0),m.default.error("IndexedDBStore failure, degrading to MemoryStore",r.t0),this.emit("degraded",r.t0),r.prev=10,m.default.log("IndexedDBStore trying to delete degraded data"),r.next=14,(0,i.resolve)(this.backend.clearDatabase());case 14:m.default.log("IndexedDBStore delete after degrading succeeeded"),r.next=20;break;case 17:r.prev=17,r.t1=r.catch(10),m.default.warn("IndexedDBStore delete after degrading failed",r.t1);case 20:if((0,o.default)(this,c.MemoryStore.prototype),!t){r.next=25;break}return r.next=24,(0,i.resolve)((l=c.MemoryStore.prototype[t]).call.apply(l,[this].concat(a)));case 24:return r.abrupt("return",r.sent);case 25:case"end":return r.stop()}}),r,this,[[0,6],[10,17]])}))),function(e){return r.apply(this,arguments)};var r}l.default.inherits(_,c.MemoryStore),l.default.extend(_.prototype,d.EventEmitter.prototype),_.exists=function(e,t){return f.default.exists(e,t)},_.prototype.startup=function(){var e=this;return this.startedUp?(m.default.log("IndexedDBStore.startup: already started"),s.default.resolve()):(m.default.log("IndexedDBStore.startup: connecting to backend"),this.backend.connect().then((function(){return m.default.log("IndexedDBStore.startup: loading presence events"),e.backend.getUserPresenceEvents()})).then((function(t){m.default.log("IndexedDBStore.startup: processing presence events"),t.forEach((function(t){var r=(0,u.default)(t,2),n=r[0],o=r[1],i=new h.default(n);o&&i.setPresenceEvent(new v.MatrixEvent(o)),e._userModifiedMap[i.userId]=i.getLastModifiedTime(),e.storeUser(i)}))})))},_.prototype.getSavedSync=g((function(){return this.backend.getSavedSync()}),"getSavedSync"),_.prototype.isNewlyCreated=g((function(){return this.backend.isNewlyCreated()}),"isNewlyCreated"),_.prototype.getSavedSyncToken=g((function(){return this.backend.getNextBatchToken()}),"getSavedSyncToken"),_.prototype.deleteAllData=g((function(){return c.MemoryStore.prototype.deleteAllData.call(this),this.backend.clearDatabase().then((function(){m.default.log("Deleted indexeddb data.")}),(function(e){throw m.default.error("Failed to delete indexeddb data: "+e),e}))})),_.prototype.wantsSave=function(){return Date.now()-this._syncTs>3e5},_.prototype.save=function(e){return e||this.wantsSave()?this._reallySave():s.default.resolve()},_.prototype._reallySave=g((function(){this._syncTs=Date.now();var e=[],t=!0,r=!1,n=void 0;try{for(var o,i=(0,a.default)(this.getUsers());!(t=(o=i.next()).done);t=!0){var s=o.value;this._userModifiedMap[s.userId]!==s.getLastModifiedTime()&&(s.events.presence&&(e.push([s.userId,s.events.presence.event]),this._userModifiedMap[s.userId]=s.getLastModifiedTime()))}}catch(e){r=!0,n=e}finally{try{!t&&i.return&&i.return()}finally{if(r)throw n}}return this.backend.syncToDatabase(e)})),_.prototype.setSyncData=g((function(e){return this.backend.setSyncData(e)}),"setSyncData"),_.prototype.getOutOfBandMembers=g((function(e){return this.backend.getOutOfBandMembers(e)}),"getOutOfBandMembers"),_.prototype.setOutOfBandMembers=g((function(e,t){return c.MemoryStore.prototype.setOutOfBandMembers.call(this,e,t),this.backend.setOutOfBandMembers(e,t)}),"setOutOfBandMembers"),_.prototype.clearOutOfBandMembers=g((function(e){return c.MemoryStore.prototype.clearOutOfBandMembers.call(this),this.backend.clearOutOfBandMembers(e)}),"clearOutOfBandMembers"),_.prototype.getClientOptions=g((function(){return this.backend.getClientOptions()}),"getClientOptions"),_.prototype.storeClientOptions=g((function(e){return c.MemoryStore.prototype.storeClientOptions.call(this,e),this.backend.storeClientOptions(e)}),"storeClientOptions"),t.exports.IndexedDBStore=_}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":37,"../models/event":42,"../models/user":50,"../utils":65,"./indexeddb-local-backend.js":56,"./indexeddb-remote-backend.js":57,"./memory":59,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/object/set-prototype-of":83,"babel-runtime/helpers/slicedToArray":97,"babel-runtime/regenerator":100,bluebird:103,events:257}],59:[function(e,t,r){"use strict";var n=i(e("babel-runtime/core-js/object/assign")),o=i(e("bluebird"));function i(e){return e&&e.__esModule?e:{default:e}}var s=e("../utils"),a=e("../models/user");t.exports.MemoryStore=function(e){e=e||{},this.rooms={},this.groups={},this.users={},this.syncToken=null,this.filters={},this.accountData={},this.localStorage=e.localStorage,this._oobMembers={},this._clientOptions={}},t.exports.MemoryStore.prototype={getSyncToken:function(){return this.syncToken},isNewlyCreated:function(){return o.default.resolve(!0)},setSyncToken:function(e){this.syncToken=e},storeGroup:function(e){this.groups[e.groupId]=e},getGroup:function(e){return this.groups[e]||null},getGroups:function(){return s.values(this.groups)},storeRoom:function(e){this.rooms[e.roomId]=e,e.currentState.on("RoomState.members",this._onRoomMember.bind(this));var t=this;e.currentState.getMembers().forEach((function(r){t._onRoomMember(null,e.currentState,r)}))},_onRoomMember:function(e,t,r){if("invite"!==r.membership){var n=this.users[r.userId]||new a(r.userId);r.name&&(n.setDisplayName(r.name),r.events.member&&n.setRawDisplayName(r.events.member.getDirectionalContent().displayname)),r.events.member&&r.events.member.getContent().avatar_url&&n.setAvatarUrl(r.events.member.getContent().avatar_url),this.users[n.userId]=n}},getRoom:function(e){return this.rooms[e]||null},getRooms:function(){return s.values(this.rooms)},removeRoom:function(e){this.rooms[e]&&this.rooms[e].removeListener("RoomState.members",this._onRoomMember),delete this.rooms[e]},getRoomSummaries:function(){return s.map(s.values(this.rooms),(function(e){return e.summary}))},storeUser:function(e){this.users[e.userId]=e},getUser:function(e){return this.users[e]||null},getUsers:function(){return s.values(this.users)},scrollback:function(e,t){return[]},storeEvents:function(e,t,r,n){},storeFilter:function(e){e&&(this.filters[e.userId]||(this.filters[e.userId]={}),this.filters[e.userId][e.filterId]=e)},getFilter:function(e,t){return this.filters[e]&&this.filters[e][t]?this.filters[e][t]:null},getFilterIdByName:function(e){if(!this.localStorage)return null;try{return this.localStorage.getItem("mxjssdk_memory_filter_"+e)}catch(e){}return null},setFilterIdByName:function(e,t){if(this.localStorage)try{this.localStorage.setItem("mxjssdk_memory_filter_"+e,t)}catch(e){}},storeAccountDataEvents:function(e){var t=this;e.forEach((function(e){t.accountData[e.getType()]=e}))},getAccountData:function(e){return this.accountData[e]},setSyncData:function(e){return o.default.resolve()},wantsSave:function(){return!1},save:function(e){},startup:function(){return o.default.resolve()},getSavedSync:function(){return o.default.resolve(null)},getSavedSyncToken:function(){return o.default.resolve(null)},deleteAllData:function(){return this.rooms={},this.users={},this.syncToken=null,this.filters={},this.accountData={},o.default.resolve()},getOutOfBandMembers:function(e){return o.default.resolve(this._oobMembers[e]||null)},setOutOfBandMembers:function(e,t){return this._oobMembers[e]=t,o.default.resolve()},clearOutOfBandMembers:function(){return this._oobMembers={},o.default.resolve()},getClientOptions:function(){return o.default.resolve(this._clientOptions)},storeClientOptions:function(e){return this._clientOptions=(0,n.default)({},e),o.default.resolve()}}},{"../models/user":50,"../utils":65,"babel-runtime/core-js/object/assign":76,bluebird:103}],60:[function(e,t,r){"use strict";var n=i(e("babel-runtime/core-js/get-iterator")),o=i(e("../../logger"));function i(e){return e&&e.__esModule?e:{default:e}}var s=e("../../utils"),a=!1,u="session.e2e.";function c(e){if(this.store=e,!(s.isFunction(e.getItem)&&s.isFunction(e.setItem)&&s.isFunction(e.removeItem)&&s.isFunction(e.key)&&"number"==typeof e.length))throw new Error("Supplied webStore does not meet the WebStorage API interface")}c.prototype={removeEndToEndAccount:function(){this.store.removeItem(l)},getEndToEndAccount:function(){return this.store.getItem(l)},getAllEndToEndDevices:function(){for(var e=h(""),t={},r=0;r<this.store.length;++r){var n=this.store.key(r),o=n.substr(e.length);n.startsWith(e)&&(t[o]=y(this.store,n))}return t},getEndToEndDeviceTrackingStatus:function(){return y(this.store,f)},getEndToEndDeviceSyncToken:function(){return y(this.store,d)},removeEndToEndDeviceData:function(){g(this.store,h("")),g(this.store,f),g(this.store,d)},getEndToEndSessions:function(e){return y(this.store,v(e))},getAllEndToEndSessions:function(){var e=_(this.store,v("")),t={},r=!0,o=!1,i=void 0;try{for(var s,a=(0,n.default)(e);!(r=(s=a.next()).done);r=!0){var u=s.value;t[u.substr(v("").length)]=y(this.store,u)}}catch(e){o=!0,i=e}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return t},removeAllEndToEndSessions:function(){g(this.store,v(""))},getAllEndToEndInboundGroupSessionKeys:function(){for(var e=u+"inboundgroupsessions/",t=[],r=0;r<this.store.length;r++){var n=this.store.key(r);n.startsWith(e)&&t.push({senderKey:n.substr(e.length,43),sessionId:n.substr(e.length+44)})}return t},getEndToEndInboundGroupSession:function(e,t){var r=function(e,t){return u+"inboundgroupsessions/"+e+"/"+t}(e,t);return this.store.getItem(r)},removeAllEndToEndInboundGroupSessions:function(){g(this.store,u+"inboundgroupsessions/")},getAllEndToEndRooms:function(){var e=_(this.store,m("")),t={},r=!0,o=!1,i=void 0;try{for(var s,a=(0,n.default)(e);!(r=(s=a.next()).done);r=!0){var u=s.value;t[u.substr(m("").length)]=y(this.store,u)}}catch(e){o=!0,i=e}finally{try{!r&&a.return&&a.return()}finally{if(o)throw i}}return t},removeAllEndToEndRooms:function(){g(this.store,m(""))},setLocalTrustedBackupPubKey:function(e){this.store.setItem(p,e)},getLocalTrustedBackupPubKey:function(){return this.store.getItem(p)}};var l=u+"account",d=u+"device_sync_token",f=u+"device_tracking",p=u+"trusted_backup_pubkey";function h(e){return u+"devices/"+e}function v(e){return u+"sessions/"+e}function m(e){return u+"rooms/"+e}function y(e,t){try{return JSON.parse(e.getItem(t))}catch(e){b("Failed to get key %s: %s",t,e),b(e.stack)}return null}function _(e,t){for(var r=[],n=0;n<e.length;++n){var o=e.key(n);o.startsWith(t)&&r.push(o)}return r}function g(e,t){for(var r=[],o=0;o<e.length;++o){var i=e.key(o);i.startsWith(t)&&r.push(i)}var s=!0,a=!1,u=void 0;try{for(var c,l=(0,n.default)(r);!(s=(c=l.next()).done);s=!0){var d=c.value;e.removeItem(d)}}catch(e){a=!0,u=e}finally{try{!s&&l.return&&l.return()}finally{if(a)throw u}}}function b(){a&&o.default.log.apply(o.default,arguments)}t.exports=c},{"../../logger":37,"../../utils":65,"babel-runtime/core-js/get-iterator":69}],61:[function(e,t,r){"use strict";var n,o=e("bluebird"),i=(n=o)&&n.__esModule?n:{default:n};function s(){this.fromToken=null}s.prototype={isNewlyCreated:function(){return i.default.resolve(!0)},getSyncToken:function(){return this.fromToken},setSyncToken:function(e){this.fromToken=e},storeGroup:function(e){},getGroup:function(e){return null},getGroups:function(){return[]},storeRoom:function(e){},getRoom:function(e){return null},getRooms:function(){return[]},removeRoom:function(e){},getRoomSummaries:function(){return[]},storeUser:function(e){},getUser:function(e){return null},getUsers:function(){return[]},scrollback:function(e,t){return[]},storeEvents:function(e,t,r,n){},storeFilter:function(e){},getFilter:function(e,t){return null},getFilterIdByName:function(e){return null},setFilterIdByName:function(e,t){},storeAccountDataEvents:function(e){},getAccountData:function(e){},setSyncData:function(e){return i.default.resolve()},wantsSave:function(){return!1},save:function(){},startup:function(){return i.default.resolve()},getSavedSync:function(){return i.default.resolve(null)},getSavedSyncToken:function(){return i.default.resolve(null)},deleteAllData:function(){return i.default.resolve()},getOutOfBandMembers:function(){return i.default.resolve(null)},setOutOfBandMembers:function(){return i.default.resolve()},clearOutOfBandMembers:function(){return i.default.resolve()},getClientOptions:function(){return i.default.resolve()},storeClientOptions:function(){return i.default.resolve()}},t.exports=s},{bluebird:103}],62:[function(e,t,r){"use strict";var n=c(e("babel-runtime/core-js/object/create")),o=c(e("babel-runtime/core-js/object/keys")),i=c(e("babel-runtime/helpers/classCallCheck")),s=c(e("babel-runtime/helpers/createClass")),a=c(e("./utils")),u=c(e("./logger"));function c(e){return e&&e.__esModule?e:{default:e}}var l=function(){function e(t){(0,i.default)(this,e),(t=t||{}).maxTimelineEntries=t.maxTimelineEntries||50,this.opts=t,this.accountData={},this.inviteRooms={},this.joinRooms={},this.nextBatch=null,this.groups={invite:{},join:{},leave:{}}}return(0,s.default)(e,[{key:"accumulate",value:function(e){this._accumulateRooms(e),this._accumulateGroups(e),this._accumulateAccountData(e),this.nextBatch=e.next_batch}},{key:"_accumulateAccountData",value:function(e){var t=this;e.account_data&&e.account_data.events&&e.account_data.events.forEach((function(e){t.accountData[e.type]=e}))}},{key:"_accumulateRooms",value:function(e){var t=this;e.rooms&&(e.rooms.invite&&(0,o.default)(e.rooms.invite).forEach((function(r){t._accumulateRoom(r,"invite",e.rooms.invite[r])})),e.rooms.join&&(0,o.default)(e.rooms.join).forEach((function(r){t._accumulateRoom(r,"join",e.rooms.join[r])})),e.rooms.leave&&(0,o.default)(e.rooms.leave).forEach((function(r){t._accumulateRoom(r,"leave",e.rooms.leave[r])})))}},{key:"_accumulateRoom",value:function(e,t,r){switch(t){case"invite":this._accumulateInviteState(e,r);break;case"join":this.inviteRooms[e]&&delete this.inviteRooms[e],this._accumulateJoinState(e,r);break;case"leave":this.inviteRooms[e]?delete this.inviteRooms[e]:delete this.joinRooms[e];break;default:u.default.error("Unknown cateogory: ",t)}}},{key:"_accumulateInviteState",value:function(e,t){if(t.invite_state&&t.invite_state.events)if(this.inviteRooms[e]){var r=this.inviteRooms[e];t.invite_state.events.forEach((function(e){for(var t=!1,n=0;n<r.invite_state.events.length;n++){var o=r.invite_state.events[n];o.type===e.type&&o.state_key==e.state_key&&(r.invite_state.events[n]=e,t=!0)}t||r.invite_state.events.push(e)}))}else this.inviteRooms[e]={invite_state:t.invite_state}}},{key:"_accumulateJoinState",value:function(e,t){this.joinRooms[e]||(this.joinRooms[e]={_currentState:(0,n.default)(null),_timeline:[],_accountData:(0,n.default)(null),_unreadNotifications:{},_summary:{},_readReceipts:{}});var r=this.joinRooms[e];if(t.account_data&&t.account_data.events&&t.account_data.events.forEach((function(e){r._accountData[e.type]=e})),t.unread_notifications&&(r._unreadNotifications=t.unread_notifications),t.summary){var i=r._summary,s=t.summary;i["m.heroes"]=s["m.heroes"]||i["m.heroes"],i["m.joined_member_count"]=s["m.joined_member_count"]||i["m.joined_member_count"],i["m.invited_member_count"]=s["m.invited_member_count"]||i["m.invited_member_count"]}if(t.ephemeral&&t.ephemeral.events&&t.ephemeral.events.forEach((function(e){"m.receipt"===e.type&&e.content&&(0,o.default)(e.content).forEach((function(t){e.content[t]["m.read"]&&(0,o.default)(e.content[t]["m.read"]).forEach((function(n){r._readReceipts[n]={data:e.content[t]["m.read"][n],eventId:t}}))}))})),t.timeline&&t.timeline.limited&&(r._timeline=[]),t.state&&t.state.events&&t.state.events.forEach((function(e){d(r._currentState,e)})),t.timeline&&t.timeline.events&&t.timeline.events.forEach((function(e,n){d(r._currentState,e),r._timeline.push({event:e,token:0===n?t.timeline.prev_batch:null})})),r._timeline.length>this.opts.maxTimelineEntries)for(var a=r._timeline.length-this.opts.maxTimelineEntries;a<r._timeline.length;a++)if(r._timeline[a].token){r._timeline=r._timeline.slice(a,r._timeline.length);break}}},{key:"_accumulateGroups",value:function(e){var t=this;e.groups&&(e.groups.invite&&(0,o.default)(e.groups.invite).forEach((function(r){t._accumulateGroup(r,"invite",e.groups.invite[r])})),e.groups.join&&(0,o.default)(e.groups.join).forEach((function(r){t._accumulateGroup(r,"join",e.groups.join[r])})),e.groups.leave&&(0,o.default)(e.groups.leave).forEach((function(r){t._accumulateGroup(r,"leave",e.groups.leave[r])})))}},{key:"_accumulateGroup",value:function(e,t,r){for(var n=["invite","join","leave"],o=0;o<n.length;o++){var i=n[o];delete this.groups[i][e]}this.groups[t][e]=r}},{key:"getJSON",value:function(){var e=this,t={join:{},invite:{},leave:{}};(0,o.default)(this.inviteRooms).forEach((function(r){t.invite[r]=e.inviteRooms[r]})),(0,o.default)(this.joinRooms).forEach((function(r){var i=e.joinRooms[r],s={ephemeral:{events:[]},account_data:{events:[]},state:{events:[]},timeline:{events:[],prev_batch:null},unread_notifications:i._unreadNotifications,summary:i._summary};(0,o.default)(i._accountData).forEach((function(e){s.account_data.events.push(i._accountData[e])}));var u={type:"m.receipt",room_id:r,content:{}};(0,o.default)(i._readReceipts).forEach((function(e){var t=i._readReceipts[e];u.content[t.eventId]||(u.content[t.eventId]={"m.read":{}}),u.content[t.eventId]["m.read"][e]=t.data})),(0,o.default)(u.content).length>0&&s.ephemeral.events.push(u),i._timeline.forEach((function(e){if(!s.timeline.prev_batch){if(!e.token)return;s.timeline.prev_batch=e.token}s.timeline.events.push(e.event)}));for(var c=(0,n.default)(null),l=s.timeline.events.length-1;l>=0;l--){var f=s.timeline.events[l];if(null!==f.state_key&&void 0!==f.state_key){var p=a.default.deepCopy(f);p.unsigned&&(p.unsigned.prev_content&&(p.content=p.unsigned.prev_content),p.unsigned.prev_sender&&(p.sender=p.unsigned.prev_sender)),d(c,p)}}(0,o.default)(i._currentState).forEach((function(e){(0,o.default)(i._currentState[e]).forEach((function(t){var r=i._currentState[e][t];c[e]&&c[e][t]&&(r=c[e][t]),s.state.events.push(r)}))})),t.join[r]=s}));var r=[];return(0,o.default)(this.accountData).forEach((function(t){r.push(e.accountData[t])})),{nextBatch:this.nextBatch,roomsData:t,groupsData:this.groups,accountData:r}}},{key:"getNextBatchToken",value:function(){return this.nextBatch}}]),e}();function d(e,t){null!==t.state_key&&void 0!==t.state_key&&t.type&&(e[t.type]||(e[t.type]=(0,n.default)(null)),e[t.type][t.state_key]=t)}t.exports=l},{"./logger":37,"./utils":65,"babel-runtime/core-js/object/create":77,"babel-runtime/core-js/object/keys":82,"babel-runtime/helpers/classCallCheck":92,"babel-runtime/helpers/createClass":93}],63:[function(e,t,r){(function(r){"use strict";var n=d(e("babel-runtime/core-js/json/stringify")),o=d(e("babel-runtime/core-js/object/keys")),i=d(e("babel-runtime/core-js/get-iterator")),s=d(e("babel-runtime/regenerator")),a=e("bluebird"),u=d(a),c=d(e("./logger")),l=e("./errors");function d(e){return e&&e.__esModule?e:{default:e}}var f,p,h,v,m,y=e("./models/user"),_=e("./models/room"),g=e("./models/group"),b=e("./utils"),k=e("./filter"),w=e("./models/event-timeline"),E=e("./pushprocessor"),S=!0;function x(e,t){return"FILTER_SYNC_"+e+(t?"_"+t:"")}function R(){S&&c.default.log.apply(c.default,arguments)}function T(e,t){this.client=e,(t=t||{}).initialSyncLimit=void 0===t.initialSyncLimit?8:t.initialSyncLimit,t.resolveInvitesToProfiles=t.resolveInvitesToProfiles||!1,t.pollTimeout=t.pollTimeout||3e4,t.pendingEventOrdering=t.pendingEventOrdering||"chronological",t.canResetEntireTimeline||(t.canResetEntireTimeline=function(e){return!1}),this.opts=t,this._peekRoomId=null,this._currentSyncRequest=null,this._syncState=null,this._syncStateData=null,this._catchingUp=!1,this._running=!1,this._keepAliveTimer=null,this._connectionReturnedDefer=null,this._notifEvents=[],this._failedSyncCount=0,this._storeIsInvalid=!1,e.getNotifTimelineSet()&&e.reEmitter.reEmit(e.getNotifTimelineSet(),["Room.timeline","Room.timelineReset"])}function I(e,t){var r=new y(t);return e.reEmitter.reEmit(r,["User.avatarUrl","User.displayName","User.presence","User.currentlyActive","User.lastPresenceTs"]),r}T.prototype.createRoom=function(e){var t=this.client,r=t.timelineSupport,n=t.unstableClientRelationAggregation,o=new _(e,t,t.getUserId(),{lazyLoadMembers:this.opts.lazyLoadMembers,pendingEventOrdering:this.opts.pendingEventOrdering,timelineSupport:r,unstableClientRelationAggregation:n});return t.reEmitter.reEmit(o,["Room.name","Room.timeline","Room.redaction","Room.redactionCancelled","Room.receipt","Room.tags","Room.timelineReset","Room.localEchoUpdated","Room.accountData","Room.myMembership","Room.replaceEvent"]),this._registerStateListeners(o),o},T.prototype.createGroup=function(e){var t=this.client,r=new g(e);return t.reEmitter.reEmit(r,["Group.profile","Group.myMembership"]),t.store.storeGroup(r),r},T.prototype._registerStateListeners=function(e){var t=this.client;t.reEmitter.reEmit(e.currentState,["RoomState.events","RoomState.members","RoomState.newMember"]),e.currentState.on("RoomState.newMember",(function(e,r,n){n.user=t.getUser(n.userId),t.reEmitter.reEmit(n,["RoomMember.name","RoomMember.typing","RoomMember.powerLevel","RoomMember.membership"])}))},T.prototype._deregisterStateListeners=function(e){e.currentState.removeAllListeners("RoomState.events"),e.currentState.removeAllListeners("RoomState.members"),e.currentState.removeAllListeners("RoomState.newMember")},T.prototype.syncLeftRooms=function(){var e=this.client,t=this,r=new k(this.client.credentials.userId);r.setTimelineLimit(1),r.setIncludeLeaveRooms(!0);var n=this.opts.pollTimeout+8e4,o={timeout:0};return e.getOrCreateFilter(x(e.credentials.userId,"LEFT_ROOMS"),r).then((function(t){return o.filter=t,e._http.authedRequest(void 0,"GET","/sync",o,void 0,n)})).then((function(r){var n=[];r.rooms&&r.rooms.leave&&(n=t._mapSyncResponseToRoomArray(r.rooms.leave));var o=[];return n.forEach((function(r){var n=r.room;if(o.push(n),r.isBrandNewRoom){r.timeline=r.timeline||{};var i=t._mapSyncEventsFormat(r.timeline,n),s=t._mapSyncEventsFormat(r.state,n);n.getLiveTimeline().setPaginationToken(r.timeline.prev_batch,w.BACKWARDS),t._processRoomEvents(n,s,i),n.recalculate(),e.store.storeRoom(n),e.emit("Room",n),t._processEventsForNotifs(n,i)}})),o}))},T.prototype.peek=function(e){var t=this,r=this.client;return this._peekRoomId=e,this.client.roomInitialSync(e,20).then((function(n){n.messages=n.messages||{},n.messages.chunk=n.messages.chunk||[],n.state=n.state||[];var o=t.createRoom(e),i=b.map(b.deepCopy(n.state),r.getEventMapper()),s=b.map(n.state,r.getEventMapper()),a=b.map(n.messages.chunk,r.getEventMapper());return n.presence&&b.isArray(n.presence)&&n.presence.map(r.getEventMapper()).forEach((function(e){var t=r.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):((t=I(r,e.getContent().user_id)).setPresenceEvent(e),r.store.storeUser(t)),r.emit("event",e)})),n.messages.start&&(o.oldState.paginationToken=n.messages.start),o.oldState.setStateEvents(i),o.currentState.setStateEvents(s),t._resolveInvites(o),o.recalculate(),o.addEventsToTimeline(a.reverse(),!0,o.getLiveTimeline(),n.messages.start),r.store.storeRoom(o),r.emit("Room",o),t._peekPoll(o),o}))},T.prototype.stopPeeking=function(){this._peekRoomId=null},T.prototype._peekPoll=function(e,t){if(this._peekRoomId===e.roomId){var r=this;this.client._http.authedRequest(void 0,"GET","/events",{room_id:e.roomId,timeout:3e4,from:t},void 0,5e4).done((function(t){if(r._peekRoomId===e.roomId){t.chunk.filter((function(e){return"m.presence"===e.type})).map(r.client.getEventMapper()).forEach((function(e){var t=r.client.store.getUser(e.getContent().user_id);t?t.setPresenceEvent(e):((t=I(r.client,e.getContent().user_id)).setPresenceEvent(e),r.client.store.storeUser(t)),r.client.emit("event",e)}));var n=t.chunk.filter((function(t){return t.room_id===e.roomId})).map(r.client.getEventMapper());e.addLiveEvents(n),r._peekPoll(e,t.end)}else R("Stopped peeking in room %s",e.roomId)}),(function(n){c.default.error("[%s] Peek poll failed: %s",e.roomId,n),setTimeout((function(){r._peekPoll(e,t)}),3e4)}))}else R("Stopped peeking in room %s",e.roomId)},T.prototype.getSyncState=function(){return this._syncState},T.prototype.getSyncStateData=function(){return this._syncStateData},T.prototype.recoverFromSyncStartupError=(f=(0,a.coroutine)(s.default.mark((function e(t,r){var n;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(0,a.resolve)(t);case 2:return n=this._startKeepAlives(),this._updateSyncState("ERROR",{error:r}),e.next=6,(0,a.resolve)(n);case 6:case"end":return e.stop()}}),e,this)}))),function(e,t){return f.apply(this,arguments)}),T.prototype._wasLazyLoadingToggled=(p=(0,a.coroutine)(s.default.mark((function e(t){var r,n;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=!!t,r=!1,e.next=4,(0,a.resolve)(this.client.store.isNewlyCreated());case 4:if(e.sent){e.next=11;break}return e.next=8,(0,a.resolve)(this.client.store.getClientOptions());case 8:return(n=e.sent)&&(r=!!n.lazyLoadMembers),e.abrupt("return",r!==t);case 11:return e.abrupt("return",!1);case 12:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)}),T.prototype._shouldAbortSync=function(e){return"M_UNKNOWN_TOKEN"===e.errcode&&(c.default.warn("Token no longer valid - assuming logout"),this.stop(),!0)},T.prototype.sync=function(){var e,t,n=this,o=(e=(0,a.coroutine)(s.default.mark((function e(){var t;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,R("Getting push rules..."),e.next=4,(0,a.resolve)(d.getPushRules());case 4:t=e.sent,R("Got push rules"),d.pushRules=t,e.next=19;break;case 9:if(e.prev=9,e.t0=e.catch(0),c.default.error("Getting push rules failed",e.t0),!f._shouldAbortSync(e.t0)){e.next=14;break}return e.abrupt("return");case 14:return R("Waiting for saved sync before retrying push rules..."),e.next=17,(0,a.resolve)(f.recoverFromSyncStartupError(h,e.t0));case 17:return o(),e.abrupt("return");case 19:m();case 20:case"end":return e.stop()}}),e,this,[[0,9]])}))),function(){return e.apply(this,arguments)}),i=(t=(0,a.coroutine)(s.default.mark((function e(){var t,r;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return R("Getting filter..."),t=void 0,f.opts.filter?t=f.opts.filter:(t=new k(d.credentials.userId)).setTimelineLimit(f.opts.initialSyncLimit),r=void 0,e.prev=4,e.next=7,(0,a.resolve)(d.getOrCreateFilter(x(d.credentials.userId),t));case 7:r=e.sent,e.next=20;break;case 10:if(e.prev=10,e.t0=e.catch(4),c.default.error("Getting filter failed",e.t0),!f._shouldAbortSync(e.t0)){e.next=15;break}return e.abrupt("return");case 15:return R("Waiting for saved sync before retrying filter..."),e.next=18,(0,a.resolve)(f.recoverFromSyncStartupError(h,e.t0));case 18:return i(),e.abrupt("return");case 20:return d.resetNotifTimelineSet(),null===f._currentSyncRequest&&(R("Sending first sync request..."),f._currentSyncRequest=f._doSyncRequest({filterId:r},v)),R("Waiting for saved sync before starting sync processing..."),e.next=25,(0,a.resolve)(h);case 25:f._sync({filterId:r});case 26:case"end":return e.stop()}}),e,this,[[4,10]])}))),function(){return t.apply(this,arguments)}),d=this.client,f=this;this._running=!0,r.document&&(this._onOnlineBound=this._onOnline.bind(this),r.document.addEventListener("online",this._onOnlineBound,!1));var p,h=u.default.resolve(),v=null,m=(p=(0,a.coroutine)(s.default.mark((function e(){var t,r;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(R("Checking lazy load status..."),n.opts.lazyLoadMembers&&d.isGuest()&&(n.opts.lazyLoadMembers=!1),!n.opts.lazyLoadMembers){e.next=24;break}return R("Checking server lazy load support..."),e.next=6,(0,a.resolve)(d.doesServerSupportLazyLoading());case 6:if(!e.sent){e.next=22;break}return e.prev=8,R("Creating and storing lazy load sync filter..."),e.next=12,(0,a.resolve)(d.createFilter(k.LAZY_LOADING_SYNC_FILTER));case 12:n.opts.filter=e.sent,R("Created and stored lazy load sync filter"),e.next=20;break;case 16:throw e.prev=16,e.t0=e.catch(8),c.default.error("Creating and storing lazy load sync filter failed",e.t0),e.t0;case 20:e.next=24;break;case 22:R("LL: lazy loading requested but not supported by server, so disabling"),n.opts.lazyLoadMembers=!1;case 24:return R("Checking whether lazy loading has changed in store..."),e.next=27,(0,a.resolve)(n._wasLazyLoadingToggled(n.opts.lazyLoadMembers));case 27:if(!e.sent){e.next=35;break}return n._storeIsInvalid=!0,t=l.InvalidStoreError.TOGGLED_LAZY_LOADING,r=new l.InvalidStoreError(t,!!n.opts.lazyLoadMembers),n._updateSyncState("ERROR",{error:r}),c.default.warn("InvalidStoreError: store is not usable: stopping sync."),e.abrupt("return");case 35:return n.opts.lazyLoadMembers&&n.opts.crypto&&n.opts.crypto.enableLazyLoading(),e.prev=36,R("Storing client options..."),e.next=40,(0,a.resolve)(n.client._storeClientOptions());case 40:R("Stored client options"),e.next=47;break;case 43:throw e.prev=43,e.t1=e.catch(36),c.default.error("Storing client options failed",e.t1),e.t1;case 47:i();case 48:case"end":return e.stop()}}),e,n,[[8,16],[36,43]])}))),function(){return p.apply(this,arguments)});d.isGuest()?f._sync({}):(R("Getting saved sync token..."),h=d.store.getSavedSyncToken().then((function(e){return R("Got saved sync token"),v=e,R("Getting saved sync..."),d.store.getSavedSync()})).then((function(e){if(R("Got reply from saved sync, exists? "+!!e),e)return f._syncFromCache(e)})).catch((function(e){c.default.error("Getting saved sync failed",e)})),o())},T.prototype.stop=function(){R("SyncApi.stop"),r.document&&(r.document.removeEventListener("online",this._onOnlineBound,!1),this._onOnlineBound=void 0),this._running=!1,this._currentSyncRequest&&this._currentSyncRequest.abort(),this._keepAliveTimer&&(clearTimeout(this._keepAliveTimer),this._keepAliveTimer=null)},T.prototype.retryImmediately=function(){return!!this._connectionReturnedDefer&&(this._startKeepAlives(0),!0)},T.prototype._syncFromCache=(h=(0,a.coroutine)(s.default.mark((function e(t){var r,n,o;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return R("sync(): not doing HTTP hit, instead returning stored /sync data"),r=t.nextBatch,this.client.store.setSyncToken(r),n={oldSyncToken:null,nextSyncToken:r,catchingUp:!1},o={next_batch:r,rooms:t.roomsData,groups:t.groupsData,account_data:{events:t.accountData}},e.prev=5,e.next=8,(0,a.resolve)(this._processSyncResponse(n,o));case 8:e.next=13;break;case 10:e.prev=10,e.t0=e.catch(5),c.default.error("Error processing cached sync",e.t0.stack||e.t0);case 13:this._storeIsInvalid||this._updateSyncState("PREPARED",n);case 14:case"end":return e.stop()}}),e,this,[[5,10]])}))),function(e){return h.apply(this,arguments)}),T.prototype._sync=(v=(0,a.coroutine)(s.default.mark((function e(t){var r,n,o,i;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(r=this.client,this._running){e.next=6;break}return R("Sync no longer running: exiting."),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),this._updateSyncState("STOPPED"),e.abrupt("return");case 6:return n=r.store.getSyncToken(),o=void 0,e.prev=8,null===this._currentSyncRequest&&(this._currentSyncRequest=this._doSyncRequest(t,n)),e.next=12,(0,a.resolve)(this._currentSyncRequest);case 12:o=e.sent,e.next=19;break;case 15:return e.prev=15,e.t0=e.catch(8),this._onSyncError(e.t0,t),e.abrupt("return");case 19:return e.prev=19,this._currentSyncRequest=null,e.finish(19);case 22:return r.store.setSyncToken(o.next_batch),this._failedSyncCount=0,e.next=26,(0,a.resolve)(r.store.setSyncData(o));case 26:if(i={oldSyncToken:n,nextSyncToken:o.next_batch,catchingUp:this._catchingUp},!this.opts.crypto){e.next=30;break}return e.next=30,(0,a.resolve)(this.opts.crypto.onSyncWillProcess(i));case 30:return e.prev=30,e.next=33,(0,a.resolve)(this._processSyncResponse(i,o));case 33:e.next=39;break;case 35:e.prev=35,e.t1=e.catch(30),c.default.error("Caught /sync error",e.t1.stack||e.t1),this.client.emit("sync.unexpectedError",e.t1);case 39:if(i.catchingUp=this._catchingUp,t.hasSyncedBefore||(this._updateSyncState("PREPARED",i),t.hasSyncedBefore=!0),!this.opts.crypto){e.next=44;break}return e.next=44,(0,a.resolve)(this.opts.crypto.onSyncCompleted(i));case 44:if(this._updateSyncState("SYNCING",i),!r.store.wantsSave()){e.next=50;break}if(!this.opts.crypto){e.next=49;break}return e.next=49,(0,a.resolve)(this.opts.crypto.saveDeviceList(0));case 49:r.store.save();case 50:this._sync(t);case 51:case"end":return e.stop()}}),e,this,[[8,15,19,22],[30,35]])}))),function(e){return v.apply(this,arguments)}),T.prototype._doSyncRequest=function(e,t){var r=this._getSyncParams(e,t);return this.client._http.authedRequest(void 0,"GET","/sync",r,void 0,r.timeout+8e4)},T.prototype._getSyncParams=function(e,t){var r=this.opts.pollTimeout;("SYNCING"!==this.getSyncState()||this._catchingUp)&&(this._catchingUp=!0,r=0);var n=e.filterId;this.client.isGuest()&&!n&&(n=this._getGuestFilter());var o={filter:n,timeout:r};return this.opts.disablePresence&&(o.set_presence="offline"),t?o.since=t:o._cacheBuster=Date.now(),"ERROR"!=this.getSyncState()&&"RECONNECTING"!=this.getSyncState()||(o.timeout=0),o},T.prototype._onSyncError=function(e,t){var r=this;if(!this._running)return R("Sync no longer running: exiting"),this._connectionReturnedDefer&&(this._connectionReturnedDefer.reject(),this._connectionReturnedDefer=null),void this._updateSyncState("STOPPED");c.default.error("/sync error %s",e),c.default.error(e),this._shouldAbortSync(e)||(this._failedSyncCount++,c.default.log("Number of consecutive failed sync requests:",this._failedSyncCount),R("Starting keep-alive"),this._startKeepAlives().then((function(e){e&&"ERROR"===r.getSyncState()&&r._updateSyncState("CATCHUP",{oldSyncToken:null,nextSyncToken:null,catchingUp:!0}),r._sync(t)})),this._currentSyncRequest=null,this._updateSyncState(this._failedSyncCount>=3?"ERROR":"RECONNECTING",{error:e}))},T.prototype._processSyncResponse=(m=(0,a.coroutine)(s.default.mark((function e(t,r){var n,o,i,l,d,f,p,h;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.client,o=this,r.presence&&b.isArray(r.presence.events)&&r.presence.events.map(n.getEventMapper()).forEach((function(e){var t=n.store.getUser(e.getSender());t?t.setPresenceEvent(e):((t=I(n,e.getSender())).setPresenceEvent(e),n.store.storeUser(t)),n.emit("event",e)})),r.account_data&&b.isArray(r.account_data.events)&&(i=r.account_data.events.map(n.getEventMapper()),n.store.storeAccountDataEvents(i),i.forEach((function(e){if("m.push_rules"===e.getType()){var t=e.getContent();n.pushRules=E.rewriteDefaultRules(t)}return n.emit("accountData",e),e}))),r.to_device&&b.isArray(r.to_device.events)&&r.to_device.events.length>0?(l=[],r.to_device.events.map(n.getEventMapper()).map((function(e){if("m.key.verification.cancel"===e.getType()){var t=e.getContent().transaction_id;t&&l.push(t)}return e})).forEach((function(e){var t=e.getContent();if("m.room.message"!=e.getType()||"m.bad.encrypted"!=t.msgtype){if("m.key.verification.start"===e.getType()||"m.key.verification.request"===e.getType()){var r=t.transaction_id;l.includes(r)&&e.flagCancelled()}n.emit("toDeviceEvent",e)}else c.default.log("Ignoring undecryptable to-device event from "+e.getSender())}))):this._catchingUp=!1,r.groups&&(r.groups.invite&&this._processGroupSyncEntry(r.groups.invite,"invite"),r.groups.join&&this._processGroupSyncEntry(r.groups.join,"join"),r.groups.leave&&this._processGroupSyncEntry(r.groups.leave,"leave")),d=[],f=[],p=[],r.rooms&&(r.rooms.invite&&(d=this._mapSyncResponseToRoomArray(r.rooms.invite)),r.rooms.join&&(f=this._mapSyncResponseToRoomArray(r.rooms.join)),r.rooms.leave&&(p=this._mapSyncResponseToRoomArray(r.rooms.leave))),this._notifEvents=[],d.forEach((function(e){var t=e.room,r=o._mapSyncEventsFormat(e.invite_state,t);o._processRoomEvents(t,r),e.isBrandNewRoom&&(t.recalculate(),n.store.storeRoom(t),n.emit("Room",t)),r.forEach((function(e){n.emit("event",e)})),t.updateMyMembership("invite")})),e.next=14,(0,a.resolve)(u.default.mapSeries(f,function(){var e=(0,a.coroutine)(s.default.mark((function e(r){var i,c,l,d,f,p,h,v,m,y,_=(i=(0,a.coroutine)(s.default.mark((function e(t){var r;return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(n.emit("event",t),!t.isState()||"m.room.encryption"!=t.getType()||!o.opts.crypto){e.next=4;break}return e.next=4,(0,a.resolve)(o.opts.crypto.onCryptoEvent(t));case 4:t.isState()&&"im.vector.user_status"===t.getType()&&((r=n.store.getUser(t.getStateKey()))?r._unstable_updateStatusMessage(t):((r=I(n,t.getStateKey()))._unstable_updateStatusMessage(t),n.store.storeUser(r)));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)});return s.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(c=r.room,l=o._mapSyncEventsFormat(r.state,c),d=o._mapSyncEventsFormat(r.timeline,c),f=o._mapSyncEventsFormat(r.ephemeral),p=o._mapSyncEventsFormat(r.account_data),r.unread_notifications&&(c.setUnreadNotificationCount("total",r.unread_notifications.notification_count),(!(h=n.isRoomEncrypted(c.roomId))||h&&c.getUnreadNotificationCount("highlight")<=0)&&c.setUnreadNotificationCount("highlight",r.unread_notifications.highlight_count)),r.timeline=r.timeline||{},!r.isBrandNewRoom){e.next=11;break}c.getLiveTimeline().setPaginationToken(r.timeline.prev_batch,w.BACKWARDS),e.next=25;break;case 11:if(!r.timeline.limited){e.next=25;break}v=!0,m=d.length-1;case 14:if(!(m>=0)){e.next=24;break}if(y=d[m].getId(),!c.getTimelineForEvent(y)){e.next=21;break}return R("Already have event "+y+" in limited sync - not resetting"),v=!1,d.splice(0,m),e.abrupt("break",24);case 21:m--,e.next=14;break;case 24:v&&(o._deregisterStateListeners(c),c.resetLiveTimeline(r.timeline.prev_batch,o.opts.canResetEntireTimeline(c.roomId)?null:t.oldSyncToken),n.resetNotifTimelineSet(),o._registerStateListeners(c));case 25:return o._processRoomEvents(c,l,d),r.summary&&c.setSummary(r.summary),c.addEphemeralEvents(f),c.addAccountData(p),c.recalculate(),r.isBrandNewRoom&&(n.store.storeRoom(c),n.emit("Room",c)),o._processEventsForNotifs(c,d),e.next=34,(0,a.resolve)(u.default.mapSeries(l,_));case 34:return e.next=36,(0,a.resolve)(u.default.mapSeries(d,_));case 36:f.forEach((function(e){n.emit("event",e)})),p.forEach((function(e){n.emit("event",e)})),c.updateMyMembership("join");case 39:case"end":return e.stop()}}),e,this)})));return function(t){return e.apply(this,arguments)}}()));case 14:if(p.forEach((function(e){var t=e.room,r=o._mapSyncEventsFormat(e.state,t),i=o._mapSyncEventsFormat(e.timeline,t),s=o._mapSyncEventsFormat(e.account_data);o._processRoomEvents(t,r,i),t.addAccountData(s),t.recalculate(),e.isBrandNewRoom&&(n.store.storeRoom(t),n.emit("Room",t)),o._processEventsForNotifs(t,i),r.forEach((function(e){n.emit("event",e)})),i.forEach((function(e){n.emit("event",e)})),s.forEach((function(e){n.emit("event",e)})),t.updateMyMembership("leave")})),t.oldSyncToken&&this._notifEvents.length&&(this._notifEvents.sort((function(e,t){return e.getTs()-t.getTs()})),this._notifEvents.forEach((function(e){n.getNotifTimelineSet().addLiveEvent(e)}))),!r.device_lists){e.next=22;break}if(!this.opts.crypto){e.next=22;break}return e.next=20,(0,a.resolve)(this.opts.crypto.handleDeviceListChanges(t,r.device_lists));case 20:e.next=22;break;case 22:this.opts.crypto&&r.device_one_time_keys_count&&(h=r.device_one_time_keys_count.signed_curve25519||0,this.opts.crypto.updateOneTimeKeyCount(h));case 23:case"end":return e.stop()}}),e,this)}))),function(e,t){return m.apply(this,arguments)}),T.prototype._startKeepAlives=function(e){void 0===e&&(e=2e3+Math.floor(5e3*Math.random())),null!==this._keepAliveTimer&&clearTimeout(this._keepAliveTimer);return e>0?this._keepAliveTimer=setTimeout(this._pokeKeepAlive.bind(this),e):this._pokeKeepAlive(),this._connectionReturnedDefer||(this._connectionReturnedDefer=u.default.defer()),this._connectionReturnedDefer.promise},T.prototype._pokeKeepAlive=function(e){void 0===e&&(e=!1);var t=this;function r(){clearTimeout(t._keepAliveTimer),t._connectionReturnedDefer&&(t._connectionReturnedDefer.resolve(e),t._connectionReturnedDefer=null)}this.client._http.request(void 0,"GET","/_matrix/client/versions",void 0,void 0,{prefix:"",localTimeoutMs:15e3}).done((function(){r()}),(function(n){400==n.httpStatus||404==n.httpStatus?t._keepAliveTimer=setTimeout(r,2e3):(e=!0,t._keepAliveTimer=setTimeout(t._pokeKeepAlive.bind(t,e),5e3+Math.floor(5e3*Math.random())),t._updateSyncState("ERROR",{error:n}))}))},T.prototype._processGroupSyncEntry=function(e,t){var r=!0,n=!1,s=void 0;try{for(var a,u=(0,i.default)((0,o.default)(e));!(r=(a=u.next()).done);r=!0){var c=a.value,l=e[c],d=this.client.store.getGroup(c),f=null===d;null===d&&(d=this.createGroup(c)),l.profile&&d.setProfile(l.profile.name,l.profile.avatar_url),l.inviter&&d.setInviter({userId:l.inviter}),d.setMyMembership(t),f&&this.client.emit("Group",d)}}catch(e){n=!0,s=e}finally{try{!r&&u.return&&u.return()}finally{if(n)throw s}}},T.prototype._mapSyncResponseToRoomArray=function(e){var t=this.client,r=this;return b.keys(e).map((function(n){var o=e[n],i=t.store.getRoom(n),s=!1;return i||(i=r.createRoom(n),s=!0),o.room=i,o.isBrandNewRoom=s,o}))},T.prototype._mapSyncEventsFormat=function(e,t){if(!e||!b.isArray(e.events))return[];var r=this.client.getEventMapper();return e.events.map((function(e){return t&&(e.room_id=t.roomId),r(e)}))},T.prototype._resolveInvites=function(e){if(e&&this.opts.resolveInvitesToProfiles){var t=this.client;e.getMembersWithMembership("invite").forEach((function(r){if(!r._requestedProfileInfo){r._requestedProfileInfo=!0;var n=t.getUser(r.userId);(n?u.default.resolve({avatar_url:n.avatarUrl,displayname:n.displayName}):t.getProfileInfo(r.userId)).done((function(t){var n=r.events.member;"invite"===n.getContent().membership&&(n.getContent().avatar_url=t.avatar_url,n.getContent().displayname=t.displayname,r.setMembershipEvent(n,e.currentState))}),(function(e){}))}}))}},T.prototype._processRoomEvents=function(e,t,r){var n=e.getLiveTimeline(),o=0==n.getEvents().length;if(o){var s=!0,a=!1,u=void 0;try{for(var c,l=(0,i.default)(t);!(s=(c=l.next()).done);s=!0){var d=c.value;this.client.getPushActionsForEvent(d)}}catch(e){a=!0,u=e}finally{try{!s&&l.return&&l.return()}finally{if(a)throw u}}n.initialiseState(t)}this._resolveInvites(e),e.recalculate(),o||(e.oldState.setStateEvents(t||[]),e.currentState.setStateEvents(t||[])),e.addLiveEvents(r||[])},T.prototype._processEventsForNotifs=function(e,t){if(this.client.getNotifTimelineSet())for(var r=0;r<t.length;r++){var n=this.client.getPushActionsForEvent(t[r]);n&&n.notify&&n.tweaks&&n.tweaks.highlight&&this._notifEvents.push(t[r])}},T.prototype._getGuestFilter=function(){return this.client._guestRooms?(0,n.default)({room:{timeline:{limit:20}}}):"{}"},T.prototype._updateSyncState=function(e,t){var r=this._syncState;this._syncState=e,this._syncStateData=t,this.client.emit("sync",this._syncState,r,t)},T.prototype._onOnline=function(){R("Browser thinks we are back online"),this._startKeepAlives(0)},t.exports=T}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"./errors":31,"./filter":33,"./logger":37,"./models/event-timeline":41,"./models/group":43,"./models/room":48,"./models/user":50,"./pushprocessor":51,"./utils":65,"babel-runtime/core-js/get-iterator":69,"babel-runtime/core-js/json/stringify":71,"babel-runtime/core-js/object/keys":82,"babel-runtime/regenerator":100,bluebird:103}],64:[function(e,t,r){"use strict";var n=o(e("bluebird"));o(e("./logger"));function o(e){return e&&e.__esModule?e:{default:e}}var i=e("./models/event-timeline"),s=function(){};function a(e,t,r){r=r||{},this._client=e,this._timelineSet=t,this._start=null,this._end=null,this._eventCount=0,this._windowLimit=r.windowLimit||1e3}function u(e,t){this.timeline=e,this.index=t}a.prototype.load=function(e,t){var r=this;t=t||20;var o=function(n){var o=void 0,i=n.getEvents();if(e){for(var s=0;s<i.length;s++)if(i[s].getId()==e){o=s;break}if(void 0===o)throw new Error("getEventTimeline result didn't include requested event")}else o=i.length;var a=Math.min(i.length,o+Math.ceil(t/2)),c=Math.max(0,a-t);r._start=new u(n,c-n.getBaseIndex()),r._end=new u(n,a-n.getBaseIndex()),r._eventCount=a-c};if(e){var i=this._client.getEventTimeline(this._timelineSet,e);return i.isFulfilled()?(o(i.value()),n.default.resolve()):i.then(o)}return o(this._timelineSet.getLiveTimeline()),n.default.resolve()},a.prototype.canPaginate=function(e){var t=void 0;if(e==i.BACKWARDS)t=this._start;else{if(e!=i.FORWARDS)throw new Error("Invalid direction '"+e+"'");t=this._end}if(!t)return s("TimelineWindow: no timeline yet"),!1;if(e==i.BACKWARDS){if(t.index>t.minIndex())return!0}else if(t.index<t.maxIndex())return!0;return Boolean(t.timeline.getNeighbouringTimeline(e)||t.timeline.getPaginationToken(e))},a.prototype.paginate=function(e,t,r,o){void 0===r&&(r=!0),void 0===o&&(o=5);var a=void 0;if(e==i.BACKWARDS)a=this._start;else{if(e!=i.FORWARDS)throw new Error("Invalid direction '"+e+"'");a=this._end}if(!a)return s("TimelineWindow: no timeline yet"),n.default.resolve(!1);if(a.pendingPaginate)return a.pendingPaginate;var u=e==i.BACKWARDS?a.retreat(t):a.advance(t);if(u){this._eventCount+=u,s("TimelineWindow: increased cap by "+u+" (now "+this._eventCount+")");var c=this._eventCount-this._windowLimit;return c>0&&this.unpaginate(c,e!=i.BACKWARDS),n.default.resolve(!0)}if(!r||0===o)return n.default.resolve(!1);if(!a.timeline.getPaginationToken(e))return s("TimelineWindow: no token"),n.default.resolve(!1);s("TimelineWindow: starting request");var l=this,d=this._client.paginateEventTimeline(a.timeline,{backwards:e==i.BACKWARDS,limit:t}).finally((function(){a.pendingPaginate=null})).then((function(r){return s("TimelineWindow: request completed with result "+r),!!r&&l.paginate(e,t,!0,o-1)}));return a.pendingPaginate=d,d},a.prototype.unpaginate=function(e,t){var r=t?this._start:this._end;if(e>this._eventCount||e<0)throw new Error("Attemting to unpaginate "+e+" events, but only have "+this._eventCount+" in the timeline");for(;e>0;){var n=t?r.advance(e):r.retreat(e);if(n<=0)throw new Error("Unable to unpaginate any further, but still have "+this._eventCount+" events");e-=n,this._eventCount-=n,s("TimelineWindow.unpaginate: dropped "+n+" (now "+this._eventCount+")")}},a.prototype.getEvents=function(){if(!this._start)return[];for(var e=[],t=this._start.timeline;;){var r=t.getEvents(),n=0,o=r.length;t===this._start.timeline&&(n=this._start.index+t.getBaseIndex()),t===this._end.timeline&&(o=this._end.index+t.getBaseIndex());for(var s=n;s<o;s++)e.push(r[s]);if(t===this._end.timeline)break;t=t.getNeighbouringTimeline(i.FORWARDS)}return e},u.prototype.minIndex=function(){return-1*this.timeline.getBaseIndex()},u.prototype.maxIndex=function(){return this.timeline.getEvents().length-this.timeline.getBaseIndex()},u.prototype.advance=function(e){if(!e)return 0;var t=void 0;if(e<0){if((t=Math.max(e,this.minIndex()-this.index))<0)return this.index+=t,t}else if((t=Math.min(e,this.maxIndex()-this.index))>0)return this.index+=t,t;var r=this.timeline.getNeighbouringTimeline(e<0?i.BACKWARDS:i.FORWARDS);return r?(this.timeline=r,this.index=e<0?this.maxIndex():this.minIndex(),s("paginate: switched to new neighbour"),this.advance(e)):0},u.prototype.retreat=function(e){return-1*this.advance(-1*e)},t.exports.TimelineWindow=a,t.exports.TimelineIndex=u},{"./logger":37,"./models/event-timeline":41,bluebird:103}],65:[function(e,t,r){"use strict";var n=s(e("babel-runtime/core-js/object/create")),o=s(e("babel-runtime/helpers/typeof")),i=s(e("babel-runtime/core-js/json/stringify"));function s(e){return e&&e.__esModule?e:{default:e}}var a=e("unhomoglyph");t.exports.encodeParams=function(e){var t="";for(var r in e)e.hasOwnProperty(r)&&(t+="&"+encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.substring(1)},t.exports.encodeUri=function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e=e.replace(r,encodeURIComponent(t[r])));return e},t.exports.map=function(e,t){for(var r=new Array(e.length),n=0;n<e.length;n++)r[n]=t(e[n]);return r},t.exports.filter=function(e,t){for(var r=[],n=0;n<e.length;n++)t(e[n],n,e)&&r.push(e[n]);return r},t.exports.keys=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(r);return t},t.exports.values=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(e[r]);return t},t.exports.forEach=function(e,t){for(var r=0;r<e.length;r++)t(e[r],r)},t.exports.findElement=function(e,t,r){var n=void 0;if(r){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return e[n]}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return e[n]},t.exports.removeElement=function(e,t,r){var n=void 0,o=void 0;if(r){for(n=e.length-1;n>=0;n--)if(t(e[n],n,e))return o=e[n],e.splice(n,1),o}else for(n=0;n<e.length;n++)if(t(e[n],n,e))return o=e[n],e.splice(n,1),o;return!1},t.exports.isFunction=function(e){return"[object Function]"==Object.prototype.toString.call(e)},t.exports.isArray=function(e){return Array.isArray?Array.isArray(e):Boolean(e&&e.constructor===Array)},t.exports.checkObjectHasKeys=function(e,t){for(var r=0;r<t.length;r++)if(!e.hasOwnProperty(t[r]))throw new Error("Missing required key: "+t[r])},t.exports.checkObjectHasNoAdditionalKeys=function(e,t){for(var r in e)if(e.hasOwnProperty(r)&&-1===t.indexOf(r))throw new Error("Unknown key: "+r)},t.exports.deepCopy=function(e){return JSON.parse((0,i.default)(e))};var u=t.exports.deepCompare=function(e,t){if(e===t)return!0;if((void 0===e?"undefined":(0,o.default)(e))!==(void 0===t?"undefined":(0,o.default)(t)))return!1;if("number"==typeof e&&isNaN(e)&&isNaN(t))return!0;if(null===e||null===t)return e===t;if(!(e instanceof Object))return!1;if(e.constructor!==t.constructor||e.prototype!==t.prototype)return!1;if(e instanceof RegExp||e instanceof Date)return e.toString()===t.toString();if(e instanceof Array){if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!u(e[r],t[r]))return!1}else{var n=void 0;for(n in t)if(t.hasOwnProperty(n)!==e.hasOwnProperty(n))return!1;for(n in t){if(t.hasOwnProperty(n)!==e.hasOwnProperty(n))return!1;if(!u(e[n],t[n]))return!1}}return!0};t.exports.extend=function(){for(var e=arguments[0]||{},t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)e[n]=r[n]}return e},t.exports.runPolyfills=function(){Array.prototype.filter||(Array.prototype.filter=function(e){if(null==this)throw new TypeError;var t=Object(this),r=t.length>>>0;if("function"!=typeof e)throw new TypeError;for(var n=[],o=arguments.length>=2?arguments[1]:void 0,i=0;i<r;i++)if(i in t){var s=t[i];e.call(o,s,i,t)&&n.push(s)}return n}),Array.prototype.map||(Array.prototype.map=function(e,t){var r=void 0,n=void 0;if(null==this)throw new TypeError(" this is null or not defined");var o=Object(this),i=o.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");arguments.length>1&&(r=t);var s=new Array(i);for(n=0;n<i;){var a,u;n in o&&(a=o[n],u=e.call(r,a,n,o),s[n]=u),n++}return s}),Array.prototype.forEach||(Array.prototype.forEach=function(e,t){var r=void 0,n=void 0;if(null==this)throw new TypeError(" this is null or not defined");var o=Object(this),i=o.length>>>0;if("function"!=typeof e)throw new TypeError(e+" is not a function");for(arguments.length>1&&(r=t),n=0;n<i;){var s;n in o&&(s=o[n],e.call(r,s,n,o)),n++}})},t.exports.inherits=function(e,t){"function"!=typeof n.default&&(Object.create=function(){function e(){}var t=Object.prototype.hasOwnProperty;return function(r){if("object"!=(void 0===r?"undefined":(0,o.default)(r)))throw new TypeError("Object prototype may only be an Object or null");e.prototype=r;var n=new e;if(e.prototype=null,arguments.length>1){var i=Object(arguments[1]);for(var s in i)t.call(i,s)&&(n[s]=i[s])}return n}}()),e.super_=t,e.prototype=(0,n.default)(t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}})},t.exports.isNumber=function(e){return"number"==typeof e&&isFinite(e)},t.exports.removeHiddenChars=function(e){return a(e.normalize("NFD").replace(c,""))};var c=/[\u200B-\u200D\u0300-\u036f\uFEFF\s]/g;function l(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}t.exports.escapeRegExp=l,t.exports.globToRegexp=function(e,t){t="boolean"!=typeof t||t;var r=l(e);return r=(r=r.replace(/\\\*/g,".*")).replace(/\?/g,"."),t&&(r=r.replace(/\\\[(!|)(.*)\\]/g,(function(e,t,r,n,o){return"["+(t?"^":"")+r.replace(/\\-/,"-")+"]"}))),r},t.exports.ensureNoTrailingSlash=function(e){return e&&e.endsWith("/")?e.substr(0,e.length-1):e}},{"babel-runtime/core-js/json/stringify":71,"babel-runtime/core-js/object/create":77,"babel-runtime/helpers/typeof":99,unhomoglyph:275}],66:[function(e,t,r){(function(r){"use strict";var n=a(e("babel-runtime/regenerator")),o=e("bluebird"),i=a(e("babel-runtime/core-js/object/create")),s=a(e("../logger"));function a(e){return e&&e.__esModule?e:{default:e}}var u=e("../utils"),c=e("events").EventEmitter;function l(e){this.roomId=e.roomId,this.client=e.client,this.webRtc=e.webRtc,this.forceTURN=e.forceTURN,this.URL=e.URL,this.turnServers=e.turnServers||[],0===this.turnServers.length&&this.client.isFallbackICEServerAllowed()&&this.turnServers.push({urls:[l.FALLBACK_ICE_SERVER]}),u.forEach(this.turnServers,(function(e){u.checkObjectHasKeys(e,["urls"])})),this.callId="c"+(new Date).getTime()+Math.random(),this.state="fledgling",this.didConnect=!1,this.candidateSendQueue=[],this.candidateSendTries=0,this.mediaPromises=(0,i.default)(null),this.screenSharingStream=null,this._answerContent=null}l.CALL_TIMEOUT_MS=6e4,l.FALLBACK_ICE_SERVER="stun:turn.matrix.org",l.ERR_LOCAL_OFFER_FAILED="local_offer_failed",l.ERR_NO_USER_MEDIA="no_user_media",l.ERR_UNKNOWN_DEVICES="unknown_devices",l.ERR_SEND_INVITE="send_invite",l.ERR_SEND_ANSWER="send_answer",u.inherits(l,c),l.prototype.placeVoiceCall=function(){E("placeVoiceCall"),k(this),x(this,I("voice")),this.type="voice"},l.prototype.placeVideoCall=function(e,t){E("placeVideoCall"),k(this),this.localVideoElement=t,this.remoteVideoElement=e,x(this,I("video")),this.type="video",g(this)},l.prototype.placeScreenSharingCall=function(e,t){E("placeScreenSharingCall"),k(this);var r=T(this);if(r){this.localVideoElement=t,this.remoteVideoElement=e;var n=this;this.webRtc.getUserMedia(r,(function(e){n.screenSharingStream=e,E("Got screen stream, requesting audio stream...");var t=I("voice");x(n,t)}),(function(e){n.emit("error",w(l.ERR_NO_USER_MEDIA,"Failed to get screen-sharing stream: "+e))})),this.type="video",g(this)}},l.prototype.playElement=function(e,t){s.default.log("queuing play on "+t+" and element "+e),this.mediaPromises[t]?this.mediaPromises[t]=this.mediaPromises[t].then((function(){return s.default.log("previous promise completed for "+t),e.play()}),(function(){return s.default.log("previous promise failed for "+t),e.play()})):this.mediaPromises[t]=e.play()},l.prototype.pauseElement=function(e,t){s.default.log("queuing pause on "+t+" and element "+e),this.mediaPromises[t]?this.mediaPromises[t]=this.mediaPromises[t].then((function(){return s.default.log("previous promise completed for "+t),e.pause()}),(function(){return s.default.log("previous promise failed for "+t),e.pause()})):this.mediaPromises[t]=e.pause()},l.prototype.assignElement=function(e,t,r){s.default.log("queuing assign on "+r+" element "+e+" for "+t),this.mediaPromises[r]?this.mediaPromises[r]=this.mediaPromises[r].then((function(){s.default.log("previous promise completed for "+r),e.srcObject=t}),(function(){s.default.log("previous promise failed for "+r),e.srcObject=t})):e.srcObject=t},l.prototype.getLocalVideoElement=function(){return this.localVideoElement},l.prototype.getRemoteVideoElement=function(){return this.remoteVideoElement},l.prototype.getRemoteAudioElement=function(){return this.remoteAudioElement},l.prototype.setLocalVideoElement=function(e){if(this.localVideoElement=e,e&&this.localAVStream&&"video"===this.type){e.autoplay=!0,this.assignElement(e,this.localAVStream,"localVideo"),e.muted=!0;var t=this;setTimeout((function(){var e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)}},l.prototype.setRemoteVideoElement=function(e){this.remoteVideoElement=e,g(this)},l.prototype.setRemoteAudioElement=function(e){this.remoteVideoElement.muted=!0,this.remoteAudioElement=e,this.remoteAudioElement.muted=!1,b(this)},l.prototype._initWithInvite=function(e){this.msg=e.getContent(),this.peerConn=R(this);var t=this;this.peerConn&&this.peerConn.setRemoteDescription(new this.webRtc.RtcSessionDescription(this.msg.offer),C(t,t._onSetRemoteDescriptionSuccess),C(t,t._onSetRemoteDescriptionError)),h(this,"ringing"),this.direction="inbound",this.msg.offer&&this.msg.offer.sdp&&this.msg.offer.sdp.indexOf("m=video")>-1?this.type="video":this.type="voice",e.getAge()&&setTimeout((function(){"ringing"==t.state&&(E("Call invite has expired. Hanging up."),t.hangupParty="remote",h(t,"ended"),_(t),"closed"!=t.peerConn.signalingState&&t.peerConn.close(),t.emit("hangup",t))}),this.msg.lifetime-e.getAge())},l.prototype._initWithHangup=function(e){this.msg=e.getContent(),h(this,"ended")},l.prototype.answer=function(){E("Answering call %s of type %s",this.callId,this.type);this._answerContent?this._sendAnswer():this.localAVStream||this.waitForLocalAVStream?this.localAVStream?this._maybeGotUserMediaForAnswer(this.localAVStream):this.waitForLocalAVStream&&h(this,"wait_local_media"):(this.webRtc.getUserMedia(I(this.type),C(this,this._maybeGotUserMediaForAnswer),C(this,this._maybeGotUserMediaForAnswer)),h(this,"wait_local_media"))},l.prototype._replacedBy=function(e){E(this.callId+" being replaced by "+e.callId),"wait_local_media"==this.state?(E("Telling new call to wait for local media"),e.waitForLocalAVStream=!0):"create_offer"==this.state?(E("Handing local stream to new call"),e._maybeGotUserMediaForAnswer(this.localAVStream),delete this.localAVStream):"invite_sent"==this.state&&(E("Handing local stream to new call"),e._maybeGotUserMediaForAnswer(this.localAVStream),delete this.localAVStream),e.localVideoElement=this.localVideoElement,e.remoteVideoElement=this.remoteVideoElement,e.remoteAudioElement=this.remoteAudioElement,this.successor=e,this.emit("replaced",e),this.hangup(!0)},l.prototype.hangup=function(e,t){if("ended"!=this.state){E("Ending call "+this.callId),y(this,"local",e,!t);var r={version:0,call_id:this.callId,reason:e};v(this,"m.call.hangup",r)}},l.prototype.setLocalVideoMuted=function(e){this.localAVStream&&f(this.localAVStream.getVideoTracks(),!e)},l.prototype.isLocalVideoMuted=function(){return!!this.localAVStream&&!p(this.localAVStream.getVideoTracks())},l.prototype.setMicrophoneMuted=function(e){this.localAVStream&&f(this.localAVStream.getAudioTracks(),!e)},l.prototype.isMicrophoneMuted=function(){return!!this.localAVStream&&!p(this.localAVStream.getAudioTracks())},l.prototype._maybeGotUserMediaForInvite=function(e){if(this.successor)this.successor._maybeGotUserMediaForAnswer(e);else if("ended"!=this.state){E("_maybeGotUserMediaForInvite -> "+this.type);var t=this,r=e,n={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:"video"===t.type}};if(e instanceof MediaStream){var o=this.getLocalVideoElement();o&&"video"==this.type&&(o.autoplay=!0,this.screenSharingStream?(E("Setting screen sharing stream to the local video element"),this.assignElement(o,this.screenSharingStream,"localVideo")):this.assignElement(o,e,"localVideo"),o.muted=!0,setTimeout((function(){var e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)),this.screenSharingStream&&(this.screenSharingStream.addTrack(e.getAudioTracks()[0]),e=this.screenSharingStream),this.localAVStream=e,f(e.getAudioTracks(),!0),this.peerConn=R(this),this.peerConn.addStream(e)}else{if("PermissionDeniedError"!==r.name)return E("Failed to getUserMedia: "+r.name),void this._getUserMediaFailed(r);E("User denied access to camera/microphone. Or possibly you are using an insecure domain. Receiving only."),this.peerConn=R(this)}this.peerConn.createOffer(C(t,t._gotLocalOffer),C(t,t._getLocalOfferFailed),n),h(t,"create_offer")}},l.prototype._sendAnswer=function(e){var t=this;v(this,"m.call.answer",this._answerContent).then((function(){h(t,"connecting"),S(t)})).catch((function(e){h(t,"ringing"),t.client.cancelPendingEvent(e.event);var r=l.ERR_SEND_ANSWER,n="Failed to send answer";throw"UnknownDeviceError"==e.name&&(r=l.ERR_UNKNOWN_DEVICES,n="Unknown devices present in the room"),t.emit("error",w(r,n)),e}))},l.prototype._maybeGotUserMediaForAnswer=function(e){var t=this;if("ended"!=t.state){var r=e;if(e instanceof MediaStream){var n=t.getLocalVideoElement();n&&"video"==t.type&&(n.autoplay=!0,this.assignElement(n,e,"localVideo"),n.muted=!0,setTimeout((function(){var e=t.getLocalVideoElement();e.play&&t.playElement(e,"localVideo")}),0)),t.localAVStream=e,f(e.getAudioTracks(),!0),t.peerConn.addStream(e)}else{if("PermissionDeniedError"!==r.name)return E("Failed to getUserMedia: "+r.name),void this._getUserMediaFailed(r);E("User denied access to camera/microphone. Or possibly you are using an insecure domain. Receiving only.")}var o={mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:"video"===t.type}};t.peerConn.createAnswer((function(e){E("Created answer: ",e),t.peerConn.setLocalDescription(e,(function(){t._answerContent={version:0,call_id:t.callId,answer:{sdp:t.peerConn.localDescription.sdp,type:t.peerConn.localDescription.type}},t._sendAnswer()}),(function(){E("Error setting local description!")}),o)}),(function(e){E("Failed to create answer: "+e)})),h(t,"create_answer")}},l.prototype._gotLocalIceCandidate=function(e){if(e.candidate){if(E("Got local ICE "+e.candidate.sdpMid+" candidate: "+e.candidate.candidate),"ended"==this.state)return;var t={candidate:e.candidate.candidate,sdpMid:e.candidate.sdpMid,sdpMLineIndex:e.candidate.sdpMLineIndex};m(this,t)}},l.prototype._gotRemoteIceCandidate=function(e){"ended"!=this.state&&(E("Got remote ICE "+e.sdpMid+" candidate: "+e.candidate),this.peerConn.addIceCandidate(new this.webRtc.RtcIceCandidate(e),(function(){}),(function(e){})))},l.prototype._receivedAnswer=function(e){if("ended"!=this.state){this.peerConn.setRemoteDescription(new this.webRtc.RtcSessionDescription(e.answer),C(this,this._onSetRemoteDescriptionSuccess),C(this,this._onSetRemoteDescriptionError)),h(this,"connecting")}},l.prototype._gotLocalOffer=function(e){var t=this;E("Created offer: ",e),"ended"!=t.state?t.peerConn.setLocalDescription(e,(function(){var e={version:0,call_id:t.callId,offer:{sdp:t.peerConn.localDescription.sdp,type:t.peerConn.localDescription.type},lifetime:l.CALL_TIMEOUT_MS};v(t,"m.call.invite",e).then((function(){h(t,"invite_sent"),setTimeout((function(){"invite_sent"==t.state&&t.hangup("invite_timeout")}),l.CALL_TIMEOUT_MS)})).catch((function(e){var r=l.ERR_SEND_INVITE,n="Failed to send invite";throw"UnknownDeviceError"==e.name&&(r=l.ERR_UNKNOWN_DEVICES,n="Unknown devices present in the room"),t.client.cancelPendingEvent(e.event),y(t,"local",r,!1),t.emit("error",w(r,n)),e}))}),(function(){E("Error setting local description!")})):E("Ignoring newly created offer on call ID "+t.callId+" because the call has ended")},l.prototype._getLocalOfferFailed=function(e){this.emit("error",w(l.ERR_LOCAL_OFFER_FAILED,"Failed to start audio for call!"))},l.prototype._getUserMediaFailed=function(e){y(this,"local","user_media_failed",!1),this.emit("error",w(l.ERR_NO_USER_MEDIA,"Couldn't start capturing media! Is your microphone set up and does this app have permission?"))},l.prototype._onIceConnectionStateChanged=function(){"ended"!=this.state&&(E("Ice connection state changed to: "+this.peerConn.iceConnectionState),"completed"==this.peerConn.iceConnectionState||"connected"==this.peerConn.iceConnectionState?(h(this,"connected"),this.didConnect=!0):"failed"==this.peerConn.iceConnectionState&&this.hangup("ice_failed"))},l.prototype._onSignallingStateChanged=function(){E("call "+this.callId+": Signalling state changed to: "+this.peerConn.signalingState)},l.prototype._onSetRemoteDescriptionSuccess=function(){E("Set remote description")},l.prototype._onSetRemoteDescriptionError=function(e){E("Failed to set remote description"+e)},l.prototype._onAddStream=function(e){E("Stream id "+e.stream.id+" added");var t=e.stream;t.getVideoTracks().length>0?(this.type="video",this.remoteAVStream=t,this.remoteAStream=t):(this.type="voice",this.remoteAStream=t);var r=this;O(t,(function(e){E("Track id "+e.id+" added"),e.onstarted=C(r,r._onRemoteStreamTrackStarted)})),void 0!==e.stream.oninactive?e.stream.oninactive=C(r,r._onRemoteStreamEnded):e.stream.onended=C(r,r._onRemoteStreamEnded),e.stream.onstarted=C(r,r._onRemoteStreamStarted),"video"===this.type?(g(this),b(this)):b(this)},l.prototype._onRemoteStreamStarted=function(e){h(this,"connected")},l.prototype._onRemoteStreamEnded=function(e){E("Remote stream ended"),this.hangupParty="remote",h(this,"ended"),_(this),"closed"!=this.peerConn.signalingState&&this.peerConn.close(),this.emit("hangup",this)},l.prototype._onRemoteStreamTrackStarted=function(e){h(this,"connected")},l.prototype._onHangupReceived=function(e){E("Hangup received"),y(this,"remote",e.reason,!0)},l.prototype._onAnsweredElsewhere=function(e){E("Answered elsewhere"),y(this,"remote","answered_elsewhere",!0)};var d,f=function(e,t){for(var r=0;r<e.length;r++)e[r].enabled=t},p=function(e){for(var t=0;t<e.length;t++)if(e[t].enabled)return!0;return!1},h=function(e,t){var r=e.state;e.state=t,e.emit("state",t,r)},v=function(e,t,r){return e.client.sendEvent(e.roomId,t,r)},m=function(e,t){e.candidateSendQueue.push(t),"ringing"!=e.state&&0===e.candidateSendTries&&setTimeout((function(){S(e)}),100)},y=function(e,t,r,n){e.getRemoteVideoElement()&&(e.getRemoteVideoElement().pause&&e.pauseElement(e.getRemoteVideoElement(),"remoteVideo"),e.assignElement(e.getRemoteVideoElement(),null,"remoteVideo")),e.getRemoteAudioElement()&&(e.getRemoteAudioElement().pause&&e.pauseElement(e.getRemoteAudioElement(),"remoteAudio"),e.assignElement(e.getRemoteAudioElement(),null,"remoteAudio")),e.getLocalVideoElement()&&(e.getLocalVideoElement().pause&&e.pauseElement(e.getLocalVideoElement(),"localVideo"),e.assignElement(e.getLocalVideoElement(),null,"localVideo")),e.hangupParty=t,e.hangupReason=r,h(e,"ended"),_(e),e.peerConn&&"closed"!==e.peerConn.signalingState&&e.peerConn.close(),n&&e.emit("hangup",e)},_=function(e){E("stopAllMedia (stream=%s)",e.localAVStream),e.localAVStream&&(O(e.localAVStream,(function(e){e.stop&&e.stop()})),e.localAVStream.stop&&e.localAVStream.stop()),e.screenSharingStream&&(O(e.screenSharingStream,(function(e){e.stop&&e.stop()})),e.screenSharingStream.stop&&e.screenSharingStream.stop()),e.remoteAVStream&&O(e.remoteAVStream,(function(e){e.stop&&e.stop()})),e.remoteAStream&&O(e.remoteAStream,(function(e){e.stop&&e.stop()}))},g=function(e){if(e.getRemoteVideoElement()&&e.remoteAVStream){var t=e.getRemoteVideoElement();t.autoplay=!0,e.assignElement(t,e.remoteAVStream,"remoteVideo"),setTimeout((function(){var t=e.getRemoteVideoElement();t.play&&e.playElement(t,"remoteVideo"),e.webRtc.isOpenWebRTC()&&h(e,"connected")}),0)}},b=(d=(0,o.coroutine)(n.default.mark((function e(t){var r;return n.default.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!t.getRemoteAudioElement()||!t.remoteAStream){e.next=8;break}if(r=t.getRemoteAudioElement(),!j){e.next=5;break}return e.next=5,(0,o.resolve)(r.setSinkId(j));case 5:r.autoplay=!0,t.assignElement(r,t.remoteAStream,"remoteAudio"),setTimeout((function(){var e=t.getRemoteAudioElement();e.play&&t.playElement(e,"remoteAudio"),t.webRtc.isOpenWebRTC()&&h(t,"connected")}),0);case 8:case"end":return e.stop()}}),e,this)}))),function(e){return d.apply(this,arguments)}),k=function(e){if(0===e.listeners("error").length)throw new Error("You MUST attach an error listener using call.on('error', function() {})")},w=function(e,t){var r=new Error(t);return r.code=e,r},E=function(){s.default.log.apply(s.default,arguments)},S=function e(t){if(0!==t.candidateSendQueue.length){var r=t.candidateSendQueue;t.candidateSendQueue=[],++t.candidateSendTries;var n={version:0,call_id:t.callId,candidates:r};E("Attempting to send "+r.length+" candidates"),v(t,"m.call.candidates",n).then((function(){t.candidateSendTries=0,e(t)}),(function(n){for(var o=0;o<r.length;o++)t.candidateSendQueue.push(r[o]);if(t.candidateSendTries>5)return E("Failed to send candidates on attempt %s. Giving up for now.",t.candidateSendTries),void(t.candidateSendTries=0);var i=500*Math.pow(2,t.candidateSendTries);++t.candidateSendTries,E("Failed to send candidates. Retrying in "+i+"ms"),setTimeout((function(){e(t)}),i)}))}},x=function(e,t){e.client.callList[e.callId]=e,e.webRtc.getUserMedia(t,C(e,e._maybeGotUserMediaForInvite),C(e,e._maybeGotUserMediaForInvite)),h(e,"wait_local_media"),e.direction="outbound",e.config=t},R=function(e){var t=new e.webRtc.RtcPeerConnection({iceTransportPolicy:e.forceTURN?"relay":void 0,iceServers:e.turnServers});return t.oniceconnectionstatechange=C(e,e._onIceConnectionStateChanged),t.onsignalingstatechange=C(e,e._onSignallingStateChanged),t.onicecandidate=C(e,e._gotLocalIceCandidate),t.onaddstream=C(e,e._onAddStream),t},T=function(e){var t=r.screen;if(t)return{video:{mediaSource:"screen",mandatory:{chromeMediaSource:"screen",chromeMediaSourceId:""+Date.now(),maxWidth:t.width,maxHeight:t.height,minFrameRate:1,maxFrameRate:10}}};e.emit("error",w(l.ERR_NO_USER_MEDIA,"Couldn't determine screen sharing constaints."))},I=function(e){var t=!!r.window.navigator.webkitGetUserMedia;switch(e){case"voice":return{audio:{deviceId:A?{ideal:A}:void 0},video:!1};case"video":return{audio:{deviceId:A?{ideal:A}:void 0},video:{deviceId:D?{ideal:D}:void 0,width:t?{exact:640}:{ideal:640},height:t?{exact:360}:{ideal:360}}}}},C=function(e,t){return function(){return t.apply(e,arguments)}},O=function(e,t){!function(e,t){for(var r=e.getVideoTracks(),n=0;n<r.length;n++)t(r[n])}(e,t),function(e,t){for(var r=e.getAudioTracks(),n=0;n<r.length;n++)t(r[n])}(e,t)};t.exports.MatrixCall=l;var j=void 0,A=void 0,D=void 0;t.exports.setAudioOutput=function(e){j=e},t.exports.setAudioInput=function(e){A=e},t.exports.setVideoInput=function(e){D=e},t.exports.createNewMatrixCall=function(e,t,n){var o=r.window,i=r.document;if(!o||!i)return null;var a={isOpenWebRTC:function(){var e=i.getElementById("script");if(!e||!e.length)return!1;for(var t=0;t<e.length;t++)if(e[t].src.indexOf("owr.js")>-1)return!0;return!1}},u=o.navigator.getUserMedia||o.navigator.webkitGetUserMedia||o.navigator.mozGetUserMedia;u&&(a.getUserMedia=function(){return u.apply(o.navigator,arguments)});try{a.RtcPeerConnection=o.RTCPeerConnection||o.webkitRTCPeerConnection||o.mozRTCPeerConnection,a.RtcSessionDescription=o.RTCSessionDescription||o.webkitRTCSessionDescription||o.mozRTCSessionDescription,a.RtcIceCandidate=o.RTCIceCandidate||o.webkitRTCIceCandidate||o.mozRTCIceCandidate,a.vendor=null,o.mozRTCPeerConnection?a.vendor="mozilla":o.webkitRTCPeerConnection?a.vendor="webkit":o.RTCPeerConnection&&(a.vendor="generic")}catch(e){return s.default.error("Failed to set up WebRTC object: possible browser interference?"),s.default.error(e),null}if(!(a.RtcIceCandidate&&a.RtcSessionDescription&&a.RtcPeerConnection&&a.getUserMedia))return null;var c=!!n&&n.forceTURN;return new l({webRtc:a,client:e,URL:o.URL,roomId:t,turnServers:e.getTurnServers(),forceTURN:e._forceTURN||c})}}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{"../logger":37,"../utils":65,"babel-runtime/core-js/object/create":77,"babel-runtime/regenerator":100,bluebird:103,events:257}],67:[function(e,t,r){"use strict";for(var n=/[\\\"\x00-\x1F]/g,o={},i=0;i<32;++i)o[String.fromCharCode(i)]="\\U"+("0000"+i.toString(16)).slice(-4).toUpperCase();function s(e){return n.lastIndex=0,e.replace(n,(function(e){return o[e]}))}function a(e){switch(typeof e){case"string":return'"'+s(e)+'"';case"number":return isFinite(e)?e:"null";case"boolean":return e;case"object":return null===e?"null":Array.isArray(e)?function(e){for(var t="[",r="",n=0;n<e.length;++n)r+=t,t=",",r+=a(e[n]);return","!=t?"[]":r+"]"}(e):function(e){var t="{",r="",n=Object.keys(e);n.sort();for(var o=0;o<n.length;++o){var i=n[o];r+=t+'"'+s(i)+'":',t=",",r+=a(e[i])}return","!=t?"{}":r+"}"}(e);default:throw new Error("Cannot stringify: "+typeof e)}}o["\b"]="\\b",o["\t"]="\\t",o["\n"]="\\n",o["\f"]="\\f",o["\r"]="\\r",o['"']='\\"',o["\\"]="\\\\",t.exports={stringify:a}},{}],68:[function(e,t,r){t.exports={default:e("core-js/library/fn/array/from"),__esModule:!0}},{"core-js/library/fn/array/from":108}],69:[function(e,t,r){t.exports={default:e("core-js/library/fn/get-iterator"),__esModule:!0}},{"core-js/library/fn/get-iterator":109}],70:[function(e,t,r){t.exports={default:e("core-js/library/fn/is-iterable"),__esModule:!0}},{"core-js/library/fn/is-iterable":110}],71:[function(e,t,r){t.exports={default:e("core-js/library/fn/json/stringify"),__esModule:!0}},{"core-js/library/fn/json/stringify":111}],72:[function(e,t,r){t.exports={default:e("core-js/library/fn/map"),__esModule:!0}},{"core-js/library/fn/map":112}],73:[function(e,t,r){t.exports={default:e("core-js/library/fn/number/is-finite"),__esModule:!0}},{"core-js/library/fn/number/is-finite":113}],74:[function(e,t,r){t.exports={default:e("core-js/library/fn/number/is-integer"),__esModule:!0}},{"core-js/library/fn/number/is-integer":114}],75:[function(e,t,r){t.exports={default:e("core-js/library/fn/number/min-safe-integer"),__esModule:!0}},{"core-js/library/fn/number/min-safe-integer":115}],76:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/assign"),__esModule:!0}},{"core-js/library/fn/object/assign":116}],77:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/create"),__esModule:!0}},{"core-js/library/fn/object/create":117}],78:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/define-property"),__esModule:!0}},{"core-js/library/fn/object/define-property":118}],79:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/entries"),__esModule:!0}},{"core-js/library/fn/object/entries":119}],80:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/freeze"),__esModule:!0}},{"core-js/library/fn/object/freeze":120}],81:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/get-prototype-of"),__esModule:!0}},{"core-js/library/fn/object/get-prototype-of":121}],82:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/keys"),__esModule:!0}},{"core-js/library/fn/object/keys":122}],83:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/set-prototype-of"),__esModule:!0}},{"core-js/library/fn/object/set-prototype-of":123}],84:[function(e,t,r){t.exports={default:e("core-js/library/fn/object/values"),__esModule:!0}},{"core-js/library/fn/object/values":124}],85:[function(e,t,r){t.exports={default:e("core-js/library/fn/promise"),__esModule:!0}},{"core-js/library/fn/promise":125}],86:[function(e,t,r){t.exports={default:e("core-js/library/fn/reflect/construct"),__esModule:!0}},{"core-js/library/fn/reflect/construct":126}],87:[function(e,t,r){t.exports={default:e("core-js/library/fn/reflect/get-prototype-of"),__esModule:!0}},{"core-js/library/fn/reflect/get-prototype-of":127}],88:[function(e,t,r){t.exports={default:e("core-js/library/fn/reflect/set-prototype-of"),__esModule:!0}},{"core-js/library/fn/reflect/set-prototype-of":128}],89:[function(e,t,r){t.exports={default:e("core-js/library/fn/set"),__esModule:!0}},{"core-js/library/fn/set":129}],90:[function(e,t,r){t.exports={default:e("core-js/library/fn/symbol"),__esModule:!0}},{"core-js/library/fn/symbol":130}],91:[function(e,t,r){t.exports={default:e("core-js/library/fn/symbol/iterator"),__esModule:!0}},{"core-js/library/fn/symbol/iterator":131}],92:[function(e,t,r){"use strict";r.__esModule=!0,r.default=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},{}],93:[function(e,t,r){"use strict";r.__esModule=!0;var n,o=e("../core-js/object/define-property"),i=(n=o)&&n.__esModule?n:{default:n};r.default=function(){function e(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),(0,i.default)(e,n.key,n)}}return function(t,r,n){return r&&e(t.prototype,r),n&&e(t,n),t}}()},{"../core-js/object/define-property":78}],94:[function(e,t,r){"use strict";r.__esModule=!0;var n,o=e("../core-js/object/define-property"),i=(n=o)&&n.__esModule?n:{default:n};r.default=function(e,t,r){return t in e?(0,i.default)(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}},{"../core-js/object/define-property":78}],95:[function(e,t,r){"use strict";r.__esModule=!0;var n=s(e("../core-js/object/set-prototype-of")),o=s(e("../core-js/object/create")),i=s(e("../helpers/typeof"));function s(e){return e&&e.__esModule?e:{default:e}}r.default=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+(void 0===t?"undefined":(0,i.default)(t)));e.prototype=(0,o.default)(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(n.default?(0,n.default)(e,t):e.__proto__=t)}},{"../core-js/object/create":77,"../core-js/object/set-prototype-of":83,"../helpers/typeof":99}],96:[function(e,t,r){"use strict";r.__esModule=!0;var n,o=e("../helpers/typeof"),i=(n=o)&&n.__esModule?n:{default:n};r.default=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!==(void 0===t?"undefined":(0,i.default)(t))&&"function"!=typeof t?e:t}},{"../helpers/typeof":99}],97:[function(e,t,r){"use strict";r.__esModule=!0;var n=i(e("../core-js/is-iterable")),o=i(e("../core-js/get-iterator"));function i(e){return e&&e.__esModule?e:{default:e}}r.default=function(e,t){if(Array.isArray(e))return e;if((0,n.default)(Object(e)))return function(e,t){var r=[],n=!0,i=!1,s=void 0;try{for(var a,u=(0,o.default)(e);!(n=(a=u.next()).done)&&(r.push(a.value),!t||r.length!==t);n=!0);}catch(e){i=!0,s=e}finally{try{!n&&u.return&&u.return()}finally{if(i)throw s}}return r}(e,t);throw new TypeError("Invalid attempt to destructure non-iterable instance")}},{"../core-js/get-iterator":69,"../core-js/is-iterable":70}],98:[function(e,t,r){"use strict";r.__esModule=!0;var n,o=e("../core-js/array/from"),i=(n=o)&&n.__esModule?n:{default:n};r.default=function(e){if(Array.isArray(e)){for(var t=0,r=Array(e.length);t<e.length;t++)r[t]=e[t];return r}return(0,i.default)(e)}},{"../core-js/array/from":68}],99:[function(e,t,r){"use strict";r.__esModule=!0;var n=s(e("../core-js/symbol/iterator")),o=s(e("../core-js/symbol")),i="function"==typeof o.default&&"symbol"==typeof n.default?function(e){return typeof e}:function(e){return e&&"function"==typeof o.default&&e.constructor===o.default&&e!==o.default.prototype?"symbol":typeof e};function s(e){return e&&e.__esModule?e:{default:e}}r.default="function"==typeof o.default&&"symbol"===i(n.default)?function(e){return void 0===e?"undefined":i(e)}:function(e){return e&&"function"==typeof o.default&&e.constructor===o.default&&e!==o.default.prototype?"symbol":void 0===e?"undefined":i(e)}},{"../core-js/symbol":90,"../core-js/symbol/iterator":91}],100:[function(e,t,r){t.exports=e("regenerator-runtime")},{"regenerator-runtime":270}],101:[function(e,t,r){"use strict";var n=e("safe-buffer").Buffer;t.exports=function(e){if(e.length>=255)throw new TypeError("Alphabet too long");var t=new Uint8Array(256);t.fill(255);for(var r=0;r<e.length;r++){var o=e.charAt(r),i=o.charCodeAt(0);if(255!==t[i])throw new TypeError(o+" is ambiguous");t[i]=r}var s=e.length,a=e.charAt(0),u=Math.log(s)/Math.log(256),c=Math.log(256)/Math.log(s);function l(e){if("string"!=typeof e)throw new TypeError("Expected String");if(0===e.length)return n.alloc(0);var r=0;if(" "!==e[r]){for(var o=0,i=0;e[r]===a;)o++,r++;for(var c=(e.length-r)*u+1>>>0,l=new Uint8Array(c);e[r];){var d=t[e.charCodeAt(r)];if(255===d)return;for(var f=0,p=c-1;(0!==d||f<i)&&-1!==p;p--,f++)d+=s*l[p]>>>0,l[p]=d%256>>>0,d=d/256>>>0;if(0!==d)throw new Error("Non-zero carry");i=f,r++}if(" "!==e[r]){for(var h=c-i;h!==c&&0===l[h];)h++;var v=n.allocUnsafe(o+(c-h));v.fill(0,0,o);for(var m=o;h!==c;)v[m++]=l[h++];return v}}}return{encode:function(t){if(!n.isBuffer(t))throw new TypeError("Expected Buffer");if(0===t.length)return"";for(var r=0,o=0,i=0,u=t.length;i!==u&&0===t[i];)i++,r++;for(var l=(u-i)*c+1>>>0,d=new Uint8Array(l);i!==u;){for(var f=t[i],p=0,h=l-1;(0!==f||p<o)&&-1!==h;h--,p++)f+=256*d[h]>>>0,d[h]=f%s>>>0,f=f/s>>>0;if(0!==f)throw new Error("Non-zero carry");o=p,i++}for(var v=l-o;v!==l&&0===d[v];)v++;for(var m=a.repeat(r);v<l;++v)m+=e.charAt(d[v]);return m},decodeUnsafe:l,decode:function(e){var t=l(e);if(t)return t;throw new Error("Non-base"+s+" character")}}}},{"safe-buffer":272}],102:[function(e,t,r){"use strict";r.byteLength=function(e){var t=c(e),r=t[0],n=t[1];return 3*(r+n)/4-n},r.toByteArray=function(e){var t,r,n=c(e),s=n[0],a=n[1],u=new i(function(e,t,r){return 3*(t+r)/4-r}(0,s,a)),l=0,d=a>0?s-4:s;for(r=0;r<d;r+=4)t=o[e.charCodeAt(r)]<<18|o[e.charCodeAt(r+1)]<<12|o[e.charCodeAt(r+2)]<<6|o[e.charCodeAt(r+3)],u[l++]=t>>16&255,u[l++]=t>>8&255,u[l++]=255&t;2===a&&(t=o[e.charCodeAt(r)]<<2|o[e.charCodeAt(r+1)]>>4,u[l++]=255&t);1===a&&(t=o[e.charCodeAt(r)]<<10|o[e.charCodeAt(r+1)]<<4|o[e.charCodeAt(r+2)]>>2,u[l++]=t>>8&255,u[l++]=255&t);return u},r.fromByteArray=function(e){for(var t,r=e.length,o=r%3,i=[],s=0,a=r-o;s<a;s+=16383)i.push(l(e,s,s+16383>a?a:s+16383));1===o?(t=e[r-1],i.push(n[t>>2]+n[t<<4&63]+"==")):2===o&&(t=(e[r-2]<<8)+e[r-1],i.push(n[t>>10]+n[t>>4&63]+n[t<<2&63]+"="));return i.join("")};for(var n=[],o=[],i="undefined"!=typeof Uint8Array?Uint8Array:Array,s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",a=0,u=s.length;a<u;++a)n[a]=s[a],o[s.charCodeAt(a)]=a;function c(e){var t=e.length;if(t%4>0)throw new Error("Invalid string. Length must be a multiple of 4");var r=e.indexOf("=");return-1===r&&(r=t),[r,r===t?0:4-r%4]}function l(e,t,r){for(var o,i,s=[],a=t;a<r;a+=3)o=(e[a]<<16&16711680)+(e[a+1]<<8&65280)+(255&e[a+2]),s.push(n[(i=o)>>18&63]+n[i>>12&63]+n[i>>6&63]+n[63&i]);return s.join("")}o["-".charCodeAt(0)]=62,o["_".charCodeAt(0)]=63},{}],103:[function(e,t,r){(function(e,n,o){!function(e){if("object"==typeof r&&void 0!==t)t.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var o;"undefined"!=typeof window?o=window:void 0!==n?o=n:"undefined"!=typeof self&&(o=self),o.Promise=e()}}((function(){var t,r,i;return function e(t,r,n){function o(s,a){if(!r[s]){if(!t[s]){var u="function"==typeof _dereq_&&_dereq_;if(!a&&u)return u(s,!0);if(i)return i(s,!0);var c=new Error("Cannot find module '"+s+"'");throw c.code="MODULE_NOT_FOUND",c}var l=r[s]={exports:{}};t[s][0].call(l.exports,(function(e){var r=t[s][1][e];return o(r||e)}),l,l.exports,e,t,r,n)}return r[s].exports}for(var i="function"==typeof _dereq_&&_dereq_,s=0;s<n.length;s++)o(n[s]);return o}({1:[function(e,t,r){"use strict";t.exports=function(e){var t=e._SomePromiseArray;function r(e){var r=new t(e),n=r.promise();return r.setHowMany(1),r.setUnwrap(),r.init(),n}e.any=function(e){return r(e)},e.prototype.any=function(){return r(this)}}},{}],2:[function(t,r,n){"use strict";var o;try{throw new Error}catch(e){o=e}var i=t("./schedule"),s=t("./queue"),a=t("./util");function u(){this._customScheduler=!1,this._isTickUsed=!1,this._lateQueue=new s(16),this._normalQueue=new s(16),this._haveDrainedQueues=!1,this._trampolineEnabled=!0;var e=this;this.drainQueues=function(){e._drainQueues()},this._schedule=i}function c(e,t,r){this._lateQueue.push(e,t,r),this._queueTick()}function l(e,t,r){this._normalQueue.push(e,t,r),this._queueTick()}function d(e){this._normalQueue._pushOne(e),this._queueTick()}function f(e){for(;e.length()>0;)p(e)}function p(e){var t=e.shift();if("function"!=typeof t)t._settlePromises();else{var r=e.shift(),n=e.shift();t.call(r,n)}}u.prototype.setScheduler=function(e){var t=this._schedule;return this._schedule=e,this._customScheduler=!0,t},u.prototype.hasCustomScheduler=function(){return this._customScheduler},u.prototype.enableTrampoline=function(){this._trampolineEnabled=!0},u.prototype.disableTrampolineIfNecessary=function(){a.hasDevTools&&(this._trampolineEnabled=!1)},u.prototype.haveItemsQueued=function(){return this._isTickUsed||this._haveDrainedQueues},u.prototype.fatalError=function(t,r){r?(e.stderr.write("Fatal "+(t instanceof Error?t.stack:t)+"\n"),e.exit(2)):this.throwLater(t)},u.prototype.throwLater=function(e,t){if(1===arguments.length&&(t=e,e=function(){throw t}),"undefined"!=typeof setTimeout)setTimeout((function(){e(t)}),0);else try{this._schedule((function(){e(t)}))}catch(e){throw new Error("No async scheduler available\n\n    See http://goo.gl/MqrFmX\n")}},a.hasDevTools?(u.prototype.invokeLater=function(e,t,r){this._trampolineEnabled?c.call(this,e,t,r):this._schedule((function(){setTimeout((function(){e.call(t,r)}),100)}))},u.prototype.invoke=function(e,t,r){this._trampolineEnabled?l.call(this,e,t,r):this._schedule((function(){e.call(t,r)}))},u.prototype.settlePromises=function(e){this._trampolineEnabled?d.call(this,e):this._schedule((function(){e._settlePromises()}))}):(u.prototype.invokeLater=c,u.prototype.invoke=l,u.prototype.settlePromises=d),u.prototype._drainQueues=function(){f(this._normalQueue),this._reset(),this._haveDrainedQueues=!0,f(this._lateQueue)},u.prototype._queueTick=function(){this._isTickUsed||(this._isTickUsed=!0,this._schedule(this.drainQueues))},u.prototype._reset=function(){this._isTickUsed=!1},r.exports=u,r.exports.firstLineError=o},{"./queue":26,"./schedule":29,"./util":36}],3:[function(e,t,r){"use strict";t.exports=function(e,t,r,n){var o=!1,i=function(e,t){this._reject(t)},s=function(e,t){t.promiseRejectionQueued=!0,t.bindingPromise._then(i,i,null,this,e)},a=function(e,t){0==(50397184&this._bitField)&&this._resolveCallback(t.target)},u=function(e,t){t.promiseRejectionQueued||this._reject(e)};e.prototype.bind=function(i){o||(o=!0,e.prototype._propagateFrom=n.propagateFromFunction(),e.prototype._boundValue=n.boundValueFunction());var c=r(i),l=new e(t);l._propagateFrom(this,1);var d=this._target();if(l._setBoundTo(c),c instanceof e){var f={promiseRejectionQueued:!1,promise:l,target:d,bindingPromise:c};d._then(t,s,void 0,l,f),c._then(a,u,void 0,l,f),l._setOnCancel(c)}else l._resolveCallback(d);return l},e.prototype._setBoundTo=function(e){void 0!==e?(this._bitField=2097152|this._bitField,this._boundTo=e):this._bitField=-2097153&this._bitField},e.prototype._isBound=function(){return 2097152==(2097152&this._bitField)},e.bind=function(t,r){return e.resolve(r).bind(t)}}},{}],4:[function(e,t,r){"use strict";var n;"undefined"!=typeof Promise&&(n=Promise);var o=e("./promise")();o.noConflict=function(){try{Promise===o&&(Promise=n)}catch(e){}return o},t.exports=o},{"./promise":22}],5:[function(e,t,r){"use strict";var n=Object.create;if(n){var o=n(null),i=n(null);o[" size"]=i[" size"]=0}t.exports=function(t){var r,n=e("./util"),o=n.canEvaluate;n.isIdentifier;function i(e,r){var o;if(null!=e&&(o=e[r]),"function"!=typeof o){var i="Object "+n.classString(e)+" has no method '"+n.toString(r)+"'";throw new t.TypeError(i)}return o}function s(e){return i(e,this.pop()).apply(e,this)}function a(e){return e[this]}function u(e){var t=+this;return t<0&&(t=Math.max(0,t+e.length)),e[t]}t.prototype.call=function(e){var t=[].slice.call(arguments,1);return t.push(e),this._then(s,void 0,void 0,t,void 0)},t.prototype.get=function(e){var t;if("number"==typeof e)t=u;else if(o){var n=r(e);t=null!==n?n:a}else t=a;return this._then(t,void 0,void 0,e,void 0)}}},{"./util":36}],6:[function(e,t,r){"use strict";t.exports=function(t,r,n,o){var i=e("./util"),s=i.tryCatch,a=i.errorObj,u=t._async;t.prototype.break=t.prototype.cancel=function(){if(!o.cancellation())return this._warn("cancellation is disabled");for(var e=this,t=e;e._isCancellable();){if(!e._cancelBy(t)){t._isFollowing()?t._followee().cancel():t._cancelBranched();break}var r=e._cancellationParent;if(null==r||!r._isCancellable()){e._isFollowing()?e._followee().cancel():e._cancelBranched();break}e._isFollowing()&&e._followee().cancel(),e._setWillBeCancelled(),t=e,e=r}},t.prototype._branchHasCancelled=function(){this._branchesRemainingToCancel--},t.prototype._enoughBranchesHaveCancelled=function(){return void 0===this._branchesRemainingToCancel||this._branchesRemainingToCancel<=0},t.prototype._cancelBy=function(e){return e===this?(this._branchesRemainingToCancel=0,this._invokeOnCancel(),!0):(this._branchHasCancelled(),!!this._enoughBranchesHaveCancelled()&&(this._invokeOnCancel(),!0))},t.prototype._cancelBranched=function(){this._enoughBranchesHaveCancelled()&&this._cancel()},t.prototype._cancel=function(){this._isCancellable()&&(this._setCancelled(),u.invoke(this._cancelPromises,this,void 0))},t.prototype._cancelPromises=function(){this._length()>0&&this._settlePromises()},t.prototype._unsetOnCancel=function(){this._onCancelField=void 0},t.prototype._isCancellable=function(){return this.isPending()&&!this._isCancelled()},t.prototype.isCancellable=function(){return this.isPending()&&!this.isCancelled()},t.prototype._doInvokeOnCancel=function(e,t){if(i.isArray(e))for(var r=0;r<e.length;++r)this._doInvokeOnCancel(e[r],t);else if(void 0!==e)if("function"==typeof e){if(!t){var n=s(e).call(this._boundValue());n===a&&(this._attachExtraTrace(n.e),u.throwLater(n.e))}}else e._resultCancelled(this)},t.prototype._invokeOnCancel=function(){var e=this._onCancel();this._unsetOnCancel(),u.invoke(this._doInvokeOnCancel,this,e)},t.prototype._invokeInternalOnCancel=function(){this._isCancellable()&&(this._doInvokeOnCancel(this._onCancel(),!0),this._unsetOnCancel())},t.prototype._resultCancelled=function(){this.cancel()}}},{"./util":36}],7:[function(e,t,r){"use strict";t.exports=function(t){var r=e("./util"),n=e("./es5").keys,o=r.tryCatch,i=r.errorObj;return function(e,s,a){return function(u){var c=a._boundValue();e:for(var l=0;l<e.length;++l){var d=e[l];if(d===Error||null!=d&&d.prototype instanceof Error){if(u instanceof d)return o(s).call(c,u)}else if("function"==typeof d){var f=o(d).call(c,u);if(f===i)return f;if(f)return o(s).call(c,u)}else if(r.isObject(u)){for(var p=n(d),h=0;h<p.length;++h){var v=p[h];if(d[v]!=u[v])continue e}return o(s).call(c,u)}}return t}}}},{"./es5":13,"./util":36}],8:[function(e,t,r){"use strict";t.exports=function(e){var t=!1,r=[];function n(){this._trace=new n.CapturedTrace(o())}function o(){var e=r.length-1;if(e>=0)return r[e]}return e.prototype._promiseCreated=function(){},e.prototype._pushContext=function(){},e.prototype._popContext=function(){return null},e._peekContext=e.prototype._peekContext=function(){},n.prototype._pushContext=function(){void 0!==this._trace&&(this._trace._promiseCreated=null,r.push(this._trace))},n.prototype._popContext=function(){if(void 0!==this._trace){var e=r.pop(),t=e._promiseCreated;return e._promiseCreated=null,t}return null},n.CapturedTrace=null,n.create=function(){if(t)return new n},n.deactivateLongStackTraces=function(){},n.activateLongStackTraces=function(){var r=e.prototype._pushContext,i=e.prototype._popContext,s=e._peekContext,a=e.prototype._peekContext,u=e.prototype._promiseCreated;n.deactivateLongStackTraces=function(){e.prototype._pushContext=r,e.prototype._popContext=i,e._peekContext=s,e.prototype._peekContext=a,e.prototype._promiseCreated=u,t=!1},t=!0,e.prototype._pushContext=n.prototype._pushContext,e.prototype._popContext=n.prototype._popContext,e._peekContext=e.prototype._peekContext=o,e.prototype._promiseCreated=function(){var e=this._peekContext();e&&null==e._promiseCreated&&(e._promiseCreated=this)}},n}},{}],9:[function(t,r,n){"use strict";r.exports=function(r,n){var o,i,s,a=r._getDomain,u=r._async,c=t("./errors").Warning,l=t("./util"),d=t("./es5"),f=l.canAttachTrace,p=/[\\\/]bluebird[\\\/]js[\\\/](release|debug|instrumented)/,h=/\((?:timers\.js):\d+:\d+\)/,v=/[\/<\(](.+?):(\d+):(\d+)\)?\s*$/,m=null,y=null,_=!1,g=!(0==l.env("BLUEBIRD_DEBUG")),b=!(0==l.env("BLUEBIRD_WARNINGS")||!g&&!l.env("BLUEBIRD_WARNINGS")),k=!(0==l.env("BLUEBIRD_LONG_STACK_TRACES")||!g&&!l.env("BLUEBIRD_LONG_STACK_TRACES")),w=0!=l.env("BLUEBIRD_W_FORGOTTEN_RETURN")&&(b||!!l.env("BLUEBIRD_W_FORGOTTEN_RETURN"));r.prototype.suppressUnhandledRejections=function(){var e=this._target();e._bitField=-1048577&e._bitField|524288},r.prototype._ensurePossibleRejectionHandled=function(){if(0==(524288&this._bitField)){this._setRejectionIsUnhandled();var e=this;setTimeout((function(){e._notifyUnhandledRejection()}),1)}},r.prototype._notifyUnhandledRejectionIsHandled=function(){$("rejectionHandled",o,void 0,this)},r.prototype._setReturnedNonUndefined=function(){this._bitField=268435456|this._bitField},r.prototype._returnedNonUndefined=function(){return 0!=(268435456&this._bitField)},r.prototype._notifyUnhandledRejection=function(){if(this._isRejectionUnhandled()){var e=this._settledValue();this._setUnhandledRejectionIsNotified(),$("unhandledRejection",i,e,this)}},r.prototype._setUnhandledRejectionIsNotified=function(){this._bitField=262144|this._bitField},r.prototype._unsetUnhandledRejectionIsNotified=function(){this._bitField=-262145&this._bitField},r.prototype._isUnhandledRejectionNotified=function(){return(262144&this._bitField)>0},r.prototype._setRejectionIsUnhandled=function(){this._bitField=1048576|this._bitField},r.prototype._unsetRejectionIsUnhandled=function(){this._bitField=-1048577&this._bitField,this._isUnhandledRejectionNotified()&&(this._unsetUnhandledRejectionIsNotified(),this._notifyUnhandledRejectionIsHandled())},r.prototype._isRejectionUnhandled=function(){return(1048576&this._bitField)>0},r.prototype._warn=function(e,t,r){return q(e,t,r||this)},r.onPossiblyUnhandledRejection=function(e){var t=a();i="function"==typeof e?null===t?e:l.domainBind(t,e):void 0},r.onUnhandledRejectionHandled=function(e){var t=a();o="function"==typeof e?null===t?e:l.domainBind(t,e):void 0};var E=function(){};r.longStackTraces=function(){if(u.haveItemsQueued()&&!Z.longStackTraces)throw new Error("cannot enable long stack traces after promises have been created\n\n    See http://goo.gl/MqrFmX\n");if(!Z.longStackTraces&&H()){var e=r.prototype._captureStackTrace,t=r.prototype._attachExtraTrace,o=r.prototype._dereferenceTrace;Z.longStackTraces=!0,E=function(){if(u.haveItemsQueued()&&!Z.longStackTraces)throw new Error("cannot enable long stack traces after promises have been created\n\n    See http://goo.gl/MqrFmX\n");r.prototype._captureStackTrace=e,r.prototype._attachExtraTrace=t,r.prototype._dereferenceTrace=o,n.deactivateLongStackTraces(),u.enableTrampoline(),Z.longStackTraces=!1},r.prototype._captureStackTrace=F,r.prototype._attachExtraTrace=N,r.prototype._dereferenceTrace=K,n.activateLongStackTraces(),u.disableTrampolineIfNecessary()}},r.hasLongStackTraces=function(){return Z.longStackTraces&&H()};var S=function(){try{if("function"==typeof CustomEvent){var e=new CustomEvent("CustomEvent");return l.global.dispatchEvent(e),function(e,t){var r={detail:t,cancelable:!0};d.defineProperty(r,"promise",{value:t.promise}),d.defineProperty(r,"reason",{value:t.reason});var n=new CustomEvent(e.toLowerCase(),r);return!l.global.dispatchEvent(n)}}if("function"==typeof Event){e=new Event("CustomEvent");return l.global.dispatchEvent(e),function(e,t){var r=new Event(e.toLowerCase(),{cancelable:!0});return r.detail=t,d.defineProperty(r,"promise",{value:t.promise}),d.defineProperty(r,"reason",{value:t.reason}),!l.global.dispatchEvent(r)}}return(e=document.createEvent("CustomEvent")).initCustomEvent("testingtheevent",!1,!0,{}),l.global.dispatchEvent(e),function(e,t){var r=document.createEvent("CustomEvent");return r.initCustomEvent(e.toLowerCase(),!1,!0,t),!l.global.dispatchEvent(r)}}catch(e){}return function(){return!1}}(),x=l.isNode?function(){return e.emit.apply(e,arguments)}:l.global?function(e){var t="on"+e.toLowerCase(),r=l.global[t];return!!r&&(r.apply(l.global,[].slice.call(arguments,1)),!0)}:function(){return!1};function R(e,t){return{promise:t}}var T={promiseCreated:R,promiseFulfilled:R,promiseRejected:R,promiseResolved:R,promiseCancelled:R,promiseChained:function(e,t,r){return{promise:t,child:r}},warning:function(e,t){return{warning:t}},unhandledRejection:function(e,t,r){return{reason:t,promise:r}},rejectionHandled:R},I=function(e){var t=!1;try{t=x.apply(null,arguments)}catch(e){u.throwLater(e),t=!0}var r=!1;try{r=S(e,T[e].apply(null,arguments))}catch(e){u.throwLater(e),r=!0}return r||t};function C(){return!1}function O(e,t,r){var n=this;try{e(t,r,(function(e){if("function"!=typeof e)throw new TypeError("onCancel must be a function, got: "+l.toString(e));n._attachCancellationCallback(e)}))}catch(e){return e}}function j(e){if(!this._isCancellable())return this;var t=this._onCancel();void 0!==t?l.isArray(t)?t.push(e):this._setOnCancel([t,e]):this._setOnCancel(e)}function A(){return this._onCancelField}function D(e){this._onCancelField=e}function M(){this._cancellationParent=void 0,this._onCancelField=void 0}function P(e,t){if(0!=(1&t)){this._cancellationParent=e;var r=e._branchesRemainingToCancel;void 0===r&&(r=0),e._branchesRemainingToCancel=r+1}0!=(2&t)&&e._isBound()&&this._setBoundTo(e._boundTo)}r.config=function(e){if("longStackTraces"in(e=Object(e))&&(e.longStackTraces?r.longStackTraces():!e.longStackTraces&&r.hasLongStackTraces()&&E()),"warnings"in e){var t=e.warnings;Z.warnings=!!t,w=Z.warnings,l.isObject(t)&&"wForgottenReturn"in t&&(w=!!t.wForgottenReturn)}if("cancellation"in e&&e.cancellation&&!Z.cancellation){if(u.haveItemsQueued())throw new Error("cannot enable cancellation after promises are in use");r.prototype._clearCancellationData=M,r.prototype._propagateFrom=P,r.prototype._onCancel=A,r.prototype._setOnCancel=D,r.prototype._attachCancellationCallback=j,r.prototype._execute=O,U=P,Z.cancellation=!0}return"monitoring"in e&&(e.monitoring&&!Z.monitoring?(Z.monitoring=!0,r.prototype._fireEvent=I):!e.monitoring&&Z.monitoring&&(Z.monitoring=!1,r.prototype._fireEvent=C)),r},r.prototype._fireEvent=C,r.prototype._execute=function(e,t,r){try{e(t,r)}catch(e){return e}},r.prototype._onCancel=function(){},r.prototype._setOnCancel=function(e){},r.prototype._attachCancellationCallback=function(e){},r.prototype._captureStackTrace=function(){},r.prototype._attachExtraTrace=function(){},r.prototype._dereferenceTrace=function(){},r.prototype._clearCancellationData=function(){},r.prototype._propagateFrom=function(e,t){};var U=function(e,t){0!=(2&t)&&e._isBound()&&this._setBoundTo(e._boundTo)};function L(){var e=this._boundTo;return void 0!==e&&e instanceof r?e.isFulfilled()?e.value():void 0:e}function F(){this._trace=new X(this._peekContext())}function N(e,t){if(f(e)){var r=this._trace;if(void 0!==r&&t&&(r=r._parent),void 0!==r)r.attachExtraTrace(e);else if(!e.__stackCleaned__){var n=G(e);l.notEnumerableProp(e,"stack",n.message+"\n"+n.stack.join("\n")),l.notEnumerableProp(e,"__stackCleaned__",!0)}}}function K(){this._trace=void 0}function q(e,t,n){if(Z.warnings){var o,i=new c(e);if(t)n._attachExtraTrace(i);else if(Z.longStackTraces&&(o=r._peekContext()))o.attachExtraTrace(i);else{var s=G(i);i.stack=s.message+"\n"+s.stack.join("\n")}I("warning",i)||V(i,"",!0)}}function B(e){for(var t=[],r=0;r<e.length;++r){var n=e[r],o="    (No stack trace)"===n||m.test(n),i=o&&z(n);o&&!i&&(_&&" "!==n.charAt(0)&&(n="    "+n),t.push(n))}return t}function G(e){var t=e.stack,r=e.toString();return t="string"==typeof t&&t.length>0?function(e){for(var t=e.stack.replace(/\s+$/g,"").split("\n"),r=0;r<t.length;++r){var n=t[r];if("    (No stack trace)"===n||m.test(n))break}return r>0&&"SyntaxError"!=e.name&&(t=t.slice(r)),t}(e):["    (No stack trace)"],{message:r,stack:"SyntaxError"==e.name?t:B(t)}}function V(e,t,r){if("undefined"!=typeof console){var n;if(l.isObject(e)){var o=e.stack;n=t+y(o,e)}else n=t+String(e);"function"==typeof s?s(n,r):"function"!=typeof console.log&&"object"!=typeof console.log||console.log(n)}}function $(e,t,r,n){var o=!1;try{"function"==typeof t&&(o=!0,"rejectionHandled"===e?t(n):t(r,n))}catch(e){u.throwLater(e)}"unhandledRejection"===e?I(e,r,n)||o||V(r,"Unhandled rejection "):I(e,n)}function W(e){var t;if("function"==typeof e)t="[function "+(e.name||"anonymous")+"]";else{t=e&&"function"==typeof e.toString?e.toString():l.toString(e);if(/\[object [a-zA-Z0-9$_]+\]/.test(t))try{t=JSON.stringify(e)}catch(e){}0===t.length&&(t="(empty array)")}return"(<"+function(e){if(e.length<41)return e;return e.substr(0,38)+"..."}(t)+">, no stack trace)"}function H(){return"function"==typeof J}var z=function(){return!1},Y=/[\/<\(]([^:\/]+):(\d+):(?:\d+)\)?\s*$/;function Q(e){var t=e.match(Y);if(t)return{fileName:t[1],line:parseInt(t[2],10)}}function X(e){this._parent=e,this._promisesCreated=0;var t=this._length=1+(void 0===e?0:e._length);J(this,X),t>32&&this.uncycle()}l.inherits(X,Error),n.CapturedTrace=X,X.prototype.uncycle=function(){var e=this._length;if(!(e<2)){for(var t=[],r={},n=0,o=this;void 0!==o;++n)t.push(o),o=o._parent;for(n=(e=this._length=n)-1;n>=0;--n){var i=t[n].stack;void 0===r[i]&&(r[i]=n)}for(n=0;n<e;++n){var s=r[t[n].stack];if(void 0!==s&&s!==n){s>0&&(t[s-1]._parent=void 0,t[s-1]._length=1),t[n]._parent=void 0,t[n]._length=1;var a=n>0?t[n-1]:this;s<e-1?(a._parent=t[s+1],a._parent.uncycle(),a._length=a._parent._length+1):(a._parent=void 0,a._length=1);for(var u=a._length+1,c=n-2;c>=0;--c)t[c]._length=u,u++;return}}}},X.prototype.attachExtraTrace=function(e){if(!e.__stackCleaned__){this.uncycle();for(var t=G(e),r=t.message,n=[t.stack],o=this;void 0!==o;)n.push(B(o.stack.split("\n"))),o=o._parent;!function(e){for(var t=e[0],r=1;r<e.length;++r){for(var n=e[r],o=t.length-1,i=t[o],s=-1,a=n.length-1;a>=0;--a)if(n[a]===i){s=a;break}for(a=s;a>=0;--a){var u=n[a];if(t[o]!==u)break;t.pop(),o--}t=n}}(n),function(e){for(var t=0;t<e.length;++t)(0===e[t].length||t+1<e.length&&e[t][0]===e[t+1][0])&&(e.splice(t,1),t--)}(n),l.notEnumerableProp(e,"stack",function(e,t){for(var r=0;r<t.length-1;++r)t[r].push("From previous event:"),t[r]=t[r].join("\n");return r<t.length&&(t[r]=t[r].join("\n")),e+"\n"+t.join("\n")}(r,n)),l.notEnumerableProp(e,"__stackCleaned__",!0)}};var J=function(){var e=/^\s*at\s*/,t=function(e,t){return"string"==typeof e?e:void 0!==t.name&&void 0!==t.message?t.toString():W(t)};if("number"==typeof Error.stackTraceLimit&&"function"==typeof Error.captureStackTrace){Error.stackTraceLimit+=6,m=e,y=t;var r=Error.captureStackTrace;return z=function(e){return p.test(e)},function(e,t){Error.stackTraceLimit+=6,r(e,t),Error.stackTraceLimit-=6}}var n,o=new Error;if("string"==typeof o.stack&&o.stack.split("\n")[0].indexOf("stackDetection@")>=0)return m=/@/,y=t,_=!0,function(e){e.stack=(new Error).stack};try{throw new Error}catch(e){n="stack"in e}return"stack"in o||!n||"number"!=typeof Error.stackTraceLimit?(y=function(e,t){return"string"==typeof e?e:"object"!=typeof t&&"function"!=typeof t||void 0===t.name||void 0===t.message?W(t):t.toString()},null):(m=e,y=t,function(e){Error.stackTraceLimit+=6;try{throw new Error}catch(t){e.stack=t.stack}Error.stackTraceLimit-=6})}();"undefined"!=typeof console&&void 0!==console.warn&&(s=function(e){console.warn(e)},l.isNode&&e.stderr.isTTY?s=function(e,t){var r=t?"[33m":"[31m";console.warn(r+e+"[0m\n")}:l.isNode||"string"!=typeof(new Error).stack||(s=function(e,t){console.warn("%c"+e,t?"color: darkorange":"color: red")}));var Z={warnings:b,longStackTraces:!1,cancellation:!1,monitoring:!1};return k&&r.longStackTraces(),{longStackTraces:function(){return Z.longStackTraces},warnings:function(){return Z.warnings},cancellation:function(){return Z.cancellation},monitoring:function(){return Z.monitoring},propagateFromFunction:function(){return U},boundValueFunction:function(){return L},checkForgottenReturns:function(e,t,r,n,o){if(void 0===e&&null!==t&&w){if(void 0!==o&&o._returnedNonUndefined())return;if(0==(65535&n._bitField))return;r&&(r+=" ");var i="",s="";if(t._trace){for(var a=t._trace.stack.split("\n"),u=B(a),c=u.length-1;c>=0;--c){var l=u[c];if(!h.test(l)){var d=l.match(v);d&&(i="at "+d[1]+":"+d[2]+":"+d[3]+" ");break}}if(u.length>0){var f=u[0];for(c=0;c<a.length;++c)if(a[c]===f){c>0&&(s="\n"+a[c-1]);break}}}var p="a promise was created in a "+r+"handler "+i+"but was not returned from it, see http://goo.gl/rRqMUw"+s;n._warn(p,!0,t)}},setBounds:function(e,t){if(H()){for(var r,n,o=(e.stack||"").split("\n"),i=(t.stack||"").split("\n"),s=-1,a=-1,u=0;u<o.length;++u){if(c=Q(o[u])){r=c.fileName,s=c.line;break}}for(u=0;u<i.length;++u){var c;if(c=Q(i[u])){n=c.fileName,a=c.line;break}}s<0||a<0||!r||!n||r!==n||s>=a||(z=function(e){if(p.test(e))return!0;var t=Q(e);return!!(t&&t.fileName===r&&s<=t.line&&t.line<=a)})}},warn:q,deprecated:function(e,t){var r=e+" is deprecated and will be removed in a future version.";return t&&(r+=" Use "+t+" instead."),q(r)},CapturedTrace:X,fireDomEvent:S,fireGlobalEvent:x}}},{"./errors":12,"./es5":13,"./util":36}],10:[function(e,t,r){"use strict";t.exports=function(e){function t(){return this.value}function r(){throw this.reason}e.prototype.return=e.prototype.thenReturn=function(r){return r instanceof e&&r.suppressUnhandledRejections(),this._then(t,void 0,void 0,{value:r},void 0)},e.prototype.throw=e.prototype.thenThrow=function(e){return this._then(r,void 0,void 0,{reason:e},void 0)},e.prototype.catchThrow=function(e){if(arguments.length<=1)return this._then(void 0,r,void 0,{reason:e},void 0);var t=arguments[1],n=function(){throw t};return this.caught(e,n)},e.prototype.catchReturn=function(r){if(arguments.length<=1)return r instanceof e&&r.suppressUnhandledRejections(),this._then(void 0,t,void 0,{value:r},void 0);var n=arguments[1];n instanceof e&&n.suppressUnhandledRejections();var o=function(){return n};return this.caught(r,o)}}},{}],11:[function(e,t,r){"use strict";t.exports=function(e,t){var r=e.reduce,n=e.all;function o(){return n(this)}e.prototype.each=function(e){return r(this,e,t,0)._then(o,void 0,void 0,this,void 0)},e.prototype.mapSeries=function(e){return r(this,e,t,t)},e.each=function(e,n){return r(e,n,t,0)._then(o,void 0,void 0,e,void 0)},e.mapSeries=function(e,n){return r(e,n,t,t)}}},{}],12:[function(e,t,r){"use strict";var n,o,i=e("./es5"),s=i.freeze,a=e("./util"),u=a.inherits,c=a.notEnumerableProp;function l(e,t){function r(n){if(!(this instanceof r))return new r(n);c(this,"message","string"==typeof n?n:t),c(this,"name",e),Error.captureStackTrace?Error.captureStackTrace(this,this.constructor):Error.call(this)}return u(r,Error),r}var d=l("Warning","warning"),f=l("CancellationError","cancellation error"),p=l("TimeoutError","timeout error"),h=l("AggregateError","aggregate error");try{n=TypeError,o=RangeError}catch(e){n=l("TypeError","type error"),o=l("RangeError","range error")}for(var v="join pop push shift unshift slice filter forEach some every map indexOf lastIndexOf reduce reduceRight sort reverse".split(" "),m=0;m<v.length;++m)"function"==typeof Array.prototype[v[m]]&&(h.prototype[v[m]]=Array.prototype[v[m]]);i.defineProperty(h.prototype,"length",{value:0,configurable:!1,writable:!0,enumerable:!0}),h.prototype.isOperational=!0;var y=0;function _(e){if(!(this instanceof _))return new _(e);c(this,"name","OperationalError"),c(this,"message",e),this.cause=e,this.isOperational=!0,e instanceof Error?(c(this,"message",e.message),c(this,"stack",e.stack)):Error.captureStackTrace&&Error.captureStackTrace(this,this.constructor)}h.prototype.toString=function(){var e=Array(4*y+1).join(" "),t="\n"+e+"AggregateError of:\n";y++,e=Array(4*y+1).join(" ");for(var r=0;r<this.length;++r){for(var n=this[r]===this?"[Circular AggregateError]":this[r]+"",o=n.split("\n"),i=0;i<o.length;++i)o[i]=e+o[i];t+=(n=o.join("\n"))+"\n"}return y--,t},u(_,Error);var g=Error.__BluebirdErrorTypes__;g||(g=s({CancellationError:f,TimeoutError:p,OperationalError:_,RejectionError:_,AggregateError:h}),i.defineProperty(Error,"__BluebirdErrorTypes__",{value:g,writable:!1,enumerable:!1,configurable:!1})),t.exports={Error:Error,TypeError:n,RangeError:o,CancellationError:g.CancellationError,OperationalError:g.OperationalError,TimeoutError:g.TimeoutError,AggregateError:g.AggregateError,Warning:d}},{"./es5":13,"./util":36}],13:[function(e,t,r){var n=function(){"use strict";return void 0===this}();if(n)t.exports={freeze:Object.freeze,defineProperty:Object.defineProperty,getDescriptor:Object.getOwnPropertyDescriptor,keys:Object.keys,names:Object.getOwnPropertyNames,getPrototypeOf:Object.getPrototypeOf,isArray:Array.isArray,isES5:n,propertyIsWritable:function(e,t){var r=Object.getOwnPropertyDescriptor(e,t);return!(r&&!r.writable&&!r.set)}};else{var o={}.hasOwnProperty,i={}.toString,s={}.constructor.prototype,a=function(e){var t=[];for(var r in e)o.call(e,r)&&t.push(r);return t};t.exports={isArray:function(e){try{return"[object Array]"===i.call(e)}catch(e){return!1}},keys:a,names:a,defineProperty:function(e,t,r){return e[t]=r.value,e},getDescriptor:function(e,t){return{value:e[t]}},freeze:function(e){return e},getPrototypeOf:function(e){try{return Object(e).constructor.prototype}catch(e){return s}},isES5:n,propertyIsWritable:function(){return!0}}}},{}],14:[function(e,t,r){"use strict";t.exports=function(e,t){var r=e.map;e.prototype.filter=function(e,n){return r(this,e,n,t)},e.filter=function(e,n,o){return r(e,n,o,t)}}},{}],15:[function(e,t,r){"use strict";t.exports=function(t,r,n){var o=e("./util"),i=t.CancellationError,s=o.errorObj,a=e("./catch_filter")(n);function u(e,t,r){this.promise=e,this.type=t,this.handler=r,this.called=!1,this.cancelPromise=null}function c(e){this.finallyHandler=e}function l(e,t){return null!=e.cancelPromise&&(arguments.length>1?e.cancelPromise._reject(t):e.cancelPromise._cancel(),e.cancelPromise=null,!0)}function d(){return p.call(this,this.promise._target()._settledValue())}function f(e){if(!l(this,e))return s.e=e,s}function p(e){var o=this.promise,a=this.handler;if(!this.called){this.called=!0;var u=this.isFinallyHandler()?a.call(o._boundValue()):a.call(o._boundValue(),e);if(u===n)return u;if(void 0!==u){o._setReturnedNonUndefined();var p=r(u,o);if(p instanceof t){if(null!=this.cancelPromise){if(p._isCancelled()){var h=new i("late cancellation observer");return o._attachExtraTrace(h),s.e=h,s}p.isPending()&&p._attachCancellationCallback(new c(this))}return p._then(d,f,void 0,this,void 0)}}}return o.isRejected()?(l(this),s.e=e,s):(l(this),e)}return u.prototype.isFinallyHandler=function(){return 0===this.type},c.prototype._resultCancelled=function(){l(this.finallyHandler)},t.prototype._passThrough=function(e,t,r,n){return"function"!=typeof e?this.then():this._then(r,n,void 0,new u(this,t,e),void 0)},t.prototype.lastly=t.prototype.finally=function(e){return this._passThrough(e,0,p,p)},t.prototype.tap=function(e){return this._passThrough(e,1,p)},t.prototype.tapCatch=function(e){var r=arguments.length;if(1===r)return this._passThrough(e,1,void 0,p);var n,i=new Array(r-1),s=0;for(n=0;n<r-1;++n){var u=arguments[n];if(!o.isObject(u))return t.reject(new TypeError("tapCatch statement predicate: expecting an object but got "+o.classString(u)));i[s++]=u}i.length=s;var c=arguments[n];return this._passThrough(a(i,c,this),1,void 0,p)},u}},{"./catch_filter":7,"./util":36}],16:[function(e,t,r){"use strict";t.exports=function(t,r,n,o,i,s){var a=e("./errors").TypeError,u=e("./util"),c=u.errorObj,l=u.tryCatch,d=[];function f(e,r,o,i){if(s.cancellation()){var a=new t(n),u=this._finallyPromise=new t(n);this._promise=a.lastly((function(){return u})),a._captureStackTrace(),a._setOnCancel(this)}else{(this._promise=new t(n))._captureStackTrace()}this._stack=i,this._generatorFunction=e,this._receiver=r,this._generator=void 0,this._yieldHandlers="function"==typeof o?[o].concat(d):d,this._yieldedPromise=null,this._cancellationPhase=!1}u.inherits(f,i),f.prototype._isResolved=function(){return null===this._promise},f.prototype._cleanup=function(){this._promise=this._generator=null,s.cancellation()&&null!==this._finallyPromise&&(this._finallyPromise._fulfill(),this._finallyPromise=null)},f.prototype._promiseCancelled=function(){if(!this._isResolved()){var e;if(void 0!==this._generator.return)this._promise._pushContext(),e=l(this._generator.return).call(this._generator,void 0),this._promise._popContext();else{var r=new t.CancellationError("generator .return() sentinel");t.coroutine.returnSentinel=r,this._promise._attachExtraTrace(r),this._promise._pushContext(),e=l(this._generator.throw).call(this._generator,r),this._promise._popContext()}this._cancellationPhase=!0,this._yieldedPromise=null,this._continue(e)}},f.prototype._promiseFulfilled=function(e){this._yieldedPromise=null,this._promise._pushContext();var t=l(this._generator.next).call(this._generator,e);this._promise._popContext(),this._continue(t)},f.prototype._promiseRejected=function(e){this._yieldedPromise=null,this._promise._attachExtraTrace(e),this._promise._pushContext();var t=l(this._generator.throw).call(this._generator,e);this._promise._popContext(),this._continue(t)},f.prototype._resultCancelled=function(){if(this._yieldedPromise instanceof t){var e=this._yieldedPromise;this._yieldedPromise=null,e.cancel()}},f.prototype.promise=function(){return this._promise},f.prototype._run=function(){this._generator=this._generatorFunction.call(this._receiver),this._receiver=this._generatorFunction=void 0,this._promiseFulfilled(void 0)},f.prototype._continue=function(e){var r=this._promise;if(e===c)return this._cleanup(),this._cancellationPhase?r.cancel():r._rejectCallback(e.e,!1);var n=e.value;if(!0===e.done)return this._cleanup(),this._cancellationPhase?r.cancel():r._resolveCallback(n);var i=o(n,this._promise);if(i instanceof t||null!==(i=function(e,r,n){for(var i=0;i<r.length;++i){n._pushContext();var s=l(r[i])(e);if(n._popContext(),s===c){n._pushContext();var a=t.reject(c.e);return n._popContext(),a}var u=o(s,n);if(u instanceof t)return u}return null}(i,this._yieldHandlers,this._promise))){var s=(i=i._target())._bitField;0==(50397184&s)?(this._yieldedPromise=i,i._proxy(this,null)):0!=(33554432&s)?t._async.invoke(this._promiseFulfilled,this,i._value()):0!=(16777216&s)?t._async.invoke(this._promiseRejected,this,i._reason()):this._promiseCancelled()}else this._promiseRejected(new a("A value %s was yielded that could not be treated as a promise\n\n    See http://goo.gl/MqrFmX\n\n".replace("%s",String(n))+"From coroutine:\n"+this._stack.split("\n").slice(1,-7).join("\n")))},t.coroutine=function(e,t){if("function"!=typeof e)throw new a("generatorFunction must be a function\n\n    See http://goo.gl/MqrFmX\n");var r=Object(t).yieldHandler,n=f,o=(new Error).stack;return function(){var t=e.apply(this,arguments),i=new n(void 0,void 0,r,o),s=i.promise();return i._generator=t,i._promiseFulfilled(void 0),s}},t.coroutine.addYieldHandler=function(e){if("function"!=typeof e)throw new a("expecting a function but got "+u.classString(e));d.push(e)},t.spawn=function(e){if(s.deprecated("Promise.spawn()","Promise.coroutine()"),"function"!=typeof e)return r("generatorFunction must be a function\n\n    See http://goo.gl/MqrFmX\n");var n=new f(e,this),o=n.promise();return n._run(t.spawn),o}}},{"./errors":12,"./util":36}],17:[function(e,t,r){"use strict";t.exports=function(t,r,n,o,i,s){var a=e("./util");a.canEvaluate,a.tryCatch,a.errorObj;t.join=function(){var e,t=arguments.length-1;t>0&&"function"==typeof arguments[t]&&(e=arguments[t]);var n=[].slice.call(arguments);e&&n.pop();var o=new r(n).promise();return void 0!==e?o.spread(e):o}}},{"./util":36}],18:[function(e,t,r){"use strict";t.exports=function(t,r,n,o,i,s){var a=t._getDomain,u=e("./util"),c=u.tryCatch,l=u.errorObj,d=t._async;function f(e,t,r,n){this.constructor$(e),this._promise._captureStackTrace();var o=a();this._callback=null===o?t:u.domainBind(o,t),this._preservedValues=n===i?new Array(this.length()):null,this._limit=r,this._inFlight=0,this._queue=[],d.invoke(this._asyncInit,this,void 0)}function p(e,r,o,i){if("function"!=typeof r)return n("expecting a function but got "+u.classString(r));var s=0;if(void 0!==o){if("object"!=typeof o||null===o)return t.reject(new TypeError("options argument must be an object but it is "+u.classString(o)));if("number"!=typeof o.concurrency)return t.reject(new TypeError("'concurrency' must be a number but it is "+u.classString(o.concurrency)));s=o.concurrency}return new f(e,r,s="number"==typeof s&&isFinite(s)&&s>=1?s:0,i).promise()}u.inherits(f,r),f.prototype._asyncInit=function(){this._init$(void 0,-2)},f.prototype._init=function(){},f.prototype._promiseFulfilled=function(e,r){var n=this._values,i=this.length(),a=this._preservedValues,u=this._limit;if(r<0){if(n[r=-1*r-1]=e,u>=1&&(this._inFlight--,this._drainQueue(),this._isResolved()))return!0}else{if(u>=1&&this._inFlight>=u)return n[r]=e,this._queue.push(r),!1;null!==a&&(a[r]=e);var d=this._promise,f=this._callback,p=d._boundValue();d._pushContext();var h=c(f).call(p,e,r,i),v=d._popContext();if(s.checkForgottenReturns(h,v,null!==a?"Promise.filter":"Promise.map",d),h===l)return this._reject(h.e),!0;var m=o(h,this._promise);if(m instanceof t){var y=(m=m._target())._bitField;if(0==(50397184&y))return u>=1&&this._inFlight++,n[r]=m,m._proxy(this,-1*(r+1)),!1;if(0==(33554432&y))return 0!=(16777216&y)?(this._reject(m._reason()),!0):(this._cancel(),!0);h=m._value()}n[r]=h}return++this._totalResolved>=i&&(null!==a?this._filter(n,a):this._resolve(n),!0)},f.prototype._drainQueue=function(){for(var e=this._queue,t=this._limit,r=this._values;e.length>0&&this._inFlight<t;){if(this._isResolved())return;var n=e.pop();this._promiseFulfilled(r[n],n)}},f.prototype._filter=function(e,t){for(var r=t.length,n=new Array(r),o=0,i=0;i<r;++i)e[i]&&(n[o++]=t[i]);n.length=o,this._resolve(n)},f.prototype.preservedValues=function(){return this._preservedValues},t.prototype.map=function(e,t){return p(this,e,t,null)},t.map=function(e,t,r,n){return p(e,t,r,n)}}},{"./util":36}],19:[function(e,t,r){"use strict";t.exports=function(t,r,n,o,i){var s=e("./util"),a=s.tryCatch;t.method=function(e){if("function"!=typeof e)throw new t.TypeError("expecting a function but got "+s.classString(e));return function(){var n=new t(r);n._captureStackTrace(),n._pushContext();var o=a(e).apply(this,arguments),s=n._popContext();return i.checkForgottenReturns(o,s,"Promise.method",n),n._resolveFromSyncValue(o),n}},t.attempt=t.try=function(e){if("function"!=typeof e)return o("expecting a function but got "+s.classString(e));var n,u=new t(r);if(u._captureStackTrace(),u._pushContext(),arguments.length>1){i.deprecated("calling Promise.try with more than 1 argument");var c=arguments[1],l=arguments[2];n=s.isArray(c)?a(e).apply(l,c):a(e).call(l,c)}else n=a(e)();var d=u._popContext();return i.checkForgottenReturns(n,d,"Promise.try",u),u._resolveFromSyncValue(n),u},t.prototype._resolveFromSyncValue=function(e){e===s.errorObj?this._rejectCallback(e.e,!1):this._resolveCallback(e,!0)}}},{"./util":36}],20:[function(e,t,r){"use strict";var n=e("./util"),o=n.maybeWrapAsError,i=e("./errors").OperationalError,s=e("./es5");var a=/^(?:name|message|stack|cause)$/;function u(e){var t;if(function(e){return e instanceof Error&&s.getPrototypeOf(e)===Error.prototype}(e)){(t=new i(e)).name=e.name,t.message=e.message,t.stack=e.stack;for(var r=s.keys(e),o=0;o<r.length;++o){var u=r[o];a.test(u)||(t[u]=e[u])}return t}return n.markAsOriginatingFromRejection(e),e}t.exports=function(e,t){return function(r,n){if(null!==e){if(r){var i=u(o(r));e._attachExtraTrace(i),e._reject(i)}else if(t){var s=[].slice.call(arguments,1);e._fulfill(s)}else e._fulfill(n);e=null}}}},{"./errors":12,"./es5":13,"./util":36}],21:[function(e,t,r){"use strict";t.exports=function(t){var r=e("./util"),n=t._async,o=r.tryCatch,i=r.errorObj;function s(e,t){if(!r.isArray(e))return a.call(this,e,t);var s=o(t).apply(this._boundValue(),[null].concat(e));s===i&&n.throwLater(s.e)}function a(e,t){var r=this._boundValue(),s=void 0===e?o(t).call(r,null):o(t).call(r,null,e);s===i&&n.throwLater(s.e)}function u(e,t){if(!e){var r=new Error(e+"");r.cause=e,e=r}var s=o(t).call(this._boundValue(),e);s===i&&n.throwLater(s.e)}t.prototype.asCallback=t.prototype.nodeify=function(e,t){if("function"==typeof e){var r=a;void 0!==t&&Object(t).spread&&(r=s),this._then(r,u,void 0,this,e)}return this}}},{"./util":36}],22:[function(t,r,n){"use strict";r.exports=function(){var n=function(){return new h("circular promise resolution chain\n\n    See http://goo.gl/MqrFmX\n")},o=function(){return new C.PromiseInspection(this._target())},i=function(e){return C.reject(new h(e))};function s(){}var a,u={},c=t("./util");a=c.isNode?function(){var t=e.domain;return void 0===t&&(t=null),t}:function(){return null},c.notEnumerableProp(C,"_getDomain",a);var l=t("./es5"),d=t("./async"),f=new d;l.defineProperty(C,"_async",{value:f});var p=t("./errors"),h=C.TypeError=p.TypeError;C.RangeError=p.RangeError;var v=C.CancellationError=p.CancellationError;C.TimeoutError=p.TimeoutError,C.OperationalError=p.OperationalError,C.RejectionError=p.OperationalError,C.AggregateError=p.AggregateError;var m=function(){},y={},_={},g=t("./thenables")(C,m),b=t("./promise_array")(C,m,g,i,s),k=t("./context")(C),w=k.create,E=t("./debuggability")(C,k),S=(E.CapturedTrace,t("./finally")(C,g,_)),x=t("./catch_filter")(_),R=t("./nodeback"),T=c.errorObj,I=c.tryCatch;function C(e){e!==m&&function(e,t){if(null==e||e.constructor!==C)throw new h("the promise constructor cannot be invoked directly\n\n    See http://goo.gl/MqrFmX\n");if("function"!=typeof t)throw new h("expecting a function but got "+c.classString(t))}(this,e),this._bitField=0,this._fulfillmentHandler0=void 0,this._rejectionHandler0=void 0,this._promise0=void 0,this._receiver0=void 0,this._resolveFromExecutor(e),this._promiseCreated(),this._fireEvent("promiseCreated",this)}function O(e){this.promise._resolveCallback(e)}function j(e){this.promise._rejectCallback(e,!1)}function A(e){var t=new C(m);t._fulfillmentHandler0=e,t._rejectionHandler0=e,t._promise0=e,t._receiver0=e}return C.prototype.toString=function(){return"[object Promise]"},C.prototype.caught=C.prototype.catch=function(e){var t=arguments.length;if(t>1){var r,n=new Array(t-1),o=0;for(r=0;r<t-1;++r){var s=arguments[r];if(!c.isObject(s))return i("Catch statement predicate: expecting an object but got "+c.classString(s));n[o++]=s}if(n.length=o,"function"!=typeof(e=arguments[r]))throw new h("The last argument to .catch() must be a function, got "+c.toString(e));return this.then(void 0,x(n,e,this))}return this.then(void 0,e)},C.prototype.reflect=function(){return this._then(o,o,void 0,this,void 0)},C.prototype.then=function(e,t){if(E.warnings()&&arguments.length>0&&"function"!=typeof e&&"function"!=typeof t){var r=".then() only accepts functions but was passed: "+c.classString(e);arguments.length>1&&(r+=", "+c.classString(t)),this._warn(r)}return this._then(e,t,void 0,void 0,void 0)},C.prototype.done=function(e,t){this._then(e,t,void 0,void 0,void 0)._setIsFinal()},C.prototype.spread=function(e){return"function"!=typeof e?i("expecting a function but got "+c.classString(e)):this.all()._then(e,void 0,void 0,y,void 0)},C.prototype.toJSON=function(){var e={isFulfilled:!1,isRejected:!1,fulfillmentValue:void 0,rejectionReason:void 0};return this.isFulfilled()?(e.fulfillmentValue=this.value(),e.isFulfilled=!0):this.isRejected()&&(e.rejectionReason=this.reason(),e.isRejected=!0),e},C.prototype.all=function(){return arguments.length>0&&this._warn(".all() was passed arguments but it does not take any"),new b(this).promise()},C.prototype.error=function(e){return this.caught(c.originatesFromRejection,e)},C.getNewLibraryCopy=r.exports,C.is=function(e){return e instanceof C},C.fromNode=C.fromCallback=function(e){var t=new C(m);t._captureStackTrace();var r=arguments.length>1&&!!Object(arguments[1]).multiArgs,n=I(e)(R(t,r));return n===T&&t._rejectCallback(n.e,!0),t._isFateSealed()||t._setAsyncGuaranteed(),t},C.all=function(e){return new b(e).promise()},C.cast=function(e){var t=g(e);return t instanceof C||((t=new C(m))._captureStackTrace(),t._setFulfilled(),t._rejectionHandler0=e),t},C.resolve=C.fulfilled=C.cast,C.reject=C.rejected=function(e){var t=new C(m);return t._captureStackTrace(),t._rejectCallback(e,!0),t},C.setScheduler=function(e){if("function"!=typeof e)throw new h("expecting a function but got "+c.classString(e));return f.setScheduler(e)},C.prototype._then=function(e,t,r,n,o){var i=void 0!==o,s=i?o:new C(m),u=this._target(),l=u._bitField;i||(s._propagateFrom(this,3),s._captureStackTrace(),void 0===n&&0!=(2097152&this._bitField)&&(n=0!=(50397184&l)?this._boundValue():u===this?void 0:this._boundTo),this._fireEvent("promiseChained",this,s));var d=a();if(0!=(50397184&l)){var p,h,y=u._settlePromiseCtx;0!=(33554432&l)?(h=u._rejectionHandler0,p=e):0!=(16777216&l)?(h=u._fulfillmentHandler0,p=t,u._unsetRejectionIsUnhandled()):(y=u._settlePromiseLateCancellationObserver,h=new v("late cancellation observer"),u._attachExtraTrace(h),p=t),f.invoke(y,u,{handler:null===d?p:"function"==typeof p&&c.domainBind(d,p),promise:s,receiver:n,value:h})}else u._addCallbacks(e,t,s,n,d);return s},C.prototype._length=function(){return 65535&this._bitField},C.prototype._isFateSealed=function(){return 0!=(117506048&this._bitField)},C.prototype._isFollowing=function(){return 67108864==(67108864&this._bitField)},C.prototype._setLength=function(e){this._bitField=-65536&this._bitField|65535&e},C.prototype._setFulfilled=function(){this._bitField=33554432|this._bitField,this._fireEvent("promiseFulfilled",this)},C.prototype._setRejected=function(){this._bitField=16777216|this._bitField,this._fireEvent("promiseRejected",this)},C.prototype._setFollowing=function(){this._bitField=67108864|this._bitField,this._fireEvent("promiseResolved",this)},C.prototype._setIsFinal=function(){this._bitField=4194304|this._bitField},C.prototype._isFinal=function(){return(4194304&this._bitField)>0},C.prototype._unsetCancelled=function(){this._bitField=-65537&this._bitField},C.prototype._setCancelled=function(){this._bitField=65536|this._bitField,this._fireEvent("promiseCancelled",this)},C.prototype._setWillBeCancelled=function(){this._bitField=8388608|this._bitField},C.prototype._setAsyncGuaranteed=function(){f.hasCustomScheduler()||(this._bitField=134217728|this._bitField)},C.prototype._receiverAt=function(e){var t=0===e?this._receiver0:this[4*e-4+3];if(t!==u)return void 0===t&&this._isBound()?this._boundValue():t},C.prototype._promiseAt=function(e){return this[4*e-4+2]},C.prototype._fulfillmentHandlerAt=function(e){return this[4*e-4+0]},C.prototype._rejectionHandlerAt=function(e){return this[4*e-4+1]},C.prototype._boundValue=function(){},C.prototype._migrateCallback0=function(e){e._bitField;var t=e._fulfillmentHandler0,r=e._rejectionHandler0,n=e._promise0,o=e._receiverAt(0);void 0===o&&(o=u),this._addCallbacks(t,r,n,o,null)},C.prototype._migrateCallbackAt=function(e,t){var r=e._fulfillmentHandlerAt(t),n=e._rejectionHandlerAt(t),o=e._promiseAt(t),i=e._receiverAt(t);void 0===i&&(i=u),this._addCallbacks(r,n,o,i,null)},C.prototype._addCallbacks=function(e,t,r,n,o){var i=this._length();if(i>=65531&&(i=0,this._setLength(0)),0===i)this._promise0=r,this._receiver0=n,"function"==typeof e&&(this._fulfillmentHandler0=null===o?e:c.domainBind(o,e)),"function"==typeof t&&(this._rejectionHandler0=null===o?t:c.domainBind(o,t));else{var s=4*i-4;this[s+2]=r,this[s+3]=n,"function"==typeof e&&(this[s+0]=null===o?e:c.domainBind(o,e)),"function"==typeof t&&(this[s+1]=null===o?t:c.domainBind(o,t))}return this._setLength(i+1),i},C.prototype._proxy=function(e,t){this._addCallbacks(void 0,void 0,t,e,null)},C.prototype._resolveCallback=function(e,t){if(0==(117506048&this._bitField)){if(e===this)return this._rejectCallback(n(),!1);var r=g(e,this);if(!(r instanceof C))return this._fulfill(e);t&&this._propagateFrom(r,2);var o=r._target();if(o!==this){var i=o._bitField;if(0==(50397184&i)){var s=this._length();s>0&&o._migrateCallback0(this);for(var a=1;a<s;++a)o._migrateCallbackAt(this,a);this._setFollowing(),this._setLength(0),this._setFollowee(o)}else if(0!=(33554432&i))this._fulfill(o._value());else if(0!=(16777216&i))this._reject(o._reason());else{var u=new v("late cancellation observer");o._attachExtraTrace(u),this._reject(u)}}else this._reject(n())}},C.prototype._rejectCallback=function(e,t,r){var n=c.ensureErrorObject(e),o=n===e;if(!o&&!r&&E.warnings()){var i="a promise was rejected with a non-error: "+c.classString(e);this._warn(i,!0)}this._attachExtraTrace(n,!!t&&o),this._reject(e)},C.prototype._resolveFromExecutor=function(e){if(e!==m){var t=this;this._captureStackTrace(),this._pushContext();var r=!0,n=this._execute(e,(function(e){t._resolveCallback(e)}),(function(e){t._rejectCallback(e,r)}));r=!1,this._popContext(),void 0!==n&&t._rejectCallback(n,!0)}},C.prototype._settlePromiseFromHandler=function(e,t,r,n){var o=n._bitField;if(0==(65536&o)){var i;n._pushContext(),t===y?r&&"number"==typeof r.length?i=I(e).apply(this._boundValue(),r):(i=T).e=new h("cannot .spread() a non-array: "+c.classString(r)):i=I(e).call(t,r);var s=n._popContext();0==(65536&(o=n._bitField))&&(i===_?n._reject(r):i===T?n._rejectCallback(i.e,!1):(E.checkForgottenReturns(i,s,"",n,this),n._resolveCallback(i)))}},C.prototype._target=function(){for(var e=this;e._isFollowing();)e=e._followee();return e},C.prototype._followee=function(){return this._rejectionHandler0},C.prototype._setFollowee=function(e){this._rejectionHandler0=e},C.prototype._settlePromise=function(e,t,r,n){var i=e instanceof C,a=this._bitField,u=0!=(134217728&a);0!=(65536&a)?(i&&e._invokeInternalOnCancel(),r instanceof S&&r.isFinallyHandler()?(r.cancelPromise=e,I(t).call(r,n)===T&&e._reject(T.e)):t===o?e._fulfill(o.call(r)):r instanceof s?r._promiseCancelled(e):i||e instanceof b?e._cancel():r.cancel()):"function"==typeof t?i?(u&&e._setAsyncGuaranteed(),this._settlePromiseFromHandler(t,r,n,e)):t.call(r,n,e):r instanceof s?r._isResolved()||(0!=(33554432&a)?r._promiseFulfilled(n,e):r._promiseRejected(n,e)):i&&(u&&e._setAsyncGuaranteed(),0!=(33554432&a)?e._fulfill(n):e._reject(n))},C.prototype._settlePromiseLateCancellationObserver=function(e){var t=e.handler,r=e.promise,n=e.receiver,o=e.value;"function"==typeof t?r instanceof C?this._settlePromiseFromHandler(t,n,o,r):t.call(n,o,r):r instanceof C&&r._reject(o)},C.prototype._settlePromiseCtx=function(e){this._settlePromise(e.promise,e.handler,e.receiver,e.value)},C.prototype._settlePromise0=function(e,t,r){var n=this._promise0,o=this._receiverAt(0);this._promise0=void 0,this._receiver0=void 0,this._settlePromise(n,e,o,t)},C.prototype._clearCallbackDataAtIndex=function(e){var t=4*e-4;this[t+2]=this[t+3]=this[t+0]=this[t+1]=void 0},C.prototype._fulfill=function(e){var t=this._bitField;if(!((117506048&t)>>>16)){if(e===this){var r=n();return this._attachExtraTrace(r),this._reject(r)}this._setFulfilled(),this._rejectionHandler0=e,(65535&t)>0&&(0!=(134217728&t)?this._settlePromises():f.settlePromises(this),this._dereferenceTrace())}},C.prototype._reject=function(e){var t=this._bitField;if(!((117506048&t)>>>16)){if(this._setRejected(),this._fulfillmentHandler0=e,this._isFinal())return f.fatalError(e,c.isNode);(65535&t)>0?f.settlePromises(this):this._ensurePossibleRejectionHandled()}},C.prototype._fulfillPromises=function(e,t){for(var r=1;r<e;r++){var n=this._fulfillmentHandlerAt(r),o=this._promiseAt(r),i=this._receiverAt(r);this._clearCallbackDataAtIndex(r),this._settlePromise(o,n,i,t)}},C.prototype._rejectPromises=function(e,t){for(var r=1;r<e;r++){var n=this._rejectionHandlerAt(r),o=this._promiseAt(r),i=this._receiverAt(r);this._clearCallbackDataAtIndex(r),this._settlePromise(o,n,i,t)}},C.prototype._settlePromises=function(){var e=this._bitField,t=65535&e;if(t>0){if(0!=(16842752&e)){var r=this._fulfillmentHandler0;this._settlePromise0(this._rejectionHandler0,r,e),this._rejectPromises(t,r)}else{var n=this._rejectionHandler0;this._settlePromise0(this._fulfillmentHandler0,n,e),this._fulfillPromises(t,n)}this._setLength(0)}this._clearCancellationData()},C.prototype._settledValue=function(){var e=this._bitField;return 0!=(33554432&e)?this._rejectionHandler0:0!=(16777216&e)?this._fulfillmentHandler0:void 0},"undefined"!=typeof Symbol&&Symbol.toStringTag&&l.defineProperty(C.prototype,Symbol.toStringTag,{get:function(){return"Object"}}),C.defer=C.pending=function(){return E.deprecated("Promise.defer","new Promise"),{promise:new C(m),resolve:O,reject:j}},c.notEnumerableProp(C,"_makeSelfResolutionError",n),t("./method")(C,m,g,i,E),t("./bind")(C,m,g,E),t("./cancel")(C,b,i,E),t("./direct_resolve")(C),t("./synchronous_inspection")(C),t("./join")(C,b,g,m,f,a),C.Promise=C,C.version="3.5.5",t("./call_get.js")(C),t("./generators.js")(C,i,m,g,s,E),t("./map.js")(C,b,i,g,m,E),t("./nodeify.js")(C),t("./promisify.js")(C,m),t("./props.js")(C,b,g,i),t("./race.js")(C,m,g,i),t("./reduce.js")(C,b,i,g,m,E),t("./settle.js")(C,b,E),t("./some.js")(C,b,i),t("./timers.js")(C,m,E),t("./using.js")(C,i,g,w,m,E),t("./any.js")(C),t("./each.js")(C,m),t("./filter.js")(C,m),c.toFastProperties(C),c.toFastProperties(C.prototype),A({a:1}),A({b:2}),A({c:3}),A(1),A((function(){})),A(void 0),A(!1),A(new C(m)),E.setBounds(d.firstLineError,c.lastLineError),C}},{"./any.js":1,"./async":2,"./bind":3,"./call_get.js":5,"./cancel":6,"./catch_filter":7,"./context":8,"./debuggability":9,"./direct_resolve":10,"./each.js":11,"./errors":12,"./es5":13,"./filter.js":14,"./finally":15,"./generators.js":16,"./join":17,"./map.js":18,"./method":19,"./nodeback":20,"./nodeify.js":21,"./promise_array":23,"./promisify.js":24,"./props.js":25,"./race.js":27,"./reduce.js":28,"./settle.js":30,"./some.js":31,"./synchronous_inspection":32,"./thenables":33,"./timers.js":34,"./using.js":35,"./util":36}],23:[function(e,t,r){"use strict";t.exports=function(t,r,n,o,i){var s=e("./util");s.isArray;function a(e){var n=this._promise=new t(r);e instanceof t&&n._propagateFrom(e,3),n._setOnCancel(this),this._values=e,this._length=0,this._totalResolved=0,this._init(void 0,-2)}return s.inherits(a,i),a.prototype.length=function(){return this._length},a.prototype.promise=function(){return this._promise},a.prototype._init=function e(r,i){var a=n(this._values,this._promise);if(a instanceof t){var u=(a=a._target())._bitField;if(this._values=a,0==(50397184&u))return this._promise._setAsyncGuaranteed(),a._then(e,this._reject,void 0,this,i);if(0==(33554432&u))return 0!=(16777216&u)?this._reject(a._reason()):this._cancel();a=a._value()}if(null!==(a=s.asArray(a)))0!==a.length?this._iterate(a):-5===i?this._resolveEmptyArray():this._resolve(function(e){switch(e){case-2:return[];case-3:return{};case-6:return new Map}}(i));else{var c=o("expecting an array or an iterable object but got "+s.classString(a)).reason();this._promise._rejectCallback(c,!1)}},a.prototype._iterate=function(e){var r=this.getActualLength(e.length);this._length=r,this._values=this.shouldCopyValues()?new Array(r):this._values;for(var o=this._promise,i=!1,s=null,a=0;a<r;++a){var u=n(e[a],o);s=u instanceof t?(u=u._target())._bitField:null,i?null!==s&&u.suppressUnhandledRejections():null!==s?0==(50397184&s)?(u._proxy(this,a),this._values[a]=u):i=0!=(33554432&s)?this._promiseFulfilled(u._value(),a):0!=(16777216&s)?this._promiseRejected(u._reason(),a):this._promiseCancelled(a):i=this._promiseFulfilled(u,a)}i||o._setAsyncGuaranteed()},a.prototype._isResolved=function(){return null===this._values},a.prototype._resolve=function(e){this._values=null,this._promise._fulfill(e)},a.prototype._cancel=function(){!this._isResolved()&&this._promise._isCancellable()&&(this._values=null,this._promise._cancel())},a.prototype._reject=function(e){this._values=null,this._promise._rejectCallback(e,!1)},a.prototype._promiseFulfilled=function(e,t){return this._values[t]=e,++this._totalResolved>=this._length&&(this._resolve(this._values),!0)},a.prototype._promiseCancelled=function(){return this._cancel(),!0},a.prototype._promiseRejected=function(e){return this._totalResolved++,this._reject(e),!0},a.prototype._resultCancelled=function(){if(!this._isResolved()){var e=this._values;if(this._cancel(),e instanceof t)e.cancel();else for(var r=0;r<e.length;++r)e[r]instanceof t&&e[r].cancel()}},a.prototype.shouldCopyValues=function(){return!0},a.prototype.getActualLength=function(e){return e},a}},{"./util":36}],24:[function(e,t,r){"use strict";t.exports=function(t,r){var n={},o=e("./util"),i=e("./nodeback"),s=o.withAppended,a=o.maybeWrapAsError,u=o.canEvaluate,c=e("./errors").TypeError,l={__isPromisified__:!0},d=new RegExp("^(?:"+["arity","length","name","arguments","caller","callee","prototype","__isPromisified__"].join("|")+")$"),f=function(e){return o.isIdentifier(e)&&"_"!==e.charAt(0)&&"constructor"!==e};function p(e){return!d.test(e)}function h(e){try{return!0===e.__isPromisified__}catch(e){return!1}}function v(e,t,r){var n=o.getDataPropertyOrDefault(e,t+r,l);return!!n&&h(n)}function m(e,t,r,n){for(var i=o.inheritedDataKeys(e),s=[],a=0;a<i.length;++a){var u=i[a],l=e[u],d=n===f||f(u,l,e);"function"!=typeof l||h(l)||v(e,u,t)||!n(u,l,e,d)||s.push(u,l)}return function(e,t,r){for(var n=0;n<e.length;n+=2){var o=e[n];if(r.test(o))for(var i=o.replace(r,""),s=0;s<e.length;s+=2)if(e[s]===i)throw new c("Cannot promisify an API that has normal methods with '%s'-suffix\n\n    See http://goo.gl/MqrFmX\n".replace("%s",t))}}(s,t,r),s}var y,_=function(e){return e.replace(/([$])/,"\\$")};var g=u?y:function(e,u,c,l,d,f){var p=function(){return this}(),h=e;function v(){var o=u;u===n&&(o=this);var c=new t(r);c._captureStackTrace();var l="string"==typeof h&&this!==p?this[h]:e,d=i(c,f);try{l.apply(o,s(arguments,d))}catch(e){c._rejectCallback(a(e),!0,!0)}return c._isFateSealed()||c._setAsyncGuaranteed(),c}return"string"==typeof h&&(e=l),o.notEnumerableProp(v,"__isPromisified__",!0),v};function b(e,t,r,i,s){for(var a=new RegExp(_(t)+"$"),u=m(e,t,a,r),c=0,l=u.length;c<l;c+=2){var d=u[c],f=u[c+1],p=d+t;if(i===g)e[p]=g(d,n,d,f,t,s);else{var h=i(f,(function(){return g(d,n,d,f,t,s)}));o.notEnumerableProp(h,"__isPromisified__",!0),e[p]=h}}return o.toFastProperties(e),e}t.promisify=function(e,t){if("function"!=typeof e)throw new c("expecting a function but got "+o.classString(e));if(h(e))return e;var r=function(e,t,r){return g(e,t,void 0,e,null,r)}(e,void 0===(t=Object(t)).context?n:t.context,!!t.multiArgs);return o.copyDescriptors(e,r,p),r},t.promisifyAll=function(e,t){if("function"!=typeof e&&"object"!=typeof e)throw new c("the target of promisifyAll must be an object or a function\n\n    See http://goo.gl/MqrFmX\n");var r=!!(t=Object(t)).multiArgs,n=t.suffix;"string"!=typeof n&&(n="Async");var i=t.filter;"function"!=typeof i&&(i=f);var s=t.promisifier;if("function"!=typeof s&&(s=g),!o.isIdentifier(n))throw new RangeError("suffix must be a valid identifier\n\n    See http://goo.gl/MqrFmX\n");for(var a=o.inheritedDataKeys(e),u=0;u<a.length;++u){var l=e[a[u]];"constructor"!==a[u]&&o.isClass(l)&&(b(l.prototype,n,i,s,r),b(l,n,i,s,r))}return b(e,n,i,s,r)}}},{"./errors":12,"./nodeback":20,"./util":36}],25:[function(e,t,r){"use strict";t.exports=function(t,r,n,o){var i,s=e("./util"),a=s.isObject,u=e("./es5");"function"==typeof Map&&(i=Map);var c=function(){var e=0,t=0;function r(r,n){this[e]=r,this[e+t]=n,e++}return function(n){t=n.size,e=0;var o=new Array(2*n.size);return n.forEach(r,o),o}}();function l(e){var t,r=!1;if(void 0!==i&&e instanceof i)t=c(e),r=!0;else{var n=u.keys(e),o=n.length;t=new Array(2*o);for(var s=0;s<o;++s){var a=n[s];t[s]=e[a],t[s+o]=a}}this.constructor$(t),this._isMap=r,this._init$(void 0,r?-6:-3)}function d(e){var r,i=n(e);return a(i)?(r=i instanceof t?i._then(t.props,void 0,void 0,void 0,void 0):new l(i).promise(),i instanceof t&&r._propagateFrom(i,2),r):o("cannot await properties of a non-object\n\n    See http://goo.gl/MqrFmX\n")}s.inherits(l,r),l.prototype._init=function(){},l.prototype._promiseFulfilled=function(e,t){if(this._values[t]=e,++this._totalResolved>=this._length){var r;if(this._isMap)r=function(e){for(var t=new i,r=e.length/2|0,n=0;n<r;++n){var o=e[r+n],s=e[n];t.set(o,s)}return t}(this._values);else{r={};for(var n=this.length(),o=0,s=this.length();o<s;++o)r[this._values[o+n]]=this._values[o]}return this._resolve(r),!0}return!1},l.prototype.shouldCopyValues=function(){return!1},l.prototype.getActualLength=function(e){return e>>1},t.prototype.props=function(){return d(this)},t.props=function(e){return d(e)}}},{"./es5":13,"./util":36}],26:[function(e,t,r){"use strict";function n(e){this._capacity=e,this._length=0,this._front=0}n.prototype._willBeOverCapacity=function(e){return this._capacity<e},n.prototype._pushOne=function(e){var t=this.length();this._checkCapacity(t+1),this[this._front+t&this._capacity-1]=e,this._length=t+1},n.prototype.push=function(e,t,r){var n=this.length()+3;if(this._willBeOverCapacity(n))return this._pushOne(e),this._pushOne(t),void this._pushOne(r);var o=this._front+n-3;this._checkCapacity(n);var i=this._capacity-1;this[o+0&i]=e,this[o+1&i]=t,this[o+2&i]=r,this._length=n},n.prototype.shift=function(){var e=this._front,t=this[e];return this[e]=void 0,this._front=e+1&this._capacity-1,this._length--,t},n.prototype.length=function(){return this._length},n.prototype._checkCapacity=function(e){this._capacity<e&&this._resizeTo(this._capacity<<1)},n.prototype._resizeTo=function(e){var t=this._capacity;this._capacity=e,function(e,t,r,n,o){for(var i=0;i<o;++i)r[i+n]=e[i+t],e[i+t]=void 0}(this,0,this,t,this._front+this._length&t-1)},t.exports=n},{}],27:[function(e,t,r){"use strict";t.exports=function(t,r,n,o){var i=e("./util"),s=function(e){return e.then((function(t){return a(t,e)}))};function a(e,a){var u=n(e);if(u instanceof t)return s(u);if(null===(e=i.asArray(e)))return o("expecting an array or an iterable object but got "+i.classString(e));var c=new t(r);void 0!==a&&c._propagateFrom(a,3);for(var l=c._fulfill,d=c._reject,f=0,p=e.length;f<p;++f){var h=e[f];(void 0!==h||f in e)&&t.cast(h)._then(l,d,void 0,c,null)}return c}t.race=function(e){return a(e,void 0)},t.prototype.race=function(){return a(this,void 0)}}},{"./util":36}],28:[function(e,t,r){"use strict";t.exports=function(t,r,n,o,i,s){var a=t._getDomain,u=e("./util"),c=u.tryCatch;function l(e,r,n,o){this.constructor$(e);var s=a();this._fn=null===s?r:u.domainBind(s,r),void 0!==n&&(n=t.resolve(n))._attachCancellationCallback(this),this._initialValue=n,this._currentCancellable=null,this._eachValues=o===i?Array(this._length):0===o?null:void 0,this._promise._captureStackTrace(),this._init$(void 0,-5)}function d(e,t){this.isFulfilled()?t._resolve(e):t._reject(e)}function f(e,t,r,o){return"function"!=typeof t?n("expecting a function but got "+u.classString(t)):new l(e,t,r,o).promise()}function p(e){this.accum=e,this.array._gotAccum(e);var r=o(this.value,this.array._promise);return r instanceof t?(this.array._currentCancellable=r,r._then(h,void 0,void 0,this,void 0)):h.call(this,r)}function h(e){var r,n=this.array,o=n._promise,i=c(n._fn);o._pushContext(),(r=void 0!==n._eachValues?i.call(o._boundValue(),e,this.index,this.length):i.call(o._boundValue(),this.accum,e,this.index,this.length))instanceof t&&(n._currentCancellable=r);var a=o._popContext();return s.checkForgottenReturns(r,a,void 0!==n._eachValues?"Promise.each":"Promise.reduce",o),r}u.inherits(l,r),l.prototype._gotAccum=function(e){void 0!==this._eachValues&&null!==this._eachValues&&e!==i&&this._eachValues.push(e)},l.prototype._eachComplete=function(e){return null!==this._eachValues&&this._eachValues.push(e),this._eachValues},l.prototype._init=function(){},l.prototype._resolveEmptyArray=function(){this._resolve(void 0!==this._eachValues?this._eachValues:this._initialValue)},l.prototype.shouldCopyValues=function(){return!1},l.prototype._resolve=function(e){this._promise._resolveCallback(e),this._values=null},l.prototype._resultCancelled=function(e){if(e===this._initialValue)return this._cancel();this._isResolved()||(this._resultCancelled$(),this._currentCancellable instanceof t&&this._currentCancellable.cancel(),this._initialValue instanceof t&&this._initialValue.cancel())},l.prototype._iterate=function(e){var r,n;this._values=e;var o=e.length;if(void 0!==this._initialValue?(r=this._initialValue,n=0):(r=t.resolve(e[0]),n=1),this._currentCancellable=r,!r.isRejected())for(;n<o;++n){var i={accum:null,value:e[n],index:n,length:o,array:this};r=r._then(p,void 0,void 0,i,void 0)}void 0!==this._eachValues&&(r=r._then(this._eachComplete,void 0,void 0,this,void 0)),r._then(d,d,void 0,r,this)},t.prototype.reduce=function(e,t){return f(this,e,t,null)},t.reduce=function(e,t,r,n){return f(e,t,r,n)}}},{"./util":36}],29:[function(t,r,i){"use strict";var s,a=t("./util"),u=a.getNativePromise();if(a.isNode&&"undefined"==typeof MutationObserver){var c=n.setImmediate,l=e.nextTick;s=a.isRecentNode?function(e){c.call(n,e)}:function(t){l.call(e,t)}}else if("function"==typeof u&&"function"==typeof u.resolve){var d=u.resolve();s=function(e){d.then(e)}}else s="undefined"!=typeof MutationObserver&&("undefined"==typeof window||!window.navigator||!window.navigator.standalone&&!window.cordova)&&"classList"in document.documentElement?function(){var e=document.createElement("div"),t={attributes:!0},r=!1,n=document.createElement("div");new MutationObserver((function(){e.classList.toggle("foo"),r=!1})).observe(n,t);return function(o){var i=new MutationObserver((function(){i.disconnect(),o()}));i.observe(e,t),r||(r=!0,n.classList.toggle("foo"))}}():void 0!==o?function(e){o(e)}:"undefined"!=typeof setTimeout?function(e){setTimeout(e,0)}:function(){throw new Error("No async scheduler available\n\n    See http://goo.gl/MqrFmX\n")};r.exports=s},{"./util":36}],30:[function(e,t,r){"use strict";t.exports=function(t,r,n){var o=t.PromiseInspection;function i(e){this.constructor$(e)}e("./util").inherits(i,r),i.prototype._promiseResolved=function(e,t){return this._values[e]=t,++this._totalResolved>=this._length&&(this._resolve(this._values),!0)},i.prototype._promiseFulfilled=function(e,t){var r=new o;return r._bitField=33554432,r._settledValueField=e,this._promiseResolved(t,r)},i.prototype._promiseRejected=function(e,t){var r=new o;return r._bitField=16777216,r._settledValueField=e,this._promiseResolved(t,r)},t.settle=function(e){return n.deprecated(".settle()",".reflect()"),new i(e).promise()},t.prototype.settle=function(){return t.settle(this)}}},{"./util":36}],31:[function(e,t,r){"use strict";t.exports=function(t,r,n){var o=e("./util"),i=e("./errors").RangeError,s=e("./errors").AggregateError,a=o.isArray,u={};function c(e){this.constructor$(e),this._howMany=0,this._unwrap=!1,this._initialized=!1}function l(e,t){if((0|t)!==t||t<0)return n("expecting a positive integer\n\n    See http://goo.gl/MqrFmX\n");var r=new c(e),o=r.promise();return r.setHowMany(t),r.init(),o}o.inherits(c,r),c.prototype._init=function(){if(this._initialized)if(0!==this._howMany){this._init$(void 0,-5);var e=a(this._values);!this._isResolved()&&e&&this._howMany>this._canPossiblyFulfill()&&this._reject(this._getRangeError(this.length()))}else this._resolve([])},c.prototype.init=function(){this._initialized=!0,this._init()},c.prototype.setUnwrap=function(){this._unwrap=!0},c.prototype.howMany=function(){return this._howMany},c.prototype.setHowMany=function(e){this._howMany=e},c.prototype._promiseFulfilled=function(e){return this._addFulfilled(e),this._fulfilled()===this.howMany()&&(this._values.length=this.howMany(),1===this.howMany()&&this._unwrap?this._resolve(this._values[0]):this._resolve(this._values),!0)},c.prototype._promiseRejected=function(e){return this._addRejected(e),this._checkOutcome()},c.prototype._promiseCancelled=function(){return this._values instanceof t||null==this._values?this._cancel():(this._addRejected(u),this._checkOutcome())},c.prototype._checkOutcome=function(){if(this.howMany()>this._canPossiblyFulfill()){for(var e=new s,t=this.length();t<this._values.length;++t)this._values[t]!==u&&e.push(this._values[t]);return e.length>0?this._reject(e):this._cancel(),!0}return!1},c.prototype._fulfilled=function(){return this._totalResolved},c.prototype._rejected=function(){return this._values.length-this.length()},c.prototype._addRejected=function(e){this._values.push(e)},c.prototype._addFulfilled=function(e){this._values[this._totalResolved++]=e},c.prototype._canPossiblyFulfill=function(){return this.length()-this._rejected()},c.prototype._getRangeError=function(e){var t="Input array must contain at least "+this._howMany+" items but contains only "+e+" items";return new i(t)},c.prototype._resolveEmptyArray=function(){this._reject(this._getRangeError(0))},t.some=function(e,t){return l(e,t)},t.prototype.some=function(e){return l(this,e)},t._SomePromiseArray=c}},{"./errors":12,"./util":36}],32:[function(e,t,r){"use strict";t.exports=function(e){function t(e){void 0!==e?(e=e._target(),this._bitField=e._bitField,this._settledValueField=e._isFateSealed()?e._settledValue():void 0):(this._bitField=0,this._settledValueField=void 0)}t.prototype._settledValue=function(){return this._settledValueField};var r=t.prototype.value=function(){if(!this.isFulfilled())throw new TypeError("cannot get fulfillment value of a non-fulfilled promise\n\n    See http://goo.gl/MqrFmX\n");return this._settledValue()},n=t.prototype.error=t.prototype.reason=function(){if(!this.isRejected())throw new TypeError("cannot get rejection reason of a non-rejected promise\n\n    See http://goo.gl/MqrFmX\n");return this._settledValue()},o=t.prototype.isFulfilled=function(){return 0!=(33554432&this._bitField)},i=t.prototype.isRejected=function(){return 0!=(16777216&this._bitField)},s=t.prototype.isPending=function(){return 0==(50397184&this._bitField)},a=t.prototype.isResolved=function(){return 0!=(50331648&this._bitField)};t.prototype.isCancelled=function(){return 0!=(8454144&this._bitField)},e.prototype.__isCancelled=function(){return 65536==(65536&this._bitField)},e.prototype._isCancelled=function(){return this._target().__isCancelled()},e.prototype.isCancelled=function(){return 0!=(8454144&this._target()._bitField)},e.prototype.isPending=function(){return s.call(this._target())},e.prototype.isRejected=function(){return i.call(this._target())},e.prototype.isFulfilled=function(){return o.call(this._target())},e.prototype.isResolved=function(){return a.call(this._target())},e.prototype.value=function(){return r.call(this._target())},e.prototype.reason=function(){var e=this._target();return e._unsetRejectionIsUnhandled(),n.call(e)},e.prototype._value=function(){return this._settledValue()},e.prototype._reason=function(){return this._unsetRejectionIsUnhandled(),this._settledValue()},e.PromiseInspection=t}},{}],33:[function(e,t,r){"use strict";t.exports=function(t,r){var n=e("./util"),o=n.errorObj,i=n.isObject;var s={}.hasOwnProperty;return function(e,a){if(i(e)){if(e instanceof t)return e;var u=function(e){try{return function(e){return e.then}(e)}catch(e){return o.e=e,o}}(e);if(u===o){a&&a._pushContext();var c=t.reject(u.e);return a&&a._popContext(),c}if("function"==typeof u){if(function(e){try{return s.call(e,"_promise0")}catch(e){return!1}}(e)){c=new t(r);return e._then(c._fulfill,c._reject,void 0,c,null),c}return function(e,i,s){var a=new t(r),u=a;s&&s._pushContext();a._captureStackTrace(),s&&s._popContext();var c=!0,l=n.tryCatch(i).call(e,(function(e){if(!a)return;a._resolveCallback(e),a=null}),(function(e){if(!a)return;a._rejectCallback(e,c,!0),a=null}));c=!1,a&&l===o&&(a._rejectCallback(l.e,!0,!0),a=null);return u}(e,u,a)}}return e}}},{"./util":36}],34:[function(e,t,r){"use strict";t.exports=function(t,r,n){var o=e("./util"),i=t.TimeoutError;function s(e){this.handle=e}s.prototype._resultCancelled=function(){clearTimeout(this.handle)};var a=function(e){return u(+this).thenReturn(e)},u=t.delay=function(e,o){var i,u;return void 0!==o?(i=t.resolve(o)._then(a,null,null,e,void 0),n.cancellation()&&o instanceof t&&i._setOnCancel(o)):(i=new t(r),u=setTimeout((function(){i._fulfill()}),+e),n.cancellation()&&i._setOnCancel(new s(u)),i._captureStackTrace()),i._setAsyncGuaranteed(),i};t.prototype.delay=function(e){return u(e,this)};function c(e){return clearTimeout(this.handle),e}function l(e){throw clearTimeout(this.handle),e}t.prototype.timeout=function(e,t){var r,a;e=+e;var u=new s(setTimeout((function(){r.isPending()&&function(e,t,r){var n;n="string"!=typeof t?t instanceof Error?t:new i("operation timed out"):new i(t),o.markAsOriginatingFromRejection(n),e._attachExtraTrace(n),e._reject(n),null!=r&&r.cancel()}(r,t,a)}),e));return n.cancellation()?(a=this.then(),(r=a._then(c,l,void 0,u,void 0))._setOnCancel(u)):r=this._then(c,l,void 0,u,void 0),r}}},{"./util":36}],35:[function(e,t,r){"use strict";t.exports=function(t,r,n,o,i,s){var a=e("./util"),u=e("./errors").TypeError,c=e("./util").inherits,l=a.errorObj,d=a.tryCatch,f={};function p(e){setTimeout((function(){throw e}),0)}function h(e,r){var o=0,s=e.length,a=new t(i);return function i(){if(o>=s)return a._fulfill();var u=function(e){var t=n(e);return t!==e&&"function"==typeof e._isDisposable&&"function"==typeof e._getDisposer&&e._isDisposable()&&t._setDisposable(e._getDisposer()),t}(e[o++]);if(u instanceof t&&u._isDisposable()){try{u=n(u._getDisposer().tryDispose(r),e.promise)}catch(e){return p(e)}if(u instanceof t)return u._then(i,p,null,null,null)}i()}(),a}function v(e,t,r){this._data=e,this._promise=t,this._context=r}function m(e,t,r){this.constructor$(e,t,r)}function y(e){return v.isDisposer(e)?(this.resources[this.index]._setDisposable(e),e.promise()):e}function _(e){this.length=e,this.promise=null,this[e-1]=null}v.prototype.data=function(){return this._data},v.prototype.promise=function(){return this._promise},v.prototype.resource=function(){return this.promise().isFulfilled()?this.promise().value():f},v.prototype.tryDispose=function(e){var t=this.resource(),r=this._context;void 0!==r&&r._pushContext();var n=t!==f?this.doDispose(t,e):null;return void 0!==r&&r._popContext(),this._promise._unsetDisposable(),this._data=null,n},v.isDisposer=function(e){return null!=e&&"function"==typeof e.resource&&"function"==typeof e.tryDispose},c(m,v),m.prototype.doDispose=function(e,t){return this.data().call(e,e,t)},_.prototype._resultCancelled=function(){for(var e=this.length,r=0;r<e;++r){var n=this[r];n instanceof t&&n.cancel()}},t.using=function(){var e=arguments.length;if(e<2)return r("you must pass at least 2 arguments to Promise.using");var o,i=arguments[e-1];if("function"!=typeof i)return r("expecting a function but got "+a.classString(i));var u=!0;2===e&&Array.isArray(arguments[0])?(e=(o=arguments[0]).length,u=!1):(o=arguments,e--);for(var c=new _(e),f=0;f<e;++f){var p=o[f];if(v.isDisposer(p)){var m=p;(p=p.promise())._setDisposable(m)}else{var g=n(p);g instanceof t&&(p=g._then(y,null,null,{resources:c,index:f},void 0))}c[f]=p}var b=new Array(c.length);for(f=0;f<b.length;++f)b[f]=t.resolve(c[f]).reflect();var k=t.all(b).then((function(e){for(var t=0;t<e.length;++t){var r=e[t];if(r.isRejected())return l.e=r.error(),l;if(!r.isFulfilled())return void k.cancel();e[t]=r.value()}w._pushContext(),i=d(i);var n=u?i.apply(void 0,e):i(e),o=w._popContext();return s.checkForgottenReturns(n,o,"Promise.using",w),n})),w=k.lastly((function(){var e=new t.PromiseInspection(k);return h(c,e)}));return c.promise=w,w._setOnCancel(c),w},t.prototype._setDisposable=function(e){this._bitField=131072|this._bitField,this._disposer=e},t.prototype._isDisposable=function(){return(131072&this._bitField)>0},t.prototype._getDisposer=function(){return this._disposer},t.prototype._unsetDisposable=function(){this._bitField=-131073&this._bitField,this._disposer=void 0},t.prototype.disposer=function(e){if("function"==typeof e)return new m(e,this,o());throw new u}}},{"./errors":12,"./util":36}],36:[function(t,r,o){"use strict";var i=t("./es5"),s="undefined"==typeof navigator,a={e:{}},u,c="undefined"!=typeof self?self:"undefined"!=typeof window?window:void 0!==n?n:void 0!==this?this:null;function l(){try{var e=u;return u=null,e.apply(this,arguments)}catch(e){return a.e=e,a}}function d(e){return u=e,l}var f=function(e,t){var r={}.hasOwnProperty;function n(){for(var n in this.constructor=e,this.constructor$=t,t.prototype)r.call(t.prototype,n)&&"$"!==n.charAt(n.length-1)&&(this[n+"$"]=t.prototype[n])}return n.prototype=t.prototype,e.prototype=new n,e.prototype};function p(e){return null==e||!0===e||!1===e||"string"==typeof e||"number"==typeof e}function h(e){return"function"==typeof e||"object"==typeof e&&null!==e}function v(e){return p(e)?new Error(T(e)):e}function m(e,t){var r,n=e.length,o=new Array(n+1);for(r=0;r<n;++r)o[r]=e[r];return o[r]=t,o}function y(e,t,r){if(!i.isES5)return{}.hasOwnProperty.call(e,t)?e[t]:void 0;var n=Object.getOwnPropertyDescriptor(e,t);return null!=n?null==n.get&&null==n.set?n.value:r:void 0}function _(e,t,r){if(p(e))return e;var n={value:r,configurable:!0,enumerable:!1,writable:!0};return i.defineProperty(e,t,n),e}function g(e){throw e}var b=function(){var e=[Array.prototype,Object.prototype,Function.prototype],t=function(t){for(var r=0;r<e.length;++r)if(e[r]===t)return!0;return!1};if(i.isES5){var r=Object.getOwnPropertyNames;return function(e){for(var n=[],o=Object.create(null);null!=e&&!t(e);){var s;try{s=r(e)}catch(e){return n}for(var a=0;a<s.length;++a){var u=s[a];if(!o[u]){o[u]=!0;var c=Object.getOwnPropertyDescriptor(e,u);null!=c&&null==c.get&&null==c.set&&n.push(u)}}e=i.getPrototypeOf(e)}return n}}var n={}.hasOwnProperty;return function(r){if(t(r))return[];var o=[];e:for(var i in r)if(n.call(r,i))o.push(i);else{for(var s=0;s<e.length;++s)if(n.call(e[s],i))continue e;o.push(i)}return o}}(),k=/this\s*\.\s*\S+\s*=/;function w(e){try{if("function"==typeof e){var t=i.names(e.prototype),r=i.isES5&&t.length>1,n=t.length>0&&!(1===t.length&&"constructor"===t[0]),o=k.test(e+"")&&i.names(e).length>0;if(r||n||o)return!0}return!1}catch(e){return!1}}function E(e){function t(){}t.prototype=e;var r=new t;function n(){return typeof r.foo}return n(),n(),e}var S=/^[a-z$_][a-z$_0-9]*$/i;function x(e){return S.test(e)}function R(e,t,r){for(var n=new Array(e),o=0;o<e;++o)n[o]=t+o+r;return n}function T(e){try{return e+""}catch(e){return"[no string representation]"}}function I(e){return e instanceof Error||null!==e&&"object"==typeof e&&"string"==typeof e.message&&"string"==typeof e.name}function C(e){try{_(e,"isOperational",!0)}catch(e){}}function O(e){return null!=e&&(e instanceof Error.__BluebirdErrorTypes__.OperationalError||!0===e.isOperational)}function j(e){return I(e)&&i.propertyIsWritable(e,"stack")}var A="stack"in new Error?function(e){return j(e)?e:new Error(T(e))}:function(e){if(j(e))return e;try{throw new Error(T(e))}catch(e){return e}};function D(e){return{}.toString.call(e)}function M(e,t,r){for(var n=i.names(e),o=0;o<n.length;++o){var s=n[o];if(r(s))try{i.defineProperty(t,s,i.getDescriptor(e,s))}catch(e){}}}var P=function(e){return i.isArray(e)?e:null};if("undefined"!=typeof Symbol&&Symbol.iterator){var U="function"==typeof Array.from?function(e){return Array.from(e)}:function(e){for(var t,r=[],n=e[Symbol.iterator]();!(t=n.next()).done;)r.push(t.value);return r};P=function(e){return i.isArray(e)?e:null!=e&&"function"==typeof e[Symbol.iterator]?U(e):null}}var L=void 0!==e&&"[object process]"===D(e).toLowerCase(),F=void 0!==e&&void 0!==e.env;function N(t){return F?e.env[t]:void 0}function K(){if("function"==typeof Promise)try{var e=new Promise((function(){}));if("[object Promise]"==={}.toString.call(e))return Promise}catch(e){}}function q(e,t){return e.bind(t)}var B={isClass:w,isIdentifier:x,inheritedDataKeys:b,getDataPropertyOrDefault:y,thrower:g,isArray:i.isArray,asArray:P,notEnumerableProp:_,isPrimitive:p,isObject:h,isError:I,canEvaluate:s,errorObj:a,tryCatch:d,inherits:f,withAppended:m,maybeWrapAsError:v,toFastProperties:E,filledRange:R,toString:T,canAttachTrace:j,ensureErrorObject:A,originatesFromRejection:O,markAsOriginatingFromRejection:C,classString:D,copyDescriptors:M,hasDevTools:"undefined"!=typeof chrome&&chrome&&"function"==typeof chrome.loadTimes,isNode:L,hasEnvVariables:F,env:N,global:c,getNativePromise:K,domainBind:q},G;B.isRecentNode=B.isNode&&(e.versions&&e.versions.node?G=e.versions.node.split(".").map(Number):e.version&&(G=e.version.split(".").map(Number)),0===G[0]&&G[1]>10||G[0]>0),B.isNode&&B.toFastProperties(e);try{throw new Error}catch(e){B.lastLineError=e}r.exports=B},{"./es5":13}]},{},[4])(4)})),"undefined"!=typeof window&&null!==window?window.P=window.Promise:"undefined"!=typeof self&&null!==self&&(self.P=self.Promise)}).call(this,e("_process"),"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},e("timers").setImmediate)},{_process:260,timers:273}],104:[function(e,t,r){var n,o;n=this,o=function(){var e=XMLHttpRequest;if(!e)throw new Error("missing XMLHttpRequest");function t(i,s){if("function"!=typeof s)throw new Error("Bad callback given: "+s);if(!i)throw new Error("No options given");var a=i.onResponse;if((i="string"==typeof i?{uri:i}:JSON.parse(JSON.stringify(i))).onResponse=a,i.verbose&&(t.log=function(){var e,t,r={},i=["trace","debug","info","warn","error"];for(t=0;t<i.length;t++)r[e=i[t]]=n,"undefined"!=typeof console&&console&&console[e]&&(r[e]=o(console,e));return r}()),i.url&&(i.uri=i.url,delete i.url),!i.uri&&""!==i.uri)throw new Error("options.uri is a required argument");if("string"!=typeof i.uri)throw new Error("options.uri must be a string");for(var u=["proxy","_redirectsFollowed","maxRedirects","followRedirect"],c=0;c<u.length;c++)if(i[u[c]])throw new Error("options."+u[c]+" is not supported");if(i.callback=s,i.method=i.method||"GET",i.headers=i.headers||{},i.body=i.body||null,i.timeout=i.timeout||t.DEFAULT_TIMEOUT,i.headers.host)throw new Error("Options.headers.host is not supported");i.json&&(i.headers.accept=i.headers.accept||"application/json","GET"!==i.method&&(i.headers["content-type"]="application/json"),"boolean"!=typeof i.json?i.body=JSON.stringify(i.json):"string"!=typeof i.body&&(i.body=JSON.stringify(i.body)));var l=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push(encodeURIComponent(r)+"="+encodeURIComponent(e[r]));return t.join("&")};if(i.qs){var d="string"==typeof i.qs?i.qs:l(i.qs);-1!==i.uri.indexOf("?")?i.uri=i.uri+"&"+d:i.uri=i.uri+"?"+d}if(i.form){if("string"==typeof i.form)throw"form name unsupported";if("POST"===i.method){var f=(i.encoding||"application/x-www-form-urlencoded").toLowerCase();switch(i.headers["content-type"]=f,f){case"application/x-www-form-urlencoded":i.body=l(i.form).replace(/%20/g,"+");break;case"multipart/form-data":var p=function(e){var t={};t.boundry="-------------------------------"+Math.floor(1e9*Math.random());var r=[];for(var n in e)e.hasOwnProperty(n)&&r.push("--"+t.boundry+'\nContent-Disposition: form-data; name="'+n+'"\n\n'+e[n]+"\n");return r.push("--"+t.boundry+"--"),t.body=r.join(""),t.length=t.body.length,t.type="multipart/form-data; boundary="+t.boundry,t}(i.form);i.body=p.body,i.headers["content-type"]=p.type;break;default:throw new Error("unsupported encoding:"+f)}}}return i.onResponse=i.onResponse||n,!0===i.onResponse&&(i.onResponse=s,i.callback=n),!i.headers.authorization&&i.auth&&(i.headers.authorization="Basic "+function(e){var t,r,n,o,i,s,a,u,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",l=0,d=0,f="",p=[];if(!e)return e;do{t=e.charCodeAt(l++),r=e.charCodeAt(l++),n=e.charCodeAt(l++),o=(u=t<<16|r<<8|n)>>18&63,i=u>>12&63,s=u>>6&63,a=63&u,p[d++]=c.charAt(o)+c.charAt(i)+c.charAt(s)+c.charAt(a)}while(l<e.length);switch(f=p.join(""),e.length%3){case 1:f=f.slice(0,-2)+"==";break;case 2:f=f.slice(0,-1)+"="}return f}(i.auth.username+":"+i.auth.password)),function(n){var o=new e,i=!1,s=function(e){var t,r=/^([\w\+\.\-]+:)(?:\/\/([^\/?#:]*)(?::(\d+))?)?/;try{t=location.href}catch(e){(t=document.createElement("a")).href="",t=t.href}var n=r.exec(t.toLowerCase())||[],o=r.exec(e.toLowerCase());return!(!o||o[1]==n[1]&&o[2]==n[2]&&(o[3]||("http:"===o[1]?80:443))==(n[3]||("http:"===n[1]?80:443)))}(n.uri),a="withCredentials"in o;if(r+=1,o.seq_id=r,o.id=r+": "+n.method+" "+n.uri,o._id=o.id,s&&!a){var u=new Error("Browser does not support cross-origin request: "+n.uri);return u.cors="unsupported",n.callback(u,o)}o.timeoutTimer=setTimeout((function(){i=!0;var e=new Error("ETIMEDOUT");return e.code="ETIMEDOUT",e.duration=n.timeout,t.log.error("Timeout",{id:o._id,milliseconds:n.timeout}),n.callback(e,o)}),n.timeout);var c={response:!1,loading:!1,end:!1};return o.onreadystatechange=function(r){if(i)return t.log.debug("Ignoring timed out state change",{state:o.readyState,id:o.id});if(t.log.debug("State change",{state:o.readyState,id:o.id,timed_out:i}),o.readyState===e.OPENED)for(var s in t.log.debug("Request started",{id:o.id}),n.headers)o.setRequestHeader(s,n.headers[s]);else o.readyState===e.HEADERS_RECEIVED?l():o.readyState===e.LOADING?(l(),d()):o.readyState===e.DONE&&(l(),d(),function(){if(!c.end){if(c.end=!0,t.log.debug("Request done",{id:o.id}),o.body=o.responseText,n.json)try{o.body=JSON.parse(o.responseText)}catch(e){return n.callback(e,o)}n.callback(null,o,o.body)}}())},o.open(n.method,n.uri,!0),s&&(o.withCredentials=!!n.withCredentials),o.send(n.body),o;function l(){if(!c.response){if(c.response=!0,t.log.debug("Got response",{id:o.id,status:o.status}),clearTimeout(o.timeoutTimer),o.statusCode=o.status,s&&0==o.statusCode){var e=new Error("CORS request rejected: "+n.uri);return e.cors="rejected",c.loading=!0,c.end=!0,n.callback(e,o)}n.onResponse(null,o)}}function d(){c.loading||(c.loading=!0,t.log.debug("Response body loading",{id:o.id}))}}(i)}t.log={trace:n,debug:n,info:n,warn:n,error:n};var r=0;function n(){}function o(e,t){return function(r,n){return"object"==typeof n&&(r+=" "+JSON.stringify(n)),e[t].call(e,r)}}return t.withCredentials=!1,t.DEFAULT_TIMEOUT=18e4,t.defaults=function(e,r){var n=function(t){return function(r,n){for(var o in r="string"==typeof r?{uri:r}:JSON.parse(JSON.stringify(r)),e)void 0===r[o]&&(r[o]=e[o]);return t(r,n)}},o=n(t);return o.get=n(t.get),o.post=n(t.post),o.put=n(t.put),o.head=n(t.head),o},["get","put","post","head"].forEach((function(e){var r=e.toUpperCase();t[e.toLowerCase()]=function(e){"string"==typeof e?e={method:r,uri:e}:(e=JSON.parse(JSON.stringify(e))).method=r;var n=[e].concat(Array.prototype.slice.apply(arguments,[1]));return t.apply(this,n)}})),t.couch=function(e,r){return"string"==typeof e&&(e={uri:e}),e.json=!0,e.body&&(e.json=e.body),delete e.body,r=r||n,t(e,(function(e,t,n){if(e)return r(e,t,n);if((t.statusCode<200||t.statusCode>299)&&n.error){for(var o in e=new Error("CouchDB error: "+(n.error.reason||n.error.error)),n)e[o]=n[o];return r(e,t,n)}return r(e,t,n)}))},t},"function"==typeof define&&define.amd?define([],o):"object"==typeof r?t.exports=o():n.returnExports=o()},{}],105:[function(e,t,r){var n=e("base-x");t.exports=n("123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz")},{"base-x":101}],106:[function(e,t,r){(function(t){
/*!
 * The buffer module from node.js, for the browser.
 *
 * @author   Feross Aboukhadijeh <https://feross.org>
 * @license  MIT
 */
"use strict";var n=e("base64-js"),o=e("ieee754"),i="function"==typeof Symbol&&"function"==typeof Symbol.for?Symbol.for("nodejs.util.inspect.custom"):null;r.Buffer=t,r.SlowBuffer=function(e){+e!=e&&(e=0);return t.alloc(+e)},r.INSPECT_MAX_BYTES=50;var s=2147483647;function a(e){if(e>s)throw new RangeError('The value "'+e+'" is invalid for option "size"');var r=new Uint8Array(e);return Object.setPrototypeOf(r,t.prototype),r}function t(e,t,r){if("number"==typeof e){if("string"==typeof t)throw new TypeError('The "string" argument must be of type string. Received type number');return l(e)}return u(e,t,r)}function u(e,r,n){if("string"==typeof e)return function(e,r){"string"==typeof r&&""!==r||(r="utf8");if(!t.isEncoding(r))throw new TypeError("Unknown encoding: "+r);var n=0|p(e,r),o=a(n),i=o.write(e,r);i!==n&&(o=o.slice(0,i));return o}(e,r);if(ArrayBuffer.isView(e))return d(e);if(null==e)throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e);if(K(e,ArrayBuffer)||e&&K(e.buffer,ArrayBuffer))return function(e,r,n){if(r<0||e.byteLength<r)throw new RangeError('"offset" is outside of buffer bounds');if(e.byteLength<r+(n||0))throw new RangeError('"length" is outside of buffer bounds');var o;o=void 0===r&&void 0===n?new Uint8Array(e):void 0===n?new Uint8Array(e,r):new Uint8Array(e,r,n);return Object.setPrototypeOf(o,t.prototype),o}(e,r,n);if("number"==typeof e)throw new TypeError('The "value" argument must not be of type number. Received type number');var o=e.valueOf&&e.valueOf();if(null!=o&&o!==e)return t.from(o,r,n);var i=function(e){if(t.isBuffer(e)){var r=0|f(e.length),n=a(r);return 0===n.length?n:(e.copy(n,0,0,r),n)}if(void 0!==e.length)return"number"!=typeof e.length||q(e.length)?a(0):d(e);if("Buffer"===e.type&&Array.isArray(e.data))return d(e.data)}(e);if(i)return i;if("undefined"!=typeof Symbol&&null!=Symbol.toPrimitive&&"function"==typeof e[Symbol.toPrimitive])return t.from(e[Symbol.toPrimitive]("string"),r,n);throw new TypeError("The first argument must be one of type string, Buffer, ArrayBuffer, Array, or Array-like Object. Received type "+typeof e)}function c(e){if("number"!=typeof e)throw new TypeError('"size" argument must be of type number');if(e<0)throw new RangeError('The value "'+e+'" is invalid for option "size"')}function l(e){return c(e),a(e<0?0:0|f(e))}function d(e){for(var t=e.length<0?0:0|f(e.length),r=a(t),n=0;n<t;n+=1)r[n]=255&e[n];return r}function f(e){if(e>=s)throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+s.toString(16)+" bytes");return 0|e}function p(e,r){if(t.isBuffer(e))return e.length;if(ArrayBuffer.isView(e)||K(e,ArrayBuffer))return e.byteLength;if("string"!=typeof e)throw new TypeError('The "string" argument must be one of type string, Buffer, or ArrayBuffer. Received type '+typeof e);var n=e.length,o=arguments.length>2&&!0===arguments[2];if(!o&&0===n)return 0;for(var i=!1;;)switch(r){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":return L(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return F(e).length;default:if(i)return o?-1:L(e).length;r=(""+r).toLowerCase(),i=!0}}function h(e,t,r){var n=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===r||r>this.length)&&(r=this.length),r<=0)return"";if((r>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return C(this,t,r);case"utf8":case"utf-8":return x(this,t,r);case"ascii":return T(this,t,r);case"latin1":case"binary":return I(this,t,r);case"base64":return S(this,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return O(this,t,r);default:if(n)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),n=!0}}function v(e,t,r){var n=e[t];e[t]=e[r],e[r]=n}function m(e,r,n,o,i){if(0===e.length)return-1;if("string"==typeof n?(o=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),q(n=+n)&&(n=i?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(i)return-1;n=e.length-1}else if(n<0){if(!i)return-1;n=0}if("string"==typeof r&&(r=t.from(r,o)),t.isBuffer(r))return 0===r.length?-1:y(e,r,n,o,i);if("number"==typeof r)return r&=255,"function"==typeof Uint8Array.prototype.indexOf?i?Uint8Array.prototype.indexOf.call(e,r,n):Uint8Array.prototype.lastIndexOf.call(e,r,n):y(e,[r],n,o,i);throw new TypeError("val must be string, number or Buffer")}function y(e,t,r,n,o){var i,s=1,a=e.length,u=t.length;if(void 0!==n&&("ucs2"===(n=String(n).toLowerCase())||"ucs-2"===n||"utf16le"===n||"utf-16le"===n)){if(e.length<2||t.length<2)return-1;s=2,a/=2,u/=2,r/=2}function c(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(o){var l=-1;for(i=r;i<a;i++)if(c(e,i)===c(t,-1===l?0:i-l)){if(-1===l&&(l=i),i-l+1===u)return l*s}else-1!==l&&(i-=i-l),l=-1}else for(r+u>a&&(r=a-u),i=r;i>=0;i--){for(var d=!0,f=0;f<u;f++)if(c(e,i+f)!==c(t,f)){d=!1;break}if(d)return i}return-1}function _(e,t,r,n){r=Number(r)||0;var o=e.length-r;n?(n=Number(n))>o&&(n=o):n=o;var i=t.length;n>i/2&&(n=i/2);for(var s=0;s<n;++s){var a=parseInt(t.substr(2*s,2),16);if(q(a))return s;e[r+s]=a}return s}function g(e,t,r,n){return N(L(t,e.length-r),e,r,n)}function b(e,t,r,n){return N(function(e){for(var t=[],r=0;r<e.length;++r)t.push(255&e.charCodeAt(r));return t}(t),e,r,n)}function k(e,t,r,n){return b(e,t,r,n)}function w(e,t,r,n){return N(F(t),e,r,n)}function E(e,t,r,n){return N(function(e,t){for(var r,n,o,i=[],s=0;s<e.length&&!((t-=2)<0);++s)r=e.charCodeAt(s),n=r>>8,o=r%256,i.push(o),i.push(n);return i}(t,e.length-r),e,r,n)}function S(e,t,r){return 0===t&&r===e.length?n.fromByteArray(e):n.fromByteArray(e.slice(t,r))}function x(e,t,r){r=Math.min(e.length,r);for(var n=[],o=t;o<r;){var i,s,a,u,c=e[o],l=null,d=c>239?4:c>223?3:c>191?2:1;if(o+d<=r)switch(d){case 1:c<128&&(l=c);break;case 2:128==(192&(i=e[o+1]))&&(u=(31&c)<<6|63&i)>127&&(l=u);break;case 3:i=e[o+1],s=e[o+2],128==(192&i)&&128==(192&s)&&(u=(15&c)<<12|(63&i)<<6|63&s)>2047&&(u<55296||u>57343)&&(l=u);break;case 4:i=e[o+1],s=e[o+2],a=e[o+3],128==(192&i)&&128==(192&s)&&128==(192&a)&&(u=(15&c)<<18|(63&i)<<12|(63&s)<<6|63&a)>65535&&u<1114112&&(l=u)}null===l?(l=65533,d=1):l>65535&&(l-=65536,n.push(l>>>10&1023|55296),l=56320|1023&l),n.push(l),o+=d}return function(e){var t=e.length;if(t<=R)return String.fromCharCode.apply(String,e);var r="",n=0;for(;n<t;)r+=String.fromCharCode.apply(String,e.slice(n,n+=R));return r}(n)}r.kMaxLength=s,t.TYPED_ARRAY_SUPPORT=function(){try{var e=new Uint8Array(1),t={foo:function(){return 42}};return Object.setPrototypeOf(t,Uint8Array.prototype),Object.setPrototypeOf(e,t),42===e.foo()}catch(e){return!1}}(),t.TYPED_ARRAY_SUPPORT||"undefined"==typeof console||"function"!=typeof console.error||console.error("This browser lacks typed array (Uint8Array) support which is required by `buffer` v5.x. Use `buffer` v4.x if you require old browser support."),Object.defineProperty(t.prototype,"parent",{enumerable:!0,get:function(){if(t.isBuffer(this))return this.buffer}}),Object.defineProperty(t.prototype,"offset",{enumerable:!0,get:function(){if(t.isBuffer(this))return this.byteOffset}}),"undefined"!=typeof Symbol&&null!=Symbol.species&&t[Symbol.species]===t&&Object.defineProperty(t,Symbol.species,{value:null,configurable:!0,enumerable:!1,writable:!1}),t.poolSize=8192,t.from=function(e,t,r){return u(e,t,r)},Object.setPrototypeOf(t.prototype,Uint8Array.prototype),Object.setPrototypeOf(t,Uint8Array),t.alloc=function(e,t,r){return function(e,t,r){return c(e),e<=0?a(e):void 0!==t?"string"==typeof r?a(e).fill(t,r):a(e).fill(t):a(e)}(e,t,r)},t.allocUnsafe=function(e){return l(e)},t.allocUnsafeSlow=function(e){return l(e)},t.isBuffer=function(e){return null!=e&&!0===e._isBuffer&&e!==t.prototype},t.compare=function(e,r){if(K(e,Uint8Array)&&(e=t.from(e,e.offset,e.byteLength)),K(r,Uint8Array)&&(r=t.from(r,r.offset,r.byteLength)),!t.isBuffer(e)||!t.isBuffer(r))throw new TypeError('The "buf1", "buf2" arguments must be one of type Buffer or Uint8Array');if(e===r)return 0;for(var n=e.length,o=r.length,i=0,s=Math.min(n,o);i<s;++i)if(e[i]!==r[i]){n=e[i],o=r[i];break}return n<o?-1:o<n?1:0},t.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},t.concat=function(e,r){if(!Array.isArray(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return t.alloc(0);var n;if(void 0===r)for(r=0,n=0;n<e.length;++n)r+=e[n].length;var o=t.allocUnsafe(r),i=0;for(n=0;n<e.length;++n){var s=e[n];if(K(s,Uint8Array)&&(s=t.from(s)),!t.isBuffer(s))throw new TypeError('"list" argument must be an Array of Buffers');s.copy(o,i),i+=s.length}return o},t.byteLength=p,t.prototype._isBuffer=!0,t.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)v(this,t,t+1);return this},t.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)v(this,t,t+3),v(this,t+1,t+2);return this},t.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)v(this,t,t+7),v(this,t+1,t+6),v(this,t+2,t+5),v(this,t+3,t+4);return this},t.prototype.toString=function(){var e=this.length;return 0===e?"":0===arguments.length?x(this,0,e):h.apply(this,arguments)},t.prototype.toLocaleString=t.prototype.toString,t.prototype.equals=function(e){if(!t.isBuffer(e))throw new TypeError("Argument must be a Buffer");return this===e||0===t.compare(this,e)},t.prototype.inspect=function(){var e="",t=r.INSPECT_MAX_BYTES;return e=this.toString("hex",0,t).replace(/(.{2})/g,"$1 ").trim(),this.length>t&&(e+=" ... "),"<Buffer "+e+">"},i&&(t.prototype[i]=t.prototype.inspect),t.prototype.compare=function(e,r,n,o,i){if(K(e,Uint8Array)&&(e=t.from(e,e.offset,e.byteLength)),!t.isBuffer(e))throw new TypeError('The "target" argument must be one of type Buffer or Uint8Array. Received type '+typeof e);if(void 0===r&&(r=0),void 0===n&&(n=e?e.length:0),void 0===o&&(o=0),void 0===i&&(i=this.length),r<0||n>e.length||o<0||i>this.length)throw new RangeError("out of range index");if(o>=i&&r>=n)return 0;if(o>=i)return-1;if(r>=n)return 1;if(this===e)return 0;for(var s=(i>>>=0)-(o>>>=0),a=(n>>>=0)-(r>>>=0),u=Math.min(s,a),c=this.slice(o,i),l=e.slice(r,n),d=0;d<u;++d)if(c[d]!==l[d]){s=c[d],a=l[d];break}return s<a?-1:a<s?1:0},t.prototype.includes=function(e,t,r){return-1!==this.indexOf(e,t,r)},t.prototype.indexOf=function(e,t,r){return m(this,e,t,r,!0)},t.prototype.lastIndexOf=function(e,t,r){return m(this,e,t,r,!1)},t.prototype.write=function(e,t,r,n){if(void 0===t)n="utf8",r=this.length,t=0;else if(void 0===r&&"string"==typeof t)n=t,r=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t>>>=0,isFinite(r)?(r>>>=0,void 0===n&&(n="utf8")):(n=r,r=void 0)}var o=this.length-t;if((void 0===r||r>o)&&(r=o),e.length>0&&(r<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");n||(n="utf8");for(var i=!1;;)switch(n){case"hex":return _(this,e,t,r);case"utf8":case"utf-8":return g(this,e,t,r);case"ascii":return b(this,e,t,r);case"latin1":case"binary":return k(this,e,t,r);case"base64":return w(this,e,t,r);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return E(this,e,t,r);default:if(i)throw new TypeError("Unknown encoding: "+n);n=(""+n).toLowerCase(),i=!0}},t.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var R=4096;function T(e,t,r){var n="";r=Math.min(e.length,r);for(var o=t;o<r;++o)n+=String.fromCharCode(127&e[o]);return n}function I(e,t,r){var n="";r=Math.min(e.length,r);for(var o=t;o<r;++o)n+=String.fromCharCode(e[o]);return n}function C(e,t,r){var n=e.length;(!t||t<0)&&(t=0),(!r||r<0||r>n)&&(r=n);for(var o="",i=t;i<r;++i)o+=B[e[i]];return o}function O(e,t,r){for(var n=e.slice(t,r),o="",i=0;i<n.length;i+=2)o+=String.fromCharCode(n[i]+256*n[i+1]);return o}function j(e,t,r){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>r)throw new RangeError("Trying to access beyond buffer length")}function A(e,r,n,o,i,s){if(!t.isBuffer(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(r>i||r<s)throw new RangeError('"value" argument is out of bounds');if(n+o>e.length)throw new RangeError("Index out of range")}function D(e,t,r,n,o,i){if(r+n>e.length)throw new RangeError("Index out of range");if(r<0)throw new RangeError("Index out of range")}function M(e,t,r,n,i){return t=+t,r>>>=0,i||D(e,0,r,4),o.write(e,t,r,n,23,4),r+4}function P(e,t,r,n,i){return t=+t,r>>>=0,i||D(e,0,r,8),o.write(e,t,r,n,52,8),r+8}t.prototype.slice=function(e,r){var n=this.length;(e=~~e)<0?(e+=n)<0&&(e=0):e>n&&(e=n),(r=void 0===r?n:~~r)<0?(r+=n)<0&&(r=0):r>n&&(r=n),r<e&&(r=e);var o=this.subarray(e,r);return Object.setPrototypeOf(o,t.prototype),o},t.prototype.readUIntLE=function(e,t,r){e>>>=0,t>>>=0,r||j(e,t,this.length);for(var n=this[e],o=1,i=0;++i<t&&(o*=256);)n+=this[e+i]*o;return n},t.prototype.readUIntBE=function(e,t,r){e>>>=0,t>>>=0,r||j(e,t,this.length);for(var n=this[e+--t],o=1;t>0&&(o*=256);)n+=this[e+--t]*o;return n},t.prototype.readUInt8=function(e,t){return e>>>=0,t||j(e,1,this.length),this[e]},t.prototype.readUInt16LE=function(e,t){return e>>>=0,t||j(e,2,this.length),this[e]|this[e+1]<<8},t.prototype.readUInt16BE=function(e,t){return e>>>=0,t||j(e,2,this.length),this[e]<<8|this[e+1]},t.prototype.readUInt32LE=function(e,t){return e>>>=0,t||j(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},t.prototype.readUInt32BE=function(e,t){return e>>>=0,t||j(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},t.prototype.readIntLE=function(e,t,r){e>>>=0,t>>>=0,r||j(e,t,this.length);for(var n=this[e],o=1,i=0;++i<t&&(o*=256);)n+=this[e+i]*o;return n>=(o*=128)&&(n-=Math.pow(2,8*t)),n},t.prototype.readIntBE=function(e,t,r){e>>>=0,t>>>=0,r||j(e,t,this.length);for(var n=t,o=1,i=this[e+--n];n>0&&(o*=256);)i+=this[e+--n]*o;return i>=(o*=128)&&(i-=Math.pow(2,8*t)),i},t.prototype.readInt8=function(e,t){return e>>>=0,t||j(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},t.prototype.readInt16LE=function(e,t){e>>>=0,t||j(e,2,this.length);var r=this[e]|this[e+1]<<8;return 32768&r?4294901760|r:r},t.prototype.readInt16BE=function(e,t){e>>>=0,t||j(e,2,this.length);var r=this[e+1]|this[e]<<8;return 32768&r?4294901760|r:r},t.prototype.readInt32LE=function(e,t){return e>>>=0,t||j(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},t.prototype.readInt32BE=function(e,t){return e>>>=0,t||j(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},t.prototype.readFloatLE=function(e,t){return e>>>=0,t||j(e,4,this.length),o.read(this,e,!0,23,4)},t.prototype.readFloatBE=function(e,t){return e>>>=0,t||j(e,4,this.length),o.read(this,e,!1,23,4)},t.prototype.readDoubleLE=function(e,t){return e>>>=0,t||j(e,8,this.length),o.read(this,e,!0,52,8)},t.prototype.readDoubleBE=function(e,t){return e>>>=0,t||j(e,8,this.length),o.read(this,e,!1,52,8)},t.prototype.writeUIntLE=function(e,t,r,n){(e=+e,t>>>=0,r>>>=0,n)||A(this,e,t,r,Math.pow(2,8*r)-1,0);var o=1,i=0;for(this[t]=255&e;++i<r&&(o*=256);)this[t+i]=e/o&255;return t+r},t.prototype.writeUIntBE=function(e,t,r,n){(e=+e,t>>>=0,r>>>=0,n)||A(this,e,t,r,Math.pow(2,8*r)-1,0);var o=r-1,i=1;for(this[t+o]=255&e;--o>=0&&(i*=256);)this[t+o]=e/i&255;return t+r},t.prototype.writeUInt8=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,1,255,0),this[t]=255&e,t+1},t.prototype.writeUInt16LE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,2,65535,0),this[t]=255&e,this[t+1]=e>>>8,t+2},t.prototype.writeUInt16BE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,2,65535,0),this[t]=e>>>8,this[t+1]=255&e,t+2},t.prototype.writeUInt32LE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,4,4294967295,0),this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e,t+4},t.prototype.writeUInt32BE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,4,4294967295,0),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},t.prototype.writeIntLE=function(e,t,r,n){if(e=+e,t>>>=0,!n){var o=Math.pow(2,8*r-1);A(this,e,t,r,o-1,-o)}var i=0,s=1,a=0;for(this[t]=255&e;++i<r&&(s*=256);)e<0&&0===a&&0!==this[t+i-1]&&(a=1),this[t+i]=(e/s>>0)-a&255;return t+r},t.prototype.writeIntBE=function(e,t,r,n){if(e=+e,t>>>=0,!n){var o=Math.pow(2,8*r-1);A(this,e,t,r,o-1,-o)}var i=r-1,s=1,a=0;for(this[t+i]=255&e;--i>=0&&(s*=256);)e<0&&0===a&&0!==this[t+i+1]&&(a=1),this[t+i]=(e/s>>0)-a&255;return t+r},t.prototype.writeInt8=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,1,127,-128),e<0&&(e=255+e+1),this[t]=255&e,t+1},t.prototype.writeInt16LE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,2,32767,-32768),this[t]=255&e,this[t+1]=e>>>8,t+2},t.prototype.writeInt16BE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,2,32767,-32768),this[t]=e>>>8,this[t+1]=255&e,t+2},t.prototype.writeInt32LE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,4,2147483647,-2147483648),this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24,t+4},t.prototype.writeInt32BE=function(e,t,r){return e=+e,t>>>=0,r||A(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e,t+4},t.prototype.writeFloatLE=function(e,t,r){return M(this,e,t,!0,r)},t.prototype.writeFloatBE=function(e,t,r){return M(this,e,t,!1,r)},t.prototype.writeDoubleLE=function(e,t,r){return P(this,e,t,!0,r)},t.prototype.writeDoubleBE=function(e,t,r){return P(this,e,t,!1,r)},t.prototype.copy=function(e,r,n,o){if(!t.isBuffer(e))throw new TypeError("argument should be a Buffer");if(n||(n=0),o||0===o||(o=this.length),r>=e.length&&(r=e.length),r||(r=0),o>0&&o<n&&(o=n),o===n)return 0;if(0===e.length||0===this.length)return 0;if(r<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("Index out of range");if(o<0)throw new RangeError("sourceEnd out of bounds");o>this.length&&(o=this.length),e.length-r<o-n&&(o=e.length-r+n);var i=o-n;if(this===e&&"function"==typeof Uint8Array.prototype.copyWithin)this.copyWithin(r,n,o);else if(this===e&&n<r&&r<o)for(var s=i-1;s>=0;--s)e[s+r]=this[s+n];else Uint8Array.prototype.set.call(e,this.subarray(n,o),r);return i},t.prototype.fill=function(e,r,n,o){if("string"==typeof e){if("string"==typeof r?(o=r,r=0,n=this.length):"string"==typeof n&&(o=n,n=this.length),void 0!==o&&"string"!=typeof o)throw new TypeError("encoding must be a string");if("string"==typeof o&&!t.isEncoding(o))throw new TypeError("Unknown encoding: "+o);if(1===e.length){var i=e.charCodeAt(0);("utf8"===o&&i<128||"latin1"===o)&&(e=i)}}else"number"==typeof e?e&=255:"boolean"==typeof e&&(e=Number(e));if(r<0||this.length<r||this.length<n)throw new RangeError("Out of range index");if(n<=r)return this;var s;if(r>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(s=r;s<n;++s)this[s]=e;else{var a=t.isBuffer(e)?e:t.from(e,o),u=a.length;if(0===u)throw new TypeError('The value "'+e+'" is invalid for argument "value"');for(s=0;s<n-r;++s)this[s+r]=a[s%u]}return this};var U=/[^+/0-9A-Za-z-_]/g;function L(e,t){var r;t=t||1/0;for(var n=e.length,o=null,i=[],s=0;s<n;++s){if((r=e.charCodeAt(s))>55295&&r<57344){if(!o){if(r>56319){(t-=3)>-1&&i.push(239,191,189);continue}if(s+1===n){(t-=3)>-1&&i.push(239,191,189);continue}o=r;continue}if(r<56320){(t-=3)>-1&&i.push(239,191,189),o=r;continue}r=65536+(o-55296<<10|r-56320)}else o&&(t-=3)>-1&&i.push(239,191,189);if(o=null,r<128){if((t-=1)<0)break;i.push(r)}else if(r<2048){if((t-=2)<0)break;i.push(r>>6|192,63&r|128)}else if(r<65536){if((t-=3)<0)break;i.push(r>>12|224,r>>6&63|128,63&r|128)}else{if(!(r<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;i.push(r>>18|240,r>>12&63|128,r>>6&63|128,63&r|128)}}return i}function F(e){return n.toByteArray(function(e){if((e=(e=e.split("=")[0]).trim().replace(U,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function N(e,t,r,n){for(var o=0;o<n&&!(o+r>=t.length||o>=e.length);++o)t[o+r]=e[o];return o}function K(e,t){return e instanceof t||null!=e&&null!=e.constructor&&null!=e.constructor.name&&e.constructor.name===t.name}function q(e){return e!=e}var B=function(){for(var e=new Array(256),t=0;t<16;++t)for(var r=16*t,n=0;n<16;++n)e[r+n]="0123456789abcdef"[t]+"0123456789abcdef"[n];return e}()}).call(this,e("buffer").Buffer)},{"base64-js":102,buffer:106,ieee754:258}],107:[function(e,t,r){
/*!
 * content-type
 * Copyright(c) 2015 Douglas Christopher Wilson
 * MIT Licensed
 */
"use strict";var n=/; *([!#$%&'*+.^_`|~0-9A-Za-z-]+) *= *("(?:[\u000b\u0020\u0021\u0023-\u005b\u005d-\u007e\u0080-\u00ff]|\\[\u000b\u0020-\u00ff])*"|[!#$%&'*+.^_`|~0-9A-Za-z-]+) */g,o=/^[\u000b\u0020-\u007e\u0080-\u00ff]+$/,i=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+$/,s=/\\([\u000b\u0020-\u00ff])/g,a=/([\\"])/g,u=/^[!#$%&'*+.^_`|~0-9A-Za-z-]+\/[!#$%&'*+.^_`|~0-9A-Za-z-]+$/;function c(e){var t=String(e);if(i.test(t))return t;if(t.length>0&&!o.test(t))throw new TypeError("invalid parameter value");return'"'+t.replace(a,"\\$1")+'"'}function l(e){this.parameters=Object.create(null),this.type=e}r.format=function(e){if(!e||"object"!=typeof e)throw new TypeError("argument obj is required");var t=e.parameters,r=e.type;if(!r||!u.test(r))throw new TypeError("invalid type");var n=r;if(t&&"object"==typeof t)for(var o,s=Object.keys(t).sort(),a=0;a<s.length;a++){if(o=s[a],!i.test(o))throw new TypeError("invalid parameter name");n+="; "+o+"="+c(t[o])}return n},r.parse=function(e){if(!e)throw new TypeError("argument string is required");var t="object"==typeof e?function(e){var t;"function"==typeof e.getHeader?t=e.getHeader("content-type"):"object"==typeof e.headers&&(t=e.headers&&e.headers["content-type"]);if("string"!=typeof t)throw new TypeError("content-type header is missing from object");return t}(e):e;if("string"!=typeof t)throw new TypeError("argument string is required to be a string");var r=t.indexOf(";"),o=-1!==r?t.substr(0,r).trim():t.trim();if(!u.test(o))throw new TypeError("invalid media type");var i=new l(o.toLowerCase());if(-1!==r){var a,c,d;for(n.lastIndex=r;c=n.exec(t);){if(c.index!==r)throw new TypeError("invalid parameter format");r+=c[0].length,a=c[1].toLowerCase(),'"'===(d=c[2])[0]&&(d=d.substr(1,d.length-2).replace(s,"$1")),i.parameters[a]=d}if(r!==t.length)throw new TypeError("invalid parameter format")}return i}},{}],108:[function(e,t,r){e("../../modules/es6.string.iterator"),e("../../modules/es6.array.from"),t.exports=e("../../modules/_core").Array.from},{"../../modules/_core":147,"../../modules/es6.array.from":223,"../../modules/es6.string.iterator":242}],109:[function(e,t,r){e("../modules/web.dom.iterable"),e("../modules/es6.string.iterator"),t.exports=e("../modules/core.get-iterator")},{"../modules/core.get-iterator":221,"../modules/es6.string.iterator":242,"../modules/web.dom.iterable":256}],110:[function(e,t,r){e("../modules/web.dom.iterable"),e("../modules/es6.string.iterator"),t.exports=e("../modules/core.is-iterable")},{"../modules/core.is-iterable":222,"../modules/es6.string.iterator":242,"../modules/web.dom.iterable":256}],111:[function(e,t,r){var n=e("../../modules/_core"),o=n.JSON||(n.JSON={stringify:JSON.stringify});t.exports=function(e){return o.stringify.apply(o,arguments)}},{"../../modules/_core":147}],112:[function(e,t,r){e("../modules/es6.object.to-string"),e("../modules/es6.string.iterator"),e("../modules/web.dom.iterable"),e("../modules/es6.map"),e("../modules/es7.map.to-json"),e("../modules/es7.map.of"),e("../modules/es7.map.from"),t.exports=e("../modules/_core").Map},{"../modules/_core":147,"../modules/es6.map":225,"../modules/es6.object.to-string":236,"../modules/es6.string.iterator":242,"../modules/es7.map.from":244,"../modules/es7.map.of":245,"../modules/es7.map.to-json":246,"../modules/web.dom.iterable":256}],113:[function(e,t,r){e("../../modules/es6.number.is-finite"),t.exports=e("../../modules/_core").Number.isFinite},{"../../modules/_core":147,"../../modules/es6.number.is-finite":226}],114:[function(e,t,r){e("../../modules/es6.number.is-integer"),t.exports=e("../../modules/_core").Number.isInteger},{"../../modules/_core":147,"../../modules/es6.number.is-integer":227}],115:[function(e,t,r){e("../../modules/es6.number.min-safe-integer"),t.exports=-9007199254740991},{"../../modules/es6.number.min-safe-integer":228}],116:[function(e,t,r){e("../../modules/es6.object.assign"),t.exports=e("../../modules/_core").Object.assign},{"../../modules/_core":147,"../../modules/es6.object.assign":229}],117:[function(e,t,r){e("../../modules/es6.object.create");var n=e("../../modules/_core").Object;t.exports=function(e,t){return n.create(e,t)}},{"../../modules/_core":147,"../../modules/es6.object.create":230}],118:[function(e,t,r){e("../../modules/es6.object.define-property");var n=e("../../modules/_core").Object;t.exports=function(e,t,r){return n.defineProperty(e,t,r)}},{"../../modules/_core":147,"../../modules/es6.object.define-property":231}],119:[function(e,t,r){e("../../modules/es7.object.entries"),t.exports=e("../../modules/_core").Object.entries},{"../../modules/_core":147,"../../modules/es7.object.entries":247}],120:[function(e,t,r){e("../../modules/es6.object.freeze"),t.exports=e("../../modules/_core").Object.freeze},{"../../modules/_core":147,"../../modules/es6.object.freeze":232}],121:[function(e,t,r){e("../../modules/es6.object.get-prototype-of"),t.exports=e("../../modules/_core").Object.getPrototypeOf},{"../../modules/_core":147,"../../modules/es6.object.get-prototype-of":233}],122:[function(e,t,r){e("../../modules/es6.object.keys"),t.exports=e("../../modules/_core").Object.keys},{"../../modules/_core":147,"../../modules/es6.object.keys":234}],123:[function(e,t,r){e("../../modules/es6.object.set-prototype-of"),t.exports=e("../../modules/_core").Object.setPrototypeOf},{"../../modules/_core":147,"../../modules/es6.object.set-prototype-of":235}],124:[function(e,t,r){e("../../modules/es7.object.values"),t.exports=e("../../modules/_core").Object.values},{"../../modules/_core":147,"../../modules/es7.object.values":248}],125:[function(e,t,r){e("../modules/es6.object.to-string"),e("../modules/es6.string.iterator"),e("../modules/web.dom.iterable"),e("../modules/es6.promise"),e("../modules/es7.promise.finally"),e("../modules/es7.promise.try"),t.exports=e("../modules/_core").Promise},{"../modules/_core":147,"../modules/es6.object.to-string":236,"../modules/es6.promise":237,"../modules/es6.string.iterator":242,"../modules/es7.promise.finally":249,"../modules/es7.promise.try":250,"../modules/web.dom.iterable":256}],126:[function(e,t,r){e("../../modules/es6.reflect.construct"),t.exports=e("../../modules/_core").Reflect.construct},{"../../modules/_core":147,"../../modules/es6.reflect.construct":238}],127:[function(e,t,r){e("../../modules/es6.reflect.get-prototype-of"),t.exports=e("../../modules/_core").Reflect.getPrototypeOf},{"../../modules/_core":147,"../../modules/es6.reflect.get-prototype-of":239}],128:[function(e,t,r){e("../../modules/es6.reflect.set-prototype-of"),t.exports=e("../../modules/_core").Reflect.setPrototypeOf},{"../../modules/_core":147,"../../modules/es6.reflect.set-prototype-of":240}],129:[function(e,t,r){e("../modules/es6.object.to-string"),e("../modules/es6.string.iterator"),e("../modules/web.dom.iterable"),e("../modules/es6.set"),e("../modules/es7.set.to-json"),e("../modules/es7.set.of"),e("../modules/es7.set.from"),t.exports=e("../modules/_core").Set},{"../modules/_core":147,"../modules/es6.object.to-string":236,"../modules/es6.set":241,"../modules/es6.string.iterator":242,"../modules/es7.set.from":251,"../modules/es7.set.of":252,"../modules/es7.set.to-json":253,"../modules/web.dom.iterable":256}],130:[function(e,t,r){e("../../modules/es6.symbol"),e("../../modules/es6.object.to-string"),e("../../modules/es7.symbol.async-iterator"),e("../../modules/es7.symbol.observable"),t.exports=e("../../modules/_core").Symbol},{"../../modules/_core":147,"../../modules/es6.object.to-string":236,"../../modules/es6.symbol":243,"../../modules/es7.symbol.async-iterator":254,"../../modules/es7.symbol.observable":255}],131:[function(e,t,r){e("../../modules/es6.string.iterator"),e("../../modules/web.dom.iterable"),t.exports=e("../../modules/_wks-ext").f("iterator")},{"../../modules/_wks-ext":218,"../../modules/es6.string.iterator":242,"../../modules/web.dom.iterable":256}],132:[function(e,t,r){t.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},{}],133:[function(e,t,r){t.exports=function(){}},{}],134:[function(e,t,r){t.exports=function(e,t,r,n){if(!(e instanceof t)||void 0!==n&&n in e)throw TypeError(r+": incorrect invocation!");return e}},{}],135:[function(e,t,r){var n=e("./_is-object");t.exports=function(e){if(!n(e))throw TypeError(e+" is not an object!");return e}},{"./_is-object":168}],136:[function(e,t,r){var n=e("./_for-of");t.exports=function(e,t){var r=[];return n(e,!1,r.push,r,t),r}},{"./_for-of":157}],137:[function(e,t,r){var n=e("./_to-iobject"),o=e("./_to-length"),i=e("./_to-absolute-index");t.exports=function(e){return function(t,r,s){var a,u=n(t),c=o(u.length),l=i(s,c);if(e&&r!=r){for(;c>l;)if((a=u[l++])!=a)return!0}else for(;c>l;l++)if((e||l in u)&&u[l]===r)return e||l||0;return!e&&-1}}},{"./_to-absolute-index":208,"./_to-iobject":210,"./_to-length":211}],138:[function(e,t,r){var n=e("./_ctx"),o=e("./_iobject"),i=e("./_to-object"),s=e("./_to-length"),a=e("./_array-species-create");t.exports=function(e,t){var r=1==e,u=2==e,c=3==e,l=4==e,d=6==e,f=5==e||d,p=t||a;return function(t,a,h){for(var v,m,y=i(t),_=o(y),g=n(a,h,3),b=s(_.length),k=0,w=r?p(t,b):u?p(t,0):void 0;b>k;k++)if((f||k in _)&&(m=g(v=_[k],k,y),e))if(r)w[k]=m;else if(m)switch(e){case 3:return!0;case 5:return v;case 6:return k;case 2:w.push(v)}else if(l)return!1;return d?-1:c||l?l:w}}},{"./_array-species-create":140,"./_ctx":149,"./_iobject":164,"./_to-length":211,"./_to-object":212}],139:[function(e,t,r){var n=e("./_is-object"),o=e("./_is-array"),i=e("./_wks")("species");t.exports=function(e){var t;return o(e)&&("function"!=typeof(t=e.constructor)||t!==Array&&!o(t.prototype)||(t=void 0),n(t)&&null===(t=t[i])&&(t=void 0)),void 0===t?Array:t}},{"./_is-array":166,"./_is-object":168,"./_wks":219}],140:[function(e,t,r){var n=e("./_array-species-constructor");t.exports=function(e,t){return new(n(e))(t)}},{"./_array-species-constructor":139}],141:[function(e,t,r){"use strict";var n=e("./_a-function"),o=e("./_is-object"),i=e("./_invoke"),s=[].slice,a={},u=function(e,t,r){if(!(t in a)){for(var n=[],o=0;o<t;o++)n[o]="a["+o+"]";a[t]=Function("F,a","return new F("+n.join(",")+")")}return a[t](e,r)};t.exports=Function.bind||function(e){var t=n(this),r=s.call(arguments,1),a=function(){var n=r.concat(s.call(arguments));return this instanceof a?u(t,n.length,n):i(t,n,e)};return o(t.prototype)&&(a.prototype=t.prototype),a}},{"./_a-function":132,"./_invoke":163,"./_is-object":168}],142:[function(e,t,r){var n=e("./_cof"),o=e("./_wks")("toStringTag"),i="Arguments"==n(function(){return arguments}());t.exports=function(e){var t,r,s;return void 0===e?"Undefined":null===e?"Null":"string"==typeof(r=function(e,t){try{return e[t]}catch(e){}}(t=Object(e),o))?r:i?n(t):"Object"==(s=n(t))&&"function"==typeof t.callee?"Arguments":s}},{"./_cof":143,"./_wks":219}],143:[function(e,t,r){var n={}.toString;t.exports=function(e){return n.call(e).slice(8,-1)}},{}],144:[function(e,t,r){"use strict";var n=e("./_object-dp").f,o=e("./_object-create"),i=e("./_redefine-all"),s=e("./_ctx"),a=e("./_an-instance"),u=e("./_for-of"),c=e("./_iter-define"),l=e("./_iter-step"),d=e("./_set-species"),f=e("./_descriptors"),p=e("./_meta").fastKey,h=e("./_validate-collection"),v=f?"_s":"size",m=function(e,t){var r,n=p(t);if("F"!==n)return e._i[n];for(r=e._f;r;r=r.n)if(r.k==t)return r};t.exports={getConstructor:function(e,t,r,c){var l=e((function(e,n){a(e,l,t,"_i"),e._t=t,e._i=o(null),e._f=void 0,e._l=void 0,e[v]=0,null!=n&&u(n,r,e[c],e)}));return i(l.prototype,{clear:function(){for(var e=h(this,t),r=e._i,n=e._f;n;n=n.n)n.r=!0,n.p&&(n.p=n.p.n=void 0),delete r[n.i];e._f=e._l=void 0,e[v]=0},delete:function(e){var r=h(this,t),n=m(r,e);if(n){var o=n.n,i=n.p;delete r._i[n.i],n.r=!0,i&&(i.n=o),o&&(o.p=i),r._f==n&&(r._f=o),r._l==n&&(r._l=i),r[v]--}return!!n},forEach:function(e){h(this,t);for(var r,n=s(e,arguments.length>1?arguments[1]:void 0,3);r=r?r.n:this._f;)for(n(r.v,r.k,this);r&&r.r;)r=r.p},has:function(e){return!!m(h(this,t),e)}}),f&&n(l.prototype,"size",{get:function(){return h(this,t)[v]}}),l},def:function(e,t,r){var n,o,i=m(e,t);return i?i.v=r:(e._l=i={i:o=p(t,!0),k:t,v:r,p:n=e._l,n:void 0,r:!1},e._f||(e._f=i),n&&(n.n=i),e[v]++,"F"!==o&&(e._i[o]=i)),e},getEntry:m,setStrong:function(e,t,r){c(e,t,(function(e,r){this._t=h(e,t),this._k=r,this._l=void 0}),(function(){for(var e=this._k,t=this._l;t&&t.r;)t=t.p;return this._t&&(this._l=t=t?t.n:this._t._f)?l(0,"keys"==e?t.k:"values"==e?t.v:[t.k,t.v]):(this._t=void 0,l(1))}),r?"entries":"values",!r,!0),d(t)}}},{"./_an-instance":134,"./_ctx":149,"./_descriptors":151,"./_for-of":157,"./_iter-define":171,"./_iter-step":173,"./_meta":176,"./_object-create":180,"./_object-dp":181,"./_redefine-all":196,"./_set-species":201,"./_validate-collection":216}],145:[function(e,t,r){var n=e("./_classof"),o=e("./_array-from-iterable");t.exports=function(e){return function(){if(n(this)!=e)throw TypeError(e+"#toJSON isn't generic");return o(this)}}},{"./_array-from-iterable":136,"./_classof":142}],146:[function(e,t,r){"use strict";var n=e("./_global"),o=e("./_export"),i=e("./_meta"),s=e("./_fails"),a=e("./_hide"),u=e("./_redefine-all"),c=e("./_for-of"),l=e("./_an-instance"),d=e("./_is-object"),f=e("./_set-to-string-tag"),p=e("./_object-dp").f,h=e("./_array-methods")(0),v=e("./_descriptors");t.exports=function(e,t,r,m,y,_){var g=n[e],b=g,k=y?"set":"add",w=b&&b.prototype,E={};return v&&"function"==typeof b&&(_||w.forEach&&!s((function(){(new b).entries().next()})))?(b=t((function(t,r){l(t,b,e,"_c"),t._c=new g,null!=r&&c(r,y,t[k],t)})),h("add,clear,delete,forEach,get,has,set,keys,values,entries,toJSON".split(","),(function(e){var t="add"==e||"set"==e;e in w&&(!_||"clear"!=e)&&a(b.prototype,e,(function(r,n){if(l(this,b,e),!t&&_&&!d(r))return"get"==e&&void 0;var o=this._c[e](0===r?0:r,n);return t?this:o}))})),_||p(b.prototype,"size",{get:function(){return this._c.size}})):(b=m.getConstructor(t,e,y,k),u(b.prototype,r),i.NEED=!0),f(b,e),E[e]=b,o(o.G+o.W+o.F,E),_||m.setStrong(b,e,y),b}},{"./_an-instance":134,"./_array-methods":138,"./_descriptors":151,"./_export":155,"./_fails":156,"./_for-of":157,"./_global":158,"./_hide":160,"./_is-object":168,"./_meta":176,"./_object-dp":181,"./_redefine-all":196,"./_set-to-string-tag":202}],147:[function(e,t,r){var n=t.exports={version:"2.6.9"};"number"==typeof __e&&(__e=n)},{}],148:[function(e,t,r){"use strict";var n=e("./_object-dp"),o=e("./_property-desc");t.exports=function(e,t,r){t in e?n.f(e,t,o(0,r)):e[t]=r}},{"./_object-dp":181,"./_property-desc":195}],149:[function(e,t,r){var n=e("./_a-function");t.exports=function(e,t,r){if(n(e),void 0===t)return e;switch(r){case 1:return function(r){return e.call(t,r)};case 2:return function(r,n){return e.call(t,r,n)};case 3:return function(r,n,o){return e.call(t,r,n,o)}}return function(){return e.apply(t,arguments)}}},{"./_a-function":132}],150:[function(e,t,r){t.exports=function(e){if(null==e)throw TypeError("Can't call method on  "+e);return e}},{}],151:[function(e,t,r){t.exports=!e("./_fails")((function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a}))},{"./_fails":156}],152:[function(e,t,r){var n=e("./_is-object"),o=e("./_global").document,i=n(o)&&n(o.createElement);t.exports=function(e){return i?o.createElement(e):{}}},{"./_global":158,"./_is-object":168}],153:[function(e,t,r){t.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},{}],154:[function(e,t,r){var n=e("./_object-keys"),o=e("./_object-gops"),i=e("./_object-pie");t.exports=function(e){var t=n(e),r=o.f;if(r)for(var s,a=r(e),u=i.f,c=0;a.length>c;)u.call(e,s=a[c++])&&t.push(s);return t}},{"./_object-gops":186,"./_object-keys":189,"./_object-pie":190}],155:[function(e,t,r){var n=e("./_global"),o=e("./_core"),i=e("./_ctx"),s=e("./_hide"),a=e("./_has"),u=function(e,t,r){var c,l,d,f=e&u.F,p=e&u.G,h=e&u.S,v=e&u.P,m=e&u.B,y=e&u.W,_=p?o:o[t]||(o[t]={}),g=_.prototype,b=p?n:h?n[t]:(n[t]||{}).prototype;for(c in p&&(r=t),r)(l=!f&&b&&void 0!==b[c])&&a(_,c)||(d=l?b[c]:r[c],_[c]=p&&"function"!=typeof b[c]?r[c]:m&&l?i(d,n):y&&b[c]==d?function(e){var t=function(t,r,n){if(this instanceof e){switch(arguments.length){case 0:return new e;case 1:return new e(t);case 2:return new e(t,r)}return new e(t,r,n)}return e.apply(this,arguments)};return t.prototype=e.prototype,t}(d):v&&"function"==typeof d?i(Function.call,d):d,v&&((_.virtual||(_.virtual={}))[c]=d,e&u.R&&g&&!g[c]&&s(g,c,d)))};u.F=1,u.G=2,u.S=4,u.P=8,u.B=16,u.W=32,u.U=64,u.R=128,t.exports=u},{"./_core":147,"./_ctx":149,"./_global":158,"./_has":159,"./_hide":160}],156:[function(e,t,r){t.exports=function(e){try{return!!e()}catch(e){return!0}}},{}],157:[function(e,t,r){var n=e("./_ctx"),o=e("./_iter-call"),i=e("./_is-array-iter"),s=e("./_an-object"),a=e("./_to-length"),u=e("./core.get-iterator-method"),c={},l={};(r=t.exports=function(e,t,r,d,f){var p,h,v,m,y=f?function(){return e}:u(e),_=n(r,d,t?2:1),g=0;if("function"!=typeof y)throw TypeError(e+" is not iterable!");if(i(y)){for(p=a(e.length);p>g;g++)if((m=t?_(s(h=e[g])[0],h[1]):_(e[g]))===c||m===l)return m}else for(v=y.call(e);!(h=v.next()).done;)if((m=o(v,_,h.value,t))===c||m===l)return m}).BREAK=c,r.RETURN=l},{"./_an-object":135,"./_ctx":149,"./_is-array-iter":165,"./_iter-call":169,"./_to-length":211,"./core.get-iterator-method":220}],158:[function(e,t,r){var n=t.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof __g&&(__g=n)},{}],159:[function(e,t,r){var n={}.hasOwnProperty;t.exports=function(e,t){return n.call(e,t)}},{}],160:[function(e,t,r){var n=e("./_object-dp"),o=e("./_property-desc");t.exports=e("./_descriptors")?function(e,t,r){return n.f(e,t,o(1,r))}:function(e,t,r){return e[t]=r,e}},{"./_descriptors":151,"./_object-dp":181,"./_property-desc":195}],161:[function(e,t,r){var n=e("./_global").document;t.exports=n&&n.documentElement},{"./_global":158}],162:[function(e,t,r){t.exports=!e("./_descriptors")&&!e("./_fails")((function(){return 7!=Object.defineProperty(e("./_dom-create")("div"),"a",{get:function(){return 7}}).a}))},{"./_descriptors":151,"./_dom-create":152,"./_fails":156}],163:[function(e,t,r){t.exports=function(e,t,r){var n=void 0===r;switch(t.length){case 0:return n?e():e.call(r);case 1:return n?e(t[0]):e.call(r,t[0]);case 2:return n?e(t[0],t[1]):e.call(r,t[0],t[1]);case 3:return n?e(t[0],t[1],t[2]):e.call(r,t[0],t[1],t[2]);case 4:return n?e(t[0],t[1],t[2],t[3]):e.call(r,t[0],t[1],t[2],t[3])}return e.apply(r,t)}},{}],164:[function(e,t,r){var n=e("./_cof");t.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==n(e)?e.split(""):Object(e)}},{"./_cof":143}],165:[function(e,t,r){var n=e("./_iterators"),o=e("./_wks")("iterator"),i=Array.prototype;t.exports=function(e){return void 0!==e&&(n.Array===e||i[o]===e)}},{"./_iterators":174,"./_wks":219}],166:[function(e,t,r){var n=e("./_cof");t.exports=Array.isArray||function(e){return"Array"==n(e)}},{"./_cof":143}],167:[function(e,t,r){var n=e("./_is-object"),o=Math.floor;t.exports=function(e){return!n(e)&&isFinite(e)&&o(e)===e}},{"./_is-object":168}],168:[function(e,t,r){t.exports=function(e){return"object"==typeof e?null!==e:"function"==typeof e}},{}],169:[function(e,t,r){var n=e("./_an-object");t.exports=function(e,t,r,o){try{return o?t(n(r)[0],r[1]):t(r)}catch(t){var i=e.return;throw void 0!==i&&n(i.call(e)),t}}},{"./_an-object":135}],170:[function(e,t,r){"use strict";var n=e("./_object-create"),o=e("./_property-desc"),i=e("./_set-to-string-tag"),s={};e("./_hide")(s,e("./_wks")("iterator"),(function(){return this})),t.exports=function(e,t,r){e.prototype=n(s,{next:o(1,r)}),i(e,t+" Iterator")}},{"./_hide":160,"./_object-create":180,"./_property-desc":195,"./_set-to-string-tag":202,"./_wks":219}],171:[function(e,t,r){"use strict";var n=e("./_library"),o=e("./_export"),i=e("./_redefine"),s=e("./_hide"),a=e("./_iterators"),u=e("./_iter-create"),c=e("./_set-to-string-tag"),l=e("./_object-gpo"),d=e("./_wks")("iterator"),f=!([].keys&&"next"in[].keys()),p=function(){return this};t.exports=function(e,t,r,h,v,m,y){u(r,t,h);var _,g,b,k=function(e){if(!f&&e in x)return x[e];switch(e){case"keys":case"values":return function(){return new r(this,e)}}return function(){return new r(this,e)}},w=t+" Iterator",E="values"==v,S=!1,x=e.prototype,R=x[d]||x["@@iterator"]||v&&x[v],T=R||k(v),I=v?E?k("entries"):T:void 0,C="Array"==t&&x.entries||R;if(C&&(b=l(C.call(new e)))!==Object.prototype&&b.next&&(c(b,w,!0),n||"function"==typeof b[d]||s(b,d,p)),E&&R&&"values"!==R.name&&(S=!0,T=function(){return R.call(this)}),n&&!y||!f&&!S&&x[d]||s(x,d,T),a[t]=T,a[w]=p,v)if(_={values:E?T:k("values"),keys:m?T:k("keys"),entries:I},y)for(g in _)g in x||i(x,g,_[g]);else o(o.P+o.F*(f||S),t,_);return _}},{"./_export":155,"./_hide":160,"./_iter-create":170,"./_iterators":174,"./_library":175,"./_object-gpo":187,"./_redefine":197,"./_set-to-string-tag":202,"./_wks":219}],172:[function(e,t,r){var n=e("./_wks")("iterator"),o=!1;try{var i=[7][n]();i.return=function(){o=!0},Array.from(i,(function(){throw 2}))}catch(e){}t.exports=function(e,t){if(!t&&!o)return!1;var r=!1;try{var i=[7],s=i[n]();s.next=function(){return{done:r=!0}},i[n]=function(){return s},e(i)}catch(e){}return r}},{"./_wks":219}],173:[function(e,t,r){t.exports=function(e,t){return{value:t,done:!!e}}},{}],174:[function(e,t,r){t.exports={}},{}],175:[function(e,t,r){t.exports=!0},{}],176:[function(e,t,r){var n=e("./_uid")("meta"),o=e("./_is-object"),i=e("./_has"),s=e("./_object-dp").f,a=0,u=Object.isExtensible||function(){return!0},c=!e("./_fails")((function(){return u(Object.preventExtensions({}))})),l=function(e){s(e,n,{value:{i:"O"+ ++a,w:{}}})},d=t.exports={KEY:n,NEED:!1,fastKey:function(e,t){if(!o(e))return"symbol"==typeof e?e:("string"==typeof e?"S":"P")+e;if(!i(e,n)){if(!u(e))return"F";if(!t)return"E";l(e)}return e[n].i},getWeak:function(e,t){if(!i(e,n)){if(!u(e))return!0;if(!t)return!1;l(e)}return e[n].w},onFreeze:function(e){return c&&d.NEED&&u(e)&&!i(e,n)&&l(e),e}}},{"./_fails":156,"./_has":159,"./_is-object":168,"./_object-dp":181,"./_uid":214}],177:[function(e,t,r){var n=e("./_global"),o=e("./_task").set,i=n.MutationObserver||n.WebKitMutationObserver,s=n.process,a=n.Promise,u="process"==e("./_cof")(s);t.exports=function(){var e,t,r,c=function(){var n,o;for(u&&(n=s.domain)&&n.exit();e;){o=e.fn,e=e.next;try{o()}catch(n){throw e?r():t=void 0,n}}t=void 0,n&&n.enter()};if(u)r=function(){s.nextTick(c)};else if(!i||n.navigator&&n.navigator.standalone)if(a&&a.resolve){var l=a.resolve(void 0);r=function(){l.then(c)}}else r=function(){o.call(n,c)};else{var d=!0,f=document.createTextNode("");new i(c).observe(f,{characterData:!0}),r=function(){f.data=d=!d}}return function(n){var o={fn:n,next:void 0};t&&(t.next=o),e||(e=o,r()),t=o}}},{"./_cof":143,"./_global":158,"./_task":207}],178:[function(e,t,r){"use strict";var n=e("./_a-function");function o(e){var t,r;this.promise=new e((function(e,n){if(void 0!==t||void 0!==r)throw TypeError("Bad Promise constructor");t=e,r=n})),this.resolve=n(t),this.reject=n(r)}t.exports.f=function(e){return new o(e)}},{"./_a-function":132}],179:[function(e,t,r){"use strict";var n=e("./_descriptors"),o=e("./_object-keys"),i=e("./_object-gops"),s=e("./_object-pie"),a=e("./_to-object"),u=e("./_iobject"),c=Object.assign;t.exports=!c||e("./_fails")((function(){var e={},t={},r=Symbol(),n="abcdefghijklmnopqrst";return e[r]=7,n.split("").forEach((function(e){t[e]=e})),7!=c({},e)[r]||Object.keys(c({},t)).join("")!=n}))?function(e,t){for(var r=a(e),c=arguments.length,l=1,d=i.f,f=s.f;c>l;)for(var p,h=u(arguments[l++]),v=d?o(h).concat(d(h)):o(h),m=v.length,y=0;m>y;)p=v[y++],n&&!f.call(h,p)||(r[p]=h[p]);return r}:c},{"./_descriptors":151,"./_fails":156,"./_iobject":164,"./_object-gops":186,"./_object-keys":189,"./_object-pie":190,"./_to-object":212}],180:[function(e,t,r){var n=e("./_an-object"),o=e("./_object-dps"),i=e("./_enum-bug-keys"),s=e("./_shared-key")("IE_PROTO"),a=function(){},u=function(){var t,r=e("./_dom-create")("iframe"),n=i.length;for(r.style.display="none",e("./_html").appendChild(r),r.src="javascript:",(t=r.contentWindow.document).open(),t.write("<script>document.F=Object<\/script>"),t.close(),u=t.F;n--;)delete u.prototype[i[n]];return u()};t.exports=Object.create||function(e,t){var r;return null!==e?(a.prototype=n(e),r=new a,a.prototype=null,r[s]=e):r=u(),void 0===t?r:o(r,t)}},{"./_an-object":135,"./_dom-create":152,"./_enum-bug-keys":153,"./_html":161,"./_object-dps":182,"./_shared-key":203}],181:[function(e,t,r){var n=e("./_an-object"),o=e("./_ie8-dom-define"),i=e("./_to-primitive"),s=Object.defineProperty;r.f=e("./_descriptors")?Object.defineProperty:function(e,t,r){if(n(e),t=i(t,!0),n(r),o)try{return s(e,t,r)}catch(e){}if("get"in r||"set"in r)throw TypeError("Accessors not supported!");return"value"in r&&(e[t]=r.value),e}},{"./_an-object":135,"./_descriptors":151,"./_ie8-dom-define":162,"./_to-primitive":213}],182:[function(e,t,r){var n=e("./_object-dp"),o=e("./_an-object"),i=e("./_object-keys");t.exports=e("./_descriptors")?Object.defineProperties:function(e,t){o(e);for(var r,s=i(t),a=s.length,u=0;a>u;)n.f(e,r=s[u++],t[r]);return e}},{"./_an-object":135,"./_descriptors":151,"./_object-dp":181,"./_object-keys":189}],183:[function(e,t,r){var n=e("./_object-pie"),o=e("./_property-desc"),i=e("./_to-iobject"),s=e("./_to-primitive"),a=e("./_has"),u=e("./_ie8-dom-define"),c=Object.getOwnPropertyDescriptor;r.f=e("./_descriptors")?c:function(e,t){if(e=i(e),t=s(t,!0),u)try{return c(e,t)}catch(e){}if(a(e,t))return o(!n.f.call(e,t),e[t])}},{"./_descriptors":151,"./_has":159,"./_ie8-dom-define":162,"./_object-pie":190,"./_property-desc":195,"./_to-iobject":210,"./_to-primitive":213}],184:[function(e,t,r){var n=e("./_to-iobject"),o=e("./_object-gopn").f,i={}.toString,s="object"==typeof window&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[];t.exports.f=function(e){return s&&"[object Window]"==i.call(e)?function(e){try{return o(e)}catch(e){return s.slice()}}(e):o(n(e))}},{"./_object-gopn":185,"./_to-iobject":210}],185:[function(e,t,r){var n=e("./_object-keys-internal"),o=e("./_enum-bug-keys").concat("length","prototype");r.f=Object.getOwnPropertyNames||function(e){return n(e,o)}},{"./_enum-bug-keys":153,"./_object-keys-internal":188}],186:[function(e,t,r){r.f=Object.getOwnPropertySymbols},{}],187:[function(e,t,r){var n=e("./_has"),o=e("./_to-object"),i=e("./_shared-key")("IE_PROTO"),s=Object.prototype;t.exports=Object.getPrototypeOf||function(e){return e=o(e),n(e,i)?e[i]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?s:null}},{"./_has":159,"./_shared-key":203,"./_to-object":212}],188:[function(e,t,r){var n=e("./_has"),o=e("./_to-iobject"),i=e("./_array-includes")(!1),s=e("./_shared-key")("IE_PROTO");t.exports=function(e,t){var r,a=o(e),u=0,c=[];for(r in a)r!=s&&n(a,r)&&c.push(r);for(;t.length>u;)n(a,r=t[u++])&&(~i(c,r)||c.push(r));return c}},{"./_array-includes":137,"./_has":159,"./_shared-key":203,"./_to-iobject":210}],189:[function(e,t,r){var n=e("./_object-keys-internal"),o=e("./_enum-bug-keys");t.exports=Object.keys||function(e){return n(e,o)}},{"./_enum-bug-keys":153,"./_object-keys-internal":188}],190:[function(e,t,r){r.f={}.propertyIsEnumerable},{}],191:[function(e,t,r){var n=e("./_export"),o=e("./_core"),i=e("./_fails");t.exports=function(e,t){var r=(o.Object||{})[e]||Object[e],s={};s[e]=t(r),n(n.S+n.F*i((function(){r(1)})),"Object",s)}},{"./_core":147,"./_export":155,"./_fails":156}],192:[function(e,t,r){var n=e("./_descriptors"),o=e("./_object-keys"),i=e("./_to-iobject"),s=e("./_object-pie").f;t.exports=function(e){return function(t){for(var r,a=i(t),u=o(a),c=u.length,l=0,d=[];c>l;)r=u[l++],n&&!s.call(a,r)||d.push(e?[r,a[r]]:a[r]);return d}}},{"./_descriptors":151,"./_object-keys":189,"./_object-pie":190,"./_to-iobject":210}],193:[function(e,t,r){t.exports=function(e){try{return{e:!1,v:e()}}catch(e){return{e:!0,v:e}}}},{}],194:[function(e,t,r){var n=e("./_an-object"),o=e("./_is-object"),i=e("./_new-promise-capability");t.exports=function(e,t){if(n(e),o(t)&&t.constructor===e)return t;var r=i.f(e);return(0,r.resolve)(t),r.promise}},{"./_an-object":135,"./_is-object":168,"./_new-promise-capability":178}],195:[function(e,t,r){t.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},{}],196:[function(e,t,r){var n=e("./_hide");t.exports=function(e,t,r){for(var o in t)r&&e[o]?e[o]=t[o]:n(e,o,t[o]);return e}},{"./_hide":160}],197:[function(e,t,r){t.exports=e("./_hide")},{"./_hide":160}],198:[function(e,t,r){"use strict";var n=e("./_export"),o=e("./_a-function"),i=e("./_ctx"),s=e("./_for-of");t.exports=function(e){n(n.S,e,{from:function(e){var t,r,n,a,u=arguments[1];return o(this),(t=void 0!==u)&&o(u),null==e?new this:(r=[],t?(n=0,a=i(u,arguments[2],2),s(e,!1,(function(e){r.push(a(e,n++))}))):s(e,!1,r.push,r),new this(r))}})}},{"./_a-function":132,"./_ctx":149,"./_export":155,"./_for-of":157}],199:[function(e,t,r){"use strict";var n=e("./_export");t.exports=function(e){n(n.S,e,{of:function(){for(var e=arguments.length,t=new Array(e);e--;)t[e]=arguments[e];return new this(t)}})}},{"./_export":155}],200:[function(e,t,r){var n=e("./_is-object"),o=e("./_an-object"),i=function(e,t){if(o(e),!n(t)&&null!==t)throw TypeError(t+": can't set as prototype!")};t.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(t,r,n){try{(n=e("./_ctx")(Function.call,e("./_object-gopd").f(Object.prototype,"__proto__").set,2))(t,[]),r=!(t instanceof Array)}catch(e){r=!0}return function(e,t){return i(e,t),r?e.__proto__=t:n(e,t),e}}({},!1):void 0),check:i}},{"./_an-object":135,"./_ctx":149,"./_is-object":168,"./_object-gopd":183}],201:[function(e,t,r){"use strict";var n=e("./_global"),o=e("./_core"),i=e("./_object-dp"),s=e("./_descriptors"),a=e("./_wks")("species");t.exports=function(e){var t="function"==typeof o[e]?o[e]:n[e];s&&t&&!t[a]&&i.f(t,a,{configurable:!0,get:function(){return this}})}},{"./_core":147,"./_descriptors":151,"./_global":158,"./_object-dp":181,"./_wks":219}],202:[function(e,t,r){var n=e("./_object-dp").f,o=e("./_has"),i=e("./_wks")("toStringTag");t.exports=function(e,t,r){e&&!o(e=r?e:e.prototype,i)&&n(e,i,{configurable:!0,value:t})}},{"./_has":159,"./_object-dp":181,"./_wks":219}],203:[function(e,t,r){var n=e("./_shared")("keys"),o=e("./_uid");t.exports=function(e){return n[e]||(n[e]=o(e))}},{"./_shared":204,"./_uid":214}],204:[function(e,t,r){var n=e("./_core"),o=e("./_global"),i=o["__core-js_shared__"]||(o["__core-js_shared__"]={});(t.exports=function(e,t){return i[e]||(i[e]=void 0!==t?t:{})})("versions",[]).push({version:n.version,mode:e("./_library")?"pure":"global",copyright:" 2019 Denis Pushkarev (zloirock.ru)"})},{"./_core":147,"./_global":158,"./_library":175}],205:[function(e,t,r){var n=e("./_an-object"),o=e("./_a-function"),i=e("./_wks")("species");t.exports=function(e,t){var r,s=n(e).constructor;return void 0===s||null==(r=n(s)[i])?t:o(r)}},{"./_a-function":132,"./_an-object":135,"./_wks":219}],206:[function(e,t,r){var n=e("./_to-integer"),o=e("./_defined");t.exports=function(e){return function(t,r){var i,s,a=String(o(t)),u=n(r),c=a.length;return u<0||u>=c?e?"":void 0:(i=a.charCodeAt(u))<55296||i>56319||u+1===c||(s=a.charCodeAt(u+1))<56320||s>57343?e?a.charAt(u):i:e?a.slice(u,u+2):s-56320+(i-55296<<10)+65536}}},{"./_defined":150,"./_to-integer":209}],207:[function(e,t,r){var n,o,i,s=e("./_ctx"),a=e("./_invoke"),u=e("./_html"),c=e("./_dom-create"),l=e("./_global"),d=l.process,f=l.setImmediate,p=l.clearImmediate,h=l.MessageChannel,v=l.Dispatch,m=0,y={},_=function(){var e=+this;if(y.hasOwnProperty(e)){var t=y[e];delete y[e],t()}},g=function(e){_.call(e.data)};f&&p||(f=function(e){for(var t=[],r=1;arguments.length>r;)t.push(arguments[r++]);return y[++m]=function(){a("function"==typeof e?e:Function(e),t)},n(m),m},p=function(e){delete y[e]},"process"==e("./_cof")(d)?n=function(e){d.nextTick(s(_,e,1))}:v&&v.now?n=function(e){v.now(s(_,e,1))}:h?(i=(o=new h).port2,o.port1.onmessage=g,n=s(i.postMessage,i,1)):l.addEventListener&&"function"==typeof postMessage&&!l.importScripts?(n=function(e){l.postMessage(e+"","*")},l.addEventListener("message",g,!1)):n="onreadystatechange"in c("script")?function(e){u.appendChild(c("script")).onreadystatechange=function(){u.removeChild(this),_.call(e)}}:function(e){setTimeout(s(_,e,1),0)}),t.exports={set:f,clear:p}},{"./_cof":143,"./_ctx":149,"./_dom-create":152,"./_global":158,"./_html":161,"./_invoke":163}],208:[function(e,t,r){var n=e("./_to-integer"),o=Math.max,i=Math.min;t.exports=function(e,t){return(e=n(e))<0?o(e+t,0):i(e,t)}},{"./_to-integer":209}],209:[function(e,t,r){var n=Math.ceil,o=Math.floor;t.exports=function(e){return isNaN(e=+e)?0:(e>0?o:n)(e)}},{}],210:[function(e,t,r){var n=e("./_iobject"),o=e("./_defined");t.exports=function(e){return n(o(e))}},{"./_defined":150,"./_iobject":164}],211:[function(e,t,r){var n=e("./_to-integer"),o=Math.min;t.exports=function(e){return e>0?o(n(e),9007199254740991):0}},{"./_to-integer":209}],212:[function(e,t,r){var n=e("./_defined");t.exports=function(e){return Object(n(e))}},{"./_defined":150}],213:[function(e,t,r){var n=e("./_is-object");t.exports=function(e,t){if(!n(e))return e;var r,o;if(t&&"function"==typeof(r=e.toString)&&!n(o=r.call(e)))return o;if("function"==typeof(r=e.valueOf)&&!n(o=r.call(e)))return o;if(!t&&"function"==typeof(r=e.toString)&&!n(o=r.call(e)))return o;throw TypeError("Can't convert object to primitive value")}},{"./_is-object":168}],214:[function(e,t,r){var n=0,o=Math.random();t.exports=function(e){return"Symbol(".concat(void 0===e?"":e,")_",(++n+o).toString(36))}},{}],215:[function(e,t,r){var n=e("./_global").navigator;t.exports=n&&n.userAgent||""},{"./_global":158}],216:[function(e,t,r){var n=e("./_is-object");t.exports=function(e,t){if(!n(e)||e._t!==t)throw TypeError("Incompatible receiver, "+t+" required!");return e}},{"./_is-object":168}],217:[function(e,t,r){var n=e("./_global"),o=e("./_core"),i=e("./_library"),s=e("./_wks-ext"),a=e("./_object-dp").f;t.exports=function(e){var t=o.Symbol||(o.Symbol=i?{}:n.Symbol||{});"_"==e.charAt(0)||e in t||a(t,e,{value:s.f(e)})}},{"./_core":147,"./_global":158,"./_library":175,"./_object-dp":181,"./_wks-ext":218}],218:[function(e,t,r){r.f=e("./_wks")},{"./_wks":219}],219:[function(e,t,r){var n=e("./_shared")("wks"),o=e("./_uid"),i=e("./_global").Symbol,s="function"==typeof i;(t.exports=function(e){return n[e]||(n[e]=s&&i[e]||(s?i:o)("Symbol."+e))}).store=n},{"./_global":158,"./_shared":204,"./_uid":214}],220:[function(e,t,r){var n=e("./_classof"),o=e("./_wks")("iterator"),i=e("./_iterators");t.exports=e("./_core").getIteratorMethod=function(e){if(null!=e)return e[o]||e["@@iterator"]||i[n(e)]}},{"./_classof":142,"./_core":147,"./_iterators":174,"./_wks":219}],221:[function(e,t,r){var n=e("./_an-object"),o=e("./core.get-iterator-method");t.exports=e("./_core").getIterator=function(e){var t=o(e);if("function"!=typeof t)throw TypeError(e+" is not iterable!");return n(t.call(e))}},{"./_an-object":135,"./_core":147,"./core.get-iterator-method":220}],222:[function(e,t,r){var n=e("./_classof"),o=e("./_wks")("iterator"),i=e("./_iterators");t.exports=e("./_core").isIterable=function(e){var t=Object(e);return void 0!==t[o]||"@@iterator"in t||i.hasOwnProperty(n(t))}},{"./_classof":142,"./_core":147,"./_iterators":174,"./_wks":219}],223:[function(e,t,r){"use strict";var n=e("./_ctx"),o=e("./_export"),i=e("./_to-object"),s=e("./_iter-call"),a=e("./_is-array-iter"),u=e("./_to-length"),c=e("./_create-property"),l=e("./core.get-iterator-method");o(o.S+o.F*!e("./_iter-detect")((function(e){Array.from(e)})),"Array",{from:function(e){var t,r,o,d,f=i(e),p="function"==typeof this?this:Array,h=arguments.length,v=h>1?arguments[1]:void 0,m=void 0!==v,y=0,_=l(f);if(m&&(v=n(v,h>2?arguments[2]:void 0,2)),null==_||p==Array&&a(_))for(r=new p(t=u(f.length));t>y;y++)c(r,y,m?v(f[y],y):f[y]);else for(d=_.call(f),r=new p;!(o=d.next()).done;y++)c(r,y,m?s(d,v,[o.value,y],!0):o.value);return r.length=y,r}})},{"./_create-property":148,"./_ctx":149,"./_export":155,"./_is-array-iter":165,"./_iter-call":169,"./_iter-detect":172,"./_to-length":211,"./_to-object":212,"./core.get-iterator-method":220}],224:[function(e,t,r){"use strict";var n=e("./_add-to-unscopables"),o=e("./_iter-step"),i=e("./_iterators"),s=e("./_to-iobject");t.exports=e("./_iter-define")(Array,"Array",(function(e,t){this._t=s(e),this._i=0,this._k=t}),(function(){var e=this._t,t=this._k,r=this._i++;return!e||r>=e.length?(this._t=void 0,o(1)):o(0,"keys"==t?r:"values"==t?e[r]:[r,e[r]])}),"values"),i.Arguments=i.Array,n("keys"),n("values"),n("entries")},{"./_add-to-unscopables":133,"./_iter-define":171,"./_iter-step":173,"./_iterators":174,"./_to-iobject":210}],225:[function(e,t,r){"use strict";var n=e("./_collection-strong"),o=e("./_validate-collection");t.exports=e("./_collection")("Map",(function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}}),{get:function(e){var t=n.getEntry(o(this,"Map"),e);return t&&t.v},set:function(e,t){return n.def(o(this,"Map"),0===e?0:e,t)}},n,!0)},{"./_collection":146,"./_collection-strong":144,"./_validate-collection":216}],226:[function(e,t,r){var n=e("./_export"),o=e("./_global").isFinite;n(n.S,"Number",{isFinite:function(e){return"number"==typeof e&&o(e)}})},{"./_export":155,"./_global":158}],227:[function(e,t,r){var n=e("./_export");n(n.S,"Number",{isInteger:e("./_is-integer")})},{"./_export":155,"./_is-integer":167}],228:[function(e,t,r){var n=e("./_export");n(n.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},{"./_export":155}],229:[function(e,t,r){var n=e("./_export");n(n.S+n.F,"Object",{assign:e("./_object-assign")})},{"./_export":155,"./_object-assign":179}],230:[function(e,t,r){var n=e("./_export");n(n.S,"Object",{create:e("./_object-create")})},{"./_export":155,"./_object-create":180}],231:[function(e,t,r){var n=e("./_export");n(n.S+n.F*!e("./_descriptors"),"Object",{defineProperty:e("./_object-dp").f})},{"./_descriptors":151,"./_export":155,"./_object-dp":181}],232:[function(e,t,r){var n=e("./_is-object"),o=e("./_meta").onFreeze;e("./_object-sap")("freeze",(function(e){return function(t){return e&&n(t)?e(o(t)):t}}))},{"./_is-object":168,"./_meta":176,"./_object-sap":191}],233:[function(e,t,r){var n=e("./_to-object"),o=e("./_object-gpo");e("./_object-sap")("getPrototypeOf",(function(){return function(e){return o(n(e))}}))},{"./_object-gpo":187,"./_object-sap":191,"./_to-object":212}],234:[function(e,t,r){var n=e("./_to-object"),o=e("./_object-keys");e("./_object-sap")("keys",(function(){return function(e){return o(n(e))}}))},{"./_object-keys":189,"./_object-sap":191,"./_to-object":212}],235:[function(e,t,r){var n=e("./_export");n(n.S,"Object",{setPrototypeOf:e("./_set-proto").set})},{"./_export":155,"./_set-proto":200}],236:[function(e,t,r){},{}],237:[function(e,t,r){"use strict";var n,o,i,s,a=e("./_library"),u=e("./_global"),c=e("./_ctx"),l=e("./_classof"),d=e("./_export"),f=e("./_is-object"),p=e("./_a-function"),h=e("./_an-instance"),v=e("./_for-of"),m=e("./_species-constructor"),y=e("./_task").set,_=e("./_microtask")(),g=e("./_new-promise-capability"),b=e("./_perform"),k=e("./_user-agent"),w=e("./_promise-resolve"),E=u.TypeError,S=u.process,x=S&&S.versions,R=x&&x.v8||"",T=u.Promise,I="process"==l(S),C=function(){},O=o=g.f,j=!!function(){try{var t=T.resolve(1),r=(t.constructor={})[e("./_wks")("species")]=function(e){e(C,C)};return(I||"function"==typeof PromiseRejectionEvent)&&t.then(C)instanceof r&&0!==R.indexOf("6.6")&&-1===k.indexOf("Chrome/66")}catch(e){}}(),A=function(e){var t;return!(!f(e)||"function"!=typeof(t=e.then))&&t},D=function(e,t){if(!e._n){e._n=!0;var r=e._c;_((function(){for(var n=e._v,o=1==e._s,i=0,s=function(t){var r,i,s,a=o?t.ok:t.fail,u=t.resolve,c=t.reject,l=t.domain;try{a?(o||(2==e._h&&U(e),e._h=1),!0===a?r=n:(l&&l.enter(),r=a(n),l&&(l.exit(),s=!0)),r===t.promise?c(E("Promise-chain cycle")):(i=A(r))?i.call(r,u,c):u(r)):c(n)}catch(e){l&&!s&&l.exit(),c(e)}};r.length>i;)s(r[i++]);e._c=[],e._n=!1,t&&!e._h&&M(e)}))}},M=function(e){y.call(u,(function(){var t,r,n,o=e._v,i=P(e);if(i&&(t=b((function(){I?S.emit("unhandledRejection",o,e):(r=u.onunhandledrejection)?r({promise:e,reason:o}):(n=u.console)&&n.error&&n.error("Unhandled promise rejection",o)})),e._h=I||P(e)?2:1),e._a=void 0,i&&t.e)throw t.v}))},P=function(e){return 1!==e._h&&0===(e._a||e._c).length},U=function(e){y.call(u,(function(){var t;I?S.emit("rejectionHandled",e):(t=u.onrejectionhandled)&&t({promise:e,reason:e._v})}))},L=function(e){var t=this;t._d||(t._d=!0,(t=t._w||t)._v=e,t._s=2,t._a||(t._a=t._c.slice()),D(t,!0))},F=function(e){var t,r=this;if(!r._d){r._d=!0,r=r._w||r;try{if(r===e)throw E("Promise can't be resolved itself");(t=A(e))?_((function(){var n={_w:r,_d:!1};try{t.call(e,c(F,n,1),c(L,n,1))}catch(e){L.call(n,e)}})):(r._v=e,r._s=1,D(r,!1))}catch(e){L.call({_w:r,_d:!1},e)}}};j||(T=function(e){h(this,T,"Promise","_h"),p(e),n.call(this);try{e(c(F,this,1),c(L,this,1))}catch(e){L.call(this,e)}},(n=function(e){this._c=[],this._a=void 0,this._s=0,this._d=!1,this._v=void 0,this._h=0,this._n=!1}).prototype=e("./_redefine-all")(T.prototype,{then:function(e,t){var r=O(m(this,T));return r.ok="function"!=typeof e||e,r.fail="function"==typeof t&&t,r.domain=I?S.domain:void 0,this._c.push(r),this._a&&this._a.push(r),this._s&&D(this,!1),r.promise},catch:function(e){return this.then(void 0,e)}}),i=function(){var e=new n;this.promise=e,this.resolve=c(F,e,1),this.reject=c(L,e,1)},g.f=O=function(e){return e===T||e===s?new i(e):o(e)}),d(d.G+d.W+d.F*!j,{Promise:T}),e("./_set-to-string-tag")(T,"Promise"),e("./_set-species")("Promise"),s=e("./_core").Promise,d(d.S+d.F*!j,"Promise",{reject:function(e){var t=O(this);return(0,t.reject)(e),t.promise}}),d(d.S+d.F*(a||!j),"Promise",{resolve:function(e){return w(a&&this===s?T:this,e)}}),d(d.S+d.F*!(j&&e("./_iter-detect")((function(e){T.all(e).catch(C)}))),"Promise",{all:function(e){var t=this,r=O(t),n=r.resolve,o=r.reject,i=b((function(){var r=[],i=0,s=1;v(e,!1,(function(e){var a=i++,u=!1;r.push(void 0),s++,t.resolve(e).then((function(e){u||(u=!0,r[a]=e,--s||n(r))}),o)})),--s||n(r)}));return i.e&&o(i.v),r.promise},race:function(e){var t=this,r=O(t),n=r.reject,o=b((function(){v(e,!1,(function(e){t.resolve(e).then(r.resolve,n)}))}));return o.e&&n(o.v),r.promise}})},{"./_a-function":132,"./_an-instance":134,"./_classof":142,"./_core":147,"./_ctx":149,"./_export":155,"./_for-of":157,"./_global":158,"./_is-object":168,"./_iter-detect":172,"./_library":175,"./_microtask":177,"./_new-promise-capability":178,"./_perform":193,"./_promise-resolve":194,"./_redefine-all":196,"./_set-species":201,"./_set-to-string-tag":202,"./_species-constructor":205,"./_task":207,"./_user-agent":215,"./_wks":219}],238:[function(e,t,r){var n=e("./_export"),o=e("./_object-create"),i=e("./_a-function"),s=e("./_an-object"),a=e("./_is-object"),u=e("./_fails"),c=e("./_bind"),l=(e("./_global").Reflect||{}).construct,d=u((function(){function e(){}return!(l((function(){}),[],e)instanceof e)})),f=!u((function(){l((function(){}))}));n(n.S+n.F*(d||f),"Reflect",{construct:function(e,t){i(e),s(t);var r=arguments.length<3?e:i(arguments[2]);if(f&&!d)return l(e,t,r);if(e==r){switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3])}var n=[null];return n.push.apply(n,t),new(c.apply(e,n))}var u=r.prototype,p=o(a(u)?u:Object.prototype),h=Function.apply.call(e,p,t);return a(h)?h:p}})},{"./_a-function":132,"./_an-object":135,"./_bind":141,"./_export":155,"./_fails":156,"./_global":158,"./_is-object":168,"./_object-create":180}],239:[function(e,t,r){var n=e("./_export"),o=e("./_object-gpo"),i=e("./_an-object");n(n.S,"Reflect",{getPrototypeOf:function(e){return o(i(e))}})},{"./_an-object":135,"./_export":155,"./_object-gpo":187}],240:[function(e,t,r){var n=e("./_export"),o=e("./_set-proto");o&&n(n.S,"Reflect",{setPrototypeOf:function(e,t){o.check(e,t);try{return o.set(e,t),!0}catch(e){return!1}}})},{"./_export":155,"./_set-proto":200}],241:[function(e,t,r){"use strict";var n=e("./_collection-strong"),o=e("./_validate-collection");t.exports=e("./_collection")("Set",(function(e){return function(){return e(this,arguments.length>0?arguments[0]:void 0)}}),{add:function(e){return n.def(o(this,"Set"),e=0===e?0:e,e)}},n)},{"./_collection":146,"./_collection-strong":144,"./_validate-collection":216}],242:[function(e,t,r){"use strict";var n=e("./_string-at")(!0);e("./_iter-define")(String,"String",(function(e){this._t=String(e),this._i=0}),(function(){var e,t=this._t,r=this._i;return r>=t.length?{value:void 0,done:!0}:(e=n(t,r),this._i+=e.length,{value:e,done:!1})}))},{"./_iter-define":171,"./_string-at":206}],243:[function(e,t,r){"use strict";var n=e("./_global"),o=e("./_has"),i=e("./_descriptors"),s=e("./_export"),a=e("./_redefine"),u=e("./_meta").KEY,c=e("./_fails"),l=e("./_shared"),d=e("./_set-to-string-tag"),f=e("./_uid"),p=e("./_wks"),h=e("./_wks-ext"),v=e("./_wks-define"),m=e("./_enum-keys"),y=e("./_is-array"),_=e("./_an-object"),g=e("./_is-object"),b=e("./_to-object"),k=e("./_to-iobject"),w=e("./_to-primitive"),E=e("./_property-desc"),S=e("./_object-create"),x=e("./_object-gopn-ext"),R=e("./_object-gopd"),T=e("./_object-gops"),I=e("./_object-dp"),C=e("./_object-keys"),O=R.f,j=I.f,A=x.f,D=n.Symbol,M=n.JSON,P=M&&M.stringify,U=p("_hidden"),L=p("toPrimitive"),F={}.propertyIsEnumerable,N=l("symbol-registry"),K=l("symbols"),q=l("op-symbols"),B=Object.prototype,G="function"==typeof D&&!!T.f,V=n.QObject,$=!V||!V.prototype||!V.prototype.findChild,W=i&&c((function(){return 7!=S(j({},"a",{get:function(){return j(this,"a",{value:7}).a}})).a}))?function(e,t,r){var n=O(B,t);n&&delete B[t],j(e,t,r),n&&e!==B&&j(B,t,n)}:j,H=function(e){var t=K[e]=S(D.prototype);return t._k=e,t},z=G&&"symbol"==typeof D.iterator?function(e){return"symbol"==typeof e}:function(e){return e instanceof D},Y=function(e,t,r){return e===B&&Y(q,t,r),_(e),t=w(t,!0),_(r),o(K,t)?(r.enumerable?(o(e,U)&&e[U][t]&&(e[U][t]=!1),r=S(r,{enumerable:E(0,!1)})):(o(e,U)||j(e,U,E(1,{})),e[U][t]=!0),W(e,t,r)):j(e,t,r)},Q=function(e,t){_(e);for(var r,n=m(t=k(t)),o=0,i=n.length;i>o;)Y(e,r=n[o++],t[r]);return e},X=function(e){var t=F.call(this,e=w(e,!0));return!(this===B&&o(K,e)&&!o(q,e))&&(!(t||!o(this,e)||!o(K,e)||o(this,U)&&this[U][e])||t)},J=function(e,t){if(e=k(e),t=w(t,!0),e!==B||!o(K,t)||o(q,t)){var r=O(e,t);return!r||!o(K,t)||o(e,U)&&e[U][t]||(r.enumerable=!0),r}},Z=function(e){for(var t,r=A(k(e)),n=[],i=0;r.length>i;)o(K,t=r[i++])||t==U||t==u||n.push(t);return n},ee=function(e){for(var t,r=e===B,n=A(r?q:k(e)),i=[],s=0;n.length>s;)!o(K,t=n[s++])||r&&!o(B,t)||i.push(K[t]);return i};G||(a((D=function(){if(this instanceof D)throw TypeError("Symbol is not a constructor!");var e=f(arguments.length>0?arguments[0]:void 0),t=function(r){this===B&&t.call(q,r),o(this,U)&&o(this[U],e)&&(this[U][e]=!1),W(this,e,E(1,r))};return i&&$&&W(B,e,{configurable:!0,set:t}),H(e)}).prototype,"toString",(function(){return this._k})),R.f=J,I.f=Y,e("./_object-gopn").f=x.f=Z,e("./_object-pie").f=X,T.f=ee,i&&!e("./_library")&&a(B,"propertyIsEnumerable",X,!0),h.f=function(e){return H(p(e))}),s(s.G+s.W+s.F*!G,{Symbol:D});for(var te="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),re=0;te.length>re;)p(te[re++]);for(var ne=C(p.store),oe=0;ne.length>oe;)v(ne[oe++]);s(s.S+s.F*!G,"Symbol",{for:function(e){return o(N,e+="")?N[e]:N[e]=D(e)},keyFor:function(e){if(!z(e))throw TypeError(e+" is not a symbol!");for(var t in N)if(N[t]===e)return t},useSetter:function(){$=!0},useSimple:function(){$=!1}}),s(s.S+s.F*!G,"Object",{create:function(e,t){return void 0===t?S(e):Q(S(e),t)},defineProperty:Y,defineProperties:Q,getOwnPropertyDescriptor:J,getOwnPropertyNames:Z,getOwnPropertySymbols:ee});var ie=c((function(){T.f(1)}));s(s.S+s.F*ie,"Object",{getOwnPropertySymbols:function(e){return T.f(b(e))}}),M&&s(s.S+s.F*(!G||c((function(){var e=D();return"[null]"!=P([e])||"{}"!=P({a:e})||"{}"!=P(Object(e))}))),"JSON",{stringify:function(e){for(var t,r,n=[e],o=1;arguments.length>o;)n.push(arguments[o++]);if(r=t=n[1],(g(t)||void 0!==e)&&!z(e))return y(t)||(t=function(e,t){if("function"==typeof r&&(t=r.call(this,e,t)),!z(t))return t}),n[1]=t,P.apply(M,n)}}),D.prototype[L]||e("./_hide")(D.prototype,L,D.prototype.valueOf),d(D,"Symbol"),d(Math,"Math",!0),d(n.JSON,"JSON",!0)},{"./_an-object":135,"./_descriptors":151,"./_enum-keys":154,"./_export":155,"./_fails":156,"./_global":158,"./_has":159,"./_hide":160,"./_is-array":166,"./_is-object":168,"./_library":175,"./_meta":176,"./_object-create":180,"./_object-dp":181,"./_object-gopd":183,"./_object-gopn":185,"./_object-gopn-ext":184,"./_object-gops":186,"./_object-keys":189,"./_object-pie":190,"./_property-desc":195,"./_redefine":197,"./_set-to-string-tag":202,"./_shared":204,"./_to-iobject":210,"./_to-object":212,"./_to-primitive":213,"./_uid":214,"./_wks":219,"./_wks-define":217,"./_wks-ext":218}],244:[function(e,t,r){e("./_set-collection-from")("Map")},{"./_set-collection-from":198}],245:[function(e,t,r){e("./_set-collection-of")("Map")},{"./_set-collection-of":199}],246:[function(e,t,r){var n=e("./_export");n(n.P+n.R,"Map",{toJSON:e("./_collection-to-json")("Map")})},{"./_collection-to-json":145,"./_export":155}],247:[function(e,t,r){var n=e("./_export"),o=e("./_object-to-array")(!0);n(n.S,"Object",{entries:function(e){return o(e)}})},{"./_export":155,"./_object-to-array":192}],248:[function(e,t,r){var n=e("./_export"),o=e("./_object-to-array")(!1);n(n.S,"Object",{values:function(e){return o(e)}})},{"./_export":155,"./_object-to-array":192}],249:[function(e,t,r){"use strict";var n=e("./_export"),o=e("./_core"),i=e("./_global"),s=e("./_species-constructor"),a=e("./_promise-resolve");n(n.P+n.R,"Promise",{finally:function(e){var t=s(this,o.Promise||i.Promise),r="function"==typeof e;return this.then(r?function(r){return a(t,e()).then((function(){return r}))}:e,r?function(r){return a(t,e()).then((function(){throw r}))}:e)}})},{"./_core":147,"./_export":155,"./_global":158,"./_promise-resolve":194,"./_species-constructor":205}],250:[function(e,t,r){"use strict";var n=e("./_export"),o=e("./_new-promise-capability"),i=e("./_perform");n(n.S,"Promise",{try:function(e){var t=o.f(this),r=i(e);return(r.e?t.reject:t.resolve)(r.v),t.promise}})},{"./_export":155,"./_new-promise-capability":178,"./_perform":193}],251:[function(e,t,r){e("./_set-collection-from")("Set")},{"./_set-collection-from":198}],252:[function(e,t,r){e("./_set-collection-of")("Set")},{"./_set-collection-of":199}],253:[function(e,t,r){var n=e("./_export");n(n.P+n.R,"Set",{toJSON:e("./_collection-to-json")("Set")})},{"./_collection-to-json":145,"./_export":155}],254:[function(e,t,r){e("./_wks-define")("asyncIterator")},{"./_wks-define":217}],255:[function(e,t,r){e("./_wks-define")("observable")},{"./_wks-define":217}],256:[function(e,t,r){e("./es6.array.iterator");for(var n=e("./_global"),o=e("./_hide"),i=e("./_iterators"),s=e("./_wks")("toStringTag"),a="CSSRuleList,CSSStyleDeclaration,CSSValueList,ClientRectList,DOMRectList,DOMStringList,DOMTokenList,DataTransferItemList,FileList,HTMLAllCollection,HTMLCollection,HTMLFormElement,HTMLSelectElement,MediaList,MimeTypeArray,NamedNodeMap,NodeList,PaintRequestList,Plugin,PluginArray,SVGLengthList,SVGNumberList,SVGPathSegList,SVGPointList,SVGStringList,SVGTransformList,SourceBufferList,StyleSheetList,TextTrackCueList,TextTrackList,TouchList".split(","),u=0;u<a.length;u++){var c=a[u],l=n[c],d=l&&l.prototype;d&&!d[s]&&o(d,s,c),i[c]=i.Array}},{"./_global":158,"./_hide":160,"./_iterators":174,"./_wks":219,"./es6.array.iterator":224}],257:[function(e,t,r){var n=Object.create||function(e){var t=function(){};return t.prototype=e,new t},o=Object.keys||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return r},i=Function.prototype.bind||function(e){var t=this;return function(){return t.apply(e,arguments)}};function s(){this._events&&Object.prototype.hasOwnProperty.call(this,"_events")||(this._events=n(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0}t.exports=s,s.EventEmitter=s,s.prototype._events=void 0,s.prototype._maxListeners=void 0;var a,u=10;try{var c={};Object.defineProperty&&Object.defineProperty(c,"x",{value:0}),a=0===c.x}catch(e){a=!1}function l(e){return void 0===e._maxListeners?s.defaultMaxListeners:e._maxListeners}function d(e,t,r){if(t)e.call(r);else for(var n=e.length,o=k(e,n),i=0;i<n;++i)o[i].call(r)}function f(e,t,r,n){if(t)e.call(r,n);else for(var o=e.length,i=k(e,o),s=0;s<o;++s)i[s].call(r,n)}function p(e,t,r,n,o){if(t)e.call(r,n,o);else for(var i=e.length,s=k(e,i),a=0;a<i;++a)s[a].call(r,n,o)}function h(e,t,r,n,o,i){if(t)e.call(r,n,o,i);else for(var s=e.length,a=k(e,s),u=0;u<s;++u)a[u].call(r,n,o,i)}function v(e,t,r,n){if(t)e.apply(r,n);else for(var o=e.length,i=k(e,o),s=0;s<o;++s)i[s].apply(r,n)}function m(e,t,r,o){var i,s,a;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),a=s[t]):(s=e._events=n(null),e._eventsCount=0),a){if("function"==typeof a?a=s[t]=o?[r,a]:[a,r]:o?a.unshift(r):a.push(r),!a.warned&&(i=l(e))&&i>0&&a.length>i){a.warned=!0;var u=new Error("Possible EventEmitter memory leak detected. "+a.length+' "'+String(t)+'" listeners added. Use emitter.setMaxListeners() to increase limit.');u.name="MaxListenersExceededWarning",u.emitter=e,u.type=t,u.count=a.length,"object"==typeof console&&console.warn&&console.warn("%s: %s",u.name,u.message)}}else a=s[t]=r,++e._eventsCount;return e}function y(){if(!this.fired)switch(this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length){case 0:return this.listener.call(this.target);case 1:return this.listener.call(this.target,arguments[0]);case 2:return this.listener.call(this.target,arguments[0],arguments[1]);case 3:return this.listener.call(this.target,arguments[0],arguments[1],arguments[2]);default:for(var e=new Array(arguments.length),t=0;t<e.length;++t)e[t]=arguments[t];this.listener.apply(this.target,e)}}function _(e,t,r){var n={fired:!1,wrapFn:void 0,target:e,type:t,listener:r},o=i.call(y,n);return o.listener=r,n.wrapFn=o,o}function g(e,t,r){var n=e._events;if(!n)return[];var o=n[t];return o?"function"==typeof o?r?[o.listener||o]:[o]:r?function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(o):k(o,o.length):[]}function b(e){var t=this._events;if(t){var r=t[e];if("function"==typeof r)return 1;if(r)return r.length}return 0}function k(e,t){for(var r=new Array(t),n=0;n<t;++n)r[n]=e[n];return r}a?Object.defineProperty(s,"defaultMaxListeners",{enumerable:!0,get:function(){return u},set:function(e){if("number"!=typeof e||e<0||e!=e)throw new TypeError('"defaultMaxListeners" must be a positive number');u=e}}):s.defaultMaxListeners=u,s.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},s.prototype.getMaxListeners=function(){return l(this)},s.prototype.emit=function(e){var t,r,n,o,i,s,a="error"===e;if(s=this._events)a=a&&null==s.error;else if(!a)return!1;if(a){if(arguments.length>1&&(t=arguments[1]),t instanceof Error)throw t;var u=new Error('Unhandled "error" event. ('+t+")");throw u.context=t,u}if(!(r=s[e]))return!1;var c="function"==typeof r;switch(n=arguments.length){case 1:d(r,c,this);break;case 2:f(r,c,this,arguments[1]);break;case 3:p(r,c,this,arguments[1],arguments[2]);break;case 4:h(r,c,this,arguments[1],arguments[2],arguments[3]);break;default:for(o=new Array(n-1),i=1;i<n;i++)o[i-1]=arguments[i];v(r,c,this,o)}return!0},s.prototype.addListener=function(e,t){return m(this,e,t,!1)},s.prototype.on=s.prototype.addListener,s.prototype.prependListener=function(e,t){return m(this,e,t,!0)},s.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,_(this,e,t)),this},s.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,_(this,e,t)),this},s.prototype.removeListener=function(e,t){var r,o,i,s,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(o=this._events))return this;if(!(r=o[e]))return this;if(r===t||r.listener===t)0==--this._eventsCount?this._events=n(null):(delete o[e],o.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(i=-1,s=r.length-1;s>=0;s--)if(r[s]===t||r[s].listener===t){a=r[s].listener,i=s;break}if(i<0)return this;0===i?r.shift():function(e,t){for(var r=t,n=r+1,o=e.length;n<o;r+=1,n+=1)e[r]=e[n];e.pop()}(r,i),1===r.length&&(o[e]=r[0]),o.removeListener&&this.emit("removeListener",e,a||t)}return this},s.prototype.removeAllListeners=function(e){var t,r,i;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=n(null),this._eventsCount=0):r[e]&&(0==--this._eventsCount?this._events=n(null):delete r[e]),this;if(0===arguments.length){var s,a=o(r);for(i=0;i<a.length;++i)"removeListener"!==(s=a[i])&&this.removeAllListeners(s);return this.removeAllListeners("removeListener"),this._events=n(null),this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(t)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this},s.prototype.listeners=function(e){return g(this,e,!0)},s.prototype.rawListeners=function(e){return g(this,e,!1)},s.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):b.call(e,t)},s.prototype.listenerCount=b,s.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]}},{}],258:[function(e,t,r){r.read=function(e,t,r,n,o){var i,s,a=8*o-n-1,u=(1<<a)-1,c=u>>1,l=-7,d=r?o-1:0,f=r?-1:1,p=e[t+d];for(d+=f,i=p&(1<<-l)-1,p>>=-l,l+=a;l>0;i=256*i+e[t+d],d+=f,l-=8);for(s=i&(1<<-l)-1,i>>=-l,l+=n;l>0;s=256*s+e[t+d],d+=f,l-=8);if(0===i)i=1-c;else{if(i===u)return s?NaN:1/0*(p?-1:1);s+=Math.pow(2,n),i-=c}return(p?-1:1)*s*Math.pow(2,i-n)},r.write=function(e,t,r,n,o,i){var s,a,u,c=8*i-o-1,l=(1<<c)-1,d=l>>1,f=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,p=n?0:i-1,h=n?1:-1,v=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=l):(s=Math.floor(Math.log(t)/Math.LN2),t*(u=Math.pow(2,-s))<1&&(s--,u*=2),(t+=s+d>=1?f/u:f*Math.pow(2,1-d))*u>=2&&(s++,u/=2),s+d>=l?(a=0,s=l):s+d>=1?(a=(t*u-1)*Math.pow(2,o),s+=d):(a=t*Math.pow(2,d-1)*Math.pow(2,o),s=0));o>=8;e[r+p]=255&a,p+=h,a/=256,o-=8);for(s=s<<o|a,c+=o;c>0;e[r+p]=255&s,p+=h,s/=256,c-=8);e[r+p-h]|=128*v}},{}],259:[function(e,t,r){!function(e,r){"use strict";"function"==typeof define&&define.amd?define(r):"object"==typeof t&&t.exports?t.exports=r():e.log=r()}(this,(function(){"use strict";var e=function(){},t="undefined",r=["trace","debug","info","warn","error"];function n(e,t){var r=e[t];if("function"==typeof r.bind)return r.bind(e);try{return Function.prototype.bind.call(r,e)}catch(t){return function(){return Function.prototype.apply.apply(r,[e,arguments])}}}function o(t,n){for(var o=0;o<r.length;o++){var i=r[o];this[i]=o<t?e:this.methodFactory(i,t,n)}this.log=this.debug}function i(e,r,n){return function(){typeof console!==t&&(o.call(this,r,n),this[e].apply(this,arguments))}}function s(r,o,s){return function(r){return"debug"===r&&(r="log"),typeof console!==t&&(void 0!==console[r]?n(console,r):void 0!==console.log?n(console,"log"):e)}(r)||i.apply(this,arguments)}function a(e,n,i){var a,u=this,c="loglevel";function l(){var e;if(typeof window!==t){try{e=window.localStorage[c]}catch(e){}if(typeof e===t)try{var r=window.document.cookie,n=r.indexOf(encodeURIComponent(c)+"=");-1!==n&&(e=/^([^;]+)/.exec(r.slice(n))[1])}catch(e){}return void 0===u.levels[e]&&(e=void 0),e}}e&&(c+=":"+e),u.name=e,u.levels={TRACE:0,DEBUG:1,INFO:2,WARN:3,ERROR:4,SILENT:5},u.methodFactory=i||s,u.getLevel=function(){return a},u.setLevel=function(n,i){if("string"==typeof n&&void 0!==u.levels[n.toUpperCase()]&&(n=u.levels[n.toUpperCase()]),!("number"==typeof n&&n>=0&&n<=u.levels.SILENT))throw"log.setLevel() called with invalid level: "+n;if(a=n,!1!==i&&function(e){var n=(r[e]||"silent").toUpperCase();if(typeof window!==t){try{return void(window.localStorage[c]=n)}catch(e){}try{window.document.cookie=encodeURIComponent(c)+"="+n+";"}catch(e){}}}(n),o.call(u,n,e),typeof console===t&&n<u.levels.SILENT)return"No console available for logging"},u.setDefaultLevel=function(e){l()||u.setLevel(e,!1)},u.enableAll=function(e){u.setLevel(u.levels.TRACE,e)},u.disableAll=function(e){u.setLevel(u.levels.SILENT,e)};var d=l();null==d&&(d=null==n?"WARN":n),u.setLevel(d,!1)}var u=new a,c={};u.getLogger=function(e){if("string"!=typeof e||""===e)throw new TypeError("You must supply a name when creating a logger.");var t=c[e];return t||(t=c[e]=new a(e,u.getLevel(),u.methodFactory)),t};var l=typeof window!==t?window.log:void 0;return u.noConflict=function(){return typeof window!==t&&window.log===u&&(window.log=l),u},u.getLoggers=function(){return c},u}))},{}],260:[function(e,t,r){var n,o,i=t.exports={};function s(){throw new Error("setTimeout has not been defined")}function a(){throw new Error("clearTimeout has not been defined")}function u(e){if(n===setTimeout)return setTimeout(e,0);if((n===s||!n)&&setTimeout)return n=setTimeout,setTimeout(e,0);try{return n(e,0)}catch(t){try{return n.call(null,e,0)}catch(t){return n.call(this,e,0)}}}!function(){try{n="function"==typeof setTimeout?setTimeout:s}catch(e){n=s}try{o="function"==typeof clearTimeout?clearTimeout:a}catch(e){o=a}}();var c,l=[],d=!1,f=-1;function p(){d&&c&&(d=!1,c.length?l=c.concat(l):f=-1,l.length&&h())}function h(){if(!d){var e=u(p);d=!0;for(var t=l.length;t;){for(c=l,l=[];++f<t;)c&&c[f].run();f=-1,t=l.length}c=null,d=!1,function(e){if(o===clearTimeout)return clearTimeout(e);if((o===a||!o)&&clearTimeout)return o=clearTimeout,clearTimeout(e);try{o(e)}catch(t){try{return o.call(null,e)}catch(t){return o.call(this,e)}}}(e)}}function v(e,t){this.fun=e,this.array=t}function m(){}i.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];l.push(new v(e,t)),1!==l.length||d||u(h)},v.prototype.run=function(){this.fun.apply(null,this.array)},i.title="browser",i.browser=!0,i.env={},i.argv=[],i.version="",i.versions={},i.on=m,i.addListener=m,i.once=m,i.off=m,i.removeListener=m,i.removeAllListeners=m,i.emit=m,i.prependListener=m,i.prependOnceListener=m,i.listeners=function(e){return[]},i.binding=function(e){throw new Error("process.binding is not supported")},i.cwd=function(){return"/"},i.chdir=function(e){throw new Error("process.chdir is not supported")},i.umask=function(){return 0}},{}],261:[function(e,t,r){(function(e){!function(n){var o="object"==typeof r&&r&&!r.nodeType&&r,i="object"==typeof t&&t&&!t.nodeType&&t,s="object"==typeof e&&e;s.global!==s&&s.window!==s&&s.self!==s||(n=s);var a,u,c=2147483647,l=36,d=1,f=26,p=38,h=700,v=72,m=128,y="-",_=/^xn--/,g=/[^\x20-\x7E]/,b=/[\x2E\u3002\uFF0E\uFF61]/g,k={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},w=l-d,E=Math.floor,S=String.fromCharCode;function x(e){throw new RangeError(k[e])}function R(e,t){for(var r=e.length,n=[];r--;)n[r]=t(e[r]);return n}function T(e,t){var r=e.split("@"),n="";return r.length>1&&(n=r[0]+"@",e=r[1]),n+R((e=e.replace(b,".")).split("."),t).join(".")}function I(e){for(var t,r,n=[],o=0,i=e.length;o<i;)(t=e.charCodeAt(o++))>=55296&&t<=56319&&o<i?56320==(64512&(r=e.charCodeAt(o++)))?n.push(((1023&t)<<10)+(1023&r)+65536):(n.push(t),o--):n.push(t);return n}function C(e){return R(e,(function(e){var t="";return e>65535&&(t+=S((e-=65536)>>>10&1023|55296),e=56320|1023&e),t+=S(e)})).join("")}function O(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function j(e,t,r){var n=0;for(e=r?E(e/h):e>>1,e+=E(e/t);e>w*f>>1;n+=l)e=E(e/w);return E(n+(w+1)*e/(e+p))}function A(e){var t,r,n,o,i,s,a,u,p,h,_,g=[],b=e.length,k=0,w=m,S=v;for((r=e.lastIndexOf(y))<0&&(r=0),n=0;n<r;++n)e.charCodeAt(n)>=128&&x("not-basic"),g.push(e.charCodeAt(n));for(o=r>0?r+1:0;o<b;){for(i=k,s=1,a=l;o>=b&&x("invalid-input"),((u=(_=e.charCodeAt(o++))-48<10?_-22:_-65<26?_-65:_-97<26?_-97:l)>=l||u>E((c-k)/s))&&x("overflow"),k+=u*s,!(u<(p=a<=S?d:a>=S+f?f:a-S));a+=l)s>E(c/(h=l-p))&&x("overflow"),s*=h;S=j(k-i,t=g.length+1,0==i),E(k/t)>c-w&&x("overflow"),w+=E(k/t),k%=t,g.splice(k++,0,w)}return C(g)}function D(e){var t,r,n,o,i,s,a,u,p,h,_,g,b,k,w,R=[];for(g=(e=I(e)).length,t=m,r=0,i=v,s=0;s<g;++s)(_=e[s])<128&&R.push(S(_));for(n=o=R.length,o&&R.push(y);n<g;){for(a=c,s=0;s<g;++s)(_=e[s])>=t&&_<a&&(a=_);for(a-t>E((c-r)/(b=n+1))&&x("overflow"),r+=(a-t)*b,t=a,s=0;s<g;++s)if((_=e[s])<t&&++r>c&&x("overflow"),_==t){for(u=r,p=l;!(u<(h=p<=i?d:p>=i+f?f:p-i));p+=l)w=u-h,k=l-h,R.push(S(O(h+w%k,0))),u=E(w/k);R.push(S(O(u,0))),i=j(r,b,n==o),r=0,++n}++r,++t}return R.join("")}if(a={version:"1.4.1",ucs2:{decode:I,encode:C},decode:A,encode:D,toASCII:function(e){return T(e,(function(e){return g.test(e)?"xn--"+D(e):e}))},toUnicode:function(e){return T(e,(function(e){return _.test(e)?A(e.slice(4).toLowerCase()):e}))}},"function"==typeof define&&"object"==typeof define.amd&&define.amd)define("punycode",(function(){return a}));else if(o&&i)if(t.exports==o)i.exports=a;else for(u in a)a.hasOwnProperty(u)&&(o[u]=a[u]);else n.punycode=a}(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],262:[function(e,t,r){"use strict";var n=String.prototype.replace,o=/%20/g,i=e("./utils"),s={RFC1738:"RFC1738",RFC3986:"RFC3986"};t.exports=i.assign({default:s.RFC3986,formatters:{RFC1738:function(e){return n.call(e,o,"+")},RFC3986:function(e){return String(e)}}},s)},{"./utils":266}],263:[function(e,t,r){"use strict";var n=e("./stringify"),o=e("./parse"),i=e("./formats");t.exports={formats:i,parse:o,stringify:n}},{"./formats":262,"./parse":264,"./stringify":265}],264:[function(e,t,r){"use strict";var n=e("./utils"),o=Object.prototype.hasOwnProperty,i={allowDots:!1,allowPrototypes:!1,arrayLimit:20,charset:"utf-8",charsetSentinel:!1,comma:!1,decoder:n.decode,delimiter:"&",depth:5,ignoreQueryPrefix:!1,interpretNumericEntities:!1,parameterLimit:1e3,parseArrays:!0,plainObjects:!1,strictNullHandling:!1},s=function(e){return e.replace(/&#(\d+);/g,(function(e,t){return String.fromCharCode(parseInt(t,10))}))},a=function(e,t,r){if(e){var n=r.allowDots?e.replace(/\.([^.[]+)/g,"[$1]"):e,i=/(\[[^[\]]*])/g,s=r.depth>0&&/(\[[^[\]]*])/.exec(n),a=s?n.slice(0,s.index):n,u=[];if(a){if(!r.plainObjects&&o.call(Object.prototype,a)&&!r.allowPrototypes)return;u.push(a)}for(var c=0;r.depth>0&&null!==(s=i.exec(n))&&c<r.depth;){if(c+=1,!r.plainObjects&&o.call(Object.prototype,s[1].slice(1,-1))&&!r.allowPrototypes)return;u.push(s[1])}return s&&u.push("["+n.slice(s.index)+"]"),function(e,t,r){for(var n=t,o=e.length-1;o>=0;--o){var i,s=e[o];if("[]"===s&&r.parseArrays)i=[].concat(n);else{i=r.plainObjects?Object.create(null):{};var a="["===s.charAt(0)&&"]"===s.charAt(s.length-1)?s.slice(1,-1):s,u=parseInt(a,10);r.parseArrays||""!==a?!isNaN(u)&&s!==a&&String(u)===a&&u>=0&&r.parseArrays&&u<=r.arrayLimit?(i=[])[u]=n:i[a]=n:i={0:n}}n=i}return n}(u,t,r)}};t.exports=function(e,t){var r=function(e){if(!e)return i;if(null!==e.decoder&&void 0!==e.decoder&&"function"!=typeof e.decoder)throw new TypeError("Decoder has to be a function.");if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new Error("The charset option must be either utf-8, iso-8859-1, or undefined");var t=void 0===e.charset?i.charset:e.charset;return{allowDots:void 0===e.allowDots?i.allowDots:!!e.allowDots,allowPrototypes:"boolean"==typeof e.allowPrototypes?e.allowPrototypes:i.allowPrototypes,arrayLimit:"number"==typeof e.arrayLimit?e.arrayLimit:i.arrayLimit,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:i.charsetSentinel,comma:"boolean"==typeof e.comma?e.comma:i.comma,decoder:"function"==typeof e.decoder?e.decoder:i.decoder,delimiter:"string"==typeof e.delimiter||n.isRegExp(e.delimiter)?e.delimiter:i.delimiter,depth:"number"==typeof e.depth||!1===e.depth?+e.depth:i.depth,ignoreQueryPrefix:!0===e.ignoreQueryPrefix,interpretNumericEntities:"boolean"==typeof e.interpretNumericEntities?e.interpretNumericEntities:i.interpretNumericEntities,parameterLimit:"number"==typeof e.parameterLimit?e.parameterLimit:i.parameterLimit,parseArrays:!1!==e.parseArrays,plainObjects:"boolean"==typeof e.plainObjects?e.plainObjects:i.plainObjects,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:i.strictNullHandling}}(t);if(""===e||null==e)return r.plainObjects?Object.create(null):{};for(var u="string"==typeof e?function(e,t){var r,a={},u=t.ignoreQueryPrefix?e.replace(/^\?/,""):e,c=t.parameterLimit===1/0?void 0:t.parameterLimit,l=u.split(t.delimiter,c),d=-1,f=t.charset;if(t.charsetSentinel)for(r=0;r<l.length;++r)0===l[r].indexOf("utf8=")&&("utf8=%E2%9C%93"===l[r]?f="utf-8":"utf8=%26%2310003%3B"===l[r]&&(f="iso-8859-1"),d=r,r=l.length);for(r=0;r<l.length;++r)if(r!==d){var p,h,v=l[r],m=v.indexOf("]="),y=-1===m?v.indexOf("="):m+1;-1===y?(p=t.decoder(v,i.decoder,f,"key"),h=t.strictNullHandling?null:""):(p=t.decoder(v.slice(0,y),i.decoder,f,"key"),h=t.decoder(v.slice(y+1),i.decoder,f,"value")),h&&t.interpretNumericEntities&&"iso-8859-1"===f&&(h=s(h)),h&&t.comma&&h.indexOf(",")>-1&&(h=h.split(",")),o.call(a,p)?a[p]=n.combine(a[p],h):a[p]=h}return a}(e,r):e,c=r.plainObjects?Object.create(null):{},l=Object.keys(u),d=0;d<l.length;++d){var f=l[d],p=a(f,u[f],r);c=n.merge(c,p,r)}return n.compact(c)}},{"./utils":266}],265:[function(e,t,r){"use strict";var n=e("./utils"),o=e("./formats"),i=Object.prototype.hasOwnProperty,s={brackets:function(e){return e+"[]"},comma:"comma",indices:function(e,t){return e+"["+t+"]"},repeat:function(e){return e}},a=Array.isArray,u=Array.prototype.push,c=function(e,t){u.apply(e,a(t)?t:[t])},l=Date.prototype.toISOString,d=o.default,f={addQueryPrefix:!1,allowDots:!1,charset:"utf-8",charsetSentinel:!1,delimiter:"&",encode:!0,encoder:n.encode,encodeValuesOnly:!1,format:d,formatter:o.formatters[d],indices:!1,serializeDate:function(e){return l.call(e)},skipNulls:!1,strictNullHandling:!1},p=function e(t,r,o,i,s,u,l,d,p,h,v,m,y){var _,g=t;if("function"==typeof l?g=l(r,g):g instanceof Date?g=h(g):"comma"===o&&a(g)&&(g=g.join(",")),null===g){if(i)return u&&!m?u(r,f.encoder,y,"key"):r;g=""}if("string"==typeof(_=g)||"number"==typeof _||"boolean"==typeof _||"symbol"==typeof _||"bigint"==typeof _||n.isBuffer(g))return u?[v(m?r:u(r,f.encoder,y,"key"))+"="+v(u(g,f.encoder,y,"value"))]:[v(r)+"="+v(String(g))];var b,k=[];if(void 0===g)return k;if(a(l))b=l;else{var w=Object.keys(g);b=d?w.sort(d):w}for(var E=0;E<b.length;++E){var S=b[E];s&&null===g[S]||(a(g)?c(k,e(g[S],"function"==typeof o?o(r,S):r,o,i,s,u,l,d,p,h,v,m,y)):c(k,e(g[S],r+(p?"."+S:"["+S+"]"),o,i,s,u,l,d,p,h,v,m,y)))}return k};t.exports=function(e,t){var r,n=e,u=function(e){if(!e)return f;if(null!==e.encoder&&void 0!==e.encoder&&"function"!=typeof e.encoder)throw new TypeError("Encoder has to be a function.");var t=e.charset||f.charset;if(void 0!==e.charset&&"utf-8"!==e.charset&&"iso-8859-1"!==e.charset)throw new TypeError("The charset option must be either utf-8, iso-8859-1, or undefined");var r=o.default;if(void 0!==e.format){if(!i.call(o.formatters,e.format))throw new TypeError("Unknown format option provided.");r=e.format}var n=o.formatters[r],s=f.filter;return("function"==typeof e.filter||a(e.filter))&&(s=e.filter),{addQueryPrefix:"boolean"==typeof e.addQueryPrefix?e.addQueryPrefix:f.addQueryPrefix,allowDots:void 0===e.allowDots?f.allowDots:!!e.allowDots,charset:t,charsetSentinel:"boolean"==typeof e.charsetSentinel?e.charsetSentinel:f.charsetSentinel,delimiter:void 0===e.delimiter?f.delimiter:e.delimiter,encode:"boolean"==typeof e.encode?e.encode:f.encode,encoder:"function"==typeof e.encoder?e.encoder:f.encoder,encodeValuesOnly:"boolean"==typeof e.encodeValuesOnly?e.encodeValuesOnly:f.encodeValuesOnly,filter:s,formatter:n,serializeDate:"function"==typeof e.serializeDate?e.serializeDate:f.serializeDate,skipNulls:"boolean"==typeof e.skipNulls?e.skipNulls:f.skipNulls,sort:"function"==typeof e.sort?e.sort:null,strictNullHandling:"boolean"==typeof e.strictNullHandling?e.strictNullHandling:f.strictNullHandling}}(t);"function"==typeof u.filter?n=(0,u.filter)("",n):a(u.filter)&&(r=u.filter);var l,d=[];if("object"!=typeof n||null===n)return"";l=t&&t.arrayFormat in s?t.arrayFormat:t&&"indices"in t?t.indices?"indices":"repeat":"indices";var h=s[l];r||(r=Object.keys(n)),u.sort&&r.sort(u.sort);for(var v=0;v<r.length;++v){var m=r[v];u.skipNulls&&null===n[m]||c(d,p(n[m],m,h,u.strictNullHandling,u.skipNulls,u.encode?u.encoder:null,u.filter,u.sort,u.allowDots,u.serializeDate,u.formatter,u.encodeValuesOnly,u.charset))}var y=d.join(u.delimiter),_=!0===u.addQueryPrefix?"?":"";return u.charsetSentinel&&("iso-8859-1"===u.charset?_+="utf8=%26%2310003%3B&":_+="utf8=%E2%9C%93&"),y.length>0?_+y:""}},{"./formats":262,"./utils":266}],266:[function(e,t,r){"use strict";var n=Object.prototype.hasOwnProperty,o=Array.isArray,i=function(){for(var e=[],t=0;t<256;++t)e.push("%"+((t<16?"0":"")+t.toString(16)).toUpperCase());return e}(),s=function(e,t){for(var r=t&&t.plainObjects?Object.create(null):{},n=0;n<e.length;++n)void 0!==e[n]&&(r[n]=e[n]);return r};t.exports={arrayToObject:s,assign:function(e,t){return Object.keys(t).reduce((function(e,r){return e[r]=t[r],e}),e)},combine:function(e,t){return[].concat(e,t)},compact:function(e){for(var t=[{obj:{o:e},prop:"o"}],r=[],n=0;n<t.length;++n)for(var i=t[n],s=i.obj[i.prop],a=Object.keys(s),u=0;u<a.length;++u){var c=a[u],l=s[c];"object"==typeof l&&null!==l&&-1===r.indexOf(l)&&(t.push({obj:s,prop:c}),r.push(l))}return function(e){for(;e.length>1;){var t=e.pop(),r=t.obj[t.prop];if(o(r)){for(var n=[],i=0;i<r.length;++i)void 0!==r[i]&&n.push(r[i]);t.obj[t.prop]=n}}}(t),e},decode:function(e,t,r){var n=e.replace(/\+/g," ");if("iso-8859-1"===r)return n.replace(/%[0-9a-f]{2}/gi,unescape);try{return decodeURIComponent(n)}catch(e){return n}},encode:function(e,t,r){if(0===e.length)return e;var n=e;if("symbol"==typeof e?n=Symbol.prototype.toString.call(e):"string"!=typeof e&&(n=String(e)),"iso-8859-1"===r)return escape(n).replace(/%u[0-9a-f]{4}/gi,(function(e){return"%26%23"+parseInt(e.slice(2),16)+"%3B"}));for(var o="",s=0;s<n.length;++s){var a=n.charCodeAt(s);45===a||46===a||95===a||126===a||a>=48&&a<=57||a>=65&&a<=90||a>=97&&a<=122?o+=n.charAt(s):a<128?o+=i[a]:a<2048?o+=i[192|a>>6]+i[128|63&a]:a<55296||a>=57344?o+=i[224|a>>12]+i[128|a>>6&63]+i[128|63&a]:(s+=1,a=65536+((1023&a)<<10|1023&n.charCodeAt(s)),o+=i[240|a>>18]+i[128|a>>12&63]+i[128|a>>6&63]+i[128|63&a])}return o},isBuffer:function(e){return!(!e||"object"!=typeof e)&&!!(e.constructor&&e.constructor.isBuffer&&e.constructor.isBuffer(e))},isRegExp:function(e){return"[object RegExp]"===Object.prototype.toString.call(e)},merge:function e(t,r,i){if(!r)return t;if("object"!=typeof r){if(o(t))t.push(r);else{if(!t||"object"!=typeof t)return[t,r];(i&&(i.plainObjects||i.allowPrototypes)||!n.call(Object.prototype,r))&&(t[r]=!0)}return t}if(!t||"object"!=typeof t)return[t].concat(r);var a=t;return o(t)&&!o(r)&&(a=s(t,i)),o(t)&&o(r)?(r.forEach((function(r,o){if(n.call(t,o)){var s=t[o];s&&"object"==typeof s&&r&&"object"==typeof r?t[o]=e(s,r,i):t.push(r)}else t[o]=r})),t):Object.keys(r).reduce((function(t,o){var s=r[o];return n.call(t,o)?t[o]=e(t[o],s,i):t[o]=s,t}),a)}}},{}],267:[function(e,t,r){"use strict";function n(e,t){return Object.prototype.hasOwnProperty.call(e,t)}t.exports=function(e,t,r,i){t=t||"&",r=r||"=";var s={};if("string"!=typeof e||0===e.length)return s;var a=/\+/g;e=e.split(t);var u=1e3;i&&"number"==typeof i.maxKeys&&(u=i.maxKeys);var c=e.length;u>0&&c>u&&(c=u);for(var l=0;l<c;++l){var d,f,p,h,v=e[l].replace(a,"%20"),m=v.indexOf(r);m>=0?(d=v.substr(0,m),f=v.substr(m+1)):(d=v,f=""),p=decodeURIComponent(d),h=decodeURIComponent(f),n(s,p)?o(s[p])?s[p].push(h):s[p]=[s[p],h]:s[p]=h}return s};var o=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)}},{}],268:[function(e,t,r){"use strict";var n=function(e){switch(typeof e){case"string":return e;case"boolean":return e?"true":"false";case"number":return isFinite(e)?e:"";default:return""}};t.exports=function(e,t,r,a){return t=t||"&",r=r||"=",null===e&&(e=void 0),"object"==typeof e?i(s(e),(function(s){var a=encodeURIComponent(n(s))+r;return o(e[s])?i(e[s],(function(e){return a+encodeURIComponent(n(e))})).join(t):a+encodeURIComponent(n(e[s]))})).join(t):a?encodeURIComponent(n(a))+r+encodeURIComponent(n(e)):""};var o=Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)};function i(e,t){if(e.map)return e.map(t);for(var r=[],n=0;n<e.length;n++)r.push(t(e[n],n));return r}var s=Object.keys||function(e){var t=[];for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.push(r);return t}},{}],269:[function(e,t,r){"use strict";r.decode=r.parse=e("./decode"),r.encode=r.stringify=e("./encode")},{"./decode":267,"./encode":268}],270:[function(e,t,r){var n=function(){return this}()||Function("return this")(),o=n.regeneratorRuntime&&Object.getOwnPropertyNames(n).indexOf("regeneratorRuntime")>=0,i=o&&n.regeneratorRuntime;if(n.regeneratorRuntime=void 0,t.exports=e("./runtime"),o)n.regeneratorRuntime=i;else try{delete n.regeneratorRuntime}catch(e){n.regeneratorRuntime=void 0}},{"./runtime":271}],271:[function(e,t,r){!function(e){"use strict";var r,n=Object.prototype,o=n.hasOwnProperty,i="function"==typeof Symbol?Symbol:{},s=i.iterator||"@@iterator",a=i.asyncIterator||"@@asyncIterator",u=i.toStringTag||"@@toStringTag",c="object"==typeof t,l=e.regeneratorRuntime;if(l)c&&(t.exports=l);else{(l=e.regeneratorRuntime=c?t.exports:{}).wrap=b;var d="suspendedStart",f="suspendedYield",p="executing",h="completed",v={},m={};m[s]=function(){return this};var y=Object.getPrototypeOf,_=y&&y(y(j([])));_&&_!==n&&o.call(_,s)&&(m=_);var g=S.prototype=w.prototype=Object.create(m);E.prototype=g.constructor=S,S.constructor=E,S[u]=E.displayName="GeneratorFunction",l.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===E||"GeneratorFunction"===(t.displayName||t.name))},l.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,S):(e.__proto__=S,u in e||(e[u]="GeneratorFunction")),e.prototype=Object.create(g),e},l.awrap=function(e){return{__await:e}},x(R.prototype),R.prototype[a]=function(){return this},l.AsyncIterator=R,l.async=function(e,t,r,n){var o=new R(b(e,t,r,n));return l.isGeneratorFunction(t)?o:o.next().then((function(e){return e.done?e.value:o.next()}))},x(g),g[u]="Generator",g[s]=function(){return this},g.toString=function(){return"[object Generator]"},l.keys=function(e){var t=[];for(var r in e)t.push(r);return t.reverse(),function r(){for(;t.length;){var n=t.pop();if(n in e)return r.value=n,r.done=!1,r}return r.done=!0,r}},l.values=j,O.prototype={constructor:O,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=r,this.done=!1,this.delegate=null,this.method="next",this.arg=r,this.tryEntries.forEach(C),!e)for(var t in this)"t"===t.charAt(0)&&o.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=r)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function n(n,o){return a.type="throw",a.arg=e,t.next=n,o&&(t.method="next",t.arg=r),!!o}for(var i=this.tryEntries.length-1;i>=0;--i){var s=this.tryEntries[i],a=s.completion;if("root"===s.tryLoc)return n("end");if(s.tryLoc<=this.prev){var u=o.call(s,"catchLoc"),c=o.call(s,"finallyLoc");if(u&&c){if(this.prev<s.catchLoc)return n(s.catchLoc,!0);if(this.prev<s.finallyLoc)return n(s.finallyLoc)}else if(u){if(this.prev<s.catchLoc)return n(s.catchLoc,!0)}else{if(!c)throw new Error("try statement without catch or finally");if(this.prev<s.finallyLoc)return n(s.finallyLoc)}}}},abrupt:function(e,t){for(var r=this.tryEntries.length-1;r>=0;--r){var n=this.tryEntries[r];if(n.tryLoc<=this.prev&&o.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var i=n;break}}i&&("break"===e||"continue"===e)&&i.tryLoc<=t&&t<=i.finallyLoc&&(i=null);var s=i?i.completion:{};return s.type=e,s.arg=t,i?(this.method="next",this.next=i.finallyLoc,v):this.complete(s)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),v},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.finallyLoc===e)return this.complete(r.completion,r.afterLoc),C(r),v}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var r=this.tryEntries[t];if(r.tryLoc===e){var n=r.completion;if("throw"===n.type){var o=n.arg;C(r)}return o}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,n){return this.delegate={iterator:j(e),resultName:t,nextLoc:n},"next"===this.method&&(this.arg=r),v}}}function b(e,t,r,n){var o=t&&t.prototype instanceof w?t:w,i=Object.create(o.prototype),s=new O(n||[]);return i._invoke=function(e,t,r){var n=d;return function(o,i){if(n===p)throw new Error("Generator is already running");if(n===h){if("throw"===o)throw i;return A()}for(r.method=o,r.arg=i;;){var s=r.delegate;if(s){var a=T(s,r);if(a){if(a===v)continue;return a}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===d)throw n=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=p;var u=k(e,t,r);if("normal"===u.type){if(n=r.done?h:f,u.arg===v)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(n=h,r.method="throw",r.arg=u.arg)}}}(e,r,s),i}function k(e,t,r){try{return{type:"normal",arg:e.call(t,r)}}catch(e){return{type:"throw",arg:e}}}function w(){}function E(){}function S(){}function x(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function R(e){var t;this._invoke=function(r,n){function i(){return new Promise((function(t,i){!function t(r,n,i,s){var a=k(e[r],e,n);if("throw"!==a.type){var u=a.arg,c=u.value;return c&&"object"==typeof c&&o.call(c,"__await")?Promise.resolve(c.__await).then((function(e){t("next",e,i,s)}),(function(e){t("throw",e,i,s)})):Promise.resolve(c).then((function(e){u.value=e,i(u)}),s)}s(a.arg)}(r,n,t,i)}))}return t=t?t.then(i,i):i()}}function T(e,t){var n=e.iterator[t.method];if(n===r){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=r,T(e,t),"throw"===t.method))return v;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return v}var o=k(n,e.iterator,t.arg);if("throw"===o.type)return t.method="throw",t.arg=o.arg,t.delegate=null,v;var i=o.arg;return i?i.done?(t[e.resultName]=i.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=r),t.delegate=null,v):i:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,v)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function C(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function O(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function j(e){if(e){var t=e[s];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var n=-1,i=function t(){for(;++n<e.length;)if(o.call(e,n))return t.value=e[n],t.done=!1,t;return t.value=r,t.done=!0,t};return i.next=i}}return{next:A}}function A(){return{value:r,done:!0}}}(function(){return this}()||Function("return this")())},{}],272:[function(e,t,r){var n=e("buffer"),o=n.Buffer;function i(e,t){for(var r in e)t[r]=e[r]}function s(e,t,r){return o(e,t,r)}o.from&&o.alloc&&o.allocUnsafe&&o.allocUnsafeSlow?t.exports=n:(i(n,r),r.Buffer=s),s.prototype=Object.create(o.prototype),i(o,s),s.from=function(e,t,r){if("number"==typeof e)throw new TypeError("Argument must not be a number");return o(e,t,r)},s.alloc=function(e,t,r){if("number"!=typeof e)throw new TypeError("Argument must be a number");var n=o(e);return void 0!==t?"string"==typeof r?n.fill(t,r):n.fill(t):n.fill(0),n},s.allocUnsafe=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return o(e)},s.allocUnsafeSlow=function(e){if("number"!=typeof e)throw new TypeError("Argument must be a number");return n.SlowBuffer(e)}},{buffer:106}],273:[function(e,t,r){(function(t,n){var o=e("process/browser.js").nextTick,i=Function.prototype.apply,s=Array.prototype.slice,a={},u=0;function c(e,t){this._id=e,this._clearFn=t}r.setTimeout=function(){return new c(i.call(setTimeout,window,arguments),clearTimeout)},r.setInterval=function(){return new c(i.call(setInterval,window,arguments),clearInterval)},r.clearTimeout=r.clearInterval=function(e){e.close()},c.prototype.unref=c.prototype.ref=function(){},c.prototype.close=function(){this._clearFn.call(window,this._id)},r.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},r.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},r._unrefActive=r.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},r.setImmediate="function"==typeof t?t:function(e){var t=u++,n=!(arguments.length<2)&&s.call(arguments,1);return a[t]=!0,o((function(){a[t]&&(n?e.apply(null,n):e.call(null),r.clearImmediate(t))})),t},r.clearImmediate="function"==typeof n?n:function(e){delete a[e]}}).call(this,e("timers").setImmediate,e("timers").clearImmediate)},{"process/browser.js":260,timers:273}],274:[function(e,t,r){t.exports={0:"O",1:"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","\u2028":" ","\u2029":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":" ","":"_","":"_","":"_","":"_","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-","":"-.","":"","":",","":",","":",","":",","":",","":"","":"","":";","":"","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":":","":"::=","":":","":"!","":"!","":"!","":"!!","":"!?","":"?","":"?","":"?","":"?","":"?","":"?!","":"??","":"","":".","":".","":".","":".","":".","":".","":".","":".","":".","":".,","":"..","":"..","":"...","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"<","":">","":">","":">","":"4","":"d","":"J","":"L","":"P","":"U","":"V","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","`":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"'","":"''",'"':"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"''","":"'''","":"'''","":"''''","":"'B","":"'D","":"'n","":"'P","":"'T","":"'Y","":"(","":"(","":"(","":"(","":"(","":"((","":"()","":"(2)","":"(2O)","":"(3)","":"(4)","":"(5)","":"(6)","":"(7)","":"(8)","":"(9)","":"(a)","":"(A)","":"(b)","":"(B)","":"(c)","":"(C)","":"(d)","":"(D)","":"(e)","":"(E)","":"(f)","":"(F)","":"(g)","":"(G)","":"(h)","":"(H)","":"(i)","":"(j)","":"(J)","":"(k)","":"(K)","":"(l)","":"(l)","":"(l)","":"(L)","":"(l2)","":"(l3)","":"(l4)","":"(l5)","":"(l6)","":"(l7)","":"(l8)","":"(l9)","":"(ll)","":"(lO)","":"(M)","":"(n)","":"(N)","":"(o)","":"(O)","":"(p)","":"(P)","":"(q)","":"(Q)","":"(r)","":"(R)","":"(rn)","":"(s)","":"(S)","":"(S)","":"(t)","":"(T)","":"(u)","":"(U)","":"(v)","":"(V)","":"(vv)","":"(W)","":"(x)","":"(X)","":"(y)","":"(Y)","":"(z)","":"(Z)","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":"()","":")","":")","":")","":")","":")","":"))","":"{","":"{","":"}","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"*","":"*","":"*","":"*","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"//","":"///","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\","":"\\\\","":"\\\\","":"\\","":"&","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"^","":"^","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"b","":"bi","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"C","":"F","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"+","":"","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<","":"<<","":"<<<","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"=","":"==","":"===","":"=","":">","":">","":">","":">","":">","":">","":"><","":">>","":">>","":">>>","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"~","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"2","":"","":"","":"","":"","":"","":"","":"2","":"2,","":"2.","":"22","":"22","":"23","":"23","":"24","":"24","":"25","":"26","":"27","":"28","":"29","":"2l","":"2l","":"2O.","":"2O","":"2O","":"","":"","":"2","":"2","":"2","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"3","":"","":"","":"","":"","":"3","":"3,","":"3.","":"3l","":"3O","":"3","":"3","":"3","":"4","":"4","":"4","":"4","":"4","":"4","":"4","":"","":"","":"","":"4,","":"4.","":"4","":"4","":"4","":"4","":"5","":"5","":"5","":"5","":"5","":"5","":"5","":"","":"5,","":"5.","":"5","":"5","":"5","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"6","":"","":"","":"","":"6,","":"6.","":"6","":"6","":"6","":"7","":"7","":"7","":"7","":"7","":"7","":"7","":"","":"7,","":"7.","":"7","":"7","":"7","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"8","":"","":"","":"8,","":"8.","":"8","":"8","":"8","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"9","":"","":"","":"","":"","":"","":"9,","":"9.","":"9","":"9","":"9","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"a","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"A","":"a","":"","":"","":"","":"","":"","":"a/c","":"a/s","":"aa","":"AA","":"ae","":"ae","":"AE","":"AE","":"ao","":"AO","":"AR","":"au","":"AU","":"av","":"av","":"AV","":"AV","":"ay","":"AY","":"","":"","":"","":"","":"","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"B","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"b","":"bl","":"","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"c","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"C","":"c","":"c","":"C","":"c","":"c","":"C","":"C","":"C'","":"c/o","":"c/u","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"d","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"D","":"d","":"d","":"d","":"d","":"D","":"D","":"D","":"d","":"","":"d","":"d'","":"d","":"dz","":"dz","":"Dz","":"DZ","":"d","":"D","":"D","":"d","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"e","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"E","":"","":"","":"e","":"E","":"e","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"f","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"F","":"f","":"F","":"f","":"FAX","":"ff","":"ffi","":"ffl","":"fi","":"fl","":"f","":"","":"","":"","":"","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"g","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"G","":"","":"g","":"","":"","":"","":"g","":"G","":"G'","":"","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"h","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"H","":"","":"h","":"h","":"h","":"H","":"H","":"h","":"h","":"h","":"H","":"H","":"H","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"i","":"","":"i","":"","":"","":"i","":"i","":"i","":"ii","":"iii","":"ij","":"iv","":"ix","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"j","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"J","":"j","":"J","":"J","":"","":"","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"k","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"K","":"k","":"k","":"K","":"K","":"k","":"K","":"K","":"K","":"K'","":"l","|":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l",I:"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"L","":"l","":"l","":"l","":"L","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l","":"l,","":"l.","":"l'","":"l2.","":"l2","":"l2","":"l2","":"l3.","":"l3","":"l3","":"l4.","":"l4","":"l4","":"l5.","":"l5","":"l5","":"l6.","":"l6","":"l6","":"l7.","":"l7","":"l7","":"l8.","":"l8","":"l8","":"l9.","":"l9","":"l9","":"lj","":"lJ","":"Lj","":"LJ","":"ll","":"ll","":"ll","":"ll","":"ll","":"ll.","":"lll","":"ll","":"ll","":"ll","":"lO","":"lO.","":"lO","":"lO","":"lO","":"ls","":"lt","":"lV","":"lX","":"l","":"lz","":"l","":"l","":"l","":"l","":"l","":"l","":"lo","":"l","":"l","":"l","":"","":"","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"M","":"MB","":"","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"N","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"n","":"N","":"n","":"nj","":"Nj","":"NJ","":"No","":"","":"","":"","":"","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"","":"","":"","":"","":"o","":"o","":"o","":"O","":"O","":"O","":"o","":"o","":"o","":"o","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"O","":"o","":"O,","":"O.","":"o'","":"O'","":"O'","%":"/","":"/","":"/","":"/","":"/","":"/","":"/","":"oe","":"OE","":"o","":"oo","":"oo","":"oo","":"OO","":"OO","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"o","":"oo","":"o","":"O","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"p","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"P","":"p","":"p","":"p","":"P'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"Q","":"q","":"QE","":"","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"r","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"R","":"r","":"r","":"r","":"r","":"r","":"r'","":"rn",m:"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"rn","":"Rs","":"","":"","":"","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"s","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"S","":"s","":"s","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"sss","":"st","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"t","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"T","":"t","":"T","":"T","":"","":"T","":"t","":"T","":"T","":"t","":"T","":"t","":"","":"T3","":"t","":"TEL","":"tf","":"ts","":"t","":"t","":"","":"","":"","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"u","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"U","":"","":"","":"u","":"U","":"U","":"U","":"U'","":"ue","":"","":"","":"","":"","":"","":"","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"v","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"V","":"VB","":"vi","":"vii","":"viii","":"Vl","":"Vll","":"Vlll","":"V","":"vv",w:"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vv","":"vy","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"W","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"x","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"X","":"x","":"X","":"xi","":"xii","":"Xl","":"Xll","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"Y","":"y","":"y","":"y","":"Y","":"Y","":"Y","":"","":"","":"","":"","":"","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"Z","":"z","":"z","":"Z","":"z","":"Z","":"z","":"","":"","":"","":"","":"","":"","":"","":"","":"i","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":" lo o ","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"l","":"l","":"l","":"l","":"l","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"l","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"l","":"l","":"o","":"o","":"o","":"o","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"'","":"/","":"","":"","":"","":"","":"","":"'","":"","":"","":"'","":"","":"","":"","":"'","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"<","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"d","":"P","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"J","":"","":"","":"","":"","":"","":"","":"","":"J","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":"","":""}},{}],275:[function(e,t,r){"use strict";var n=e("./data.json");var o=RegExp(Object.keys(n).map((function(e){return e.replace(/([.?*+^$[\]\\(){}|-])/g,"\\$1")})).join("|"),"g");function i(e){return n[e]}t.exports=function(e){return e.replace(o,i)}},{"./data.json":274}],276:[function(e,t,r){"use strict";var n=e("punycode"),o=e("./util");function i(){this.protocol=null,this.slashes=null,this.auth=null,this.host=null,this.port=null,this.hostname=null,this.hash=null,this.search=null,this.query=null,this.pathname=null,this.path=null,this.href=null}r.parse=g,r.resolve=function(e,t){return g(e,!1,!0).resolve(t)},r.resolveObject=function(e,t){return e?g(e,!1,!0).resolveObject(t):t},r.format=function(e){o.isString(e)&&(e=g(e));return e instanceof i?e.format():i.prototype.format.call(e)},r.Url=i;var s=/^([a-z0-9.+-]+:)/i,a=/:[0-9]*$/,u=/^(\/\/?(?!\/)[^\?\s]*)(\?[^\s]*)?$/,c=["{","}","|","\\","^","`"].concat(["<",">",'"',"`"," ","\r","\n","\t"]),l=["'"].concat(c),d=["%","/","?",";","#"].concat(l),f=["/","?","#"],p=/^[+a-z0-9A-Z_-]{0,63}$/,h=/^([+a-z0-9A-Z_-]{0,63})(.*)$/,v={javascript:!0,"javascript:":!0},m={javascript:!0,"javascript:":!0},y={http:!0,https:!0,ftp:!0,gopher:!0,file:!0,"http:":!0,"https:":!0,"ftp:":!0,"gopher:":!0,"file:":!0},_=e("querystring");function g(e,t,r){if(e&&o.isObject(e)&&e instanceof i)return e;var n=new i;return n.parse(e,t,r),n}i.prototype.parse=function(e,t,r){if(!o.isString(e))throw new TypeError("Parameter 'url' must be a string, not "+typeof e);var i=e.indexOf("?"),a=-1!==i&&i<e.indexOf("#")?"?":"#",c=e.split(a);c[0]=c[0].replace(/\\/g,"/");var g=e=c.join(a);if(g=g.trim(),!r&&1===e.split("#").length){var b=u.exec(g);if(b)return this.path=g,this.href=g,this.pathname=b[1],b[2]?(this.search=b[2],this.query=t?_.parse(this.search.substr(1)):this.search.substr(1)):t&&(this.search="",this.query={}),this}var k=s.exec(g);if(k){var w=(k=k[0]).toLowerCase();this.protocol=w,g=g.substr(k.length)}if(r||k||g.match(/^\/\/[^@\/]+@[^@\/]+/)){var E="//"===g.substr(0,2);!E||k&&m[k]||(g=g.substr(2),this.slashes=!0)}if(!m[k]&&(E||k&&!y[k])){for(var S,x,R=-1,T=0;T<f.length;T++){-1!==(I=g.indexOf(f[T]))&&(-1===R||I<R)&&(R=I)}-1!==(x=-1===R?g.lastIndexOf("@"):g.lastIndexOf("@",R))&&(S=g.slice(0,x),g=g.slice(x+1),this.auth=decodeURIComponent(S)),R=-1;for(T=0;T<d.length;T++){var I;-1!==(I=g.indexOf(d[T]))&&(-1===R||I<R)&&(R=I)}-1===R&&(R=g.length),this.host=g.slice(0,R),g=g.slice(R),this.parseHost(),this.hostname=this.hostname||"";var C="["===this.hostname[0]&&"]"===this.hostname[this.hostname.length-1];if(!C)for(var O=this.hostname.split(/\./),j=(T=0,O.length);T<j;T++){var A=O[T];if(A&&!A.match(p)){for(var D="",M=0,P=A.length;M<P;M++)A.charCodeAt(M)>127?D+="x":D+=A[M];if(!D.match(p)){var U=O.slice(0,T),L=O.slice(T+1),F=A.match(h);F&&(U.push(F[1]),L.unshift(F[2])),L.length&&(g="/"+L.join(".")+g),this.hostname=U.join(".");break}}}this.hostname.length>255?this.hostname="":this.hostname=this.hostname.toLowerCase(),C||(this.hostname=n.toASCII(this.hostname));var N=this.port?":"+this.port:"",K=this.hostname||"";this.host=K+N,this.href+=this.host,C&&(this.hostname=this.hostname.substr(1,this.hostname.length-2),"/"!==g[0]&&(g="/"+g))}if(!v[w])for(T=0,j=l.length;T<j;T++){var q=l[T];if(-1!==g.indexOf(q)){var B=encodeURIComponent(q);B===q&&(B=escape(q)),g=g.split(q).join(B)}}var G=g.indexOf("#");-1!==G&&(this.hash=g.substr(G),g=g.slice(0,G));var V=g.indexOf("?");if(-1!==V?(this.search=g.substr(V),this.query=g.substr(V+1),t&&(this.query=_.parse(this.query)),g=g.slice(0,V)):t&&(this.search="",this.query={}),g&&(this.pathname=g),y[w]&&this.hostname&&!this.pathname&&(this.pathname="/"),this.pathname||this.search){N=this.pathname||"";var $=this.search||"";this.path=N+$}return this.href=this.format(),this},i.prototype.format=function(){var e=this.auth||"";e&&(e=(e=encodeURIComponent(e)).replace(/%3A/i,":"),e+="@");var t=this.protocol||"",r=this.pathname||"",n=this.hash||"",i=!1,s="";this.host?i=e+this.host:this.hostname&&(i=e+(-1===this.hostname.indexOf(":")?this.hostname:"["+this.hostname+"]"),this.port&&(i+=":"+this.port)),this.query&&o.isObject(this.query)&&Object.keys(this.query).length&&(s=_.stringify(this.query));var a=this.search||s&&"?"+s||"";return t&&":"!==t.substr(-1)&&(t+=":"),this.slashes||(!t||y[t])&&!1!==i?(i="//"+(i||""),r&&"/"!==r.charAt(0)&&(r="/"+r)):i||(i=""),n&&"#"!==n.charAt(0)&&(n="#"+n),a&&"?"!==a.charAt(0)&&(a="?"+a),t+i+(r=r.replace(/[?#]/g,(function(e){return encodeURIComponent(e)})))+(a=a.replace("#","%23"))+n},i.prototype.resolve=function(e){return this.resolveObject(g(e,!1,!0)).format()},i.prototype.resolveObject=function(e){if(o.isString(e)){var t=new i;t.parse(e,!1,!0),e=t}for(var r=new i,n=Object.keys(this),s=0;s<n.length;s++){var a=n[s];r[a]=this[a]}if(r.hash=e.hash,""===e.href)return r.href=r.format(),r;if(e.slashes&&!e.protocol){for(var u=Object.keys(e),c=0;c<u.length;c++){var l=u[c];"protocol"!==l&&(r[l]=e[l])}return y[r.protocol]&&r.hostname&&!r.pathname&&(r.path=r.pathname="/"),r.href=r.format(),r}if(e.protocol&&e.protocol!==r.protocol){if(!y[e.protocol]){for(var d=Object.keys(e),f=0;f<d.length;f++){var p=d[f];r[p]=e[p]}return r.href=r.format(),r}if(r.protocol=e.protocol,e.host||m[e.protocol])r.pathname=e.pathname;else{for(var h=(e.pathname||"").split("/");h.length&&!(e.host=h.shift()););e.host||(e.host=""),e.hostname||(e.hostname=""),""!==h[0]&&h.unshift(""),h.length<2&&h.unshift(""),r.pathname=h.join("/")}if(r.search=e.search,r.query=e.query,r.host=e.host||"",r.auth=e.auth,r.hostname=e.hostname||e.host,r.port=e.port,r.pathname||r.search){var v=r.pathname||"",_=r.search||"";r.path=v+_}return r.slashes=r.slashes||e.slashes,r.href=r.format(),r}var g=r.pathname&&"/"===r.pathname.charAt(0),b=e.host||e.pathname&&"/"===e.pathname.charAt(0),k=b||g||r.host&&e.pathname,w=k,E=r.pathname&&r.pathname.split("/")||[],S=(h=e.pathname&&e.pathname.split("/")||[],r.protocol&&!y[r.protocol]);if(S&&(r.hostname="",r.port=null,r.host&&(""===E[0]?E[0]=r.host:E.unshift(r.host)),r.host="",e.protocol&&(e.hostname=null,e.port=null,e.host&&(""===h[0]?h[0]=e.host:h.unshift(e.host)),e.host=null),k=k&&(""===h[0]||""===E[0])),b)r.host=e.host||""===e.host?e.host:r.host,r.hostname=e.hostname||""===e.hostname?e.hostname:r.hostname,r.search=e.search,r.query=e.query,E=h;else if(h.length)E||(E=[]),E.pop(),E=E.concat(h),r.search=e.search,r.query=e.query;else if(!o.isNullOrUndefined(e.search)){if(S)r.hostname=r.host=E.shift(),(C=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=C.shift(),r.host=r.hostname=C.shift());return r.search=e.search,r.query=e.query,o.isNull(r.pathname)&&o.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.href=r.format(),r}if(!E.length)return r.pathname=null,r.search?r.path="/"+r.search:r.path=null,r.href=r.format(),r;for(var x=E.slice(-1)[0],R=(r.host||e.host||E.length>1)&&("."===x||".."===x)||""===x,T=0,I=E.length;I>=0;I--)"."===(x=E[I])?E.splice(I,1):".."===x?(E.splice(I,1),T++):T&&(E.splice(I,1),T--);if(!k&&!w)for(;T--;T)E.unshift("..");!k||""===E[0]||E[0]&&"/"===E[0].charAt(0)||E.unshift(""),R&&"/"!==E.join("/").substr(-1)&&E.push("");var C,O=""===E[0]||E[0]&&"/"===E[0].charAt(0);S&&(r.hostname=r.host=O?"":E.length?E.shift():"",(C=!!(r.host&&r.host.indexOf("@")>0)&&r.host.split("@"))&&(r.auth=C.shift(),r.host=r.hostname=C.shift()));return(k=k||r.host&&E.length)&&!O&&E.unshift(""),E.length?r.pathname=E.join("/"):(r.pathname=null,r.path=null),o.isNull(r.pathname)&&o.isNull(r.search)||(r.path=(r.pathname?r.pathname:"")+(r.search?r.search:"")),r.auth=e.auth||r.auth,r.slashes=r.slashes||e.slashes,r.href=r.format(),r},i.prototype.parseHost=function(){var e=this.host,t=a.exec(e);t&&(":"!==(t=t[0])&&(this.port=t.substr(1)),e=e.substr(0,e.length-t.length)),e&&(this.hostname=e)}},{"./util":277,punycode:261,querystring:269}],277:[function(e,t,r){"use strict";t.exports={isString:function(e){return"string"==typeof e},isObject:function(e){return"object"==typeof e&&null!==e},isNull:function(e){return null===e},isNullOrUndefined:function(e){return null==e}}},{}]},{},[1]);